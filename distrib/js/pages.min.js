/*! Hualala-Merchant-Management 2015-02-12 */

!function(a){IX.ns("Hualala.Entry");var b=[{name:"group_name",type:"text",palceholder:"请输入主账号",clz:"form-control input-md",key:"groupName",field:{validators:{notEmpty:{message:"请输入主账号"}}}},{name:"group_subname",type:"text",palceholder:"请输入子账号",clz:"form-control input-md",key:"childName",field:{validators:{notEmpty:{message:"用户账号不能为空"},stringLength:{min:3,max:50,message:"账号名称长度在3-50个字符之间"},loginName:{message:"账号名称只能包含数字、英文字母和下划线(_)"}}}},{name:"login_pwd",type:"password",palceholder:"请输入登陆密码",clz:"form-control input-md",key:"password",field:{validators:{notEmpty:{message:"请输入登陆密码"},callback:{callback:function(a){var b=6,c=32;return a.length<6||a.length>32?{valid:!1,message:"密码长度必须在"+b+"位到"+c+"位之间"}:{valid:!0}}}}}},{name:"login_auth",type:"text",palceholder:"请输入验证码",clz:"form-control input-md",key:"authCode",field:{validators:{notEmpty:{message:"请输入验证码"}}}},{name:"group_mobile",type:"text",placeholder:"请输入账号绑定的手机号",clz:"form-control input-md",key:"userMobile",field:{validators:{notEmpty:{message:"请输入账号绑定的手机号"},mobile:{message:"请输入中国地区正确的手机号"}}}},{name:"mobile_pwd",type:"password",placeholder:"短信动态密码",clz:"form-control input-md",key:"dynamicPwd",field:{validators:{notEmpty:{message:"请输入短信动态密码"}}}}],c=new IX.IListManager;_.each(b,function(a){var b=$XP(a,"name");c.register(b,a)});var d="group_name,group_subname,login_pwd,login_auth".split(","),e="group_name,group_mobile,mobile_pwd".split(","),f=function(b){var c=a($XP(b,"$btn")),d=$XF(b,"getParams"),e=$XP(b,"waiting",60),f=null,g=Hualala.Global.getMobileDynamicPWD,h=function(a){var b=d();return b?void g(b,function(b){"000"==$XP(b,"resultcode")?(Hualala.UI.TopTip({type:"success",msg:$XP(b,"resultmsg","短信发送成功")}),a()):(Hualala.UI.TopTip({type:"danger",msg:$XP(b,"resultmsg","发送动态密码失败")}),c.button("reset"))}):void c.button("reset")},i=function(){var a=e;f=setInterval(function(){if(a--,0==a)return clearInterval(f),c.attr("data-loading-text","发送中..."),void c.button("reset");var b="{time}秒后重试",d=b.replaceAll("{time}",a);c.text(d)},1e3)},j=function(){c.unbind("click").on("click",function(){c.hasClass("disabled")||(c.button("loading"),h(i))})};return j(),{getDynamicPWD:function(){c.trigger("click")}}};Hualala.Common.DynamicPWD=f;var g=function(b){var c=a($XP(b,"container")),d=c.find(".auth-img"),e=c.find(".progress"),f=Hualala.Global.genAuthCode,g=function(a){e[a?"removeClass":"addClass"]("hidden"),d[a?"addClass":"removeClass"]("hidden")},h=function(a){g(!0),f({},function(b){var c=null;"000"==$XP(b,"resultcode")?c=$XP(b,"data.code",null):(Hualala.UI.TopTip({type:"warning",msg:"获取验证码失败"}),g()),a(c)})},i=function(a){return a?(d.attr("src",a+"?"+(new Date).getTime()),void setTimeout(function(){g()},500)):void setTimeout(function(){h(i)},1e3)},j=function(){c.find(".auth-img").unbind("click").on("click",function(b){d=a(b.target),h(i)})},k=function(){h(i),j()};return k(),{genCode:function(){h(i)}}};Hualala.Entry.initLogin=Stapes.subclass({constructor:function(a){this.$container=$XP(a,"$container"),this.mode=$XP(a,"mode","common"),this.callServer=Hualala.Global.loginCallServer,this.formKeys=[],this.formFieldHT=c,this.formFields=[],this.$subBtn=null,this.$authCode=null,this.authCode=null,this.$dinamicPWDBtn=null,this.dinamicPWD=null,this.progress=null,this.fvOpts=null,this.$formPanel=null,this.switchLoginMode(this.mode),this.bindEvent()}}),Hualala.Entry.initLogin.proto({switchLoginMode:function(a){var b=this;b.mode=a,"common"==b.mode?(b.callServer=Hualala.Global.loginCallServer,b.formKeys=d,b.$formPanel=b.$container.find(".panel-login"),b.$subBtn=b.$container.find("#login_sub"),b.$progress=b.$subBtn.parent().find(".progress"),b.$authCode=b.$container.find(".ix-authcode"),b.authCode=new g({container:b.$authCode}),b.formFields=b.formFieldHT.getByKeys(b.formKeys),b.fvOpts=b.initValidFieldOpts()):"mobile"==b.mode&&(b.callServer=Hualala.Global.dynamicLoginCallServer,b.formKeys=e,b.$formPanel=b.$container.find(".panel-forget-pwd"),b.$subBtn=b.$container.find("#login_mobile"),b.$progress=b.$subBtn.parent().find(".progress"),b.$dynamicPWDBtn=b.$container.find(".btn-mobile-pwd"),b.dinamicPWD=new f({$btn:b.$dynamicPWDBtn,getParams:function(){var a=b.$formPanel.find("#group_name"),c=b.$formPanel.find("#group_mobile"),d=b.$formPanel.data("bootstrapValidator");if(!d.validateField(a).isValidField(a)||!d.validateField(c).isValidField(c))return null;var e=b.getFormData(),f={};return _.each(e,function(a,b){("groupName"==b||"userMobile"==b)&&(f[b]=a)}),f}}),b.formFields=b.formFieldHT.getByKeys(b.formKeys),b.fvOpts=b.initValidFieldOpts()),b.initLoginForm()},toggleProgress:function(a){var b=this;b.$progress[a?"removeClass":"addClass"]("hidden"),b.$subBtn[a?"addClass":"removeClass"]("hidden")},initValidFieldOpts:function(){var a=this,b={};return _.each(a.formFields,function(a){var c=$XP(a,"name"),d=$XP(a,"field");b[c]=d}),b},getFormData:function(){var b=this,c={};return _.each(b.formFields,function(d){var e=$XP(d,"name"),f=$XP(d,"key"),g=a("[name="+e+"]",b.$formPanel).val();c[f]=g}),c},initLoginForm:function(){var b=this;b.$container.find(".panel-warning").addClass("hidden"),b.$formPanel.removeClass("hidden"),b.$formPanel.find("#group_name").val(b.groupName),b.$formPanel.data("bootstrapValidator")||(b.$formPanel.bootstrapValidator({trigger:"blur",fields:b.fvOpts}).on("success.field.bv",function(a,c){var d=$XP(c,"field");"group_mobile"==d&&b.$dynamicPWDBtn.removeClass("disabled").attr("disabled",!1)}).on("error.field.bv",function(c,d){{var e=a(c.target);e.data("bootstrapValidator")}b.toggleProgress();var f=$XP(d,"field");("group_mobile"==f||"group_name"==f)&&b.$dynamicPWDBtn.addClass("disabled").attr("disabled",!0)}).on("success.form.bv",function(c){c.preventDefault();var d=a(c.target),e=(d.data("bootstrapValidator"),b.getFormData());IX.Debug.info("INFO: Login Params : "),IX.Debug.info(e),b.callServer(e,function(a){"000"==a.resultcode?document.location.href=Hualala.PageRoute.createPath("main"):(Hualala.UI.TopTip({type:"danger",msg:$XP(a,"resultmsg")}),"common"==b.mode&&b.authCode.genCode()),b.toggleProgress(),b.$subBtn.attr("disabled",!1)})}),b.$formPanel.bootstrapValidator("resetForm"),b.$dynamicPWDBtn&&b.$dynamicPWDBtn.removeClass("disabled").attr("disabled",!1))},bindEvent:function(){var b=this;b.$container.delegate("#login_sub, #login_mobile","click",function(){b.toggleProgress(!0);var a=b.$formPanel.data("bootstrapValidator");a.validate()}),b.$container.delegate(".form-control[tabIndex]","keyup",function(c){if(13==c.keyCode){var d=a(this),e=parseInt(d.attr("tabIndex")),f=a(".form-control[tabIndex="+(e+1)+"]");d.blur(),f.length>0&&!f.is(".btn")?f.focus():b.$subBtn.trigger("click")}}),b.$container.delegate(".btn-change-mode","click",function(){var c=a(this),d=c.attr("data-mode");b.groupName=b.$formPanel.find("#group_name").val(),b.toggleProgress(),b.switchLoginMode(d)})}})}(jQuery,window),function(){IX.ns("Hualala.Shop");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip),b=Stapes.subclass({constructor:function(){this.origCities=[],this.origAreas=[],this.origShops=[],this.isReady=!1,this.callServer=Hualala.Global.getShopQuerySchema}});b.proto({init:function(b,c){var d=this;d.isReady=!1,d.callServer(b,function(b){"000"==b.resultcode?(d.origCities=$XP(b,"data.cities",[]),d.origAreas=$XP(b,"data.areas",[]),d.origShops=$XP(b,"data.shops",[]),d.initDataModel(),d.isReady=!0):(a({msg:$XP(b,"resultmsg",""),type:"danger"}),d.isReady=!1),c(d)})},initDataModel:function(){var a=this,b=new IX.IListManager,c=new IX.IListManager,d=new IX.IListManager;_.each(this.origCities,function(c){var d=$XP(c,"cityID"),e=_.filter(a.origShops,function(a){return $XP(a,"cityID")==d}),f=_.filter(a.origAreas,function(a){return $XP(a,"cityID")==d});e=_.pluck(e,"shopID"),f=_.pluck(f,"areaID"),b.register(d,IX.inherit(c,{shopLst:e,areaLst:f}))}),_.each(this.origAreas,function(b){var d=$XP(b,"areaID"),e=_.filter(a.origShops,function(a){return $XP(a,"areaID")==d});e=_.pluck(e,"shopID"),c.register(d,IX.inherit(b,{shopLst:e}))}),_.each(this.origShops,function(a){var b=$XP(a,"shopID");d.register(b,a)}),a.set({ds_city:b,ds_area:c,ds_shop:d})},hasReady:function(){return this.isReady},getCities:function(a){a=IX.isEmpty(a)?null:IX.isString(a)?[a]:a;var b=this.get("ds_city"),c=null;return c=b[a?"getByKeys":"getAll"](a)},getShops:function(a){a=IX.isEmpty(a)?null:IX.isString(a)?[a]:a;var b=this.get("ds_shop"),c=null;return c=b[a?"getByKeys":"getAll"](a)},getShopsByAreaID:function(a){if(!a)return null;var b=this.get("ds_shop"),c=_.filter(b.getAll(),function(b){var c=$XP(b,"areaID");return a==c});return 0==c.length?null:c},getShopsByCityID:function(a){if(!a)return null;var b=this.get("ds_shop"),c=_.filter(b.getAll(),function(b){var c=$XP(b,"cityID");return a==c});return 0==c.length?null:c},getAreas:function(a){a=IX.isEmpty(a)?null:IX.isString(a)?[a]:a;var b=this.get("ds_area"),c=null;return c=b[a?"getByKeys":"getAll"](a)},destroy:function(){this.origCities=[],this.origAreas=[],this.origShops=[],this.isReady=!1}}),Hualala.Shop.QueryModel=b}(jQuery,window),function(a){IX.ns("Hualala.Shop");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Stapes.subclass({constructor:function(){this.isReady=!1,this.needShopCreate=!1,this.$container=null,this.$queryBox=null,this.$filter=null,this.$query=null,this.loadTemplates()}}));b.proto({init:function(a){if(this.model=$XP(a,"model",null),this.needShopCreate=$XP(a,"needShopCreate",!1),this.$container=$XP(a,"container",null),!this.model||!this.$container||0==this.$container.length)throw"Init Query View Failed!!";this.keywordLst=null,this.renderLayout(),this.bindEvent(),this.isReady=!0,this.emit("filter",this.getFilterParams())},hasReady:function(){return this.isReady},loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_shop_query")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_filter"));Handlebars.registerPartial("shopCity",Hualala.TplLib.get("tpl_shop_filter")),Handlebars.registerPartial("toggle",Hualala.TplLib.get("tpl_site_navbarToggle")),this.set({queryTpl:a,filterTpl:b})},mapChosenShopData:function(){var a=this,b=this.model.getCities(),c=[];return _.each(b,function(b){var d=$XP(b,"cityName",""),e=($XP(b,"cityID",""),$XP(b,"shopLst")),f=a.model.getShops(e);c.push({name:d,items:_.map(f,function(a){return{code:$XP(a,"shopID"),name:$XP(a,"shopName")}})})}),c},mapRenderLayoutData:function(){var a=this.model.getCities(),b=(this.model.getShops(),this.mapFilterData({type:"city",name:"城市：",focus:0,data:a})),c=this.mapChosenShopData();return{clz:"",shopCity:b,toggle:{target:"#shop_query"},needShopCreate:this.needShopCreate,optGrp:c}},chkCtrlRight:function(){var a=this,b=Hualala.Common.getCurPageUserRight(),c=$XP(b,"right.disabled",[]),d=$XP(b,"right.enabled",[]);_.each(c,function(b){a.$query.find("[data-btn-name="+b+"]").attr("disabled",!0).addClass("invisible")}),_.each(d,function(b){a.$query.find("[data-btn-name="+b+"]").attr("disabled",!1).removeClass("invisible")})},renderLayout:function(){var b=this,c=b.get("queryTpl"),d=(b.model,b.mapRenderLayoutData()),e=c(d);this.$queryBox=a(e),this.$container.prepend(this.$queryBox),this.$filter=this.$queryBox.find(".filter"),this.$query=this.$queryBox.find(".query"),this.initShopChosenPanel(),this.chkCtrlRight()},mapFilterData:function(a){var b=$XP(a,"data",[]),c=$XP(a,"type"),d=$XP(a,"name"),e=$XP(a,"focus",0),f={type:c,name:d,items:[]},g=0,h={focusClz:"",type:c,code:-1,name:"全部",count:0};return f.items=_.map(b,function(a){var b=c+"Count",d=parseInt($XP(a,b,0));return g+=d,{focusClz:"",type:c,code:$XP(a,c+"ID",""),name:$XP(a,c+"Name",""),count:d}}),h=IX.inherit(h,{count:g,focusClz:""}),f.items.unshift(h),f.items[e].focusClz="disabled",f},initShopChosenPanel:function(){var b=this,c=new Pymatch([]),d=b.model.getShops(),e=function(a){c.setNames(_.map(d,function(a){return IX.inherit(a,{name:a.shopName})}));var b=c.match(a),e={};return _.each(b,function(a){e[a[0].shopID]=!0}),e};b.$query.find('.navbar-form[role="search"] select').chosen({width:"200px",placeholder_text:"请选择店铺名称",no_results_text:"抱歉，没有找到！",allow_single_deselect:!0,getMatchedFn:e}).change(function(){var c=a(this);b.keywordLst=c.val()})},renderAreaFilter:function(a){var b=this,c=b.get("filterTpl"),d=(b.model,b.mapFilterData({type:"area",name:"区域：",focus:0,data:a})),e=c(d);this.$filter.find(".area").remove(),this.$filter.append(e),this.initShopChosenPanel()},updateFilterCityLayout:function(a){var b=this,c=null;-1!=a?(c=b.model.getCities(a),c=$XP(c[0],"areaLst",null),c=b.model.getAreas(c),b.renderAreaFilter(c)):b.$filter.find(".area").remove(),b.$filter.find(".btn-link[data-city]").removeClass("disabled"),b.$filter.find(".btn-link[data-city="+a+"]").addClass("disabled")},updateFilterAreaLayout:function(a){var b=this;b.$filter.find(".btn-link[data-area]").removeClass("disabled"),b.$filter.find(".btn-link[data-area="+a+"]").addClass("disabled")},bindEvent:function(){var b=this;this.$filter.on("click",".btn-link[data-city]",function(){var c=a(this),d=c.attr("data-city");b.updateFilterCityLayout(d),b.emit("filter",b.getFilterParams())}),this.$filter.on("click",".btn-link[data-area]",function(){var c=a(this),d=c.attr("data-area");b.updateFilterAreaLayout(d),b.emit("filter",b.getFilterParams())}),this.$query.on("click",".create-shop",function(){a(this);document.location.href=Hualala.PageRoute.createPath("shopCreate")}),this.$query.on("click",".query-btn",function(){var c=(a(this),b.keywordLst||null),d=null,e=-1,f=-1;IX.isEmpty(c)||(d=b.model.getShops(c)[0],e=$XP(d,"cityID",-1),f=$XP(d,"areaID",-1)),b.updateFilterCityLayout(e),b.updateFilterAreaLayout(f),b.emit("query",b.getQueryParams())}),this.$query.on("keyup",".chosen-container",function(){var c=a(this);c.hasClass("chosen-container-active")&&!c.hasClass("chosen-with-drop")&&(c.find("input").first().trigger("blur.chosen"),b.$query.find(".query-btn").trigger("click"))})},destroy:function(){this.isReady=!1,this.needShopCreate=!1,this.$container.find(".shop-query").remove(),this.$queryBox=null,this.$filter=null,this.$query=null},getFilterParams:function(){var a=this,b=a.$filter.find(".btn-link.disabled"),c=b.filter("[data-city]").attr("data-city"),d=b.filter("[data-area]").attr("data-area");return c=c&&-1!=c?c:"",d=d&&-1!=d?d:"",{cityID:c,areaID:d,keywordLst:""}},getQueryParams:function(){var a=this,b=a.keywordLst||null,c=a.getFilterParams(),d=a.model.getShops();return b=IX.isEmpty(b)?"":$XP(_.find(d,function(a){return $XP(a,"shopID")==b}),"shopName",""),IX.inherit(c,{keywordLst:b})}}),Hualala.Shop.QueryView=b}(jQuery,window),function(){IX.ns("Hualala.Shop");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.Shop.QueryModel),b=Hualala.Shop.QueryView,c=Stapes.subclass({constructor:function(c){this.set({sessionData:Hualala.getSessionData()}),this.container=$XP(c,"container",null),this.needShopCreate=$XP(c,"needShopCreate",!1),this.resultController=$XP(c,"resultController",null),this.model=new a,this.view=new b,this.init()}});c.proto({init:function(){var a=this;a.bindEvent(),a.model.emit("load",function(){if(!a.model.hasReady())throw"Shop Query Init Failed!!";a.view.emit("init")})},bindEvent:function(){this.on({reload:function(){var a=this;a.model.distory(),a.view.distory(),a.init()},query:function(a){var b=this;IX.Debug.info("DEBUG: Shop Query Controller Query Params : "),IX.Debug.info(a),b.resultController&&b.resultController.emit("load",IX.inherit(a,{pageNo:1,pageSize:15}))}},this),this.model.on({load:function(a){var b=this,c=$XP(b.get("sessionData"),"user",{});b.model.init(c,a)}},this),this.view.on({init:function(){var a=this;a.view.init({model:a.model,needShopCreate:a.needShopCreate,container:a.container})},filter:function(a){var b=this;b.emit("query",a)},query:function(a){var b=this;b.emit("query",a)}},this)}}),Hualala.Shop.QueryController=c}(jQuery,window),function(){IX.ns("Hualala.Shop");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip),b=Stapes.subclass({constructor:function(a){if(this.callServer=$XP(a,"callServer",null),!this.callServer)throw"callServer is empty!"}});b.proto({init:function(a){this.set({pageCount:0,totalSize:0,pageNo:$XP(a,"pageNo",1),pageSize:$XP(a,"pageSize",15),cityID:$XP(a,"cityID",""),areaID:$XP(a,"areaID",""),keywordLst:$XP(a,"keywordLst",""),ds_shop:new IX.IListManager,ds_page:new IX.IListManager})},updatePagerParams:function(a){var b=this,c="pageCount,totalSize,pageNo,pageSize,cityID,areaID,keywordLst";_.each(a,function(a,d){c.indexOf(d)>-1&&b.set(d,a)})},getPagerParams:function(){return{pageNo:this.get("pageNo"),pageSize:this.get("pageSize"),cityID:this.get("cityID"),areaID:this.get("areaID"),keywordLst:this.get("keywordLst")}},updateDataStore:function(a,b){var d=this,e=d.get("ds_shop"),f=d.get("ds_page"),g=_.map(a,function(a){var b=$XP(a,"shopID"),d=new c(a);return e.register(b,d),b});f.register(b,g)},resetDataStore:function(){var a=this,b=a.get("ds_shop"),c=a.get("ds_page");b.clear(),c.clear()},load:function(b,c){var d=this;d.updatePagerParams(b),d.callServer(d.getPagerParams(),function(b){"000"==b.resultcode?(d.updateDataStore($XP(b,"data.records",[]),$XP(b,"data.page.pageNo")),d.updatePagerParams($XP(b,"data.page",{}))):a({msg:$XP(b,"resultmsg",""),type:"danger"}),c(d)})},getShops:function(a){var b=this,c=b.get("ds_shop"),d=b.get("ds_page"),e=_.map(c.getByKeys(d.get(a)),function(a){return a.getAll()});return IX.Debug.info("DEBUG: Shop Card List Model PageData : "),IX.Debug.info(e),e},getShopModelByShopID:function(a){var b=this,c=b.get("ds_shop");return c.get(a)},updateShopStatus:function(a,b,c,d){var e=this,f=e.get("ds_shop"),g=f.get(a);g.emit("switchShopStatus",{status:b,failFn:c,successFn:d})},updateShopBusinessStatus:function(a,b,c){var d=this,e=d.get("ds_shop"),f=$XP(a,"shopID"),g=e.get(f);g.emit("switchBusinessStatus",{name:$XP(a,"name"),id:$XP(a,"id"),status:$XP(a,"status",0),failFn:b,successFn:c})}}),Hualala.Shop.CardListModel=b;var c=Stapes.subclass({constructor:function(a){this.switchShopStatusCallServer=Hualala.Global.switchShopStatus,this.switchShopBusinessStatusCallServer=Hualala.Global.switchShopServiceFeatureStatus,this.set(a),this.bindEvent()}});c.proto({switchShopStatus:function(b,c,d){var e=this,f=e.get("shopID");e.set("status",b),IX.Debug.info("DEBUG: Base Shop Model ["+e.get("shopID")+"] Status :"+b),this.switchShopStatusCallServer({shopID:f,status:b},function(g){"000"!==g.resultcode?(a({msg:$XP(g,"resultmsg",""),type:"danger"}),e.set("status",b?0:1),c(f)):(a({msg:b?"开启成功！":"关闭成功！",type:"success"}),d(f))})},switchShopBusinessStatus:function(b){var c=this,d=c.get("shopID"),e=$XF(b,"failFn"),f=$XF(b,"successFn"),g=$XP(b,"name"),h=$XP(b,"id"),i=$XP(b,"status"),j=function(a,b){var d=c.get("serviceFeatures").split(",");1==b?d.push(a):d=_.filter(d,function(b){return b!==a}),c.set("serviceFeatures",d.join(","))};j(g,i),IX.Debug.info("DEBUG: Switch Shop ["+c.get("shopID")+"] ServiceFeature: "+c.get("serviceFeatures")),this.switchShopBusinessStatusCallServer({shopID:d,serviceFeatures:g,operation:i},function(b){"000"!==b.resultcode?(a({msg:$XP(b,"resultmsg",""),type:"danger"}),j(g,i?0:1),e({shopID:d,id:h})):(a({msg:i?"开启成功！":"关闭成功！",type:"success"}),f({mShop:c,id:h,name:g}))})},bindEvent:function(){var b=this;this.on({switchShopStatus:function(a){var b=$XP(a,"status"),c=$XF(a,"failFn"),d=$XF(a,"successFn");this.switchShopStatus(b,c,d)},switchBusinessStatus:function(a){this.switchShopBusinessStatus(a)},setServiceParams:function(c){var d=$XF(c,"callServer"),e=$XP(c,"params",{}),f=$XP(c,"serviceID"),g=b.get("shopID"),h=$XF(c,"failFn"),i=$XF(c,"successFn");d(IX.inherit(e,{shopID:g,strType:f}),function(c){if("000"!==c.resultcode)a({msg:$XP(c,"resultmsg",""),type:"danger"}),h();else{var d={};d[f]=e;var g=b.get("revParamJson")||null,j=b.get("takeawayParamJson")||null,k=b.get("serviceFeatures");if(g=g?JSON.parse(g):{},j=j?JSON.parse(j):{},20==f||21==f?(j=IX.inherit(j,d),b.set("takeawayParamJson",JSON.stringify(j))):(g=IX.inherit(g,d),b.set("revParamJson",JSON.stringify(g))),41==f){var l=$XP(e,"checkSpotOrder",0);k=0==l?k.replace("spot_pay,",""):k.concat("spot_pay,"),b.set("serviceFeatures",k)}i(),a({msg:"配置成功!",type:"success"})}})}})}})}(jQuery,window),function(a){IX.ns("Hualala.Shop");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Stapes.subclass({constructor:function(){this.$container=null,this.$resultBox=null,this.$list=null,this.$pager=null,this.emptyBar=null,this.loadTemplates()}}));b.proto({init:function(a){if(this.$container=$XP(a,"container",null),this.model=$XP(a,"model",null),!this.$container||!this.model)throw"CardList View Init Failed!";this.initLayout()},initLayout:function(){var a=this.get("layoutTpl"),b=a();this.$container.append(b),this.$resultBox=this.$container.find(".shop-list"),this.$list=this.$container.find(".shop-list-body"),this.$pager=this.$container.find(".page-selection"),this.initPager(),this.bindEvent()},initPager:function(a){var b={total:0,page:1,maxVisible:10,leaps:!0};this.$pager.IXPager(IX.inherit(b,a))},bindEvent:function(){var b=this;b.$list.tooltip({selector:"[title]"}),b.$list.on("click",".btn[data-href]",function(){var b=a(this),c=b.attr("data-href");IX.isEmpty(c)||(document.location.href=c)}),b.$pager.on("page",function(a,c){var d=b.model.getPagerParams();d.pageNo=c,b.model.emit("load",IX.inherit(d,{pageNo:$XP(d,"pageNo",1),pageSize:$XP(d,"pageSize",15)}))})},loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_shop_list_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_list")),c=Handlebars.compile(Hualala.TplLib.get("tpl_shop_card")),d=Handlebars.compile(Hualala.TplLib.get("tpl_shop_tags"));Handlebars.registerPartial("shopTag",Hualala.TplLib.get("tpl_shop_tags")),Handlebars.registerPartial("shopCard",Hualala.TplLib.get("tpl_shop_card")),this.set({layoutTpl:a,listTpl:b,itemTpl:c,tagTpl:d})},mapTags:function(a){var b="areaName,cuisineName1,cuisineName2".split(","),c=_.map(b,function(b){return $XP(a,b,null)});return _.filter(c,function(a){return!IX.isEmpty(a)})},mapRenderData:function(a){var b=this,c=function(a){return _.map(a,function(a){return{clz:"label-info",tag:a}})},d=_.map(a,function(a){var d=$XP(a,"address",""),e=Hualala.Common.strByteLength(d),f="";return f=72>e?d:Hualala.Common.substrByte(d,70)+"...",{clz:"",id:$XP(a,"shopID",""),name:$XP(a,"shopName",""),img:Hualala.Common.getSourceImage($XP(a,"imagePath",""),{width:100,height:100,quality:50}),tags:c(b.mapTags(a)),address:d,slugAddr:f,tel:$XP(a,"tel",""),infoHref:Hualala.PageRoute.createPath("shopInfo",[$XP(a,"shopID","")]),menuHref:Hualala.PageRoute.createPath("shopMenu",[$XP(a,"shopID","")]),checked:1==$XP(a,"status")?"checked":""}});return{shopCard:{list:d}}},initSwitcher:function(b){var c=this;c.$list.find(b).bootstrapSwitch({size:"normal",onColor:"success",offColor:"default",onText:"已开通",offText:"未开通"}),c.$list.find(b).on("switchChange.bootstrapSwitch",function(d,e){var f=a(this),g=f.attr("data-shop"),e=e?1:0;Hualala.UI.Confirm({title:(1==e?"开启":"关闭")+"店铺",msg:"你确定要"+(1==e?"开启":"关闭")+"店铺？",okFn:function(){c.model.updateShopStatus(g,e,function(a){c.$list.find(b).filter("[data-shop="+a+"]").bootstrapSwitch("toggleState",!0)},function(){})},cancelFn:function(){c.$list.find(b).filter("[data-shop="+g+"]").bootstrapSwitch("toggleState",!0)}})})},render:function(){var a=this,b=a.model,c=b.getPagerParams(),d=$XP(c,"pageNo"),e=b.getShops(d),f=a.mapRenderData(e),g=a.get("listTpl"),h=g(f);a.emptyBar&&a.emptyBar.destroy(),a.$list.empty(),0==e.length?(a.emptyBar=new Hualala.UI.EmptyPlaceholder({container:a.$list}),a.emptyBar.show()):a.$list.html(h),a.initPager({total:b.get("pageCount"),page:b.get("pageNo"),href:"javascript:void(0);"}),a.initSwitcher(":checkbox[name=switcher]")}}),Hualala.Shop.CardListView=b;var c=b.subclass({constructor:function(){this.$container=null,this.$resultBox=null,this.$list=null,this.$pager=null,this.emptyBar=null,this.shopBusinessSwitcherTipHT=new IX.IListManager,this.loadTemplates(),this.initShopBusinessSwitcherTips()}});c.proto({bindEvent:function(){var b=this;b.$list.tooltip({selector:"[title]"}),b.$pager.on("page",function(a,c){var d=b.model.getPagerParams();d.pageNo=c,b.model.emit("load",IX.inherit(d,{pageNo:$XP(d,"pageNo",1),pageSize:$XP(d,"pageSize",15)}))}),b.$list.on("click",".btn[data-business]",function(){var c=a(this),d=c.attr("data-shop"),e=b.model.getShopModelByShopID(d),f=c.attr("data-business"),g=c.attr("data-business-id"),h=e.get("serviceFeatures");b.initBusinessModal(c,d,f,g,h)}),b.$list.on("click",".bind-settle",function(){var c=a(this),d=c.attr("data-id"),e=c.attr("data-shop");b.initBindSettleModal(c,d,e)})},initShopBusinessSwitcherTips:function(){var a=this,b=Hualala.TypeDef.ShopBusinessSwitcherTips;_.each(b,function(b){var c=$XP(b,"name");a.shopBusinessSwitcherTipHT.register(c,b)})},getBusinessSwitcherTipsByName:function(a){var b=this,c=b.shopBusinessSwitcherTipHT;return c.get(a)},loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_shop_list_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_list")),c=Handlebars.compile(Hualala.TplLib.get("tpl_shop_list_item")),d=Handlebars.compile(Hualala.TplLib.get("tpl_shop_tags"));Handlebars.registerPartial("shopTag",Hualala.TplLib.get("tpl_shop_tags")),Handlebars.registerPartial("shopItem",Hualala.TplLib.get("tpl_shop_list_item")),this.set({layoutTpl:a,listTpl:b,itemTpl:c,tagTpl:d})},getBusinessDesc:function(a,b,c,d,e){var f=this,g=null,h=null,i=null,j="",k=Hualala.TypeDef.MinuteIntervalOptions(),l=function(a){var b=_.find(k,function(b){return $XP(b,"value")==a});return $XP(b,"label","")},m=f.getBusinessSwitcherStatus(e,d),n=$XP(f.getBusinessSwitcherTipsByName(d),"desc","");switch(a){case 10:g=Handlebars.compile(Hualala.TplLib.get("tpl_shop_commonreserve_desc")),h="advanceTime,noticeTime,minAmount,reserveTableTime,reserveTableDesc,payMethod".split(","),i=_.map(h,function(a){var b=$XP(c,a,"");switch(a){case"advanceTime":b=IX.isEmpty(b)||0==b?"不限制顾客提前预定时间, ":"顾客需提前"+l(b)+"预订, ";break;case"noticeTime":b=IX.isEmpty(b)||0==b?"订单立即通知餐厅, ":"订单提前"+l(b)+"通知餐厅, ";break;case"minAmount":b=IX.isEmpty(b)||0==b?"":"最低消费"+b+Hualala.Constants.CashUnit+", ";break;case"reserveTableTime":b=IX.isEmpty(b)||0==b?"":"留位"+l(b)+", ";break;case"reserveTableDesc":b=IX.isEmpty(b)?"":b+",";break;case"payMethod":b=(0==b?"仅支持在线支付":1==b?"仅支持线下支付":"线上及线下支付均支持")+", "}return b});break;case 11:g=Handlebars.compile(Hualala.TplLib.get("tpl_shop_justeat_desc")),h="servicePeriods,holidayFlag,minAmount,advanceTime,noticeTime,reserveTableTime,reserveTableDesc,payMethod".split(","),i=_.map(h,function(a){var b=$XP(c,a,"");switch(a){case"servicePeriods":b="开放时间段："+b.replace(",","-").replace(/([\d]{2})([\d]{2})/g,"$1:$2")+", ";break;case"holidayFlag":b=(0==b?"工作日及节假日均开放":1==b?"仅节假日开放":"仅工作日开放")+", ";break;case"minAmount":b=IX.isEmpty(b)||0==b?"":"最低消费"+b+Hualala.Constants.CashUnit+", ";break;case"advanceTime":b=IX.isEmpty(b)||0==b?"不限制顾客提前预定时间, ":"顾客需提前"+l(b)+"预订, ";break;case"noticeTime":b=IX.isEmpty(b)||0==b?"订单立即通知餐厅, ":"订单提前"+l(b)+"通知餐厅, ";break;case"reserveTableTime":b=IX.isEmpty(b)||0==b?"":"留位"+l(b)+", ";break;case"reserveTableDesc":b=IX.isEmpty(b)?"":b+",";break;case"payMethod":b=(0==b?"仅支持在线支付":1==b?"仅支持线下支付":"线上及线下支付均支持")+", "}return b});break;case 41:g=Handlebars.compile(Hualala.TplLib.get("tpl_shop_spotorder_desc")),h=0==b?"isDinner,supportCommitToSoftware,checkSpotOrder,payBeforeCommit".split(","):"isDinner,supportCommitToSoftware,fetchFoodMode".split(","),i=_.map(h,function(a){var d=$XP(c,a,"");switch(a){case"isDinner":d=0==b?!0:!1;break;case"supportCommitToSoftware":d=IX.isEmpty(d)?"支持下单到餐饮软件, ":(1==d?"支持":"不支持")+"下单到餐饮软件, ";break;case"fetchFoodMode":d="下单后"+(1==d?"凭牌号":2==d?"直接":"凭流水号")+"在收银台取餐, ";break;case"checkSpotOrder":d=(1==d?"支持":"不支持")+"顾客通过手机结账, ";break;case"payMethodAtShop":d=(1==d?"餐前先通过手机结账":2==d?"餐后可通过手机结账":"不能用手机结账")+", ";break;case"payBeforeCommit":d=(1==d?"餐前":"餐后")+"结账, "}return d});break;case 20:g=Handlebars.compile(Hualala.TplLib.get("tpl_shop_takeaway_desc")),h="servicePeriods,holidayFlag,noticeTime,takeawayDeliveryTime,minAmount,serviceAmount,freeServiceAmount,takeawayScope,payMethod".split(","),i=_.map(h,function(a){var b=$XP(c,a,"");switch(a){case"servicePeriods":b="开放时间段："+b.replace(",","-").replace(/([\d]{2})([\d]{2})/g,"$1:$2")+", ";break;case"holidayFlag":b=(0==b?"工作日及节假日均开放":1==b?"仅节假日开放":"仅工作日开放")+", ";break;case"noticeTime":b=IX.isEmpty(b)||0==b?"订单立即通知餐厅, ":"订单提前"+l(b)+"通知餐厅, ";break;case"takeawayDeliveryTime":b=IX.isEmpty(b)||0==b?"立即送达, ":"预计"+b+"分钟送达, ";break;case"minAmount":b=(IX.isEmpty(b)||0==b?0:b)+"元起送, ";break;case"serviceAmount":b=IX.isEmpty(b)||0==b?"免费送餐, ":b+"元送餐费";break;case"freeServiceAmount":b=IX.isEmpty(b)||0==b?"":"(满"+b+"元免送餐费), ";break;case"takeawayScope":b=IX.isEmpty(b)||0==b?"":"送餐范围"+b+"公里, ";break;case"payMethod":b=(0==b?"仅支持在线支付":1==b?"仅支持线下支付":"线上及线下支付均支持")+", "}return b});break;case 21:g=Handlebars.compile(Hualala.TplLib.get("tpl_shop_takeout_desc")),h="servicePeriods,holidayFlag,advanceTime,noticeTime,minAmount,payMethod".split(","),i=_.map(h,function(a){var b=$XP(c,a,"");switch(a){case"servicePeriods":b="开放时间段："+b.replace(",","-").replace(/([\d]{2})([\d]{2})/g,"$1:$2")+", ";break;case"holidayFlag":b=(0==b?"工作日及节假日均开放":1==b?"仅节假日开放":"仅工作日开放")+", ";break;case"advanceTime":b=IX.isEmpty(b)||0==b?"不限制顾客提前预定时间, ":"顾客需提前"+l(b)+"预订, ";break;case"noticeTime":b=IX.isEmpty(b)||0==b?"订单立即通知餐厅, ":"订单提前"+l(b)+"通知餐厅, ";break;case"minAmount":b=IX.isEmpty(b)||0==b?"":"最低消费"+b+Hualala.Constants.CashUnit+", ";break;case"payMethod":b=(0==b?"仅支持在线支付":1==b?"仅支持线下支付":"线上及线下支付均支持")+", "}return b})}return 11==a||41==a||10==a||20==a||21==a?(j=g(_.object(h,i)),j=j.slice(0,j.lastIndexOf(",")),j=1==m?j:n):j=n,j},getBusinessSwitcherStatus:function(a,b){var c=this,d=c.model.getShopModelByShopID(a),e=d.get("serviceFeatures")||"";return e.indexOf(b)>=0?1:0},getShopBusiness:function(a){var b=this,c=Hualala.TypeDef.ShopBusiness,d=new IX.IListManager,e=$XP(a,"shopID"),f=$XP(a,"serviceFeatures",""),g=null,h=$XP(a,"revParamJson",null),i=$XP(a,"takeawayParamJson",null);h=h?JSON.parse(h):{},i=i?JSON.parse(i):{},g=IX.inherit(h,i);var j=null;return _.each(c,function(c){var h=$XP(c,"id"),i=$XP(c,"name"),j=b.getBusinessSwitcherStatus(e,i),k=$XP(g,h.toString(),{}),l=$XP(a,"operationMode",null);"41"==h&&(k=IX.inherit(k,{checkSpotOrder:f.indexOf("spot_pay")>=0?1:0}));var m=IX.inherit(c,k,{switcherStatus:j,shopID:e,desc:b.getBusinessDesc(h,l,k,i,e)});d.register(i,m)}),j=_.filter(d.getAll(),function(a){return 1==$XP(a,"businessIsSupported",!1)})},mapBusinessRenderData:function(a){var b=this,c=b.getShopBusiness(a);return _.map(c,function(b){var c=$XP(b,"name"),d="icon-"+c,e="switcher_business",f=1==$XP(b,"switcherStatus")?"checked":"";return{icon:d,label:$XP(b,"label"),switcherName:e,shopID:$XP(b,"shopID"),type:c,id:$XP(b,"id"),open:f,desc:$XP(b,"desc",""),serviceFeatures:$XP(a,"serviceFeatures",""),hideBtn:"bi"==c||"crm"==c?"disabled hidden":""}})},chkHasAccountRole:function(){var a=Hualala.getSessionUser(),b=$XP(a,"role");roles=Hualala.TypeDef.SiteRoleType;var c=_.find(roles,function(a){var c=$XP(a,"roleType"),d=_.find(b,function(b){return $XP(a,"roleType")==b});return!!d&&"manager"!=c});return!!c},mapRenderData:function(a){var b=this,c=_.map(a,function(a){var c=$XP(a,"settleID","");return{clz:"",shopID:$XP(a,"shopID",""),shopName:$XP(a,"shopName",""),hideAccount:b.chkHasAccountRole()?!0:!1,settleID:c,settleName:$XP(a,"settleName",""),btn:{clz:"bind-settle",label:IX.isEmpty(c)||0==c?"绑定结算账户":"修改"},switcherName:"switcher_status",shopOpen:1==$XP(a,"status")?"checked":"",business:b.mapBusinessRenderData(a)}});return{shopItem:{list:c}}},initSwitcher:function(b){var c=this,d=c.$list.find(":checkbox[name="+b+"]"),e=function(){d.each(function(b,c){var d=a(c),e=d.attr("data-shop"),f=a(":checkbox[name=switcher_status][data-shop="+e+"]"),g=f[0].checked;d.bootstrapSwitch("disabled",g?!1:!0)})};d.bootstrapSwitch({size:"normal",onColor:"switcher_business"==b?"primary":"success",offColor:"default",onText:"已开通",offText:"未开通"}),"switcher_business"==b&&e(),d.on("switchChange.bootstrapSwitch",function(d,e){var f=a(this),g=f.attr("name"),h=f.attr("data-shop"),e=e?1:0,i=f.attr("data-business"),j=f.attr("data-business-id");
if("switcher_status"==g)Hualala.UI.Confirm({title:(1==e?"开启":"关闭")+"店铺",msg:"你确定要"+(1==e?"开启":"关闭")+"店铺？",okFn:function(){c.model.updateShopStatus(h,e,function(a){var d=c.$list.find(":checkbox[name="+b+"]").filter("[data-shop="+a+"]"),f=c.$list.find(":checkbox[name=switcher_business]").filter("[data-shop="+a+"]");d.bootstrapSwitch("toggleState",!0),f.bootstrapSwitch("disabled",0==e?!1:!0)},function(a){var d=(c.$list.find(":checkbox[name="+b+"]").filter("[data-shop="+a+"]"),c.$list.find(":checkbox[name=switcher_business]").filter("[data-shop="+a+"]"));d.bootstrapSwitch("disabled",0==e?!0:!1)})},cancelFn:function(){f.bootstrapSwitch("toggleState",!0)}});else{var k=c.getBusinessSwitcherTipsByName(i),l=(1==e?"开启":"关闭")+$XP(k,"title",""),m=$XP(k,1==e?"switchOn":"switchOff","");Hualala.UI.Confirm({title:l,msg:m,okFn:function(){c.model.updateShopBusinessStatus({shopID:h,name:i,id:j,status:e},function(a){c.$list.find(":checkbox[name="+b+"]").filter("[data-shop="+$XP(a,"shopID")+"][data-business-id="+$XP(a,"id")+"]").bootstrapSwitch("toggleState",!0)},function(a){var b=$XP(a,"mShop"),d=($XP(a,"id"),$XP(a,"name")),e=b.getAll(),g=c.getShopBusiness(e),h=_.find(g,function(a){return a.name==d}),i=$XP(h,"desc","");f.parents(".shop-business").find(".desc").html(i)})},cancelFn:function(){f.bootstrapSwitch("toggleState",!0)}})}})},render:function(){var a=this,b=a.model,c=b.getPagerParams(),d=$XP(c,"pageNo"),e=b.getShops(d),f=a.mapRenderData(e),g=a.get("listTpl"),h=g(f);a.emptyBar&&a.emptyBar.destroy(),a.$list.empty(),0==e.length?(a.emptyBar=new Hualala.UI.EmptyPlaceholder({container:a.$list}),a.emptyBar.show()):a.$list.html(h),a.initPager({total:b.get("pageCount"),page:b.get("pageNo"),href:"javascript:void(0);"}),a.initSwitcher("switcher_business"),a.initSwitcher("switcher_status")},initBusinessModal:function(a,b,c,d,e){{var f=this;new Hualala.Setting.editServiceView({triggerEl:a,serviceID:d,serviceName:c,serviceFeatures:e,model:f.model.getShopModelByShopID(b),successFn:function(a,b,c,d){var e=a.get("operationMode"),g=d.attr("data-business"),h=d.attr("data-shop"),i=f.getBusinessDesc(parseInt(b),e,c,g,h);d.parents(".shop-business").find(".desc").html(i)}})}},initBindSettleModal:function(a,b,c){{var d=this;new Hualala.Setting.bindSettleUnitView({triggerEl:a,settleID:b,model:d.model.getShopModelByShopID(c),successFn:function(a,b,c){var d=$XP(c,"settleUnitID"),e=$XP(c,"settleUnitName","");b.attr("data-id",d),b.parent().find(".account-name").html(e),a.set({settleID:d,settleName:e})}})}}}),Hualala.Shop.ShopListView=c}(jQuery,window),function(){IX.ns("Hualala.Shop");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.UI.LoadingModal),b=(Hualala.Shop.ShopListModel,Hualala.Shop.ShopListView,Stapes.subclass({constructor:function(a){if(this.set({sessionData:Hualala.getSessionData()}),this.container=$XP(a,"container",null),this.view=$XP(a,"view",null),this.model=$XP(a,"model",null),!this.view||!this.model||!this.container)throw"Shop List init faild!!";this.isReady=!1,this.bindEvent()}}));b.proto({init:function(b){this.model.init(b),this.view.init({model:this.model,container:this.container}),this.loadingModal=new a({start:100}),this.isReady=!0},hasReady:function(){return this.isReady},bindEvent:function(){this.on({load:function(a){var b=this;b.hasReady()||b.init(a),b.model.emit("load",a)}},this),this.model.on({load:function(a){var b=this,c=function(){b.view.emit("render"),b.loadingModal.hide()};b.loadingModal.show(),b.model.load(a,c)}},this),this.view.on({render:function(){var a=this;a.view.render()},reloadPager:function(a){var b=this;b.view.initPager(a)}},this)}}),Hualala.Shop.ShopListController=b}(jQuery,window),function(a){function b(b){this.cfg=a.extend({},c,b),this.sContent="",this.$searchBox=a(this.cfg.searchBox),this.$mapResult=a(this.cfg.mapResult),this.map="",this.mapPoint={},this.isAreaSearched=!1}var c={data:{isSearchMap:!1,keyword:"",shopName:"",tel:"",address:"",city:"",area:"",lng:"",lat:""},searchBox:".search-box",mapResult:".map-result",mapCanvasId:"mapCanvas",load:function(){},serach:function(){}};b.prototype={init:function(){var b=this,c=b.cfg.data;if(b.map=new BMap.Map(b.cfg.mapCanvasId),b.map.addControl(new BMap.NavigationControl),b.map.enableScrollWheelZoom(),b.sContent=['<dl class="map-shop-info">',"<dt>"+c.shopName+"</dt>","<dd>","<p><span>电话：</span>"+c.tel+"</p>","<p><span>地址：</span>"+c.address+"</p>","</dd>","</dl>"].join(""),b[(!c.isSearchMap&&c.lng&&c.lat?"load":"search")+"Map"](c),b.$searchBox[0]){var d=b.$searchBox.find(".map-keyword"),e=b.$searchBox.find(".map-search-btn"),f=a.extend({},b.cfg.data);e.on("click",function(){f.keyword=a.trim(d.val()),b.searchMap(f)})}return this},loadMap:function(a){var b=this;a=a||b.cfg.data,b.map.centerAndZoom(new BMap.Point(a.lng,a.lat),14),b.map.enableScrollWheelZoom();var c=new BMap.Marker(new BMap.Point(a.lng,a.lat),{enableMassClear:!0,raiseOnDrag:!0});c.enableDragging(),b.map.addOverlay(c),c.openInfoWindow(new BMap.InfoWindow(b.sContent)),c.addEventListener("click",function(){c.openInfoWindow(new BMap.InfoWindow(b.sContent))}),c.addEventListener("dragend",function(a){b.setResult(a.point.lng,a.point.lat)}),b.setResult(a.lng,a.lat)},searchMap:function(a){var b=this;a=a||b.cfg.data;var c=new BMap.LocalSearch(b.map,{renderOptions:{map:b.map},pageCapacity:1,onInfoHtmlSet:function(a){a.marker.openInfoWindow(new BMap.InfoWindow(b.sContent))},onMarkersSet:function(){}});c.search(a.keyword||a.address||a.area||a.city),c.setSearchCompleteCallback(function(){c.getStatus()!==BMAP_STATUS_SUCCESS&&(Hualala.UI.Alert({msg:"抱歉，百度地图未搜到您要查询的精确位置，现为您显示该位置所在的城市或区域，您可以通过移动地图上的标记来精确定位要查询的位置。"}),b.isAreaSearched?c.search(a.city):(b.isAreaSearched=!0,c.search(a.area)))}),c.setMarkersSetCallback(function(a){for(var c=a.length;c--;){var d=a[c].marker;d.enableDragging(),b.setResult(d.point.lng,d.point.lat),d.openInfoWindow(new BMap.InfoWindow(b.sContent)),d.addEventListener("click",function(){var a=this.getPosition();b.setResult(a.lng,a.lat)}),d.addEventListener("dragend",function(a){b.setResult(a.point.lng,a.point.lat)})}})},setResult:function(a,b){var c=this;c.mapPoint={lng:a,lat:b},c.$mapResult[0]&&c.$mapResult.html("您店铺的经度："+a+"    纬度： "+b)}},IX.ns("Hualala.Shop"),Hualala.Shop.map=function(a){return new b(a).init()}}(jQuery),function(a){function b(b,c,d){f.getCuisines({cityID:d},function(d){return"000"!=d.resultcode?void(d.resultmsg&&h({msg:d.resultmsg,type:"danger"})):(b.siblings(".chosen-container").remove(),g.createChosen(b.show().data("chosen",null),d.data.records||[],"cuisineID","cuisineName",{width:"100%"},{cuisineID:"",cuisineName:"--请选择--"}).blur().change(function(){a(this).blur()}),c.siblings(".chosen-container").remove(),void g.createChosen(c.show().data("chosen",null),d.data.records||[],"cuisineID","cuisineName",{width:"100%"},{cuisineID:"",cuisineName:"--不限--"}).blur().change(function(){a(this).blur()}))})}function c(b,c){f.getAreas({cityID:c},function(c){return"000"!=c.resultcode?void(c.resultmsg&&h({msg:c.resultmsg,type:"danger"})):(b.siblings(".chosen-container").remove(),void g.createChosen(b.show().data("chosen",null),c.data.records||[],"areaID","areaName",{width:"100%"},{areaID:"",areaName:"--请选择--"}).blur().change(function(){a(this).blur()}))})}function d(b){f.getCities({isActive:1},function(c){return"000"!=c.resultcode?void(c.resultmsg&&h({msg:c.resultmsg,type:"danger"})):void g.createChosen(b,c.data.records||[],"cityID","cityName",{width:"100%"},{cityID:"",cityName:"--请选择--"}).change(function(){a(this).blur()})})}function e(a){return a.find("option:selected").text().replace(/-/g,"")}IX.ns("Hualala.Shop");var f=Hualala.Global,g=Hualala.UI,h=g.TopTip;Hualala.Shop.initCreate=function(i){i.bootstrapWizard();var j=i.data("bootstrapWizard"),k=i.find("#tab1"),l=i.find("#tab2"),m=i.find("#tab3"),n=k.find("#cityID"),o=k.find("#areaID"),p=k.find("#cuisineID1"),q=k.find("#cuisineID2"),r=null,s=Hualala.Shop.Typedef.operationMode;g.fillSelect(k.find("#operationMode"),s),d(n),g.createChosen(o,[],1,1,{width:"100%",placeholder_text:"请先选择或输入所在城市"},!1),g.createChosen(p,[],1,1,{width:"100%",placeholder_text:"请先选择或输入所在城市"},!1),g.createChosen(q,[],1,1,{width:"100%",placeholder_text:"请先选择或输入所在城市"},!1),n.on("change",function(){var d=a(this).val();d&&(c(o,d),b(p,q,d))}),k.find("#openingHoursStart, #openingHoursEnd").timepicker({minuteStep:1,showMeridian:!1,disableFocus:!0,showInputs:!1}),k.bootstrapValidator({excluded:":disabled",fields:{shopName:{message:"店铺名无效",validators:{notEmpty:{message:"店铺名不能为空"},stringLength:{min:2,max:100,message:"店铺名长度必须在2到100个字符之间"}}},cityID:{validators:{notEmpty:{message:"请选择店铺所在城市"}}},tel:{validators:{notEmpty:{message:"店铺电话不能为空"},telOrMobile:{message:""}}},address:{validators:{notEmpty:{message:"店铺地址不能为空"},stringLength:{min:1,max:80,message:"店铺地址不能超过80个字符"}}},PCCL:{validators:{notEmpty:{message:"人均消费不能为空"},numeric:{message:"人均消费必须是金额数字"}}},operationMode:{validators:{notEmpty:{message:"请选择店铺运营模式"}}},openingHoursStart:{validators:{notEmpty:{message:"每天营业开始时间不能空"},time:{message:""}}},openingHoursEnd:{validators:{notEmpty:{message:"每天营业结束时间不能空"},time:{message:"",startTimeField:"openingHoursStart"}}},areaID:{validators:{notEmpty:{message:"请选择店铺所在地标"}}},cuisineID1:{validators:{notEmpty:{message:"请选择菜系1"}}}}}),r=k.data("bootstrapValidator");var t=k.find("#uploadImg"),u="";t.find("img").attr("src",f.IMAGE_ROOT+"/shop_head_img_default.png"),t.find("button, img").on("click",function(){g.uploadImg({onSuccess:function(a,b){var c=f.IMAGE_RESOURCE_DOMAIN+"/"+a+"?quality=70";u=a,t.find("img").attr("src",c),b.modal("hide")}})});var v=null,w=null,x="",y=l.find(".map-search-box"),z=m.find("#shopSettingLink");i.find("#nextStep").on("click",function(){var a=j.activePane();if(a.is("#tab1")){if(!r.validate().isValid())return;v=Hualala.Common.parseForm(k),v.shopID=x,v.shopName=v.shopName.replace("（","(").replace("）",")"),v.areaName=e(o),v.cuisineName1=e(p),v.cuisineName2=v.cuisineID2?e(q):"",v.imagePath=u,v.openingHours=v.openingHoursStart+"-"+v.openingHoursEnd;var b=[v.shopName,v.address,v.cuisineName1];v.cuisineName2&&b.push(v.cuisineName2),b.push(v.areaName),v.keywordLst=b.join(" | ");var c=x?f.updateShopBaseInfo:f.createShop;return void c(v,function(a){return"000"!=a.resultcode?void(a.resultmsg&&h({msg:a.resultmsg,type:"danger"})):(x=x||a.data.records[0].shopID,m.find("h4 span").eq(1).text(v.shopName),z.attr("href",Hualala.PageRoute.createPath("setting")),j.next(),void(w=Hualala.Shop.map({data:{isSearchMap:!0,shopName:v.shopName,tel:v.tel,address:v.address,area:v.areaName,city:e(n)},searchBox:y})))})}if(a.is("#tab2")){var d=w.mapPoint.lng,g=w.mapPoint.lat,i={shopID:x,mapLongitudeValue:d,mapLatitudeValue:g,mapLongitudeValueBaiDu:d,mapLatitudeValueBaiDu:g},c=f.setShopMap;c(i,function(a){return"000"!=a.resultcode?void(a.resultmsg&&h({msg:a.resultmsg,type:"danger"})):void 0})}j.next()})}}(jQuery,window),function(a){function b(b,c){b.find("input, select").not(".map-keyword, #openingHoursEnd").each(function(){var b=a(this),d=b.siblings("p");d.text(b.is("#openingHoursStart")?c.openingHours:b.is("select")?f(b):b.val())})}function c(b,c,d,e,f){var i=g.getCuisines;i({cityID:d},function(d){return"000"!=d.resultcode?void(d.resultmsg&&j({msg:d.resultmsg,type:"danger"})):(b.siblings(".chosen-container").remove(),h.createChosen(b.show().data("chosen",null),d.data.records||[],"cuisineID","cuisineName",{width:"100%",placeholder_text:"请选择或输入菜系1"},!1,e||"").blur().change(function(){a(this).blur()}),c.siblings(".chosen-container").remove(),void h.createChosen(c.show().data("chosen",null),d.data.records||[],"cuisineID","cuisineName",{width:"100%",placeholder_text:"请选择或输入菜系2"},{cuisineID:"",cuisineName:"--不限--"},f||"").blur().change(function(){a(this).blur()}))})}function d(b,c,d){g.getAreas({cityID:c},function(c){return"000"!=c.resultcode?void(c.resultmsg&&j({msg:c.resultmsg,type:"danger"})):(b.siblings(".chosen-container").remove(),void h.createChosen(b.show().data("chosen",null),c.data.records||[],"areaID","areaName",{width:"100%",placeholder_text:"请选择或输入地标"},!1,d||"").blur().change(function(){a(this).blur()}))})}function e(b,c){g.getCities({isActive:1},function(d){return"000"!=d.resultcode?void(d.resultmsg&&j({msg:d.resultmsg,type:"danger"})):void h.createChosen(b,d.data.records||[],"cityID","cityName",{width:"100%",placeholder_text:"请选择或输入所在城市"},!1,c.cityID).trigger("change",[c.areaID,c.cuisineID1,c.cuisineID2]).change(function(){a(this).blur()})})}function f(a){return a.find("option:selected").text().replace(/-/g,"")}IX.ns("Hualala.Shop");var g=Hualala.Global,h=Hualala.UI,i=Hualala.Shop,j=h.TopTip,k=Hualala.Common.parseForm;i.initInfo=function(l,m,n){if(n){var o=i.createShopFuncNav(m,n,l),p=n,q=null,r=Hualala.Shop.Typedef.operationMode,s=null,t=null,u=null,v=null,w=null,x="",y=null,z=g.IMAGE_RESOURCE_DOMAIN+"/",A=null,B=null;g.getShopInfo({shopID:p},function(b){if("000"!=b.resultcode)return void(b.resultmsg&&j({msg:b.resultmsg,type:"danger"}));q=b.data.records[0],i.createShopInfoHead(q,l,function(a){o.before(a)});var f=q.openingHours.split("-");q.openingHoursStart=f[0],q.openingHoursEnd=f[1],q.operationModeName=r[q.operationMode];var k=Handlebars.compile(Hualala.TplLib.get("tpl_shop_info"));s=a(k(q)).appendTo(l),t=s.find("#cityID"),u=s.find("#areaID"),v=s.find("#cuisineID1"),w=s.find("#cuisineID2"),h.fillSelect(s.find("#operationMode"),r).val(q.operationMode),t.on("change",function(b,e,f,g){var h=a(this).val();h&&(d(u,h,e),c(v,w,h,f,g))}),e(t,q),s.find("#openingHoursStart, #openingHoursEnd").timepicker({minuteStep:1,showMeridian:!1,disableFocus:!0,showInputs:!1}),s.bootstrapValidator({excluded:":disabled",fields:{shopName:{message:"店铺名无效",validators:{notEmpty:{message:"店铺名不能为空"},stringLength:{min:2,max:100,message:"店铺名长度必须在2到100个字符之间"}}},cityID:{validators:{notEmpty:{message:"请选择店铺所在城市"}}},tel:{validators:{notEmpty:{message:"店铺电话不能为空"},telOrMobile:{message:""}}},address:{validators:{notEmpty:{message:"店铺地址不能为空"},stringLength:{min:1,max:80,message:"店铺地址不能超过80个字符"}}},PCCL:{validators:{notEmpty:{message:"人均消费不能为空"},numeric:{message:"人均消费必须是金额数字"}}},operationMode:{validators:{notEmpty:{message:"请选择店铺运营模式"}}},openingHoursStart:{validators:{notEmpty:{message:"每天营业开始时间不能空"},time:{message:""}}},openingHoursEnd:{validators:{notEmpty:{message:"每天营业结束时间不能空"},time:{message:"",startTimeField:"openingHoursStart"}}},areaID:{validators:{notEmpty:{message:"请选择店铺所在地标"}}},cuisineID1:{validators:{notEmpty:{message:"请选择菜系1"}}}}}).on("submit",function(){return!1}),A=s.data("bootstrapValidator");var m=s.find("#uploadImg");y=m.find("img").attr("src",g.IMAGE_ROOT+"/shop_head_img_default.png"),x=q.imagePath,x&&y.attr("src",z+x+"?quality=70"),B=i.map({data:{isSearchMap:!1,shopName:q.shopName,tel:q.tel,address:q.address,area:q.areaName,city:q.cityName,lng:q.mapLongitudeValueBaiDu,lat:q.mapLatitudeValueBaiDu}})}),l.on("click",function(c){var d=a(c.target);if(d.is(".edit-mode #uploadImg img, .edit-mode #uploadImg a")&&h.uploadImg({onSuccess:function(a,b){x=a,y.attr("src",z+a),b.modal("hide")}}),d.is("#remarkMap"))if(A.isValidField("shopName")&&A.isValidField("tel")&&A.isValidField("address")){var e=B.mapPoint,l=k(s);console.log(l),B=i.map({data:{isSearchMap:!1,shopName:l.shopName,tel:l.tel,address:l.address,area:f(u),city:f(t),lng:e.lng,lat:e.lat}});var m={shopID:p,mapLongitudeValue:e.lng,mapLatitudeValue:e.lat,mapLongitudeValueBaiDu:e.lng,mapLatitudeValueBaiDu:e.lat};g.setShopMap(m,function(a){return"000"!=a.resultcode?void(a.resultmsg&&j({msg:a.resultmsg,type:"danger"})):void j({msg:"重新标记地图成功！",type:"success"})})}else j({msg:"店铺相关信息填写有误！",type:"danger"});if(d.is("#editBtn")&&s.removeClass("read-mode").addClass("edit-mode"),d.is("#saveBtn")){if(!A.validate().isValid())return;var n=k(s);n.shopID=p,n.shopName=n.shopName.replace("（","(").replace("）",")"),n.areaName=f(u),n.cuisineName1=f(v),n.cuisineName2=n.cuisineID2?f(w):"",n.imagePath=x,n.openingHours=n.openingHoursStart+"-"+n.openingHoursEnd;var o=[n.shopName,n.address,n.cuisineName1];n.cuisineName2&&o.push(n.cuisineName2),o.push(n.areaName),n.keywordLst=o.join(" | "),g.updateShopBaseInfo(n,function(a){return"000"!=a.resultcode?void(a.resultmsg&&j({msg:a.resultmsg,type:"danger"})):(s.removeClass("edit-mode").addClass("read-mode"),j({msg:"保存成功！",type:"success"}),void b(s,n))})}})}}}(jQuery,window),function(a,b){function c(a,b){clearTimeout(a.tId),a.tId=setTimeout(function(){a.call(b)},100)}IX.ns("Hualala.Shop"),Hualala.Shop.initMenu=function(d,e,f){function g(){var a=new Pymatch([]),b=z,c=function(c){a.setNames(_.map(b,function(a){return IX.inherit(a,{name:a.foodName})}));var d=a.match(c),e={};return _.each(d,function(a){e[a[0].foodID]=!0}),e};M.chosen({width:"200px",placeholder_text:"选择或输入菜品名称",no_results_text:"抱歉，没有相关菜品！",allow_single_deselect:!0,getMatchedFn:c}).change(function(){k()})}function h(){var c=a(b).scrollTop()+a(b).height(),d=P.offset().top+P.height();c>d&&A<z.length&&m()}function j(a,b){if(a.files&&a.files[0]){var c=new FileReader;c.onload=function(a){b.attr("src",a.target.result)},c.readAsDataURL(a.files[0])}}function k(){var b=N.filter(":checked"),c=a.trim(L.val()),d=a.trim(M.val());c||d||b.length?(C={},c&&(C.takeawayTag=c),d&&(C.foodID=d),b.each(function(){"isHasImage"==this.id?C.isHasImage="0":C[this.id]="1"})):C=null,A=0,m()}function m(a){z=o(),O.text(z.length),0==A&&P.empty(),P.append(G({foods:z.slice(a?0:A,A+B)})),A+=B}function n(a,b){for(var c=x[a].foods,d=c.length;d--;)if(c[d].foodID==b)return c[d];return null}function o(){var b=[];if(y)b=x[y].foods;else for(var c in x)b.push.apply(b,x[c].foods);for(p in C)b=a.grep(b,function(a){return a[p]==C[p]});return b}function q(a){var b={};for(i=0,l=a.length;l>i;i++){var c=a[i],d=c.foodCategoryID;if(b[d]=b[d]||{foods:[],foodCategoryName:c.foodCategoryName},c.foodID){r(c),c.takeoutPackagingFee=c.takeoutPackagingFee>0?parseFloat(c.takeoutPackagingFee):"",(-1==c.prePrice||c.prePrice==c.price)&&(c.prePrice=c.price,c.price=""),(-1==c.vipPrice||c.vipPrice>=c.prePrice)&&(c.vipPrice=""),c.price=c.price||"",c.prePrice=c.prePrice||"",c.vipPrice=c.vipPrice||"";var e=b[d].foods,f={unit:c.unit?c.unit+":":"",price:c.price?"￥"+parseFloat(c.price):"",prePrice:c.prePrice?"￥"+parseFloat(c.prePrice):"",vipPrice:c.vipPrice?"￥"+parseFloat(c.vipPrice):""},g=s(e,c,"foodID");-1==g?(c.units=[f],e.push(c)):e[g].units.push(f)}}return b}function r(a){var b=a.imgePath;if(b){var c=a.imageHWP,d=92,e=c>1?d:Math.round(d/c),f=c>1?Math.round(d*c):d;a.imgSrc=imgHost+b.replace(/\.\w+$/,(c?"="+e+"x"+f:"")+"$&?quality=70")}else a.imgSrc=imgRoot+"dino80.png";a.discountIco=1==a.isDiscount?"glyphicon-ok":"glyphicon-minus",a.takeawayIco=a.takeawayTag>0?"glyphicon-ok":"glyphicon-minus",a.activeIco=1==a.foodIsActive?"glyphicon-ok":"glyphicon-minus"}function s(a,b,c){for(var d=0,e=a.length;e>d;d++)if(a[d][c]==b[c])return d;return-1}if(f){var t=Hualala.Global,u=Hualala.UI,v=u.TopTip,w=f;imgHost=t.IMAGE_RESOURCE_DOMAIN+"/",imgRoot=t.IMAGE_ROOT+"/";var x=null,y="",z=null,A=0,B=10,C=null,D=["hotTag","takeawayTag","isDiscount"],E=null,F=null,G=Handlebars.compile(Hualala.TplLib.get("tpl_food")),H=Handlebars.compile(Hualala.TplLib.get("tpl_edit_food")),I=a(Hualala.TplLib.get("tpl_shop_menu")),J=null,K=I.find("#foodSearch"),L=K.find("#takeawayTag"),M=K.find("#foodName"),N=K.find("input[type=checkbox]"),O=(I.find(".tbl-foods thead"),I.find("#foodSearchInfo span")),P=I.find(".tbl-foods tbody"),Q=null,R=null,S=null;t.getShopMenu({shopID:w},function(b){if("000"!=b.resultcode)return void(b.resultmsg&&v({msg:b.resultmsg,type:"danger"}));var c=b.data.records;if(!c||0==c.length){var e=a('<div class="alert alert-warning t-c">此店铺暂无菜品，您可以通过下载<a target="_blank">PC客户端</a>上传菜品数据。</div>');return e.find("a").attr("href",Hualala.PageRoute.createPath("pcclient")),void e.appendTo(d)}x=q(c),m();var f=I.find("#foodClassBox").append(a('<span class="current-food-class"></span>').text("全部菜品 ("+z.length+")"));for(var h in x){var i=x[h];a("<span></span>").data("id",h).text(i.foodCategoryName+" ("+i.foods.length+")").appendTo(f)}J=f.find("span");var j=Handlebars.compile(Hualala.TplLib.get("tpl_food_name"));M.html(j({classifiedFoods:x})),g(),I.appendTo(d)}),a(b).on("scroll",function(){z&&c(h)}),a(document).on("change",function(b){var c=a(b.target);if(c.is("#takeawayTag , #foodSearch input[type=checkbox]")&&k(),c.is(".form-food input[type=radio]")&&c.closest("div").find("label").removeClass("active").find("input:checked").parent().addClass("active"),c.is(".food-pic input")){var d=Q.filter(".food-pic");c.val()&&(d.addClass("loading"),j(c[0],d.find("img")),d.submit())}}),top.imgCallback=function(c){var d=Q.filter(".food-pic"),e=a.parseJSON(c),f=e.status;if("success"==f){var g=e.url,h=e.imageHWP||"";F.imagePath=g,h&&(F.imageHWP=h),b.FileReader||d.find("img").attr("src",imgHost+g.replace(/\.\w+$/,(h?"=200x"+Math.round(200*h):"")+"$&?quality=70"))}else v({msg:f+"：菜品图片上传失败"});d.removeClass("loading"),a("#imgResponse").remove()},P.on("click","tr",function(){var b=a(this);E=n(b.data("cid"),b.data("id"));var c=["isSpecialty","isRecommend","isNew"],d=E.imgePath;E.foodPic=d?imgHost+d+"?quality=70":imgRoot+"food_bg.png",E.hotTag1=imgRoot+"hottag1.png",E.hotTag2=imgRoot+"hottag2.png",E.hotTag3=imgRoot+"hottag3.png",Q=a(H(E)),R=new u.ModalDialog({id:"editFood",title:"修改菜品",html:Q,hideCloseBtn:!1}).show(),R._.footer.find(".btn-ok").text("保存修改"),R._.footer.find(".btn-close").text("返回"),S=Q.filter(".form-food").bootstrapValidator({fields:{minOrderCount:{validators:{notEmpty:{message:"起售份数不能为空"},integer:{message:"起售份数必须是整数"},between:{min:1,max:99,message:"起售份数必须在1到99之间"}}}}}).data("bootstrapValidator"),F={shopID:w,foodID:b.data("id")};for(var e=c.length;e--;){var f=c[e];F[f]="0",1==E[f]&&Q.find("input[name=foodIco][value="+f+"]").prop("checked",!0).trigger("change")}for(var e=D.length;e--;){var g=D[e];Q.find("input[name="+g+"][value="+E[g]+"]").prop("checked",!0).trigger("change")}Q.find("input[name=isActive][value="+E.foodIsActive+"]").prop("checked",!0).trigger("change")}),a(document).on("click",function(b){var c=a(b.target);if(c.is("#editFood .btn-ok")){if(!S.validate().isValid())return;var d=Q.find("input[name=foodIco]:checked").not("[value=none]");d[0]&&(F[d.val()]="1");for(var e=D.length;e--;){var f=D[e];F[f]=Q.find("input[name="+f+"]").filter(":checked").val()}F.isActive=Q.find("input[name=isActive]:checked").val(),F.minOrderCount=Q.find("input[name=minOrderCount]").val(),F.tasteList=a.trim(Q.find("input[name=tasteList]").val()),t.updateFood(F,function(b){return"000"!=b.resultcode?void(b.resultmsg&&v({msg:b.resultmsg,type:"danger"})):(R.hide(),a.extend(E,F),F.imagePath&&(E.imgePath=F.imagePath),E.foodIsActive=E.isActive,r(E),P.empty(),void m(!0))})}c.is("#foodClassBox span")&&(J.removeClass("current-food-class"),c.addClass("current-food-class"),y=c.data("id"),L.val(""),M.val(""),N.prop("checked",!1),C=null,A=0,m())})}}}(jQuery,window),function(){}(jQuery,window),function(a){IX.ns("Hualala.Shop"),Hualala.Shop.Typedef={operationMode:{0:"正餐",1:"快餐",2:"美食广场"}},Hualala.Shop.createShopInfoHead=function(b,c,d){var e=c||a("#ix_wrapper > .ix-body > .container"),f=a('<div class="bs-callout shop-info-head"></div>');!d&&f.appendTo(e);var g=function(b){var c={shopName:b.shopName,shopUrl:Hualala.Common.getShopUrl(b.shopID),shopListLink:Hualala.PageRoute.createPath("shop"),checked:1==b.status?"checked":""},e=Handlebars.compile(Hualala.TplLib.get("tpl_shop_info_head"));f.append(a(e(c))).find("input").bootstrapSwitch({onColor:"success",onText:"已开通",offText:"未开通"}).on("switchChange.bootstrapSwitch",function(c,d){var e=a(this);Hualala.Global.switchShopStatus({shopID:b.shopID,status:+d},function(a){return"000"!=a.resultcode?(e.bootstrapSwitch("toggleState",!0),void(a.resultmsg&&Hualala.UI.TopTip({msg:a.resultmsg,type:"danger"}))):void Hualala.UI.TopTip({msg:+d?"开启成功":"关闭成功",type:"success"})})}),f.find("#resetPwd").on("click",function(){var c=Handlebars.compile(Hualala.TplLib.get("tpl_set_shop_client_pwd")),d=a(c(b)),e=new Hualala.UI.ModalDialog({id:"resetCltPwdDlg",title:"重置代理程序密码",html:d,sizeCls:"modal-sm",hideCloseBtn:!1}).show(),f=d.find(".has-feedback"),g=f.find(".form-control-feedback"),h=f.find("small"),i=d.find("#shopClinetPwd").data("validate",!1).on("blur",function(){var b=a(this),c=a.trim(b.val()).length;b.data("validate",!1),c?6>c||c>16?h.text("密码长度必须在6到16个字符之间"):(h.text(""),b.data("validate",!0)):h.text("密码不能为空");var d=b.data("validate");f.toggleClass("has-success",d).toggleClass("has-error",!d),g.toggleClass("glyphicon-ok",d).toggleClass("glyphicon-remove",!d)});d.find("#showPwd").change(function(){i.attr("type",this.checked?"text":"password")}),e._.footer.find(".btn-ok").on("click",function(){i.trigger("blur").data("validate")&&Hualala.Global.setShopClientPwd({shopID:b.shopID,hLLAgentLoginPWD:i.val()},function(a){return"000"!=a.resultcode?void(a.resultmsg&&Hualala.UI.TopTip({msg:a.resultmsg,type:"danger"})):(e.hide(),void Hualala.UI.TopTip({msg:"重置代理程序密码成功！",type:"success"}))})})}),d&&d(f)};return a.isPlainObject(b)?void g(b):void Hualala.Global.getShopInfo({shopID:b},function(a){if("000"!=a.resultcode)return void(a.resultmsg&&Hualala.UI.TopTip({msg:a.resultmsg,type:"danger"}));var b=a.data.records[0];g(b)})},Hualala.Shop.createShopFuncNav=function(b,c,d){var e=["shopInfo","shopMenu"],f=Hualala.PageRoute,g=a('<ul class="nav navbar-nav"></ul>'),h=d||a("#ix_wrapper > .ix-body > .container");for(i=0,l=e.length;l>i;i++){var j=e[i],k=j==b,m=k?"javascript:;":f.createPath(j,[c]),n=f.getPageLabelByName(j);a("<li></li>").toggleClass("active",k).append(a("<a></a>").attr("href",m).text(n)).appendTo(g)}return a('<div class="navbar navbar-default shop-func-nav"></div>').append(g).appendTo(h)};var b=function(){{var b=a("#ix_wrapper > .ix-body > .container");new Hualala.Shop.QueryController({needShopCreate:!0,container:b,resultController:new Hualala.Shop.ShopListController({container:b,model:new Hualala.Shop.CardListModel({callServer:Hualala.Global.queryShop}),view:new Hualala.Shop.CardListView})})}};Hualala.Shop.HomePageInit=b;var c=function(b,c){var d=a("#ix_wrapper > .ix-body > .container");Hualala.UI.BreadCrumb({container:d,hideRoot:!0,nodes:Hualala.PageRoute.getParentNamesByPath()}),Hualala.Shop.initInfo(d,b,c)};Hualala.Shop.BaseInfoMgrInit=c;var d=function(b,c){var d=a("#ix_wrapper > .ix-body > .container");Hualala.UI.BreadCrumb({container:d,hideRoot:!0,nodes:Hualala.PageRoute.getParentNamesByPath()}),Hualala.Shop.createShopInfoHead(c,d),Hualala.Shop.createShopFuncNav(b,c,d),Hualala.Shop.initMenu(d,b,c)};Hualala.Shop.FoodMenuMgrInit=d;var e=function(){var b=a("#ix_wrapper > .ix-body > .container");Hualala.UI.BreadCrumb({container:b,hideRoot:!0,nodes:Hualala.PageRoute.getParentNamesByPath()});var c=Handlebars.compile(Hualala.TplLib.get("tpl_shop_create")),d=a(c({pcClientPath:Hualala.PageRoute.createPath("pcclient")}));b.append(d),Hualala.Shop.initCreate(d)};Hualala.Shop.CreateShopInit=e}(jQuery,window),function(a){IX.ns("Hualala.Setting");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip),c={advanceTime:{type:"combo",label:"用户提前预订时间",defaultVal:0,options:Hualala.TypeDef.MinuteIntervalOptions(),validCfg:{validators:{notEmpty:{message:"请输入用户提前预订时间"}}}},noticeTime:{type:"combo",label:"订单提前通知时间",defaultVal:0,options:Hualala.Common.getMinuteIntervalOptions({startLabel:"用户下单后立即通知"}),validCfg:{validators:{notEmpty:{message:"请输入订单提前通知时间"}}}},minAmount:{type:"text",label:"最低消费金额",prefix:"￥",surfix:Hualala.Constants.CashUnit,defaultVal:0,validCfg:{validators:{notEmpty:{message:"请输入最低消费金额"},numeric:{message:"最低消费金额必须为数字"},greaterThan:{inclusive:!0,value:0,message:"最低消费金额必须大于或等于0"}}}},serviceAmount:{type:"text",label:"服务费",prefix:"￥",surfix:Hualala.Constants.CashUnit,defaultVal:0,validCfg:{validators:{numeric:{message:"服务费必须为数字"},greaterThan:{inclusive:!0,value:0,message:"服务费必须大于或等于0"}}}},freeServiceAmount:{type:"text",label:"免服务费菜品金额",prefix:"￥",surfix:Hualala.Constants.CashUnit,defaultVal:0,validCfg:{validators:{numeric:{message:"免服务费菜品金额必须为数字"},greaterThan:{inclusive:!0,value:0,message:"免服务费菜品金额必须大于或等于0"}}}},holidayFlag:{type:"combo",label:"节假日开放",defaultVal:0,options:Hualala.TypeDef.HolidayFlagOptions,validCfg:{validators:{notEmpty:{message:"请选择节假日开放类型"}}}},openDays:{type:"text",label:"开放服务天数",surfix:"天",defaultVal:"",validCfg:{validators:{notEmpty:{message:"请输入开放服务天数"},digits:{message:"开放服务天数必须为数字"},greaterThan:{inclusive:!0,value:0,message:"开放服务天数必须大于或等于0"}}}},servicePeriods:{type:"section",label:"开放时段",min:{type:"timepicker",surfix:'<span class="glyphicon glyphicon-time"></span>',defaultVal:"",validCfg:{group:".min-input",validators:{notEmpty:{message:"请输入起始时间"}}}},max:{type:"timepicker",surfix:'<span class="glyphicon glyphicon-time"></span>',defaultVal:"",validCfg:{group:".max-input",validators:{notEmpty:{message:"请输入结束时间"}}}}},reserveTableTime:{type:"combo",label:"留位时间",defaultVal:0,options:Hualala.TypeDef.MinuteIntervalOptions(60),validCfg:{validators:{notEmpty:{message:"请选择留位时间"},numeric:{message:"留位时间必须为数字"},greaterThan:{inclusive:!0,value:0,message:"留位时间必须大于或等于0"}}}},reserveTableDesc:{type:"text",label:"留位特别说明",defaultVal:"",validCfg:{validators:{stringLength:{max:40,message:"留位特别说明不能超过40个字"}}}},takeawayDeliveryAgent:{type:"text",label:"配送单位",defaultVal:"自助配送",validCfg:{}},takeawayDeliveryTime:{type:"text",label:"预计送餐所需时间",surfix:"分钟",defaultVal:"",validCfg:{validators:{notEmpty:{message:"请输入预计送餐所需时间"},numeric:{message:"预计送餐所需时间必须为数字"},greaterThan:{inclusive:!0,value:0,message:"预计送餐所需时间必须大于或等于0"}}}},takeawayScope:{type:"text",label:"送餐范围",surfix:"公里",defaultVal:"",validCfg:{validators:{notEmpty:{message:"请输入送餐范围"},numeric:{message:"送餐范围必须为数字"},greaterThan:{inclusive:!0,value:0,message:"送餐范围必须大于或等于0"}}}},takeawayScopeDesc:{type:"text",label:"送餐范围说明",defaultVal:"",validCfg:{validators:{stringLength:{max:200,message:"送餐范围说明不能超过200个字"}}}},submitSMSTemplateID:{type:"hidden",defaultVal:""},checkSMSTemplateID:{type:"hidden",defaultVal:""},payMethod:{type:"combo",label:"可选支付方式",defaultVal:0,options:Hualala.TypeDef.PayMethodOptions,validCfg:{validators:{notEmpty:{message:"请选择可选支付方式"}}}},needInputTableName:{type:"switcher",label:"下单时输入桌号",defaultVal:1,onLabel:"需要",offLabel:"不需要",validCfg:{validators:{}}},supportInvoice:{type:"switcher",label:"提供发票",defaultVal:1,onLabel:"需要",offLabel:"不需要",validCfg:{validators:{}}},supportCommitToSoftware:{type:"switcher",label:"下单到餐饮软件",defaultVal:1,onLabel:"支持",offLabel:"不支持",validCfg:{validators:{}}},payMethodAtShop:{type:"combo",label:"店内支付方式",defaultVal:0,options:Hualala.TypeDef.PayMethodAtShopOptions,validCfg:{validators:{notEmpty:{message:"请选择店内支付方式"}}}},checkSpotOrder:{type:"switcher",label:"支持手机结账",defaultVal:1,onLabel:"支持",offLabel:"不支持",validCfg:{validators:{}}},payBeforeCommit:{type:"combo",label:"结账模式",defaultVal:1,options:Hualala.TypeDef.PayBeforeCommitOptions,validCfg:{validators:{}}},fetchFoodMode:{type:"combo",label:"下单后出餐模式",defaultVal:0,options:Hualala.TypeDef.FetchFoodModeOptions,validCfg:{validators:{notEmpty:{message:"下单后出餐模式不能为空"}}}}},d=new IX.IListManager;_.each(c,function(a,b){var c=$XP(a,"type"),e="col-sm-offset-1 col-sm-3 control-label";if("section"==c){var f=minID=b+"_min_"+IX.id(),g=b+"_max_"+IX.id(),h=b+"_min",i=b+"_max",j=IX.inherit($XP(a,"min",{}),{id:minID,name:h,clz:"col-sm-3"}),k=IX.inherit($XP(a,"max",{}),{id:g,name:i,clz:"col-sm-3"});d.register(b,IX.inherit(a,{id:f,labelClz:e,min:j,max:k}))}else d.register(b,IX.inherit(a,{id:b+"_"+IX.id(),name:b,labelClz:e,clz:"col-sm-5"}))});var e=Stapes.subclass({constructor:function(a){if(this.$trigger=$XP(a,"triggerEl"),this.serviceID=$XP(a,"serviceID",null),this.serviceName=$XP(a,"serviceName",null),this.model=$XP(a,"model",null),this.serviceFeatures=$XP(a,"serviceFeatures",""),this.serviceList=Hualala.TypeDef.ShopBusiness,this.modal=null,this.successFn=$XF(a,"successFn"),!this.serviceID||!this.serviceName||!this.model)throw"Service View init failed!";if(this.loadTemplates(),this.serviceInfo=this.getServiceInfo("id",this.serviceID),this.callServer=$XP(this.serviceInfo,"callServer",""),IX.isFn(this.callServer))this.callServer=this.callServer;else{if(!IX.isString(this.callServer))throw"Configuration failed : Invalid Page Initialized for "+this.callServer;
IX.nsExisted(this.callServer)&&(this.callServer=IX.getNS(this.callServer))}var b=this.model.get("revParamJson")||null,c=this.model.get("takeawayParamJson")||null,d=null;b=b?JSON.parse(b):{},c=c?JSON.parse(c):{},d=IX.inherit(b,c),this.formParams=$XP(d,this.serviceID),this.initModal(),this.renderForm(),this.bindEvent(),this.emit("show")}});e.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_shop_service_form_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns"));Handlebars.registerHelper("checkFormElementType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),Handlebars.registerHelper("isInputGroup",function(a,b,c){return a||b?c.fn(this):c.inverse(this)}),this.set({layoutTpl:a,btnTpl:b})},initModal:function(){var a=this;a.modal=new Hualala.UI.ModalDialog({id:"service_edit",clz:"service-modal",title:a.getModalTitle(),afterRemove:function(){}})},initSwitcher:function(b){var c=this;c.modal._.body.find(b).each(function(){var b=a(this),c=b.attr("data-onLabel"),d=b.attr("data-offLabel");b.bootstrapSwitch({size:"normal",onColor:"primary",offColor:"default",onText:c,offText:d})})},initTimePicker:function(a){var b=this;b.modal._.body.find(a).timepicker({minuteStep:30,showSeconds:!1,showMeridian:!1,disableFocus:!0,showInputs:!1})},getServiceInfo:function(a,b){var c=this,d=c.model.get("operationMode"),e=IX.inherit({},_.find(this.serviceList,function(c){return c[a]==b}));return IX.isEmpty($XP(e,"operationMode"))||(e=IX.inherit(e,{formKeys:$XP(e,"operationMode."+d)})),e},getModalTitle:function(){return $XP(this.serviceInfo,"label")+"配置"},bindEvent:function(){var b=this,c=b.initValidFieldOpts();this.on({show:function(){this.modal.show()},hide:function(){this.modal.hide()}}),b.modal._.dialog.find(".btn").on("click",function(){var c=a(this),d=c.attr("name");if("cancel"==d)b.emit("hide");else{var e=b.modal._.body.find("form").data("bootstrapValidator");c.button("提交中..."),e.validate()}}),b.modal._.body.find("form").bootstrapValidator({trigger:"blur",fields:c}).on("error.field.bv",function(b){{var c=a(b.target);c.data("bootstrapValidator")}}).on("success.form.bv",function(c){c.preventDefault();var d=a(c.target),e=(d.data("bootstrapValidator"),b.serializeForm());IX.Debug.info("DEBUG: Shop Business Service Edit View Form Params : "),IX.Debug.info(e),b.model.emit("setServiceParams",{callServer:b.callServer,params:e,serviceID:b.serviceID,failFn:function(){b.modal._.footer.find(".btn[name=submit]").button("reset")},successFn:function(){b.modal._.footer.find(".btn[name=submit]").button("reset"),b.emit("hide"),b.successFn(b.model,b.serviceID,e,b.$trigger)}})})},decodeTimeStr:function(a){return 0==a.length?"":a.substr(0,2)+":"+a.substr(2)},encodeTimeStr:function(a,b){return(a+","+b).replace(/\:/g,"")},mapServiceFormElsData:function(){var a=this,b=$XP(a.serviceInfo,"formKeys","").split(","),c=_.map(b,function(b){var c=d.get(b),e=$XP(c,"type");if("section"==e&&"servicePeriods"==b){var f=$XP(a.formParams,b,"").split(",");return f=_.map(f,function(b){return a.decodeTimeStr(b)}),IX.inherit(c,{min:IX.inherit($XP(c,"min"),{value:f[0]||$XP(c,"min.defaultVal")}),max:IX.inherit($XP(c,"max"),{value:f[1]||$XP(c,"max.defaultVal")})})}if("combo"==e){var f=$XP(a.formParams,b,$XP(c,"defaultVal")),g=_.map($XP(c,"options"),function(a){return IX.inherit(a,{selected:$XP(a,"value")==f?"selected":""})});return IX.inherit(c,{value:$XP(a.formParams,b,$XP(c,"defaultVal")),options:g})}return"switcher"==e?"checkSpotOrder"==b?IX.inherit(c,{checked:a.serviceFeatures.indexOf("spot_pay")>=0?"checked":""}):IX.inherit(c,{checked:$XP(a.formParams,b)==$XP(c,"defaultVal")?"checked":""}):"text"==e&&"20"==a.serviceID&&"minAmount"==b?IX.inherit(c,{label:"起送金额",value:$XP(a.formParams,b,0)}):"text"==e&&"20"==a.serviceID&&"serviceAmount"==b?IX.inherit(c,{label:"送餐费",value:$XP(a.formParams,b,0)}):"text"==e&&"20"==a.serviceID&&"freeServiceAmount"==b?IX.inherit(c,{label:"免送餐费金额",prefix:"满",surfix:Hualala.Constants.CashUnit+"，免送餐费",value:$XP(a.formParams,b,$XP(c,"defaultVal"))}):IX.inherit(c,{value:$XP(a.formParams,b,$XP(c,"defaultVal"))})});return IX.Debug.info("DEBUG: Shop Business Service Edit View Form Elements : "),IX.Debug.info(c),c},renderForm:function(){var a=this,b=(a.initValidFieldOpts(),a.mapServiceFormElsData()),c=a.get("layoutTpl"),d=a.get("btnTpl"),e=c({formClz:"shop-service-form form-feedback-out",items:b});a.modal._.body.html(e),a.modal._.footer.html(d({btns:[{clz:"btn-default",name:"cancel",label:"取消"},{clz:"btn-warning",name:"submit",label:"保存"}]})),a.initSwitcher(":checkbox[data-type=switcher]"),a.initTimePicker("[data-type=timepicker]")},serializeForm:function(){{var b=this,c=$XP(b.serviceInfo,"formKeys","").split(","),e={};_.map(c,function(c){var f=d.get(c),g=$XP(f,"type");if("section"==g&&"servicePeriods"==c){var h=a("[name="+c+"_min]").val(),i=a("[name="+c+"_max]").val();e[c]=b.encodeTimeStr(h,i)}else e[c]="switcher"==g?a("[name="+c+"]").data("bootstrapSwitch").options.state?1:0:a("[name="+c+"]").val()})}return e},initValidFieldOpts:function(){var a=this,b=$XP(a.serviceInfo,"formKeys","").split(","),c={};return _.each(b,function(a){var b=d.get(a),e=$XP(b,"type");if("section"==e){var f=a+"_min",g=a+"_max";c[f]=$XP(b,"min.validCfg",{}),c[g]=$XP(b,"max.validCfg",{})}else c[a]=$XP(b,"validCfg",{})}),c}}),Hualala.Setting.editServiceView=e;var f=Stapes.subclass({constructor:function(a){if(this.$trigger=$XP(a,"triggerEl",null),this.settleID=$XP(a,"settleID",""),this.model=$XP(a,"model",null),this.successFn=$XF(a,"successFn"),this.getSettleUnitsCallServer=Hualala.Global.queryAccount,this.bindSettleUnitCallServer=Hualala.Global.bindSettleUnitByShopID,this.modal=null,this.$body=null,this.$footer=null,!this.$trigger||!this.settleID||!this.model)throw"Bind Settle Unit View init failed!";this.loadTemplates(),this.initModal(),this.bindEvent(),this.emit("load")}});f.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_role_bind_shop")),b=Handlebars.compile(Hualala.TplLib.get("tpl_settle_list")),c=Handlebars.compile(Hualala.TplLib.get("tpl_settle_item"));Handlebars.registerPartial("settleItem",Hualala.TplLib.get("tpl_settle_item")),Handlebars.registerHelper("checkItemType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),this.set({layoutTpl:a,listTpl:b,itemTpl:c})},initModal:function(){var a=this;a.modal=new Hualala.UI.ModalDialog({id:"bind_settle_modal",clz:"account-modal",title:"绑定结算账户"}),a.$body=a.modal._.body,a.$footer=a.modal._.footer;var b=a.get("layoutTpl"),c=b({clz:"",title:"选择店铺要绑定的结算账户"});a.$body.html(c),a.$resultBox=a.$body.find(".result-box")},bindEvent:function(){var c=this;this.on({show:function(){c.modal.show()},hide:function(){c.modal.hide()},load:function(){c.origSettleData?c.render(c.origSettleData):c.getSettleUnitsCallServer({},function(a){"000"!=a.resultcode?(b({msg:$XP(a,"resultmsg",""),type:"danger"}),c.emit("hide")):(c.origSettleData=$XP(a,"data.records",[]),c.render(c.origSettleData),c.emit("show"))})}}),c.$resultBox.tooltip({selector:"[title]"}),c.$resultBox.delegate(":radio","change",function(){var b=a(this),d=(this.checked?!0:!1,b.val());c.curSettleUnit=_.find(c.origSettleData,function(a){return $XP(a,"settleUnitID","")==d})}),c.$footer.delegate(".btn","click",function(){var b=a(this),d=b.hasClass("btn-ok")?"ok":"cancel";"cancel"==d?c.emit("hide"):c.bindItems()})},bindItems:function(){var a=this;a.bindSettleUnitCallServer({shopID:a.model.get("shopID"),settleID:$XP(a.curSettleUnit,"settleUnitID"),settleName:$XP(a.curSettleUnit,"settleUnitName"),oldSettleID:a.settleID},function(c){"000"!=c.resultcode?b({msg:$XP(c,"resultmsg",""),type:"danger"}):(b({msg:"绑定成功",type:"success"}),a.emit("hide"),a.successFn(a.model,a.$trigger,a.curSettleUnit))})},mapRenderData:function(a){var b=this,c=_.map(a,function(a){var c=$XP(a,"settleUnitID"),d=c==b.settleID?"checked":"";return"checked"==d&&(b.curSettleUnit=a),IX.inherit(a,{type:"radio",clz:"bind-item",settleUnitNameLabel:$XP(a,"settleUnitName",""),checked:d})});return c},render:function(a){var b=this,c=b.get("listTpl"),d=b.mapRenderData(a),e=c({settleList:{list:d}});b.$resultBox.html(e)}}),Hualala.Setting.bindSettleUnitView=f}(jQuery,window),function(a){IX.ns("Hualala.Setting");var b=function(){{var b=a("#ix_wrapper > .ix-body > .container");new Hualala.Shop.QueryController({needShopCreate:!1,container:b,resultController:new Hualala.Shop.ShopListController({container:b,model:new Hualala.Shop.CardListModel({callServer:Hualala.Global.queryShop}),view:new Hualala.Shop.ShopListView})})}};Hualala.Setting.ShopMgrInit=b}(jQuery,window),function(){IX.ns("Hualala.Account");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip),b=Hualala.Shop.CardListModel,c=b.subclass({constructor:b.prototype.constructor});c.proto({init:function(a){this.set({pageCount:0,totalSize:0,pageNo:$XP(a,"pageNo",1),pageSize:$XP(a,"pageSize",15),transCreateBeginTime:$XP(a,"transCreateBeginTime",""),transCreateEndTime:$XP(a,"transCreateEndTime",""),settleUnitID:$XP(a,"settleUnitID",""),transStatus:$XP(a,"transStatus",""),transType:$XP(a,"transType",""),groupID:$XP(a,"groupID",""),minTransAmount:$XP(a,"minTransAmount",""),maxTransAmount:$XP(a,"maxTransAmount",""),ds_account:new IX.IListManager,ds_page:new IX.IListManager})},updatePagerParams:function(a){var b=this,c="pageCount,totalSize,pageNo,pageSize,transCreateBeginTime,transCreateEndTime,settleUnitID,transStatus,transType,groupID,minTransAmount,maxTransAmount";_.each(a,function(a,d){c.indexOf(d)>-1&&b.set(d,a)})},getPagerParams:function(){return{pageNo:this.get("pageNo"),pageSize:this.get("pageSize"),settleUnitID:this.get("settleUnitID"),transCreateBeginTime:this.get("transCreateBeginTime"),transCreateEndTime:this.get("transCreateEndTime"),transStatus:this.get("transStatus"),transType:this.get("transType"),groupID:this.get("groupID"),minTransAmount:this.get("minTransAmount"),maxTransAmount:this.get("maxTransAmount")}},updateDataStore:function(a,b){var c=this,e=c.get("ds_account"),f=c.get("ds_page"),g=_.map(a,function(a){var b=$XP(a,"settleUnitID"),c=new d(a);return e.register(b,c),b});f.register(b,g)},resetDataStore:function(){var a=this,b=a.get("ds_account"),c=a.get("ds_page");b.clear(),c.clear()},load:function(b,c){var d=this;d.updatePagerParams(b),d.callServer(d.getPagerParams(),function(b){"000"==b.resultcode?(d.updateDataStore($XP(b,"data.records",[]),$XP(b,"data.page.pageNo")),d.updatePagerParams(IX.inherit($XP(b,"data",{}),$XP(b,"data.page",{})))):a({msg:$XP(b,"resultmsg",""),type:"danger"}),c(d)})},getAccounts:function(a){var b=this,c=b.get("ds_account"),d=b.get("ds_page"),e=_.map(c.getByKeys(d.get(a)),function(a){return a.getAll()});return IX.Debug.info("DEBUG: Account List Model PageData :"),IX.Debug.info(e),e},getAccountModelByID:function(a){var b=this,c=b.get("ds_account");return c.get(a)}}),Hualala.Account.AccountListModel=c;var d=Stapes.subclass({constructor:function(a){!IX.isEmpty(a)&&this.set(a),this.bindEvent()}});d.proto({bindEvent:function(){var b=this;b.on({load:function(a){var c=$XP(a,"settleUnitID"),d=$XF(a,"cbFn"),e=Hualala.Global.queryAccount,f=$XP(Hualala.getSessionSite(),"groupID","");e({settleUnitID:c,groupID:f},function(a){var e=$XP(a,"data.records",[]);if(0==e.length)throw"get Account Data ("+c+") Failed!";b.set(e[0]),d()})},withdrawCash:function(c){var d=Hualala.Global.withdrawCash,e=$XP(c,"params",{}),f=b.get("settleUnitID"),g=$XF(c,"failFn"),h=$XF(c,"successFn"),i=b.get("poundageAmount")||0,j=b.get("poundageMinAmount")||0;d(IX.inherit(e,{settleUnitID:f,poundageAmount:i,poundageMinAmount:j}),function(c){if("000"!==c.resultcode)a({msg:$XP(c,"resultmsg",""),type:"danger"}),g();else{var d=$XP(e,"transAmount",0),f=b.get("settleBalance")||0,i=Hualala.Common.Math.sub(f-d);b.set("settleBalance",i),h(),a({msg:"提现成功!",type:"success"})}})},"delete":function(c){var d=Hualala.Global.deleteAccount,e=b.get("settleUnitID"),f=$XP(Hualala.getSessionSite(),"groupID",""),g=$XF(c,"failFn"),h=$XF(c,"successFn");d({settleUnitID:e,groupID:f},function(b){"000"!==b.resultcode?(a({msg:$XP(b,"resultmsg",""),type:"danger"}),g(e)):(a({msg:"删除成功!",type:"success"}),h(e))})},edit:function(c){var d=Hualala.Global.editAccount,e=b.get("settleUnitID"),f=$XP(Hualala.getSessionSite(),"groupID",""),g=$XF(c,"failFn"),h=$XF(c,"successFn");d(IX.inherit($XP(c,"params",{}),{groupID:f,settleUnitID:e}),function(d){"000"!==d.resultcode?(a({msg:$XP(d,"resultmsg",""),type:"danger"}),g(e)):(a({msg:"修改成功!",type:"success"}),b.set($XP(c,"params",{})),h(e))})},add:function(c){var d=Hualala.Global.addAccount,e=$XP(Hualala.getSessionSite(),"groupID",""),f=$XF(c,"failFn"),g=$XF(c,"successFn");d(IX.inherit($XP(c,"params",{}),{groupID:e}),function(d){"000"!==d.resultcode?(a({msg:$XP(d,"resultmsg",""),type:"danger"}),f()):(a({msg:"添加成功!",type:"success"}),b.set($XP(c,"params",{})),g())})}})}}),Hualala.Account.BaseAccountModel=d;var e=c.subclass({constructor:function(){this.callServer=Hualala.Global.queryAccountTransDetail}});e.proto({init:function(a){this.set({pageCount:0,totalSize:0,pageNo:$XP(a,"pageNo",1),pageSize:$XP(a,"pageSize",15),transCreateBeginTime:$XP(a,"transCreateBeginTime",""),transCreateEndTime:$XP(a,"transCreateEndTime",""),settleUnitID:$XP(a,"settleUnitID",""),transStatus:$XP(a,"transStatus",""),transType:$XP(a,"transType",""),groupID:$XP(a,"groupID",""),minTransAmount:$XP(a,"minTransAmount",""),maxTransAmount:$XP(a,"maxTransAmount",""),ds_trans:new IX.IListManager,ds_page:new IX.IListManager})},updateDataStore:function(a,b){var c=this,d=c.get("ds_trans"),e=c.get("ds_page"),g=_.map(a,function(a){var b=$XP(a,"SUATransItemID"),c=new f(a);return d.register(b,c),b});e.register(b,g)},resetDataStore:function(){var a=this,b=a.get("ds_trans"),c=a.get("ds_page");b.clear(),c.clear()},load:function(b,c){var d=this;d.updatePagerParams(b),d.callServer(d.getPagerParams(),function(b){"000"==b.resultcode?(d.updateDataStore($XP(b,"data.records",[]),$XP(b,"data.page.pageNo")),d.updatePagerParams(IX.inherit($XP(b,"data",{}),$XP(b,"data.page",{})))):a({msg:$XP(b,"resultmsg",""),type:"danger"}),c(d)})},getDataByPageNo:function(a){var b=this,c=b.get("ds_trans"),d=b.get("ds_page"),e=_.map(c.getByKeys(d.get(a)),function(a){return a.getAll()});return IX.Debug.info("DEBUG: Account TransList Model PageData :"),IX.Debug.info(e),e},getModelByID:function(a){var b=this,c=b.get("ds_trans");return c.get(a)}}),Hualala.Account.AccountTransListModel=e;var f=d.subclass({constructor:d.prototype.constructor});f.proto({bindEvent:function(){}}),Hualala.Account.BaseTransactionModel=f;var g=Hualala.Shop.QueryModel.subclass({constructor:function(){this.origCities=[],this.origAreas=[],this.origShops=[],this.isReady=!1,this.callServer=Hualala.Global.getAccountQueryShop}});Hualala.Account.AccountQueryShopModel=g;var h=Hualala.Shop.CardListModel.subclass({constructor:function(){this.origData=null,this.dataStore=new IX.IListManager}});h.proto({initDataStore:function(a){var b=this;b.origData=a,_.each(b.origData,function(a){b.dataStore.register($XP(a,"shipID"),a)})},load:function(a,b){var c=this;c.updatePagerParams(a);var d=c.get("pageNo"),e=c.get("pageSize"),f=c.get("cityID"),g=c.get("areaID"),h=c.get("keywordLst"),i=0,j=(d-1)*e,k=e*d,l=0,m=[];m=g.length>0?_.filter(c.origData,function(a){return $XP(a,"areaID")==g}):c.origData,m=f.length>0?_.filter(m,function(a){return $XP(a,"cityID")==f}):m,m=h.length>0?_.filter(m,function(a){return $XP(a,"shopName")==h}):m,i=m.length,l=Math.ceil(i/e),m=_.filter(m,function(a,b){return b>=j&&k>b}),c.updateDataStore(m,d),c.updatePagerParams({pageCount:l,totalSize:i,pageNo:d,pageSize:e}),b(c)}}),Hualala.Account.AccountQueryShopResultModel=h}(jQuery,window),function(a){IX.ns("Hualala.Account");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.Shop.CardListView),c=b.subclass({constructor:b.prototype.constructor});c.proto({loadTemplates:function(){{var a=Handlebars.compile(Hualala.TplLib.get("tpl_account_list_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_account_list")),c=Handlebars.compile(Hualala.TplLib.get("tpl_account_card"));Handlebars.compile(Hualala.TplLib.get("tpl_addAccount_Card"))}Handlebars.registerPartial("accountCard",Hualala.TplLib.get("tpl_account_card")),this.set({layoutTpl:a,listTpl:b,itemTpl:c})},initLayout:function(){var a=this.get("layoutTpl"),b=a();this.$container.append(b),this.$resultBox=this.$container.find(".account-list"),this.$list=this.$container.find(".account-list-body"),this.$pager=this.$container.find(".page-selection"),this.initPager(),this.bindEvent(),this.bindCardEvent()},bindCardEvent:function(){var b=this;b.$list.on("click",".btn.withdraw",function(){var c=a(this),e=c.parents(".bank-card").attr("data-id");if(!c.hasClass("disabled")){new d({triggerEl:c,settleUnitID:e,model:b.model.getAccountModelByID(e),parentView:b})}}),b.on({updateSettleBalance:function(a){var c=a.get("settleUnitID"),d=a.get("settleBalance");b.$container.find("[data-id="+c+"] .cash > strong").html(d)}})},chkCtrlRight:function(){var a=this,b=Hualala.Common.getCurPageUserRight(),c=$XP(b,"right.disabled",[]),d=$XP(b,"right.enabled",[]);_.each(c,function(b){a.$list.find("[data-btn-name="+b+"]").attr("disabled",!0).addClass("invisible")}),_.each(d,function(b){a.$list.find("[data-btn-name="+b+"]").attr("disabled",!1).removeClass("invisible")})},mapRenderData:function(a){var b=_.map(a,function(a){var b=$XP(a,"settleUnitID"),c=0==$XP(a,"defaultAccount",0)?!1:!0,d=Hualala.Common.mapBankInfo($XP(a,"bankCode")),e=Hualala.Common.codeMask($XP(a,"bankAccount",""),0,-4),f=parseFloat($XP(a,"settleBalance",0));return{settleUnitID:b,hasDefault:c,settleUnitName:$XP(a,"settleUnitName",""),disableWithdraw:0>=f?"disabled":"",settleBalance:f,bankIcon:$XP(d,"icon_16",""),bankComName:$XP(d,"name",""),bankAccountStr:$XP(e,"val","").replace(/([\w|*]{4})/g,"$1 ").replace(/([*])/g,"<span>$1</span>"),shopCount:parseInt($XP(a,"shopCount",0)),path:Hualala.PageRoute.createPath("accountDetail",[b])}});return{accountCard:{list:b}}},render:function(){var a=this,b=a.model,c=b.getPagerParams(),d=$XP(c,"pageNo"),e=b.getAccounts(d),f=a.mapRenderData(e),g=a.get("listTpl"),h=g(f);a.emptyBar&&a.emptyBar.destroy(),a.$list.empty(),a.$list.html(h),a.chkCtrlRight(),a.initPager({total:b.get("pageCount"),page:b.get("pageNo"),href:"javascript:void(0);"})},refresh:function(){document.location.reload(!1)}}),Hualala.Account.AccountListView=c;var d=Stapes.subclass({constructor:function(a){if(this.$trigger=$XP(a,"triggerEl"),this.settleUnitID=$XP(a,"settleUnitID",null),this.model=$XP(a,"model",null),this.parentView=$XP(a,"parentView",null),this.modal=null,!this.settleUnitID||!this.model)throw"Withdraw Cash View init failed!";this.loadTemplates(),this.initModal(),this.renderForm(),this.bindEvent(),this.emit("show")}});d.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_withdraw_form")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns"));this.set({layoutTpl:a,btnTpl:b})},initModal:function(){var a=this;a.modal=new Hualala.UI.ModalDialog({id:"account_withdraw",clz:"service-modal",title:"结算账户提现",afterRemove:function(){}})},mapPoundageAmountStr:function(a){return IX.isEmpty(a)||0==a?"无手续费":"<strong>"+a+"</strong>元"},mapPoundageMinAmountStr:function(a){return IX.isEmpty(a)||0==a?"不限":"<strong>"+a+"</strong>元"},mapFormElsData:function(){var a=this,b=[{key:"settleUnitName",label:"结算账户名称"},{key:"receiverName",label:"开户名"},{key:"bankName",label:"开户行"},{key:"bankAccount",label:"账号"},{key:"settleBalance",label:"账户余额"},{key:"poundageAmount",label:"提现手续费"},{key:"poundageMinAmount",label:"免费提现最低金额"}],c=a.model.get("poundageAmount"),d=a.model.get("poundageMinAmount"),e='<p class="alert alert-warning ">由于提现操作需要向银行缴纳交易手续费<strong>{poundageAmount}</strong>元人民币，<br/>当提现金额高于<strong>{poundageMinAmount}</strong>(包含<strong>{poundageMinAmount}</strong>)元人民币，手续费由<strong>北京多来点信息技术有限公司</strong>支付；<br/>当提现金额低于<strong>{poundageMinAmount}</strong>元人民币，手续费由<strong>{settleUnitName}</strong>支付。<br/></p>',f="";IX.isEmpty(c)||0==c||(f=e.replaceAll("{poundageAmount}",c).replaceAll("{poundageMinAmount}",d).replaceAll("{settleUnitName}",a.model.get("settleUnitName")));var g=_.map(b,function(b){var c=$XP(b,"key"),d="";switch(c){case"poundageAmount":d=a.mapPoundageAmountStr(a.model.get(c));break;case"poundageMinAmount":d=a.mapPoundageMinAmountStr(a.model.get(c));break;case"settleBalance":d="<strong>"+a.model.get(c)+"</strong>元";break;default:d=a.model.get(c)}return{label:$XP(b,"label",""),value:d}});return{accountInfo:g,warningText:f,formClz:"account-withdraw-form form-feedback-out",labelClz:"col-sm-4 control-label",clz:"col-sm-7",id:"transAmount",label:"请输入提现金额",name:"transAmount",value:a.model.get("settleBalance")}},renderForm:function(){var a=this,b=a.mapFormElsData(),c=a.get("layoutTpl"),d=a.get("btnTpl"),e=c(b);a.modal._.body.html(e),a.modal._.footer.html(d({btns:[{clz:"btn-default",name:"cancel",label:"取消"},{clz:"btn-warning",name:"submit",label:"立即提现"}]}))},bindEvent:function(){var b=this;this.on({show:function(){this.modal.show()},hide:function(){this.modal.hide(),this.parentView.emit("updateSettleBalance",b.model)}}),b.modal._.dialog.find(".btn").on("click",function(){var c=a(this),d=c.attr("name");if("cancel"==d)b.emit("hide");else{var e=b.modal._.body.find("form").data("bootstrapValidator");c.button("提交中..."),e.validate()}}),b.modal._.body.find("form").bootstrapValidator({trigger:"blur",fields:{transAmount:{validators:{notEmpty:{message:"请输入提现金额"},numeric:{message:"提现金额必须为数字"},greaterThan:{inclusive:!1,value:b.model.get("poundageAmount")||0,message:"提现金额必须大于"+b.model.get("poundageAmount")||0},lessThan:{inclusive:!0,value:b.model.get("settleBalance"),message:"提现金额不能超过账户余额"},accuracy:{accuracy:2,message:"输入现金只能精确到小数点后2位"}}}}}).on("error.field.bv",function(b){{var c=a(b.target);c.data("bootstrapValidator")}}).on("success.form.bv",function(c){c.preventDefault();var d=a(c.target),e=(d.data("bootstrapValidator"),b.serializeForm());b.model.emit("withdrawCash",{params:e,failFn:function(){b.modal._.footer.find(".btn[name=submit]").button("reset")},successFn:function(){b.modal._.footer.find(".btn[name=submit]").button("reset"),b.emit("hide")}})})},serializeForm:function(){var a=this,b=a.modal._.body;return{transAmount:b.find("#transAmount").val()}}}),Hualala.Account.WithdrawCashView=d;var e={transCreateTime:{type:"section",label:"日期",min:{type:"datetimepicker",surfix:'<span class="glyphicon glyphicon-calendar"></span>',defaultVal:"",validCfg:{group:".min-input",validators:{}}},max:{type:"datetimepicker",surfix:'<span class="glyphicon glyphicon-calendar"></span>',defaultVal:"",validCfg:{group:".max-input",validators:{}}}},transAmount:{type:"section",label:"金额",min:{type:"text",prefix:"￥",surfix:"元",defaultVal:"",validCfg:{validators:{numeric:{message:"金额必须为数字"},greaterThan:{inclusive:!0,value:0,message:"金额必须大于或等于0"}}}},max:{type:"text",prefix:"￥",surfix:"元",defaultVal:"",validCfg:{validators:{numeric:{message:"金额必须为数字"},greaterThan:{inclusive:!0,value:0,message:"金额必须大于或等于0"}}}}},transStatus:{type:"combo",label:"状态",defaultVal:"",options:Hualala.TypeDef.FSMTransStatus,validCfg:{validators:{}}},transType:{type:"combo",label:"类型",defaultVal:"",options:Hualala.TypeDef.FSMTransType,validCfg:{validators:{}}},button:{type:"button",clz:"btn btn-block btn-warning",label:"查询"}},f=new IX.IListManager;_.each(e,function(a,b){var c=$XP(a,"type"),d="col-xs-2 col-sm-2 col-md-2 control-label";if("section"==c){var e=minID=b+"_min_"+IX.id(),g=b+"_max_"+IX.id(),h="transCreateTime"==b?"transCreateBeginTime":"minTransAmount",i="transCreateTime"==b?"transCreateEndTime":"maxTransAmount",j=IX.inherit($XP(a,"min",{}),{id:minID,name:h,clz:"col-xs-5 col-sm-5 col-md-5"}),k=IX.inherit($XP(a,"max",{}),{id:g,name:i,clz:"col-xs-5 col-sm-5 col-md-5"});f.register(b,IX.inherit(a,{id:e,labelClz:d,min:j,max:k}))}else f.register(b,IX.inherit(a,{id:b+"_"+IX.id(),name:b,labelClz:d},"button"!==$XP(a,"type")?{clz:"col-xs-5 col-sm-8 col-md-5"}:null))});var g=[{clz:"",label:"时间"},{clz:"",label:"流水号"},{clz:"",label:"交易状态"},{clz:"",label:"交易类型"},{clz:"",label:"交易金额"},{clz:"",label:"交易费用"},{clz:"",label:"余额变动"},{clz:"",label:"交易后余额"},{clz:"",label:"操作"}],h=b.subclass({constructor:function(){this.$container=null,this.$queryForm=null,this.$resultBox=null,this.$pager=null,this.loadTemplates()}});h.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_account_detail")),b=Handlebars.compile(Hualala.TplLib.get("tpl_transaQuery_result"));Handlebars.registerPartial("transaQueryForm",Hualala.TplLib.get("tpl_transaQuery_form")),Handlebars.registerPartial("transaQueryResult",Hualala.TplLib.get("tpl_transaQuery_result")),Handlebars.registerHelper("checkFormElementType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),Handlebars.registerHelper("chkColType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),this.set({layoutTpl:a,tableTpl:b})},initLayout:function(){var a=this.get("layoutTpl"),b=[],c="table-bordered table-striped table-hover ix-data-report",d=g,e={cols:[{colClz:"col-sm-6",items:f.getByKeys(["transCreateTime","transAmount"])},{colClz:"col-sm-4",items:f.getByKeys(["transType","transStatus"])},{colClz:"col-sm-2",items:f.getByKeys(["button"])}]},h=a({query:e,result:{clz:c,thead:d,rows:b}});this.$container.html(h),this.$queryForm=this.$container.find(".query-form"),this.$resultBox=this.$container.find(".query-result"),this.$pager=this.$container.find(".page-selection"),this.render(),this.initQueryEls(),this.bindEvent(),this.bindQueryEvent()},initQueryEls:function(){var b=this;b.$queryForm.find("[data-type=datetimepicker]").datetimepicker({format:"yyyy/mm/dd",startDate:"2010/01/01",autoclose:!0,minView:"month",todayBtn:!0,todayHighlight:!0,language:"zh-CN"}),b.$queryForm.on("click",".input-group-addon",function(){var b=a(this),c=b.prev(":text[data-type=datetimepicker]");c.length>0&&c.datetimepicker("show")})},bindEvent:function(){var b=this;b.$resultBox.tooltip({selector:"[title]"}),b.$resultBox.on("click",".btn[data-href]",function(){var b=a(this),c=b.attr("data-href");IX.isEmpty(c)||(document.location.href=c)}),b.$pager.on("page",function(a,c){var d=b.model.getPagerParams();d.pageNo=c,b.model.emit("load",IX.inherit(d,{pageNo:$XP(d,"pageNo",1),pageSize:$XP(d,"pageSize",15)}))})},bindQueryEvent:function(){var b=this;b.$resultBox.on("click","a[data-orderkey]",function(){{var b=a(this),c=b.attr("data-orderkey")||"",d=b.attr("data-type")||"",e=b.attr("data-id")||"",f=b.attr("data-orderid")||"";new Hualala.Account.AccountTransDetailModal({triggerEl:b,orderKey:c,orderID:f,transType:d,transID:e})}}),b.$queryForm.on("click",".btn",function(){var a=b.getQueryFormParams();b.model.emit("load",a)})},getQueryFormParams:function(){var a=this,b=a.$queryForm.find(">form").serializeArray(),c={};return _.each(b,function(a){var b=$XP(a,"name"),d=$XP(a,"value","");switch(b){case"transCreateBeginTime":case"transCreateEndTime":d=IX.isEmpty(d)?"":IX.Date.getDateByFormat(d,"yyyyMMddHHmmss");break;default:d=IX.isEmpty(d)?"":d}c[b]=d}),IX.Debug.info("DEBUG: Account TransList View Query Form Params : "),IX.Debug.info(c),c},mapTimeData:function(a){var b={value:"",text:"",clz:"date"},c="";return IX.isString(a)&&a.length>0&&(c=a.replace(/([\d]{4})([\d]{2})([\d]{2})([\d]{2})([\d]{2})([\d]{2})/g,"$1/$2/$3 $4:$5:$6"),c=IX.Date.getDateByFormat(c,"yyyy/MM/dd HH:mm"),b=IX.inherit({value:a,text:c})),b},mapTransStatus:function(a){a=a+""||"";var b=Hualala.TypeDef.FSMTransStatus,c=_.filter(b,function(b){return $XP(b,"value","")==a});return 0==a.length||0==c.length?{text:"",value:""}:{text:$XP(c[0],"label",""),value:$XP(c[0],"value",""),clz:"status"}},mapTransType:function(a){a=a||"";var b=Hualala.TypeDef.FSMTransType,c=_.filter(b,function(b){return $XP(b,"value","")==a});return 0==a.length||0==c.length?{text:"",value:""}:{text:$XP(c[0],"label",""),value:$XP(c[0],"value",""),clz:"text"}},mapCashData:function(a){return{text:Hualala.Common.Math.prettyNumeric(Hualala.Common.Math.standardPrice(a)),value:a,clz:"number"}},mapTransChanged:function(a){var b=$XP(a,"transAmount",0),c=$XP(a,"transSalesCommission",0),d=$XP(a,"transPoundage",0),e=Hualala.Common.Math.sub(b,c,d);return{value:e,text:Hualala.Common.Math.prettyNumeric(e),clz:"number"}},mapColsRenderData:function(a){var b=this,c="transCreateTime,SUATransItemID,transStatus,transType,transAmount,transactionCost,transChanged,transAfterBalance,rowControl",d={clz:"",type:"text"},e=_.map(c.split(","),function(c){var e=null;switch(c){case"transCreateTime":e=b.mapTimeData($XP(a,c,""));break;case"SUATransItemID":e={value:$XP(a,c,""),text:$XP(a,c,""),clz:"number"};break;case"transStatus":e=b.mapTransStatus($XP(a,c,""));break;case"transType":e=b.mapTransType($XP(a,c,""));break;case"transAmount":case"transAfterBalance":e=b.mapCashData($XP(a,c,""));break;case"transactionCost":var f=$XP(a,"transSalesCommission",0),g=$XP(a,"transPoundage",0),h=Hualala.Common.Math.add(f,g);e=b.mapCashData(h);break;case"transChanged":e=b.mapTransChanged(a);break;case"rowControl":var i=$XP(a,"transType",""),j=$XP(a,"transStatus",""),k="104,199,202,203,204,205,206,299";e={type:"button",btnClz:k.indexOf(i)>=0||"203"==i&&1>j?"hidden":"",label:"查看",SUATransItemID:$XP(a,"SUATransItemID",""),transType:i,orderKey:$XP(a,"orderKey",""),orderID:$XP(a,"orderID","")}}return IX.inherit(d,e)});return e},mapRenderData:function(a){var b=this,c="table-bordered table-striped table-hover ix-data-report",d=g,e=_.map(a,function(a){return{clz:"",cols:b.mapColsRenderData(a)}});return{clz:c,isEmpty:0==a.length?!0:!1,colCount:d.length,thead:d,rows:e}},render:function(){var a=this,b=a.model,c=b.getPagerParams(),d=$XP(c,"pageNo"),e=b.getDataByPageNo(d),f=a.mapRenderData(e),g=a.get("tableTpl"),h=g(f);a.$resultBox.empty(),a.$resultBox.html(h),a.initPager({total:b.get("pageCount"),page:b.get("pageNo"),href:"javascript:void(0);"})}}),Hualala.Account.AccountTransListView=h;var i=Hualala.Shop.QueryView.subclass({constructor:Hualala.Shop.QueryView.prototype.constructor});Hualala.Account.AccountQueryShopView=i;var j=b.subclass({constructor:b.prototype.constructor});j.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_shop_list_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_list")),c=Handlebars.compile(Hualala.TplLib.get("tpl_shop_table"));Handlebars.registerPartial("shopTable",Hualala.TplLib.get("tpl_shop_table")),this.set({layoutTpl:a,listTpl:b,itemTpl:c})},mapRenderData:function(a){var b=_.map(a,function(a){return{clz:"",id:$XP(a,"shopID",""),name:$XP(a,"shopName",""),city:$XP(a,"cityName","")}});return{shopTable:{isEmpty:a&&0!=a.length?!1:!0,colCount:3,rows:b}}},render:function(){var a=this,b=a.model,c=b.getPagerParams(),d=$XP(c,"pageNo"),e=b.getShops(d),f=a.mapRenderData(e),g=a.get("listTpl"),h=g(f);a.$list.empty(),a.$list.html(h),a.initPager({total:b.get("pageCount"),page:b.get("pageNo"),href:"javascript:void(0);"})}}),Hualala.Account.AccountQueryShopResultView=j}(jQuery,window),function(){IX.ns("Hualala.Account");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.Account.AccountListModel,Hualala.Account.AccountListView,Hualala.Shop.ShopListController),b=(Hualala.Shop.QueryModel,Hualala.Shop.QueryView,Hualala.Shop.QueryController),c=a.subclass({constructor:a.prototype.constructor});Hualala.Account.AccountListController=c;var d=b.subclass({constructor:function(a){this.set({sessionData:Hualala.getSessionData()}),this.settleUnitID=$XP(a,"settleUnitID",""),this.settleName=$XP(a,"settleName",""),this.shopCount=$XP(a,"shopCount",""),this.container=$XP(a,"container",null),this.needShopCreate=!1,this.model=new Hualala.Account.AccountQueryShopModel,this.view=new Hualala.Account.AccountQueryShopView,this.resultContainer=$XP(a,"resultContainer",null),this.resultController=new Hualala.Account.AccountQueryShopResultController({container:this.resultContainer,model:new Hualala.Account.AccountQueryShopResultModel,view:new Hualala.Account.AccountQueryShopResultView}),this.init()}});d.proto({init:function(){var a=this;a.bindEvent(),a.model.emit("load",function(){if(!a.model.hasReady())throw"Shop Query Init Failed!!";
a.resultController.initDataStore(a.model.getShops()),a.view.emit("init")})},bindEvent:function(){this.on({reload:function(){var a=this;a.model.distory(),a.view.distory(),a.init()},query:function(a){var b=this;IX.Debug.info("DEBUG: Account Query Shops Params:"),IX.Debug.info(a),b.resultController&&b.resultController.emit("load",IX.inherit(a,{pageNo:1,pageSize:15}))}},this),this.model.on({load:function(a){var b=this,c={settleUnitID:b.settleUnitID,settleName:b.settleName,shopCount:b.shopCount};b.model.init(c,a)}},this),this.view.on({init:function(){var a=this;a.view.init({model:a.model,needShopCreate:a.needShopCreate,container:a.container})},filter:function(a){var b=this;b.emit("query",a)},query:function(a){var b=this;b.emit("query",a)}},this)}}),Hualala.Account.AccountQueryShopController=d;var e=Hualala.Shop.ShopListController.subclass({constructor:Hualala.Shop.ShopListController.prototype.constructor});e.proto({initDataStore:function(a){this.model.initDataStore(a)},bindEvent:function(){this.on({load:function(a){var b=this;b.hasReady()||b.init(a),b.model.emit("load",a)}},this),this.model.on({load:function(a){var b=this,c=function(){b.view.emit("render")};b.model.load(a,c)}},this),this.view.on({render:function(){var a=this;a.view.render()},reloadPager:function(){var a=this;a.view.initPager(params)}},this)}}),Hualala.Account.AccountQueryShopResultController=e}(jQuery,window),function(){IX.ns("Hualala.Account");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.UI.LoadingModal),b=(Hualala.Account.BaseAccountModel,Stapes.subclass({constructor:function(a){if(this.container=$XP(a,"container",null),this.settleUnitID=$XP(a,"settleUnitID",null),this.model=$XP(a,"accountModel",null),this.view=$XP(a,"mgrView",null),this.transaDetailCtrl=$XP(a,"transaDetailCtrl",null),!(this.container&&this.model&&this.view&&this.transaDetailCtrl))throw"Account Detail Mgr Init Failed!!";this.init()}}));b.proto({init:function(){var a=this;a.bindEvent(),a.model.emit("load",{settleUnitID:a.settleUnitID,cbFn:function(){a.view.emit("init",{model:a.model,container:a.container}),a.view.emit("render")}})},bindEvent:function(){this.on({query:function(){}},this),this.view.on({init:function(a){var b=this;b.view.init(a),b.transaDetailCtrl.init({container:b.container.find(".account-detail-box"),settleUnitID:b.settleUnitID})},render:function(){var a=this;a.view.render()}},this)}}),Hualala.Account.AccountMgrController=b;var c=Stapes.subclass({constructor:function(){this.set({sessionData:Hualala.getSessionData()}),this.container=null,this.settleUnitID=null,this.model=new Hualala.Account.AccountTransListModel,this.view=new Hualala.Account.AccountTransListView}});c.proto({init:function(b){var c=this;if(c.container=$XP(b,"container",null),c.settleUnitID=$XP(b,"settleUnitID",""),c.loadingModal=new a({start:100}),!this.container||!this.model||!this.view)throw"Account Transaction Detail Mgr Init Failed!!";c.bindEvent(),c.model.init({groupID:$XP(c.get("sessionData"),"site.groupID"),settleUnitID:c.settleUnitID}),c.model.emit("load",{pageNo:1,pageSize:15,cbFn:function(a){c.view.emit("init",{container:c.container,model:a}),c.loadingModal.hide()}})},bindEvent:function(){this.model.on({load:function(a){var b=this,c=$XP(a,"cbFn",function(){b.view.emit("render"),b.loadingModal.hide()});b.loadingModal.show(),this.model.load(a,c)}},this),this.view.on({init:function(a){this.view.init(a)},render:function(){this.view.render()}},this)}}),Hualala.Account.TransactionDetailController=c}(jQuery,window),function(a){IX.ns("Hualala.Account");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip),c=[{clz:"btn-success withdraw",act:"withdraw",label:"提现"},{clz:"btn-link",act:"edit",label:"修改财务人员信息"},{clz:"btn-link",act:"queryShops",label:"查看全部店铺"},{clz:"btn-link",act:"delete",label:"删除此帐户"}],d=Stapes.subclass({constructor:function(){this.$container=null,this.$nav=null,this.breadCrumbs=null,this.$schema=null,this.$detail=null,this.model=null,this.loadTemplates()}});d.proto({init:function(a){if(this.$container=$XP(a,"container",null),this.model=$XP(a,"model",null),!this.$container||!this.model)throw"Account Detail View Init Failed!";this.initLayout()},initLayout:function(){var a=this.get("layoutTpl"),b=a();this.$container.html(b),this.$nav=this.$container.find(".account-nav"),this.$schema=this.$container.find(".account-schema-box"),this.$detail=this.$container.find(".account-detail-box"),this.bindEvent()},initBreadCrumbs:function(){var b=this,c=b.$nav,d=Hualala.PageRoute.getParentNamesByPath();b.breadCrumbs=new Hualala.UI.BreadCrumb({container:c,hideRoot:!0,nodes:d,clz:"account-crumbs",clickFn:function(){var b=a(this);document.location.href=b.attr("data-href")},mapRenderData:function(a,c,d){var e=_.map(a,function(c,d){var e=$XP(c,"label",""),f=$XP(c,"name",""),g=Hualala.PageRoute.createPath(f,[b.model.get("settleUnitID")]);return{clz:"crumb",label:e,path:g,name:f,isLastNode:a.length-1==d?!0:!1}});return c===!0&&e.shift(),{clz:d,items:e}}})},loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_accountMgr_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_account_schema")),c=Handlebars.compile(Hualala.TplLib.get("tpl_withdraw_form"));Handlebars.registerPartial("accountCard",Hualala.TplLib.get("tpl_account_card")),this.set({layoutTpl:a,schemaTpl:b,withDrawTpl:c})},bindEvent:function(){var b=this;b.$schema.on("click",".btn.withdraw",function(){a(this).hasClass("disabled")||b.withdraw(a(this))}),b.$schema.on("click","[data-act]",function(){var c=a(this),d=c.attr("data-act");if(!c.hasClass("disabled"))switch(d){case"edit":b.editAccount(c);break;case"queryShops":b.queryShops();break;case"delete":b.deleteAccount()}}),b.on({updateSettleBalance:function(a){var c=a.get("settleUnitID"),d=Hualala.Common.Math.prettyNumeric(a.get("settleBalance"));b.$container.find("[data-id="+c+"] .cash > strong").html(d)}})},editAccount:function(a){new g({triggerEl:a,mode:"edit",model:this.model,parentView:this})},withdraw:function(a){{var b=this;new Hualala.Account.WithdrawCashView({triggerEl:a,settleUnitID:b.model.get("settleUnitID"),model:b.model,parentView:b})}},queryShops:function(a){{var b=this;new Hualala.Account.AccountQueryShopModal({triggerEl:a,settleUnitID:b.model.get("settleUnitID"),model:b.model,parentView:b})}},deleteAccount:function(){var a=this;Hualala.UI.Confirm({title:"删除结算账户",msg:"是否删除该账户？",okLabel:"删除",okFn:function(){a.model.emit("delete",{successFn:function(a){document.location.href=Hualala.PageRoute.createPath("account",[a])}})}})},mapRenderData:function(){var a=this,b=a.model,d=c,e=_.filter(IX.clone(d),function(a){return"withdraw"!=$XP(a,"act")}),f=null,g=b.get("settleUnitID")||"",h=0==b.get("defaultAccount")?!1:!0,i=Hualala.Common.mapBankInfo(b.get("bankCode")),j=Hualala.Common.codeMask(b.get("bankAccount")||"",0,-4),k=parseFloat(b.get("settleBalance")||0),l=parseInt(b.get("shopCount")||0),m=0>=k?"disabled":"";return f={clz:"pull-left",settleUnitID:g,hasDefault:h,settleUnitName:b.get("settleUnitName")||"",disableWithdraw:m,settleBalance:k,bankIcon:$XP(i,"icon_16",""),bankComName:$XP(i,"name",""),bankAccountStr:$XP(j,"val","").replace(/([\w|*]{4})/g,"$1 ").replace(/([*])/g,"<span>$1</span>"),shopCount:l,path:Hualala.PageRoute.createPath("accountDetail",[g]),isDetail:!0,acts:IX.map(e,function(a,b){var c=$XP(a,"act","");return IX.inherit(a,{isFirst:0==b?!0:!1,disabled:"delete"!=c||0==k&&0==l?"":"disabled"})})},{accountCard:f,acts:_.map(d,function(a){var b=$XP(a,"act","");return"queryShops"==b?IX.inherit(a,{label:$XP(a,"label","")+"("+l+")"}):"withdraw"==b?IX.inherit(a,{disableWithdraw:m}):"delete"==b?IX.inherit(a,{disabled:0!=k||0!=l?"disabled":""}):a})}},render:function(){var a=this,b=(a.model,a.mapRenderData()),c=a.get("schemaTpl"),d=c(b);a.initBreadCrumbs(),a.$schema.html(d)},refresh:function(){this.render()}}),Hualala.Account.AccountMgrView=d;var e={receiverType:{type:"radiogrp",label:"收款方类型",defaultVal:2,options:Hualala.TypeDef.AccountReceiverTypes,validCfg:{validators:{}}},receiverName:{type:"text",label:"收款单位/姓名",defaultVal:"",validCfg:{validators:{notEmpty:{message:"请输入收款单位/姓名"},stringLength:{max:20,message:"收款单位/姓名不能超过20个字"}}}},settleUnitName:{type:"text",label:"结算账户名称",defaultVal:"",validCfg:{validators:{notEmpty:{message:"请输入结算账户名称"},stringLength:{max:50,message:"结算账户名称不能超过50个字"}}}},bankAccount:{type:"text",label:"转账账号",defaultVal:"",validCfg:{validators:{notEmpty:{message:"请输入转账账号"},stringLength:{max:30,message:"转账账号不能超过30个字"}}}},bankCode:{type:"combo",label:"转账银行",defaultVal:"CMB",options:Hualala.TypeDef.BankOptions,validCfg:{validators:{notEmpty:{message:"请选择转账银行"}}}},bankName:{type:"text",label:"转账分行",defaultVal:"",prefix:'<span class="bank-name-icon icon-CMB-16"></span>',validCfg:{validators:{notEmpty:{message:"请输入转账分行名称"},stringLength:{max:40,message:"转账分行不能超过40个字"}}}},remark:{type:"text",label:"备注",defaultVal:"",validCfg:{validators:{stringLength:{max:250,message:"备注不能超过250个字"}}}},defaultAccount:{type:"switcher",label:"默认账户",defaultVal:1,onLabel:"开启",offLabel:"关闭",helpClz:"help-block col-sm-12 text-center form-help-cutoff",help:"<span class='cutoff'></span><span class='cutoff-text text-warning'>如需更改请与哗啦啦客服联系。</span>",validCfg:{validators:{}}},receiverLinkman:{type:"text",label:"姓名",defaultVal:"",prefix:'<span class="glyphicon glyphicon-user"></span>',validCfg:{validators:{notEmpty:{message:"请输入姓名"},stringLength:{max:20,message:"姓名不能超过20个字"}}}},receiverMobile:{type:"text",label:"手机",defaultVal:"",prefix:'<span class="glyphicon glyphicon-phone"></span>',validCfg:{validators:{notEmpty:{message:"请输入手机号"},mobile:{message:"请输入正确手机号"}}}},receiverEmail:{type:"text",label:"邮箱",defaultVal:"",prefix:'<span class="glyphicon glyphicon-envelope"></span>',validCfg:{validators:{emailAddress:{message:"请输入正确邮箱账号"}}}}},f=new IX.IListManager;_.each(e,function(a,b){var c=$XP(a,"type"),d="col-sm-offset-1 col-sm-3 control-label";if("radiogrp"==c){var e=_.map($XP(a,"options"),function(a){return IX.inherit(a,{id:b+"_"+IX.id(),name:b,clz:"col-sm-5 radio-inline"})});f.register(b,IX.inherit(a,{id:"",options:e,labelClz:d,clz:"col-sm-5"}))}else f.register(b,IX.inherit(a,{id:b+"_"+IX.id(),name:b,labelClz:d,clz:"col-sm-5"}))});var g=Stapes.subclass({constructor:function(a){this.$trigger=$XP(a,"trigger",null),this.mode=$XP(a,"mode","edit"),this.model=$XP(a,"model",null)||new Hualala.Account.BaseAccountModel,this.parentView=$XP(a,"parentView",null),this.modal=null,this.formKeys="settleUnitName,receiverType,receiverName,bankAccount,bankCode,bankName,remark,defaultAccount,receiverLinkman,receiverMobile,receiverEmail".split(","),this.loadTemplates(),this.initModal(),this.renderForm(),this.bindEvent(),this.resetBankCode(),this.emit("show")}});g.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_account_edit")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns"));Handlebars.registerHelper("checkFormElementType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),Handlebars.registerHelper("isInputGroup",function(a,b,c){return a||b?c.fn(this):c.inverse(this)}),this.set({layoutTpl:a,btnTpl:b})},getModalTitle:function(){return("edit"==this.mode?"修改":"增加")+"财务人员信息"},initModal:function(){var a=this;a.modal=new Hualala.UI.ModalDialog({id:"account_edit",clz:"account-modal",title:a.getModalTitle(),afterRemove:function(){}})},mapFormElsData:function(){var a=this,b=a.mode,c=a.formKeys,d=_.map(c,function(c){var d=f.get(c),e=$XP(d,"type");if("combo"==e){var g=a.model.get(c)||$XP(d,"defaultVal"),h=_.map($XP(d,"options"),function(a){return IX.inherit(a,{selected:$XP(a,"value")==g?"selected":""})});return IX.inherit(d,{disabled:"edit"==b?"disabled":"",value:g,options:h})}if("radiogrp"==e){var g=a.model.get(c)||$XP(d,"defaultVal"),h=_.map($XP(d,"options"),function(a){return IX.inherit(a,{disabled:"edit"==b?"disabled":"",checked:$XP(a,"value")==g?"checked":""})});return IX.inherit(d,{value:g,options:h})}return"switcher"==e?IX.inherit(d,{disabled:"edit"==b?"disabled":"",checked:a.model.get(c)==$XP(d,"defaultVal")?"checked":""}):IX.inherit(d,{disabled:"edit"!==b?"":"receiverLinkman"==c||"receiverMobile"==c||"receiverEmail"==c?"":"disabled",value:a.model.get(c)||$XP(d,"defaultVal")})});return d},renderForm:function(){var a=this,b=a.mapFormElsData(),c=a.mode,d=a.get("layoutTpl"),e=a.get("btnTpl"),f=d({formClz:"account-form form-feedback-out",items:b});a.modal._.body.html(f),a.modal._.footer.html(e({btns:[{clz:"btn-default",name:"cancel",label:"取消"},{clz:"btn-warning",name:"submit",label:"edit"==c?"保存":"添加"}]})),a.initSwitcher(":checkbox[data-type=switcher]")},initValidFieldOpts:function(){var a=this,b=a.formKeys,c={};return _.each(b,function(a){var b=f.get(a),d=$XP(b,"type");if("section"==d){var e=a+"_min",g=a+"_max";c[e]=$XP(b,"min.validCfg",{}),c[g]=$XP(b,"max.validCfg",{})}else c[a]=$XP(b,"validCfg",{})}),c},bindEvent:function(){var b=this,c=b.initValidFieldOpts();this.on({show:function(){this.modal.show()},hide:function(){this.modal.hide()}}),b.modal._.dialog.find(".btn").on("click",function(){var c=a(this),d=c.attr("name");if("cancel"==d)b.emit("hide");else{var e=b.modal._.body.find("form").data("bootstrapValidator");c.button("提交中..."),e.validate()}}),b.modal._.body.find("form [name=bankCode]").on("change",function(){var c=a(this),d=b.modal._.body.find("form .bank-name-icon"),e=c.val();d.trigger("change",e)}),b.modal._.body.find("form .bank-name-icon").on("change",function(b,c){var d=a(this),e=Hualala.Common.mapBankInfo(c);IX.Debug.info("DEBUG: Account Bank Info : "),IX.Debug.info(e),d.removeClass().addClass("bank-name-icon "+$XP(e,"icon_16",""))}),b.modal._.body.find("form").bootstrapValidator({trigger:"blur",fields:c}).on("error.field.bv",function(b){{var c=a(b.target);c.data("bootstrapValidator")}}).on("success.form.bv",function(c){c.preventDefault();var d=a(c.target),e=(d.data("bootstrapValidator"),b.serializeForm());IX.Debug.info("DEBUG: Account Edit View Form Params : "),IX.Debug.info(e),b.model.emit(b.mode,{params:e,failFn:function(){b.modal._.footer.find(".btn[name=submit]").button("reset")},successFn:function(){b.modal._.footer.find(".btn[name=submit]").button("reset"),b.parentView&&IX.isFn(b.parentView.refresh)&&b.parentView.refresh(),b.emit("hide")}})})},resetBankCode:function(){var a=this,b=a.modal._.body.find("form [name=bankCode]").val();a.modal._.body.find("form .bank-name-icon").trigger("change",b)},initSwitcher:function(b){var c=this;c.modal._.body.find(b).each(function(){var b=a(this),c=b.attr("data-onLabel"),d=b.attr("data-offLabel");b.bootstrapSwitch({size:"normal",onColor:"primary",offColor:"default",onText:c,offText:d})})},serializeForm:function(){{var b=this,c=b.formKeys,d={};_.map(c,function(b){var c=f.get(b),e=$XP(c,"type");d[b]="switcher"==e?a("[name="+b+"]").data("bootstrapSwitch").options.state?1:0:"radiogrp"==e?a("[name="+b+"]:checked").val():a("[name="+b+"]").val()})}return d}}),Hualala.Account.AccountEditView=g;var h=Stapes.subclass({constructor:function(a){this.$trigger=$XP(a,"trigger",null),this.model=$XP(a,"model",null),this.parentView=$XP(a,"parentView",null),this.modal=null,this.$queryBox=null,this.$resultBox=null,this.queryCtrl=null,this.set({settleUnitID:this.model.get("settleUnitID"),settleName:this.model.get("settleUnitName"),shopCount:this.model.get("shopCount")}),this.loadTemplates(),this.initModal(),this.render(),this.bindEvent(),this.initQueryBox(),this.emit("show")}});h.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_account_query_shop")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns"));this.set({layoutTpl:a,btnTpl:b})},initModal:function(){var a=this;a.modal=new Hualala.UI.ModalDialog({id:"account_query_shop",clz:"account-modal",title:"结算账户关联店铺",afterRemove:function(){}})},render:function(){var a=this,b=a.get("layoutTpl"),c=a.get("btnTpl"),d=a.model.get("settleUnitName")||"",e=[{clz:"btn-default",name:"cancel",label:"关闭"}],f=b({clz:"",title:d,label:"结算账户名称"});a.modal._.body.html(f),a.modal._.footer.html(c({btns:e})),a.$queryBox=a.modal._.body.find(".query-box"),a.$resultBox=a.modal._.body.find(".result-box")},bindEvent:function(){var b=this;this.on({show:function(){b.modal.show()},hide:function(){b.modal.hide()}}),b.modal._.dialog.find(".btn").on("click",function(){var c=a(this),d=c.attr("name");"cancel"==d&&b.emit("hide")})},initQueryBox:function(){var a=this;a.queryCtrl=new Hualala.Account.AccountQueryShopController({container:a.$queryBox,resultContainer:a.$resultBox,settleUnitID:a.get("settleUnitID"),settleName:a.get("settleName"),shopCount:a.get("shopCount")})}}),Hualala.Account.AccountQueryShopModal=h;var i=Hualala.Constants.PersonUnit,j=Hualala.Constants.CashUnit,k=function(a){if(IX.isEmpty(a))return"";var b=Hualala.TypeDef.ShopBusiness,c=_.find(b,function(b){var c=$XP(b,"id");return c==a});return c?$XP(c,"label",""):""},l=function(a){if(IX.isEmpty(a))return"";var b=Hualala.TypeDef.GENDER,c=_.find(b,function(b){var c=$XP(b,"value");return c==a});return c?$XP(c,"label",""):""},m=function(a,b){var c=$XP(a,"label",""),d=$XP(a,"fieldType",""),e=$XP(a,"fields",[]),f=$XP(b,"userSex","");f=IX.isEmpty(f)?"":"("+l(f)+")";var g=_.map(e,function(a){var c=q[a],d=$XP(c,"label",""),e=$XP(c,"unit",""),g=$XP(c,"clz",""),h=$XP(b,a,"");return h+="userName"==a?f:"",h+=e,{key:a,clz:g,label:d,value:h}});return{label:c,fieldType:d,fields:g}},n=function(a,b){var c=$XP(a,"label",""),d=$XP(a,"fieldType",""),e=$XP(a,"fields",[]),f=$XP(b,"orderSubType",""),g=k(f);g=IX.isEmpty(g)?"":"("+g+")";var h=_.map(e,function(a){var c=q[a],d=$XP(c,"label",""),e=$XP(c,"unit",""),g=$XP(c,"clz",""),h=$XP(b,a,"");switch(a){case"timeName":case"consumptionTypeName":case"promotionDesc":case"orderRemark":g+=IX.isEmpty(h)?" hidden":"";break;case"orderTime":case"orderCreateTime":h=IX.Date.getDateByFormat(Hualala.Common.formatDateTimeValue(h),"yyyy/MM/dd HH:mm");break;case"statusName":var i=$XP(b,"isAlreadyPaid",0),j=$XP(b,"orderStatus",""),k="";k=j>=20&&1==i?"<span>线上付款</span>":j>=20&&0==i?'<span color="red">'+(20==j?"餐到付款":"到店付款")+"</span>":"<span>未付款</span>",k="("+k+")",h+=k;break;case"takeoutAddress":g+=20==f||21==f?"":" hidden"}return h+=e,{key:a,clz:g,label:d,value:h}});return{label:c,orderSubTypeLabel:g,fieldType:d,fields:h}},o=function(a,b){var c=$XP(a,"label",""),d=$XP(a,"fieldType",""),e=$XP(a,"fields",[]),f=$XP(b,"orderSubType",""),g=_.map(e,function(a){var c=q[a],d=$XP(c,"label",""),e=$XP(c,"unit",""),g=$XP(c,"clz",""),h=$XP(b,a,"");switch(a){case"serviceAmount":case"discountAmount":case"freeAmount":case"giftAmount":case"cardDiscountAmount":case"pointBalance":case"moneyBalance":case"orderRefundAmount":g+=0==h?" hidden":"";break;case"presentInfo":g+=IX.isEmpty(h)?" hidden":"";break;case"takeoutPackagingAmount":g+=20==f||21==f?"":" hidden"}return h+=e,{key:a,clz:g,label:d,value:h}});return{label:c,fieldType:d,fields:g}},p=function(a,b){var c=$XP(a,"label",""),d=$XP(a,"fieldType",""),e=$XP(a,"fields",[]),f=$XP(b,"records",[]),g=_.groupBy(f,function(a){return $XP(a,"foodCategoryID")});return g=_.map(g,function(a,b){var c="",d=a.length,f=_.map(a,function(a){var b={};return _.each(e,function(d){var e=$XP(a,d,""),f=IX.isEmpty(q[d])||IX.isEmpty(q[d].unit)||"foodAmount"==d?"":q[d].unit;"foodAmount"==d&&(e=Hualala.Common.Math.prettyPrice(e)),"foodCategoryName"==d&&(c=e),b[d]=e+f}),b});return{foodCategoryName:c,foodCategorySum:"("+d+")",foodCategoryID:b,rows:f}}),{fieldType:d,label:c,categories:g}},q={userName:{label:"姓名",clz:"col-xs-6"},userLoginMobile:{label:"手机",clz:"col-xs-6"},orderID:{label:"订单号",clz:"col-xs-6"},orderCheckPWD:{label:"消费密码",clz:"col-xs-6"},person:{label:"人数",unit:i,clz:"col-xs-6"},timeName:{label:"餐段名称",clz:"col-xs-6"},tableName:{label:"桌台号",clz:"col-xs-6"},shopOrderKey:{label:"餐饮软件凭证号",clz:"col-xs-6"},orderTime:{label:"用餐时间",clz:"col-xs-12"},orderCreateTime:{label:"下单时间",clz:"col-xs-12"},statusName:{label:"订餐状态",clz:"col-xs-12"},takeoutAddress:{label:"外送地址",clz:"col-xs-6"},consumptionTypeName:{label:"用餐类型",clz:"col-xs-12"},promotionDesc:{label:"店家促销描述",clz:"col-xs-12"},orderRemark:{label:"订单备注",clz:"col-xs-12"},foodAmount:{label:"菜品金额",unit:j,clz:"col-xs-6"},serviceAmount:{label:"服务费",unit:j,clz:"col-xs-6"},paidAmount:{label:"买单前已付金额",unit:j,clz:"col-xs-6"},promotionTotalAmount:{label:"餐饮软件优惠金额",unit:j,clz:"col-xs-6"},discountAmount:{label:"商家折免",unit:j,clz:"col-xs-6"},freeAmount:{label:"商家减免",unit:j,clz:"col-xs-6"},giftAmount:{label:"商家代金券金额",unit:j,clz:"col-xs-6"},presentInfo:{label:"赠送",clz:"col-xs-6"},cardDiscountAmount:{label:"会员卡优惠",unit:j,clz:"col-xs-6"},pointBalance:{label:"积分抵扣",unit:j,clz:"col-xs-6"},moneyBalance:{label:"会员卡余额支付",unit:j,clz:"col-xs-6"},takeoutPackagingAmount:{label:"打包费",unit:j,clz:"col-xs-6"},orderTotal:{label:"订单金额",unit:j,clz:"col-xs-6"},orderRefundAmount:{label:"退款金额",unit:j,clz:"col-xs-6"},shopName:{label:"店铺名称",clz:"col-xs-6"},shopTel:{label:"电话",clz:"col-xs-6"},foodPrice:{label:"菜品价格",unit:j}},r={userFields:{label:"个人信息",fieldType:"list",fields:["userName","userLoginMobile"],mapFn:m},orderFields:{label:"订单信息",fieldType:"list",fields:["orderID","orderCheckPWD","person","timeName","tableName","shopOrderKey","orderTime","orderCreateTime","statusName","takeoutAddress","consumptionTypeName","promotionDesc","orderRemark"],mapFn:n},payFields:{label:"支付详情",fieldType:"list",fields:["foodAmount","serviceAmount","paidAmount","promotionTotalAmount","discountAmount","freeAmount","giftAmount","presentInfo","cardDiscountAmount","pointBalance","moneyBalance","takeoutPackagingAmount","orderTotal","orderRefundAmount","shopName","shopTel"],mapFn:o},foodsFields:{label:"菜品信息",fieldType:"table",fields:["foodCategoryName","foodCategoryID","foodName","foodUnit","foodPrice","foodAmount"],mapFn:p}},s=Stapes.subclass({constructor:function(a){if(this.$trigger=$XP(a,"triggerEl"),this.orderKey=$XP(a,"orderKey",""),this.orderID=$XP(a,"orderID",""),this.transType=$XP(a,"transType",""),this.transID=$XP(a,"transID",""),this.transTypes=Hualala.TypeDef.FSMTransType,this.transTypeHT=new IX.IListManager,this.initTransTypeLib(),this.modal=null,this.tplName=$XP(this.transTypeHT.get(this.transType),"tpl",null),this.callServerName=$XP(this.transTypeHT.get(this.transType),"queryCall",null),this.callServer=null,IX.isFn(this.callServerName))this.callServer=this.callServerName;else{if(!IX.isString(this.callServerName))throw"Configuration failed : Invalid Page Initialized for "+this.callServerName;IX.nsExisted(this.callServerName)&&(this.callServer=IX.getNS(this.callServerName))}return this.queryKeys=$XP(this.transTypeHT.get(this.transType),"queryKeys",null),this.tplName&&this.callServer?(this.loadTemplates(),this.initModal(),this.bindEvent(),void this.emit("load",this.mapQueryParams())):null}});s.proto({initTransTypeLib:function(){var a=this;_.each(this.transTypes,function(b){var c=$XP(b,"value","").toString();c.length>0&&a.transTypeHT.register(c,b)})},loadTemplates:function(){var a=this,b=Handlebars.compile(Hualala.TplLib.get(a.tplName)),c=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns"));Handlebars.registerHelper("chkFieldType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),this.set({layoutTpl:b,btnTpl:c})},initModal:function(){var a=this;a.modal=new Hualala.UI.ModalDialog({id:"account_trans_detail",clz:"account-modal",sizeCls:"modal-lg",title:"结算账户交易详情",afterRemove:function(){}})},bindEvent:function(){var c=this;c.on({load:function(a){c.callServer(a,function(a){"000"==a.resultcode?c.render($XP(a,"data",null)):b({msg:$XP(a,"resultmsg",""),type:"danger"})})},show:function(){c.modal.show()},hide:function(){c.modal.hide()}},this),c.modal._.dialog.on("click",".btn",function(){var b=a(this),d=b.attr("name");"cancel"==d&&c.emit("hide")})},mapOrderPayDetail:function(a){var b="userFields,orderFields,payFields,foodsFields".split(",");b=_.map(b,function(b){var c=r[b],d=$XF(c,"mapFn"),e=_.pick(c,"label","fieldType","fields");return d(e,a)}),IX.Debug.info("DEBUG: Account TransDetail Modal Order Pay Detail Fieldsets : "),IX.Debug.info(b);var c=$XP(a,"data.orderSubType",""),d=k(c);d=IX.isEmpty(d)?"":"("+d+")";var e={label:"订单打印内容",orderSubTypeLabel:d,content:$XP(a,"orderPrnStr","").replace(/\n/g,"<br/>")};return{fieldsets:b,printDetail:e}},mapFsmCustomerDetail:function(a){var b=this,c=$XP(a,"settleUnitDetail",[])[0],d=$XP(a,"customerCard",[])[0],e=$XP(c,"transType"),f=$XP(b.transTypeHT.get(e),"label","");return c=IX.each(c,{},function(a,c,d){var e="transAfterBalance,transAmount,transSalesCommission";return e.indexOf(d)>=0?a[d]=Hualala.Common.Math.prettyNumeric(Hualala.Common.Math.prettyPrice(c)):"transType"==d?a=IX.inherit(a,{transType:c,transTypeLabel:$XP(b.transTypeHT.get(c),"label","")}):a[d]=c,a}),d=IX.each(d,{},function(a,b,c){var d="saveCashTotal,saveMoneyTotal,moneyBalance";return a[c]=d.indexOf(c)>=0?Hualala.Common.Math.prettyNumeric(Hualala.Common.Math.prettyPrice(b)):b,a}),{settleUnitDetail:IX.inherit(c,{transTypeLabel:f}),customerCard:d}},mapRenderData:function(a){var b=this,c=_.last(b.callServerName.split(".")),d=null;switch(c){case"queryAccountOrderPayDetail":d=b.mapOrderPayDetail(a);break;case"queryAccountFsmCustomerDetail":d=b.mapFsmCustomerDetail(a)}return d},render:function(a){var b=this,c=b.mapRenderData(a),d=b.get("layoutTpl"),e=b.get("btnTpl"),f=d(c);b.modal._.body.html(f),b.modal._.footer.html(e({btns:[{clz:"btn-default",name:"cancel",label:"关闭"}]})),b.emit("show")},mapQueryParams:function(){var a=this,b={};return _.each(a.queryKeys.split(","),function(c){var d="SUA_TransItemID"==c?"transID":c;b[c]=a[d]}),IX.Debug.info("DEBUG: Account TransDetail Modal Query Params:"),IX.Debug.info(b),b}}),Hualala.Account.AccountTransDetailModal=s}(jQuery,window),function(a){IX.ns("Hualala.Account");var b=function(){var b=a("#ix_wrapper > .ix-body > .container"),c=new Hualala.Account.AccountListController({container:b,view:new Hualala.Account.AccountListView,model:new Hualala.Account.AccountListModel({callServer:Hualala.Global.queryAccount})});c.emit("load",{pageNo:1,pageSize:15})},c=function(){{var b=Hualala.PageRoute.getPageContextByPath(),c=a("#ix_wrapper > .ix-body > .container");new Hualala.Account.AccountMgrController({container:c,settleUnitID:$XP(b,"params",[])[0],accountModel:new Hualala.Account.BaseAccountModel,mgrView:new Hualala.Account.AccountMgrView,transaDetailCtrl:new Hualala.Account.TransactionDetailController})}};Hualala.Account.AccountMgrInit=c,Hualala.Account.AccountListInit=b}(jQuery,window),function(){IX.ns("Hualala.Order");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip),b=Stapes.subclass({constructor:function(a){if(this.callServer=$XP(a,"callServer",null),!this.callServer)throw"callServer is empty!";this.cities=$XP(a,"cities",[]),this.statisticKeys="count,foodAmount,giftAmountTotal,orderRefundAmount,orderRegAmount,orderTotal,orderAmount,shouldSettlementTotal,total",this.queryKeys=$XP(a,"queryKeys",[]),this.pagerKeys="pageCount,totalSize,pageNo,pageSize".split(","),this.queryParamsKeys=null,this.hasPager=$XP(a,"hasPager",!0),this.recordModel=$XP(a,"recordModel",c);var b=$XF(a,"initQueryParams");b.apply(this)}});b.proto({init:function(a,b){this.cities=b||this.cities,this.set(IX.inherit({ds_record:new IX.IListManager,ds_page:new IX.IListManager,ds_statistic:new IX.IListManager},this.hasPager?{pageCount:0,totalSize:0,pageNo:$XP(a,"pageNo",1),pageSize:$XP(a,"pageSize",15)}:{})),this.queryParamsKeys=this.hasPager?this.queryKeys.concat(this.pagerKeys):this.queryKeys},updatePagerParams:function(a){var b=this,c=b.queryParamsKeys.join(",");_.each(a,function(a,d){c.indexOf(d)>-1&&b.set(d,a)})},getPagerParams:function(){var a=this,b={};return _.each(a.queryParamsKeys,function(c){b[c]=a.get(c)}),b},updateDataStore:function(a,b){var c=this,d=c.get("ds_record"),e=c.get("ds_page");b=c.hasPager?b:1;var f=_.map(a,function(a){var e=b+"_"+IX.id(),f=new c.recordModel(IX.inherit(a,{__id__:e}));return d.register(e,f),e});e.register(b,f)},updateStatisticDataStore:function(a){var b=this,c=b.get("ds_statistic");_.each(b.statisticKeys.split(","),function(b){var d=$XP(a,b,"");c.register(b,d)})},resetDataStore:function(){this.recordHT.clear(),this.pageHT.clear()},load:function(b,c){var d=this;d.updatePagerParams(b),d.callServer(d.getPagerParams(),function(b){"000"==b.resultcode?(d.updateDataStore($XP(b,"data.records",[]),$XP(b,"data.page.pageNo")),d.updatePagerParams($XP(b,"data.page",{})),d.updateStatisticDataStore($XP(b,"data",{}))):a({msg:$XP(b,"resultmsg",""),type:"danger"}),c(d)})},getRecordsByPageNo:function(a){var b=this,c=b.get("ds_record"),d=b.get("ds_page");a=b.hasPager?a:1;var e=_.map(c.getByKeys(d.get(a)),function(a){return a.getAll()});return IX.Debug.info("DEBUG: Order Query Result Model PageData"),IX.Debug.info(e),e},getRecordModelByID:function(a){var b=this,c=b.get("ds_record");return c.get(a)},getCityByCityID:function(a){if(IX.isEmpty(a))return null;var b=this.cities,c=_.find(b,function(b){return $XP(b,"cityID")==a});return c},getStatisticData:function(){var a=this,b=a.get("ds_statistic"),c={};return _.each(a.statisticKeys.split(","),function(a){c[a]=b.get(a)}),c}}),Hualala.Order.OrderQueryResultModel=b;var c=Stapes.subclass({constructor:function(a){this.set(a)}});c.proto({}),Hualala.Order.BaseOrderRecordModel=c}(jQuery,window),function(a){IX.ns("Hualala.Order");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,[{key:"cityID",clz:"text",label:"城市"},{key:"shopName",clz:"text",label:"店铺名称"},{key:"orderID",clz:"number",label:"订单号"},{key:"userName",clz:"text",label:"客户姓名"},{key:"orderTime",clz:"date",label:"就餐时间"},{key:"orderStatus",clz:"status",label:"订单状态"},{key:"orderTotal",clz:"number",label:"应付金额"},{key:"moneyBalance",clz:"number",label:"会员卡支付"},{key:"pointBalance",clz:"number",label:"会员卡积分支付"},{key:"orderRefundAmount",clz:"number",label:"退订/退款"},{key:"total",clz:"number",label:"应结金额"},{key:"shouldSettlementTotal",clz:"number",label:"结算金额"},{key:"rowControl",clz:"",label:"操作"}]),c=[{key:"cityID",clz:"text",label:"城市"},{key:"billDate",clz:"date",label:"日期"},{key:"count",clz:"number",label:"订单数"},{key:"giftAmountTotal",clz:"number",label:"代金券总金额"},{key:"orderTotal",clz:"number",label:"订单支付金额"},{key:"orderWaitTotal",clz:"number",label:"待消费订单金额"},{key:"orderRegAmount",clz:"number",label:"退款金额"},{key:"orderRefundAmount",clz:"number",label:"退订金额"},{key:"total",clz:"number",label:"成交金额"},{key:"orderTotal",clz:"number",label:"线下金额"},{key:"rowControl",clz:"",label:"操作"}],d=[{key:"index",clz:"number",label:"序号"},{key:"foodName",clz:"text",label:"菜品名称"},{key:"foodCategoryName",clz:"text",label:"分类名称"},{key:"sumPrice",clz:"number",label:"平均价格"},{key:"sumMaster",clz:"number",label:"销售份数"}],e=[{key:"userName",clz:"text",label:"姓名"},{key:"userSex",clz:"text",label:"性别"},{key:"userLoginMobile",clz:"text",label:"手机号"},{key:"sumRecord",clz:"number",label:"订餐次数"},{key:"foodAmount",clz:"number",label:"订餐金额"},{key:"minOrderTime",clz:"date",label:"首次订餐时间"},{key:"maxOrderTime",clz:"date",label:"最近订餐时间"}],f=function(a,b,c){var d=this,e=Hualala.PageRoute.getPageContextByPath(),f=$XP(e,"name"),g=d.model.getPagerParams(),h=d.model.queryKeys,i={value:"",text:""},j=$XP(a,c,"");switch(c){case"cityID":j=d.getCityByCityID(j),i.value=$XP(j,"cityID",""),i.text=$XP(j,"cityName","");break;case"userName":var k=$XP(a,"userMobile",""),l=Hualala.Common.getGender($XP(a,"userSex","")),m=Hualala.Common.substrByte(j,10)+"...";l=IX.isEmpty(l)?"":"("+$XP(l,"label","")+")",k=IX.isEmpty(k)?"":"("+k+")",i.value=$XP(a,"userID",""),i.text=m+l+k;break;case"orderTime":case"minOrderTime":case"maxOrderTime":i.value=j,i.text=IX.Date.getDateByFormat(Hualala.Common.formatDateTimeValue(j),"yyyy/MM/dd HH:mm");break;case"orderStatus":j=Hualala.Common.getOrderStatus(j),i.value=$XP(j,"value",""),i.text=$XP(j,"label","");break;case"billDate":i.value=j,i.text=IX.Date.getDateByFormat(Hualala.Common.formatDateTimeValue(j),"yyyy/MM/dd");break;case"index":i.value=b,i.text=b+1;break;case"sumMaster":i.value=j,i.text=j+"&nbsp;"+$XP(a,"foodUnit","");break;case"sumPrice":i.value=j||0,i.text=Hualala.Common.Math.prettyNumeric(Hualala.Common.Math.standardPrice(Hualala.Common.Math.div(i.value,$XP(a,"sumMaster",1))));
break;case"userSex":i.value=j,i.text=$XP(Hualala.Common.getGender($XP(a,"userSex","")),"label","");break;case"total":case"orderTotal":case"moneyBalance":case"pointBalance":case"orderRefundAmount":case"shouldSettlementTotal":i.value=j,i.text=Hualala.Common.Math.prettyNumeric(Hualala.Common.Math.standardPrice(j));break;case"foodAmount":i.value=j,i.text=Hualala.Common.Math.prettyNumeric(Hualala.Common.Math.standardPrice(j));case"rowControl":if("orderQuery"==f)i={type:"button",btns:[{label:"查看详情",link:"javascript:void(0);",clz:"query-order-detail",id:$XP(a,"orderID",""),key:$XP(a,"orderKey",""),type:""}]};else if("orderQueryDay"==f||"orderQueryDuring"==f){g=IX.inherit(g,{shopID:$XP(a,"shopID","")}),"orderQueryDay"==f&&(g=IX.inherit(g,{startDate:$XP(a,"billDate",""),endDate:$XP(a,"billDate","")}));var n="orderQueryDuring"==f?"orderQueryDay":"orderQuery",o=_.map(h,function(a){return $XP(g,a,"")}),p="";"orderQuery"==n&&(o=o.concat(["","","",""])),p=Hualala.PageRoute.createPath(n,o),i={type:"button",btns:[{label:"查看详情",link:p,clz:"",id:"",type:""}]}}break;default:i.value=i.text=$XP(a,c,"")}return i};Hualala.Order.mapQueryOrderResultRenderData=function(a){var c=this,d="col-md-12",e="table-bordered table-striped table-hover ix-data-report",g=b,h=c.model.getStatisticData(),i=function(a,b){var d=_.map(g,function(a){return{key:$XP(a,"key",""),clz:$XP(a,"clz","")}}),e={clz:"",type:"text"},h=_.map(d,function(d){var g=f.apply(c,[a,b,$XP(d,"key","")]);return IX.inherit(e,g,{clz:$XP(d,"clz","")})});return h},j=_.map(a,function(a,b){return{clz:"",cols:i(a,b)}}),k="orderTotal,orderRefundAmount,total,shouldSettlementTotal",l=_.map(k.split(","),function(a){var b=$XP(h,a,0),c=1,d="",e="orderTotal"==a?3:1;return{clz:d,colspan:e,rowspan:c,text:Hualala.Common.Math.prettyNumeric(Hualala.Common.Math.standardPrice(b)),value:b}});l.unshift({clz:"title",colspan:"6",rowspan:"1",value:"",text:"共计："}),l.push({clz:"",colspan:"",rowspan:"",value:"",text:""});var m=[{clz:"",cols:l}];return{clz:d,tblClz:e,isEmpty:a&&0!=a.length?!1:!0,colCount:g.length,thead:g,rows:j,tfoot:m}},Hualala.Order.mapQueryOrderDuringRenderData=function(a){var b=this,d=Hualala.PageRoute.getPageContextByPath(),e=$XP(d,"name"),g=(b.model.getPagerParams(),b.model.queryKeys,"col-md-12"),h="table-bordered table-striped table-hover ix-data-report",i=IX.clone(c),j=b.model.getStatisticData();"orderQueryDuring"==e&&(i=_.map(i,function(a){var b=$XP(a,"key","");return"billDate"==b&&(a=IX.inherit(a,{key:"shopName",label:"店铺名称"})),a}));var k=function(a,c){var d=_.map(i,function(a){return _.pick(a,"key","clz")}),e={clz:"",type:"text"},g=_.map(d,function(d){var g=f.apply(b,[a,c,$XP(d,"key","")]);return IX.inherit(e,g,{clz:$XP(d,"clz","")})});return g},l=_.map(a,function(a,b){return{clz:"",cols:k(a,b)}}),m="count,giftAmountTotal,orderTotal,orderWaitTotal,orderRegAmount,orderRefundAmount,total,orderAmount",n=_.map(m.split(","),function(a){var b=$XP(j,a,0),c=1,d="",e=1;return{clz:d,colspan:e,rowspan:c,text:Hualala.Common.Math.prettyNumeric("count"==a?b:Hualala.Common.Math.standardPrice(b)),value:b}});n.unshift({clz:"title",colspan:"2",rowspan:"1",value:"",text:"共计："}),n.push({clz:"",colspan:"",rowspan:"",value:"",text:""});var o=[{clz:"",cols:n}];return{clz:g,isEmpty:a&&0!=a.length?!1:!0,colCount:i.length,tblClz:h,thead:i,rows:l,tfoot:o}},Hualala.Order.mapQueryDishesHotRenderData=function(a){var b=this,c="col-md-12",e="table-bordered table-striped table-hover ix-data-report",g=d,h=function(a,c){var d=_.map(g,function(a){return _.pick(a,"key","clz")}),e={clz:"",type:"text"},h=_.map(d,function(d){var g=f.apply(b,[a,c,$XP(d,"key","")]);return IX.inherit(e,g,{clz:$XP(d,"clz","")})});return h},i=_.map(a,function(a,b){return{clz:"",cols:h(a,b)}});return{clz:c,tblClz:e,isEmpty:a&&0!=a.length?!1:!0,colCount:g.length,thead:g,rows:i}},Hualala.Order.mapQueryUserRenderData=function(a){var b=this,c="col-md-12",d="table-bordered table-striped table-hover ix-data-report",g=e,h=function(a,c){var d=_.map(g,function(a){return _.pick(a,"key","clz")}),e={clz:"",type:"text"},h=_.map(d,function(d){var g=f.apply(b,[a,c,$XP(d,"key","")]);return IX.inherit(e,g,{clz:$XP(d,"clz","")})});return h},i=_.map(a,function(a,b){return{clz:"",cols:h(a,b)}});return{clz:c,tblClz:d,isEmpty:a&&0!=a.length?!1:!0,colCount:g.length,thead:g,rows:i}},Hualala.Order.renderQueryOrderResult=function(a){var b=this;b.$result.empty(),b.$result.html(b.get("resultTpl")(a))};var g=Stapes.subclass({constructor:function(a){this.$container=null,this.$resultBox=null,this.$result=null,this.$pager=null,this.set("mapResultRenderData",$XF(a,"mapResultRenderData")),this.set("renderResult",$XF(a,"renderResult")),this.loadTemplate()}});g.proto({init:function(a){if(this.$container=$XP(a,"container",null),this.model=$XP(a,"model",null),!this.$container||!this.model)throw"Query Result View Init Faild!";this.initLayout()},loadTemplate:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_shop_list_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_base_datagrid"));Handlebars.registerPartial("colBtns",Hualala.TplLib.get("tpl_base_grid_colbtns")),Handlebars.registerHelper("chkColType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),this.set({layoutTpl:a,resultTpl:b})},initLayout:function(){var a=this.get("layoutTpl"),b=a();this.$container.append(b),this.$resultBox=this.$container.find(".shop-list"),this.$result=this.$container.find(".shop-list-body"),this.$pager=this.$container.find(".page-selection"),this.initPager(),this.bindEvent()},initPager:function(a){var b=this;if(b.model.hasPager){var c={total:0,page:1,maxVisible:10,leaps:!0};this.$pager.IXPager(IX.inherit(c,a))}},bindEvent:function(){var b=this;b.model.hasPager&&b.$pager.on("page",function(a,c){var d=b.model.getPagerParams();d.pageNo=c,b.model.emit("load",IX.inherit(d,{pageNo:$XP(d,"pageNo",1),pageSize:$XP(d,"pageSize",15)}))}),b.$resultBox.on("click","a.query-order-detail",function(){{var b=a(this),c=b.attr("data-key"),d=b.attr("data-id"),e="101";new Hualala.Account.AccountTransDetailModal({triggerEl:b,orderKey:c,orderID:d,transType:e,transID:""})}})},mapRenderData:function(){var a=this.get("mapResultRenderData"),b=IX.isFn(a)?a.apply(this,arguments):null;return b},renderRecords:function(){var a=this.get("renderResult");IX.isFn(a)&&a.apply(this,arguments)},render:function(){var a=this,b=a.model,c=b.hasPager,d=b.getPagerParams(),e=$XP(d,"pageNo",1),f=b.getRecordsByPageNo(e),g=a.mapRenderData(f);a.renderRecords(g),c&&a.initPager({total:b.get("pageCount"),page:b.get("pageNo"),href:"javascript:void(0);"})},getCityByCityID:function(a){var b=this,c=b.model.getCityByCityID(a);return c}}),Hualala.Order.OrderQueryResultView=g}(jQuery,window),function(){IX.ns("Hualala.Order");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.UI.LoadingModal),b=Stapes.subclass({constructor:function(a){if(this.set({sessionData:Hualala.getSessionData()}),this.container=$XP(a,"container",null),this.view=$XP(a,"view",null),this.model=$XP(a,"model",null),!this.view||!this.model||!this.container)throw"Query Result init faild!";this.isReady=!1,this.bindEvent()}});b.proto({init:function(b){this.model.init($XP(b,"params",{}),$XP(b,"cities",null)),this.view.init({model:this.model,container:this.container}),this.loadingModal=new a({start:100}),this.isReady=!0},hasReady:function(){return this.isReady},bindEvent:function(){this.on({load:function(a){var b=this;b.hasReady()||b.init(a),b.model.emit("load",$XP(a,"params",{}))}},this),this.model.on({load:function(a){var b=this,c=function(){b.view.emit("render"),b.loadingModal.hide()};b.loadingModal.show(),b.model.load(a,c)}},this),this.view.on({render:function(){var a=this;a.view.render()}},this)}}),Hualala.Order.OrderListController=b}(jQuery,window),function(){IX.ns("Hualala.Order");Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip;Hualala.Order.initQueryParams=function(){var a=Hualala.PageRoute.getPageContextByPath(),b=this,c=$XP(a,"params",[]),d=b.queryKeys,e=_.object(d,c);b.set(e)};var a=Hualala.Shop.QueryModel.subclass({constructor:function(a){this.origCities=[],this.origAreas=[],this.origShops=[],this.queryKeys=$XP(a,"queryKeys",[]),this.isReady=!1,this.callServer=Hualala.Global.getShopQuerySchema;var b=$XF(a,"initQueryParams");b.apply(this)}});a.proto({getQueryParams:function(){var a=this,b=_.map(a.queryKeys,function(b){return a.get(b)}),c=_.object(a.queryKeys,b);return IX.Debug.info("DEBUG: Order Query Model Query Params :"),IX.Debug.info(c),c}}),Hualala.Order.QueryModel=a}(jQuery,window),function(a){IX.ns("Hualala.Order");Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip;Hualala.Order.QueryFormElsCfg={orderTime:{type:"section",label:"日期",min:{type:"datetimepicker",defaultVal:"",validCfg:{group:".min-input",validators:{}}},max:{type:"datetimepicker",defaultVal:"",validCfg:{group:".max-input",validators:{}}}},cityID:{type:"combo",label:"城市",defaultVal:"",options:[],validCfg:{validators:{}}},shopID:{type:"combo",label:"店铺",defaultVal:"",options:[],validCfg:{validators:{}}},orderStatus:{type:"combo",label:"状态",defaultVal:"",options:Hualala.TypeDef.OrderStatus,validCfg:{validators:{}}},orderTotal:{type:"section",label:"金额",min:{type:"text",defaultVal:"",validCfg:{validators:{numeric:{message:"金额必须为数字"},greaterThan:{inclusive:!0,value:0,message:"金额必须大于或等于0"}}}},max:{type:"text",defaultVal:"",validCfg:{validators:{numeric:{message:"金额必须为数字"},greaterThan:{inclusive:!0,value:0,message:"金额必须大于或等于0"}}}}},orderID:{type:"text",label:"订单号",defaultVal:"",validCfg:{validators:{numeric:{message:"订单号必须为数字"}}}},userMobile:{type:"text",label:"手机号",defaultVal:"",validCfg:{validators:{numeric:{message:"手机号码必须为数字"}}}},userLoginMobile:{type:"text",label:"手机号",defaultVal:"",validCfg:{validators:{numeric:{message:"手机号码必须为数字"}}}},foodCategoryName:{type:"text",label:"分类名称",defaultVal:"",validCfg:{validators:{}}},userName:{type:"text",label:"订餐人",defaultVal:"",validCfg:{validators:{}}},button:{type:"button",clz:"btn btn-block btn-warning",label:"查询"}};var b=new IX.IListManager;_.each(Hualala.Order.QueryFormElsCfg,function(a,c){var d=$XP(a,"type"),e="col-xs-2 col-sm-2 col-md-4 control-label";if("section"==d){var f=minID=c+"_min_"+IX.id(),g=c+"_max_"+IX.id(),h="orderTime"==c?"startDate":"s_orderTotal",i="orderTime"==c?"endDate":"e_orderTotal",j=IX.inherit($XP(a,"min",{}),{id:minID,name:h,clz:"col-xs-5 col-sm-5 col-md-5"}),k=IX.inherit($XP(a,"max",{}),{id:g,name:i,clz:"col-xs-5 col-sm-5 col-md-5"});b.register(c,IX.inherit(a,{id:f,labelClz:"col-xs-2 col-sm-2 col-md-2 control-label",min:j,max:k}))}else b.register(c,IX.inherit(a,{id:c+"_"+IX.id(),name:c,labelClz:e},"button"!==$XP(a,"type")?{clz:"col-xs-8 col-sm-8 col-md-8"}:null))}),Hualala.Order.mapOrderQueryFormRenderData=function(){var a=this,c=(a.model.queryKeys,{cols:[{colClz:"col-md-4",items:b.getByKeys(["orderTime","orderTotal"])},{colClz:"col-md-2",items:b.getByKeys(["cityID","orderStatus"])},{colClz:"col-md-3",items:b.getByKeys(["shopID","orderID"])},{colClz:"col-md-3",items:b.getByKeys(["userMobile"])},{colClz:"col-md-offset-1 col-md-2",items:b.getByKeys(["button"])}]});return{query:c}},Hualala.Order.mapOrderQueryBaseFormRenderData=function(){var a=this,c=(a.model.queryKeys,{cols:[{colClz:"col-md-4",items:b.getByKeys(["orderTime"])},{colClz:"col-md-2",items:b.getByKeys(["cityID"])},{colClz:"col-md-2",items:b.getByKeys(["shopID"])},{colClz:"col-md-2",items:b.getByKeys(["orderStatus"])},{colClz:"col-md-2",items:b.getByKeys(["button"])}]});return{query:c}},Hualala.Order.mapDishesHotQueryFormRenderData=function(){var a=this,c=(a.model.queryKeys,{cols:[{colClz:"col-md-2",items:b.getByKeys(["cityID"])},{colClz:"col-md-2",items:b.getByKeys(["shopID"])},{colClz:"col-md-4",items:b.getByKeys(["orderTime"])},{colClz:"col-md-2",items:b.getByKeys(["foodCategoryName"])},{colClz:"col-md-2",items:b.getByKeys(["button"])}]});return{query:c}},Hualala.Order.mapUsersQueryFormRenderData=function(){var a=this,c=(a.model.queryKeys,{cols:[{colClz:"col-md-3",items:b.getByKeys(["cityID"])},{colClz:"col-md-3",items:b.getByKeys(["shopID"])},{colClz:"col-md-4",items:b.getByKeys(["orderTime"])},{colClz:"col-md-3",items:b.getByKeys(["userLoginMobile"])},{colClz:"col-md-3",items:b.getByKeys(["userName"])},{colClz:"col-md-offset-4 col-md-2",items:b.getByKeys(["button"])}]});return{query:c}};var c=Stapes.subclass({constructor:function(a){this.isReady=!1,this.$container=null,this.$queryBox=null,this.loadTemplates(),this.set("mapRenderDataFn",$XF(a,"mapRenderDataFn"))}});c.proto({init:function(a){if(this.model=$XP(a,"model",null),this.$container=$XP(a,"container",null),!this.model||!this.$container||0==this.$container.length)throw"Init Query View Failed!!";this.renderLayout(),this.bindEvent(),this.isReady=!0,this.emit("query",this.getQueryParams())},hasReady:function(){return this.isReady},loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_order_queryLayout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_order_comboOpts"));Handlebars.registerPartial("orderQueryForm",Hualala.TplLib.get("tpl_order_queryForm")),Handlebars.registerHelper("checkFormElementType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),Handlebars.registerHelper("isInputGroup",function(a,b,c){return a||b?c.fn(this):c.inverse(this)}),this.set({layoutTpl:a,comboOptsTpl:b})},initQueryFormEls:function(){var a=this,b=a.model.getQueryParams(),c=$XP(b,"cityID",""),d=$XP(b,"shopID","");a.initCityComboOpts(c),a.initShopComboOpts(c,d),_.each(b,function(b,c){("startDate"==c||"endDate"==c)&&(b=IX.isEmpty(b)?"":IX.Date.getDateByFormat(Hualala.Common.formatDateTimeValue(b),"yyyy/MM/dd")),a.$queryBox.find("[name="+c+"]").val(b)})},initChosenPanel:function(a){var b=new Pymatch([]),c=$XP(a,"sectionsData"),d=$XP(a,"$target"),e=$XP(a,"chosenPanelCfg",{}),f=$XF(a,"changeFn"),g=function(a){b.setNames(_.map(c,function(a){return IX.inherit(a,{name:a.label,py:a.py})}));var d=b.match(a),e={};return _.each(d,function(a){e[a[0].value]=!0}),e},h=d.data("chosen");h&&h.destroy(),d.chosen(IX.inherit({width:"200px",placeholder_text:"请选择",no_results_text:"抱歉，没有找到！",allow_single_deselect:!0},e,{getMatchedFn:g})).change(function(a){f.apply(this,a)})},initCityComboOpts:function(b){var c=this,d=c.model.getCities();if(!IX.isEmpty(d)){d=_.map(d,function(a){var c=$XP(a,"cityID",""),d=$XP(a,"cityName","");return{value:c,label:d,selected:c==b?"selected":"",py:$XP(a,"py","")}}),d.unshift({value:"",label:"全部",selected:IX.isEmpty(b)?"selected":"",py:"quan;bu"});var e=c.get("comboOptsTpl"),f=e({opts:d}),g=c.$queryBox.find("select[name=cityID]");g.html(f),c.initChosenPanel({chosenPanelCfg:{width:g.parent().width()+"px",placeholder_text:"请选择城市"},sectionsData:d,$target:g,changeFn:function(){var b=a(this);c.chosenCityID=b.val()}})}},initShopComboOpts:function(b,c){var d=this,e=IX.isEmpty(b)?d.model.getShops():d.model.getShopsByCityID(b);if(!IX.isEmpty(e)){e=_.map(e,function(a){var b=$XP(a,"shopID",""),d=$XP(a,"shopName","");return{value:b,label:d,selected:b==c?"selected":"",py:$XP(a,"py","")}}),e.unshift({value:"",label:"全部",selected:IX.isEmpty(c)?"selected":"",py:"quan;bu"});var f=d.get("comboOptsTpl"),g=f({opts:e}),h=d.$queryBox.find("select[name=shopID]");h.html(g),d.initChosenPanel({chosenPanelCfg:{width:h.parent().width()+"px",placeholder_text:"请选择店铺"},sectionsData:e,$target:h,changeFn:function(){var b=a(this);d.chosenCityID=b.val()}})}},initQueryEls:function(){var b=this;b.$queryBox.find("[data-type=datetimepicker]").datetimepicker({format:"yyyy/mm/dd",startDate:"2010/01/01",autoclose:!0,minView:"month",todayBtn:!0,todayHighlight:!0,language:"zh-CN"}),b.$queryBox.on("click",".input-group-addon",function(){var b=a(this),c=b.prev(":text[data-type=datetimepicker]");c.length>0&&c.datetimepicker("show")})},mapRenderLayoutData:function(){var a=this.get("mapRenderDataFn");return IX.isFn(a)&&a.apply(this)},renderLayout:function(){var b=this,c=b.get("layoutTpl"),d=(b.model,b.mapRenderLayoutData()),e=c(d);b.$queryBox=a(e),b.$container.html(b.$queryBox),b.initQueryFormEls(),b.initQueryEls()},bindEvent:function(){var b=this;b.$queryBox.on("change","select",function(){var c=a(this),d=c.val();b.initShopComboOpts(d,"")}),b.$queryBox.on("click",".btn.btn-warning",function(){a(this);b.emit("query",b.getQueryParams())})},getQueryParams:function(){var a=this,b=(a.model.queryKeys,a.$queryBox.find("form")),c=b.serializeArray();return c=_.map(c,function(a){var b=$XP(a,"name"),c=$XP(a,"value","");return"startDate"==b||"endDate"==b?(c=IX.isEmpty(c)?"":IX.Date.getDateByFormat(c,"yyyyMMdd"),{name:b,value:c}):a}),c=_.object(_.pluck(c,"name"),_.pluck(c,"value")),a.model.set(c),c}}),Hualala.Order.QueryView=c}(jQuery,window),function(){IX.ns("Hualala.Order");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.Shop.QueryController.subclass({constructor:function(a){if(this.set({sessionData:Hualala.getSessionData()}),this.container=$XP(a,"container",null),this.resultController=$XP(a,"resultController",null),this.model=$XP(a,"model",null),this.view=$XP(a,"view",null),!(this.container&&this.model&&this.view&&this.resultController))throw"QueryController init faild!";this.init()}}));a.proto({bindEvent:function(){this.on({reload:function(){var a=this;a.model.distory(),a.view.distory(),a.init()},query:function(a){var b=this,c=b.model.getCities();IX.Debug.info("DEBUG: Order Query Controller Query Params:"),IX.Debug.info(a),b.resultController&&b.resultController.emit("load",{params:IX.inherit(a,{pageNo:1,pageSize:15}),cities:c})}},this),this.model.on({load:function(a){var b=this,c=$XP(b.get("sessionData"),"user",{});b.model.init(c,a)}},this),this.view.on({init:function(){var a=this;a.view.init({model:a.model,needShopCreate:a.needShopCreate,container:a.container})},filter:function(a){var b=this;b.emit("query",a)},query:function(a){var b=this;b.emit("query",a)}},this)}}),Hualala.Order.QueryController=a}(jQuery,window),function(a){IX.ns("Hualala.Order");var b=function(){var b=Hualala.PageRoute.getPageContextByPath(),c=a("#ix_wrapper > .ix-body > .container");c.empty();var d=function(){var a=IX.Date.getDateByFormat(new Hualala.Date((new Date).getTime()/1e3).toText(),"yyyyMMdd"),c=_.map(Hualala.TypeDef.OrderSubNavType,function(c){var d=_.map($XP(c,"pkeys",[]),function(b){return"startDate"==b||"endDate"==b?a:""});return{active:$XP(b,"name")==c.name?"active":"",disabled:"",path:Hualala.PageRoute.createPath(c.name,d)||"#",name:c.name,label:c.label}});return{toggle:{target:"#order_navbar"},items:c}},e=Handlebars.compile(Hualala.TplLib.get("tpl_order_subnav"));Handlebars.registerPartial("toggle",Hualala.TplLib.get("tpl_site_navbarToggle")),c.html('<div class="order-subnav clearfix" /><div class="order-body" ><div class="order-query-box"></div><div class="order-result-box"></div></div>');{var f=c.find(".order-subnav");c.find(".order-body")}f.html(e(d()))},c=function(){Hualala.PageRoute.getPageContextByPath(),a("#ix_wrapper > .ix-body > .container");b();var c=IX.Date.getDateByFormat(new Hualala.Date((new Date).getTime()/1e3).toText(),"yyyyMMdd"),d=_.find(Hualala.TypeDef.OrderSubNavType,function(a){return"orderQuery"==a.name}),e=$XP(d,"pkeys",[]);e=_.map(e,function(a){return"startDate"==a||"endDate"==a?c:""}),document.location.href=Hualala.PageRoute.createPath("orderQuery",e)},d=function(){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container");b();{var e=d.find(".order-body"),f=$XP(_.findWhere(Hualala.TypeDef.OrderSubNavType,{name:$XP(c,"name")}),"pkeys");new Hualala.Order.QueryController({container:e,resultController:new Hualala.Order.OrderListController({container:e,model:new Hualala.Order.OrderQueryResultModel({callServer:Hualala.Global.queryOrderDetail,queryKeys:f,initQueryParams:Hualala.Order.initQueryParams}),view:new Hualala.Order.OrderQueryResultView({mapResultRenderData:Hualala.Order.mapQueryOrderResultRenderData,renderResult:Hualala.Order.renderQueryOrderResult})}),model:new Hualala.Order.QueryModel({queryKeys:f,initQueryParams:Hualala.Order.initQueryParams}),view:new Hualala.Order.QueryView({mapRenderDataFn:Hualala.Order.mapOrderQueryFormRenderData})})}},e=function(){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container");b();{var e=d.find(".order-body"),f=$XP(_.findWhere(Hualala.TypeDef.OrderSubNavType,{name:$XP(c,"name")}),"pkeys");new Hualala.Order.QueryController({container:e,resultController:new Hualala.Order.OrderListController({container:e,model:new Hualala.Order.OrderQueryResultModel({callServer:Hualala.Global.queryOrderDayDetail,queryKeys:f,initQueryParams:Hualala.Order.initQueryParams}),view:new Hualala.Order.OrderQueryResultView({mapResultRenderData:Hualala.Order.mapQueryOrderDuringRenderData,renderResult:Hualala.Order.renderQueryOrderResult})}),model:new Hualala.Order.QueryModel({queryKeys:f,initQueryParams:Hualala.Order.initQueryParams}),view:new Hualala.Order.QueryView({mapRenderDataFn:Hualala.Order.mapOrderQueryBaseFormRenderData})})}},f=function(){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container");b();{var e=d.find(".order-body"),f=$XP(_.findWhere(Hualala.TypeDef.OrderSubNavType,{name:$XP(c,"name")}),"pkeys");new Hualala.Order.QueryController({container:e,resultController:new Hualala.Order.OrderListController({container:e,model:new Hualala.Order.OrderQueryResultModel({callServer:Hualala.Global.queryOrderDuringDetail,queryKeys:f,initQueryParams:Hualala.Order.initQueryParams}),view:new Hualala.Order.OrderQueryResultView({mapResultRenderData:Hualala.Order.mapQueryOrderDuringRenderData,renderResult:Hualala.Order.renderQueryOrderResult})}),model:new Hualala.Order.QueryModel({queryKeys:f,initQueryParams:Hualala.Order.initQueryParams}),view:new Hualala.Order.QueryView({mapRenderDataFn:Hualala.Order.mapOrderQueryBaseFormRenderData})})}},g=function(){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container");b();{var e=d.find(".order-body"),f=$XP(_.findWhere(Hualala.TypeDef.OrderSubNavType,{name:$XP(c,"name")}),"pkeys");new Hualala.Order.QueryController({container:e,resultController:new Hualala.Order.OrderListController({container:e,model:new Hualala.Order.OrderQueryResultModel({hasPager:!1,callServer:Hualala.Global.queryOrderDishesHot,queryKeys:f,initQueryParams:Hualala.Order.initQueryParams}),view:new Hualala.Order.OrderQueryResultView({mapResultRenderData:Hualala.Order.mapQueryDishesHotRenderData,renderResult:Hualala.Order.renderQueryOrderResult})}),model:new Hualala.Order.QueryModel({queryKeys:f,initQueryParams:Hualala.Order.initQueryParams}),view:new Hualala.Order.QueryView({mapRenderDataFn:Hualala.Order.mapDishesHotQueryFormRenderData})})}},h=function(){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container");b();{var e=d.find(".order-body"),f=$XP(_.findWhere(Hualala.TypeDef.OrderSubNavType,{name:$XP(c,"name")}),"pkeys");new Hualala.Order.QueryController({container:e,resultController:new Hualala.Order.OrderListController({container:e,model:new Hualala.Order.OrderQueryResultModel({hasPager:!1,callServer:Hualala.Global.queryUserOrderStatistic,queryKeys:f,initQueryParams:Hualala.Order.initQueryParams}),view:new Hualala.Order.OrderQueryResultView({mapResultRenderData:Hualala.Order.mapQueryUserRenderData,renderResult:Hualala.Order.renderQueryOrderResult})}),model:new Hualala.Order.QueryModel({queryKeys:f,initQueryParams:Hualala.Order.initQueryParams}),view:new Hualala.Order.QueryView({mapRenderDataFn:Hualala.Order.mapUsersQueryFormRenderData})})}};Hualala.Order.OrderPageLayoutInit=b,Hualala.Order.OrderChartInit=c,Hualala.Order.QueryOrderInit=d,Hualala.Order.QueryOrderByDayDetailInit=e,Hualala.Order.QueryOrderByDuringDetailInit=f,Hualala.Order.QueryOrderDishesHotInit=g,Hualala.Order.QueryOrderCustomerInit=h}(jQuery,window),function(a){IX.ns("Hualala.User");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.UI.LoadingModal,{loginName:{type:"text",label:"账号名称",mode:"readonly",defaultVal:"",prefix:'<span class="glyphicon glyphicon-user"></span>',validCfg:{validators:{notEmpty:{message:"请输入账号名称"},stringLength:{min:3,max:50,message:"账号名称长度在3-50个字符之间"},loginName:{message:"账号名称只能包含数字、英文字母和下划线(_)"}}}},accountID:{type:"hidden",defaultVal:""},loginPWD:{type:"password",label:"登录密码",defaultVal:"",prefix:'<span class="glyphicon glyphicon-lock"></span>',validCfg:{validators:{notEmpty:{message:"请设置密码"},stringLength:{min:6,max:16,message:"请设置密码长度在6-16位之间"},noChinese:{message:"密码不能含有中文字符"}}}},plainPWD:{type:"checkbox",label:"显示明文",defaultVal:1,onLabel:"开启",offLabel:"关闭",validCfg:{}},userName:{type:"text",label:"用户姓名",defaultVal:"",prefix:'<span class="glyphicon glyphicon-user"></span>',validCfg:{validators:{notEmpty:{message:"请输入用户名称"},stringLength:{max:30,message:"用户姓名最多可以输入30个字符"}}}},userRemark:{type:"text",label:"用户备注",defaultVal:"",prefix:'<span class="glyphicon glyphicon-bookmark"></span>',validCfg:{validators:{stringLength:{max:30,message:"用户备注最多可以输入30个字符"}}}},userEmail:{type:"text",label:"邮箱地址",defaultVal:"",prefix:'<span class="glyphicon glyphicon-envelope"></span>',validCfg:{validators:{emailAddress:{message:"请输入正确的电子邮箱地址"}}}},accountStatus:{type:"switcher",label:"账号状态",defaultVal:1,onLabel:"正常",offLabel:"停用",validCfg:{validators:{}}},roleBinding:{type:"roleBindGrp",label:"请选择角色权限",defaultVal:"",validCfg:{}},bindedMobile:{type:"staticwithbtns",label:"已绑定手机",defaultVal:"",btns:[{clz:"col-sm-2",btnClz:"btn-link",label:"更改手机号",act:"changeMobile"},{clz:"col-sm-2",btnClz:"btn-link",label:"解除绑定",act:"unbindMobile"}],validCfg:{}},userMobile:{type:"textwithbtns",label:"手机号",defaultVal:"",btns:[{clz:"col-sm-2",btnClz:"btn-warning",label:"获取验证码",act:"getCode",loadingText:"发送中..."}],validCfg:{validators:{notEmpty:{message:"请输入要绑定的手机号"},mobile:{message:"请输入中国地区手机号"}}}},dynamicCode:{type:"text",label:"验证码",defaultVal:"",validCfg:{validators:{notEmpty:{message:"请输入短信验证码"}}}}}),c=new IX.IListManager;_.each(b,function(a,b){var d=$XP(a,"type"),e="col-sm-offset-1 col-sm-3 control-label";"checkbox"==d?c.register(b,IX.inherit(a,{id:b+"_"+IX.id(),name:b,labelClz:e+" invisible",clz:"col-sm-5 checkbox"})):"roleBindGrp"==d?c.register(b,IX.inherit(a,{id:b+"_"+IX.id(),name:b,labelClz:e,clz:"col-sm-offset-3 col-sm-8"})):"staticwithbtns"==d?c.register(b,IX.inherit(a,{id:b+"_"+IX.id(),name:b,labelClz:e,clz:"col-sm-3"})):c.register(b,IX.inherit(a,{id:b+"_"+IX.id(),name:b,labelClz:e,clz:"col-sm-5"}))});var d="loginName,loginPWD,plainPWD,accountID".split(","),e="loginName,accountID,userName,userRemark,userEmail,accountStatus".split(","),f="loginName,accountID,roleBinding".split(","),g="accountID,bindedMobile,userMobile,dynamicCode".split(","),h=Stapes.subclass({constructor:function(a){if(this.mode=$XP(a,"mode","add"),this.$container=$XP(a,"container",null),this.parentView=$XP(a,"parentView",null),this.model=$XP(a,"model",null),this.evtType=$XP(a,"evtType"),this.successFn=$XF(a,"successFn"),this.failFn=$XF(a,"failFn"),!this.model||!this.parentView)throw"ResetPWDView init faild!";this.initBaseCfg(),this.formParams=this.model.getAll(),this.loadTemplates(),this.renderForm(),this.initUIComponents(),this.bindEvent()}});h.proto({getViewMode:function(){return this.mode},initBaseCfg:function(){this.formKeys=d,"edit"==this.mode?(this.modal=this.parentView.resetPWDModal,this.$body=this.modal._.body,this.$footer=this.modal._.footer):(this.$body=this.$container,this.modal=null,this.$footer=null)},closeModal:function(){this.modal&&this.modal.hide()},initUIComponents:function(){},loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_base_user_form")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns"));Handlebars.registerHelper("checkFormElementType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),Handlebars.registerHelper("isInputGroup",function(a,b,c){return a||b?c.fn(this):c.inverse(this)}),this.set({layoutTpl:a,btnTpl:b})},mapFormElsData:function(){var a=this,b=a.formKeys,d=_.map(b,function(b){var d=c.get(b),e=$XP(d,"type");return"checkbox"==e?IX.inherit(d,{checked:$XP(a.formParams,b)==$XP(d,"defaultVal")?"checked":""}):"switcher"==e?IX.inherit(d,{checked:$XP(a.formParams,b)==$XP(d,"defaultVal")?"checked":""}):IX.inherit(d,{value:$XP(a.formParams,b,$XP(d,"defaultVal",""))},"text"==e&&"wizard_add"==a.mode&&"loginName"==b?{mode:""}:{})});return IX.Debug.info("DEBUG: User ResetPWD Form Elements :"),IX.Debug.info(d),d},renderBtns:function(){var a=this,b=a.get("btnTpl");"edit"==a.mode?a.$footer.html(b({btns:[{clz:"btn-default",name:"cancel",label:"取消"},{clz:"btn-warning",name:"submit",label:"保存",loadingText:"提交中..."}]})):"personal_edit"==a.mode&&a.$container.append(b({btns:[{clz:"btn-warning col-sm-offset-5",name:"submit",label:"确定",loadingText:"提交中..."}]}))},renderForm:function(){var a=this,b=a.mapFormElsData(),c=a.get("layoutTpl"),d=(a.get("btnTpl"),c({formClz:"user-form form-feedback-out",items:b}));a.$body.html(d),a.renderBtns()},bindEvent:function(){var b=this,c=b.initValidFieldOpts();b.$body.delegate("form :checkbox","change",function(){b.$body.find(".form-control[name=loginPWD]").attr("type",this.checked?"text":"password")}),b.$footer&&b.$footer.delegate(".btn","click",function(){var c=a(this),d=c.attr("name");if("cancel"==d)b.closeModal();else{var e=b.$body.find("form").data("bootstrapValidator");c.button("loading"),e.validate()}}),"personal_edit"==b.getViewMode()&&b.$body.delegate(".btn","click",function(){var c=a(this),d=c.attr("name");if("submit"==d){var e=b.$body.find("form").data("bootstrapValidator");c.button("loading"),e.validate()}}),b.$body.find("form").bootstrapValidator({trigger:"blur",fields:c}).on("error.field.bv",function(c){{var d=a(c.target);d.data("bootstrapValidator")}b.failFn(b.model)}).on("success.form.bv",function(c){c.preventDefault();var d=a(c.target),e=(d.data("bootstrapValidator"),b.serializeForm());IX.Debug.info("DEBUG: User ResetPWD Form Params:"),IX.Debug.info(e),b.model.emit(b.evtType,{params:e,failFn:function(){b.$footer&&b.$footer.find(".btn[name=submit]").button("reset"),b.failFn(b.model)},successFn:function(){b.successFn(b.model),b.$footer&&b.$footer.find(".btn[name=submit]").button("reset"),b.closeModal()}})})},serializeForm:function(){{var b=this,d=_.filter(b.formKeys,function(a){return"plainPWD"!=a}),e={};_.map(d,function(d){var f=c.get(d),g=$XP(f,"type");e[d]="switcher"==g?a("[name="+d+"]",b.$body).data("bootstrapSwitch").options.state?1:0:a("[name="+d+"]",b.$body).val()})}return e},initValidFieldOpts:function(){var a=this,b=_.filter(a.formKeys,function(a){return"plainPWD"!=a&&"accountID"!=a}),d={};return _.each(b,function(a){{var b=c.get(a);$XP(b,"type")}d[a]=$XP(b,"validCfg",{})}),d}}),Hualala.User.ResetPWDView=h;var i=h.subclass({constructor:h.prototype.constructor});i.proto({initBaseCfg:function(){this.formKeys=e,"edit"==this.mode?(this.modal=this.parentView.userBaseInfoModal,this.$body=this.modal._.body,this.$footer=this.modal._.footer):(this.$body=this.$container,this.modal=null,this.$footer=null)},initSwitcher:function(b){var c=this;c.$body.find(b).each(function(){var b=a(this),c=b.attr("data-onLabel"),d=b.attr("data-offLabel");b.bootstrapSwitch({size:"normal",onColor:"primary",offColor:"default",onText:c,offText:d})})},initUIComponents:function(){var a=this;a.initSwitcher(":checkbox[data-type=switcher]")}}),Hualala.User.UserBaseInfoView=i;var j=h.subclass({constructor:h.prototype.constructor});j.proto({initBaseCfg:function(){this.formKeys=g,"edit"==this.mode?(this.modal=this.parentView.userBaseInfoModal,this.$body=this.modal._.body,this.$footer=this.modal._.footer):(this.$body=this.$container,this.modal=null,this.$footer=null)},mapFormElsData:function(){var a=this,b=a.formKeys,d=_.map(b,function(b){var d=c.get(b),e=$XP(d,"type");if("staticwithbtns"==e){var f=$XP(a.formParams,"userMobile",""),g=1==$XP(a.formParams,"mobileBinded")?"":"hidden";return IX.inherit(d,{value:f,hidden:g,labelClz:"col-sm-3 control-label"})}return"textwithbtns"==e?IX.inherit(d,{value:"",labelClz:"col-sm-3 control-label"}):IX.inherit(d,{value:$XP(a.formParams,b,$XP(d,"defaultVal","")),labelClz:"col-sm-3 control-label"},"text"==e&&"wizard_add"==a.mode&&"loginName"==b?{mode:""}:{})
});return IX.Debug.info("DEBUG: User ResetPWD Form Elements :"),IX.Debug.info(d),d},renderBtns:function(){var a=this,a=this,b=a.get("btnTpl");"personal_edit"==a.mode&&a.$container.append(b({btns:[{clz:"btn-warning col-sm-offset-5",name:"submit",label:"绑定手机",loadingText:"提交中..."}]}))},initUIComponents:function(){var b=this,c=$XP(b.formParams,"mobileBinded");b.dynamicPWD=new Hualala.Common.DynamicPWD({$btn:b.$body.find(".btn-warning[data-act=getCode]"),waiting:180,getParams:function(){var a=b.model.get("groupLoginName"),c=b.$body.find(":text[name=userMobile]"),d=b.$body.find("form").data("bootstrapValidator");return d.validateField(c).isValidField(c)?{groupName:a,userMobile:c.val()}:null}}),1==c?(b.$body.find(".form-group").eq(0).show(),b.$body.find(".form-group:gt(0)").hide(),b.$body.find(".btn[name=submit]").hide()):(b.$body.find(".form-group").eq(0).hide(),b.$body.find(".form-group:gt(0)").show(),b.$body.find(".btn[name=submit]").show()),b.$body.delegate(".btn[data-act]","click",function(){var c=a(this),d=c.attr("data-act");"unbindMobile"==d?Hualala.UI.Confirm({title:"手机号解除绑定",msg:"是否解除绑定账号("+b.model.get("loginName")+")的手机号？",okLabel:"解除绑定",okFn:function(){b.model.emit("unbindMobile",{accountID:b.model.get("accountID"),successFn:function(){b.$body.find(".form-group").eq(0).hide(),b.$body.find(".form-group:gt(0)").show(),b.$body.find(".btn[name=submit]").show()}})}}):"changeMobile"==d&&(b.$body.find(".form-group").eq(0).hide(),b.$body.find(".form-group:gt(0)").show(),b.$body.find(".btn[name=submit]").show())})}}),Hualala.User.UserBindMobileView=j;var k=Stapes.subclass({constructor:function(a){if(this.mode=$XP(a,"mode","add"),this.$container=$XP(a,"container",null),this.parentView=$XP(a,"parentView",null),this.model=$XP(a,"model",null),this.evtType=$XP(a,"evtType"),this.successFn=$XF(a,"successFn"),this.failFn=$XF(a,"failFn"),!this.model||!this.parentView)throw"UserRoleView init faild!";this.loadTemplates(),this.formParams=this.model.getAll(),this.initBaseCfg()}});k.proto({getViewMode:function(){return this.mode},closeModal:function(){this.modal&&this.modal.hide()},initBaseCfg:function(){var a=this;a.formKeys=f,"edit"==this.mode?(this.modal=this.parentView.userRoleModal,this.$body=this.modal._.body,this.$footer=this.modal._.footer):(this.modal=null,this.$body=this.$container,this.$footer=null),a.model.emit("queryRoleBinding",{successFn:function(){a.renderForm(),a.initUIComponents(),a.bindEvent()},failFn:function(){a.closeModal()}})},loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_base_user_form")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns"));Handlebars.registerHelper("checkFormElementType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),Handlebars.registerHelper("isInputGroup",function(a,b,c){return a||b?c.fn(this):c.inverse(this)}),this.set({layoutTpl:a,btnTpl:b})},mapRoleBindingElsData:function(){var a=this,b=a.model.get("roles"),c=_.map(b,function(a){var b=$XP(a,"binded",!1),c=($XP(a,"id",""),$XP(a,"name",""),$XP(a,"roleType","")),d=$XP(a,"desc","");return IX.inherit(a,{type:c,roleDesc:d,btnLabel:"finance"==c?"绑定账号":"绑定店铺",hideBtn:"general"==c||"admin"==c?"hidden":"",disabledBtn:b?"":"disabled",checked:b?"checked":""})});return{items:c}},mapFormElsData:function(){var a=this,b=a.formKeys,d=_.map(b,function(b){var d=c.get(b),e=$XP(d,"type");return"roleBindGrp"==e?IX.inherit(d,a.mapRoleBindingElsData()):IX.inherit(d,{value:$XP(a.formParams,b,$XP(d,"defaultVal",""))})});return IX.Debug.info("DEBUG: User ResetPWD Form Elements :"),IX.Debug.info(d),d},renderForm:function(){var a=this,b=a.mapFormElsData(),c=a.get("layoutTpl"),d=a.get("btnTpl"),e=c({formClz:"role-form form-feedback-out",items:b});a.$body.html(e),"edit"==a.mode&&a.$footer.html(d({btns:[{clz:"btn-default",name:"cancel",label:"取消"},{clz:"btn-warning",name:"submit",label:"保存",loadingText:"提交中..."}]}))},initUIComponents:function(){},updateRoleBindStatus:function(a){var b=this,c=b.model,d=c.getRoleInfoByType(a),e=$XP(d,"binded")?$XP(d,"items"):[],f=b.$body.find(":checkbox[name="+a+"]");e.length<=0&&(f[0].checked=!1,f.trigger("change"))},bindEvent:function(){var b=this;b.$body.delegate("input:checkbox","change",function(){var c=this.checked?!0:!1,d=a(this),e=d.attr("name"),f=d.parents(".checkbox").find(".btn[data-role="+e+"]");f[c?"removeClass":"addClass"]("disabled"),c?(b.model.updateRoleBind(e,c),f.trigger("click")):b.model.updateRoleBind(e,c)}),b.$body.delegate(".btn[data-role]","click",function(){var c=a(this),d=c.attr("data-role");switch(d){case"manager":b.bindModal=new Hualala.User.BindShopModal({trigger:c,model:b.model,parentView:b,roleType:d,mutiSelect:!1});break;case"finance":b.bindModal=new Hualala.User.BindSettleAccountModal({model:b.model,parentView:b,roleType:d,mutiSelect:!0});break;case"area-manager":b.bindModal=new Hualala.User.BindShopMultiModal({model:b.model,roleType:d,parentView:b})}}),"edit"==b.mode&&b.$footer.delegate(".btn","click",function(){var c=a(this),d=c.attr("name");"cancel"==d?b.closeModal():(c.button("loading"),b.model.emit("editRole",{successFn:function(){b.$footer.find(".btn[name=submit]").button("reset"),b.closeModal(),b.successFn(b.model)},failFn:function(){b.$footer.find(".btn[name=submit]").button("reset"),b.closeModal(),b.failFn(b.model)}}))})}}),Hualala.User.UserRoleView=k}(jQuery,window),function(a){IX.ns("Hualala.User");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.UI.LoadingModal,[{id:"user_base_info",label:"基本信息"},{id:"user_login_pwd",label:"登录密码"},{id:"user_role_binding",label:"角色绑定"}]),c=[{clz:"btn-default btn-prev",name:"prev",label:"上一步",loadingText:"请稍候..."},{clz:"btn-default btn-cancel",name:"cancel",label:"取消",loadingText:"取消"},{clz:"btn-warning btn-next",name:"next",label:"下一步",loadingText:"请稍候..."},{clz:"btn-success btn-finish ",name:"finish",label:"完成",loadingText:"提交中..."}],d=Stapes.subclass({constructor:function(a){this.parentView=$XP(a,"parentView"),this.evtType=$XP(a,"evtType","create"),this.successFn=$XF(a,"successFn"),this.failFn=$XF(a,"failFn"),this.modal=null,this.$body=null,this.$wizard=null,this.wizardID="create_user_wizard",this.model=new Hualala.User.BaseUserModel,this.stepViewHT=new IX.IListManager,this.loadTemplates(),this.initModal(),this.renderWizardLayout(),this.initWizard(),this.enableGoToNextStep=!1,this.bindEvent()}});d.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_wizard_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns"));Handlebars.registerPartial("stepAction",Hualala.TplLib.get("tpl_shop_modal_btns")),this.set({layoutTpl:a,btnTpl:b})},initModal:function(){var a=this;a.modal=new Hualala.UI.ModalDialog({id:"create_user_modal",clz:"account-modal",title:"添加用户账号",backdrop:"static",showFooter:!1,afterHide:function(){}}),a.$body=a.modal._.body,a.modal.show()},mapWizardLayoutData:function(){var a=this,d=[],e=[];return d=_.map(b,function(a,b){return e.push({id:$XP(a,"id")}),IX.inherit(a,{idx:b+1})}),{id:a.wizardID,clz:"wizard-create-user",stepNavs:d,steps:e,btns:c}},renderWizardLayout:function(){var a=this,b=a.mapWizardLayoutData(),c=a.get("layoutTpl"),d=c(b);a.$body.html(d),a.modal.show()},getTabContentIDByIndex:function(b,c){var d=a("li:eq("+c+")",b),e=d.find("a[data-toggle]").attr("href").replace("#","");return e},initUserBaseInfoView:function(a,b,c){var d=this,e=new Hualala.User.UserBaseInfoView({mode:c,container:a,parentView:d,model:d.model,evtType:"wizard_add"==c?"addUser":"editUser",successFn:function(){d.switchWizardCtrlStatus("reset"),d.getNextStep()},failFn:function(){d.switchWizardCtrlStatus("reset")}});d.stepViewHT.register(b,e)},initResetPWDView:function(a,b,c){var d=this,e=new Hualala.User.ResetPWDView({mode:c,container:a,parentView:d,model:d.model,evtType:"resetPWD",successFn:function(){d.switchWizardCtrlStatus("reset"),d.getNextStep()},failFn:function(){d.switchWizardCtrlStatus("reset")}});d.stepViewHT.register(b,e)},initUserRoleView:function(a,b,c){var d=this,e=new Hualala.User.UserRoleView({mode:c,container:a,parentView:d,model:d.model,evtType:"editRole",successFn:function(){},failFn:function(){}});d.stepViewHT.register(b,e)},commitUserInfo:function(a){var b=this,c=a.$body,d=c.find("form"),e=d.data("bootstrapValidator");b.switchWizardCtrlStatus("loading"),e.validate()},commitStep:function(a){var b=this,c=b.stepViewHT.get(a);switch(a){case"user_base_info":case"user_login_pwd":b.commitUserInfo(c);break;case"user_role_binding":b.model.emit("editRole",{successFn:function(){b.successFn(b.model),b.modal.hide()},failFn:function(){b.failFn(b.model)}})}},initWizard:function(){var b=this;b.$wizard=b.$body.find("#"+b.wizardID),b.$wizard.bsWizard({tabClass:"tabClass",nextSelector:".btn[name=next]",previousSelector:".btn[name=prev]",finishSelector:".btn[name=finish]",onTabClick:function(){return!1},onInit:function(c,d,e){var f=(a("li:eq("+e+")",b.$wizard),b.getTabContentIDByIndex(d,e)),g=a("#"+f,b.$wizard);b.initUserBaseInfoView(g,f,"wizard_add")},onNext:function(c){var d=a(c.find("a[data-toggle]").attr("href")),e=d.attr("id");0==b.enableGoToNextStep&&b.commitStep(e);var f=b.enableGoToNextStep;return b.enableGoToNextStep=!1,f},onPrevious:function(b){{var c=a(b.find("a[data-toggle]").attr("href"));c.attr("id")}return!0},onTabChange:function(c,d,e,f){var g=(b.getTabContentIDByIndex(d,e),b.getTabContentIDByIndex(d,f)),h=a("#"+g,b.$wizard),i=b.stepViewHT.get(g),j=IX.isEmpty(i)?null:i.getViewMode();return-1==e&&0==f?!0:0==f&&i&&"wizard_add"==j?(b.initUserBaseInfoView(h,g,"wizard_edit"),!0):void(1==f?IX.isEmpty(j)&&b.initResetPWDView(h,g,"wizard_edit"):2==f&&IX.isEmpty(j)&&b.initUserRoleView(h,g,"wizard_edit"))},onTabShow:function(){},onFinish:function(c){var d=a(c.find("a[data-toggle]").attr("href")),e=d.attr("id");b.commitStep(e)}})},switchWizardCtrlStatus:function(a){var b=this;b.$wizard.find(".wizard-ctrl .btn").button(a)},getNextStep:function(){var a=this;a.enableGoToNextStep=!0,a.$wizard.bsWizard("next")},getPrevieousStep:function(){var a=this;a.enableGoToNextStep=!0,a.$wizard.bsWizard("previeous")},bindEvent:function(){var b=this;b.$wizard.find(".wizard-ctrl .btn-cancel").on("click",function(){var c=(a(this),b.$wizard.bsWizard("currentIndex")),d=b.getTabContentIDByIndex(b.$wizard.find(".wizard-nav"),c),e=b.stepViewHT.get(d),f=(e.getViewMode(),b.model.get("accountID"));f||0!=c?Hualala.UI.Confirm({title:"取消创建账号",msg:"是否取消创建新账户的操作？",okLabel:"确定",okFn:function(){b.model.emit("remove",{successFn:function(){b.modal.hide()}})}}):b.modal.hide()})}}),Hualala.User.CreateUserModal=d}(jQuery,window),function(a){IX.ns("Hualala.User");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.UI.LoadingModal,[{id:"bind_mobile",title:"绑定手机",panelClz:"in",expanded:"true"},{id:"reset_pwd",title:"重置密码",panelClz:"",expanded:"false"}]),c=Stapes.subclass({constructor:function(a){this.$btnGrp=$XP(a,"$btnGrp"),this.curPanelName=$XP(a,"curPanelName","bind_mobile"),this.userModel=null,this.$body=null,this.$bindMobilePanel=null,this.$resetPWDPanel=null,this.panelGrpHT=new IX.IListManager,this.initUserModel(),this.loadTemplates(),this.bindBtnGrpEvent()}});c.proto({initUserModel:function(){var a=this,b=Hualala.getSessionUser();b=IX.inherit(b,{roleType:$XP(b,"role").join(",")}),a.userModel=new Hualala.User.BaseUserModel(b)},updateCurPanelName:function(a){this.curPanelName=a},loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_user_mgr_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns"));this.set({layoutTpl:a,btnTpl:b})},mapLayoutRenderData:function(){var a=this,c=_.map(b,function(b){var c=$XP(b,"id");return IX.inherit(b,{panelClz:c==a.curPanelName?"in":"",expanded:c==a.curPanelName?"true":""})});return{panelGrpID:"user_mgr_panel",panels:c}},renderPanelGrpLayout:function(){var a=this,b=a.get("layoutTpl"),c=a.mapLayoutRenderData(),d=b(c);a.$body.html(d),a.$bindMobilePanel=a.$body.find("#bind_mobile"),a.$resetPWDPanel=a.$body.find("#reset_pwd"),a.panelGrpHT.register("reset_pwd",new Hualala.User.ResetPWDView({mode:"personal_edit",container:a.$resetPWDPanel.find(".panel-body"),parentView:a,model:a.userModel,evtType:"resetPWD",successFn:function(){var b=a.panelGrpHT.get("reset_pwd");b.$body.find('.btn[name="submit"]').button("reset")},failFn:function(){var b=a.panelGrpHT.get("reset_pwd");b.$body.find('.btn[name="submit"]').button("reset")}})),a.panelGrpHT.register("bind_mobile",new Hualala.User.UserBindMobileView({mode:"personal_edit",container:a.$bindMobilePanel.find(".panel-body"),parentView:a,model:a.userModel,evtType:"bindMobile",successFn:function(){var b=a.panelGrpHT.get("bind_mobile");b.$body.find('.btn[name="submit"]').button("reset")},failFn:function(){var b=a.panelGrpHT.get("bind_mobile");b.$body.find('.btn[name="submit"]').button("reset")}})),a.renderModalBtns()},renderModalBtns:function(){var a=this,b=a.get("btnTpl");a.modal._.footer.html(b({btns:[{clz:"btn-default",name:"cancel",label:"关闭"}]})),a.modal._.footer.find(".btn-default").attr("data-dismiss","modal")},initModal:function(){var a=this;a.modal=new Hualala.UI.ModalDialog({id:"user_mgr_modal",clz:"account-modal user-mgr-modal",title:"个人管理",showFooter:!0,afterHide:function(){}}),a.$body=a.modal._.body,a.renderPanelGrpLayout(),a.modal.show()},bindBtnGrpEvent:function(){var b=this;b.$btnGrp.undelegate(".btn[data-target]","click"),b.$btnGrp.delegate(".btn[data-target]","click",function(){var c=a(this),d=c.attr("data-target");b.updateCurPanelName(d),b.initModal()})}}),Hualala.User.UserMgrModal=c}(jQuery,window),function(a){IX.ns("Hualala.User");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip),c=(Hualala.UI.LoadingModal,Stapes.subclass({constructor:function(a){this.$trigger=$XP(a,"trigger",null),this.model=$XP(a,"model",null),this.parentView=$XP(a,"parentView",null),this.modal=null,this.$queryBox=null,this.$resultBox=null,this.queryCtrl=null,this.set({accountID:this.model.get("accountID"),roleType:$XP(a,"roleType"),mutiSelect:$XP(a,"mutiSelect",!1)}),this.loadTemplates(),this.initModal(),this.render(),this.bindEvent(),this.initQueryBox(),this.emit("show")}}));c.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_role_bind_shop")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns"));this.set({layoutTpl:a,btnTpl:b})},initModal:function(){var a=this;a.modal=new Hualala.UI.ModalDialog({id:"account_query_shop",clz:"account-modal",title:"选择所管辖的店铺",backdrop:"static"})},render:function(){var a=this,b=a.get("layoutTpl"),c=a.get("btnTpl"),d=a.model.getRoleInfoByType(a.get("roleType")),e=$XP(d,"name",""),f=[{clz:"btn-default",name:"cancel",label:"取消"},{clz:"btn-warning",name:"save",label:"确定"}];htm=b({clz:"",title:"选择"+e+"所管辖的店铺"}),a.modal._.body.html(htm),a.modal._.footer.html(c({btns:f})),a.$queryBox=a.modal._.body.find(".query-box"),a.$resultBox=a.modal._.body.find(".result-box")},bindEvent:function(){var c=this;this.on({show:function(){c.modal.show()},hide:function(){c.modal.hide()}}),c.modal._.dialog.find(".btn").on("click",function(){var d=a(this),e=d.attr("name");if("cancel"==e)c.emit("hide"),c.parentView.updateRoleBindStatus(c.get("roleType"));else{c.queryCtrl.emit("bindItems");var f=c.model,g=c.get("roleType"),h=f.getRoleInfoByType(g),i=$XP(h,"binded")?$XP(h,"items"):[];i.length>0?c.emit("hide"):b({msg:"请选择要绑定的店铺",type:"danger"})}})},initQueryBox:function(){var a=this;a.queryCtrl=new Hualala.User.QueryShopController({container:a.$queryBox,resultContainer:a.$resultBox,accountID:this.model.get("accountID"),roleType:a.get("roleType"),mutiSelect:a.get("mutiSelect"),userModel:a.model})}}),Hualala.User.BindShopModal=c}(jQuery,window),function(a){IX.ns("Hualala.User");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip),c=(Hualala.UI.LoadingModal,Stapes.subclass({constructor:function(a){this.set({sessionData:Hualala.getSessionData()}),this.$trigger=$XP(a,"trigger",null),this.model=$XP(a,"model",null),this.parentView=$XP(a,"parentView",null),this.modal=null,this.$resultBox=null,this.set({accountID:this.model.get("accountID"),roleType:$XP(a,"roleType"),mutiSelect:$XP(a,"mutiSelect",!1),itemsCache:null}),this.origSettleData=null,this.querySettleCallServer=Hualala.Global.queryAccount,this.$body=null,this.$footer=null,this.$resultBox=null,this.loadTemplates(),this.initModal(),this.bindEvent(),this.emit("load"),this.emit("show")}}));c.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_role_bind_shop")),b=Handlebars.compile(Hualala.TplLib.get("tpl_settle_list")),c=Handlebars.compile(Hualala.TplLib.get("tpl_settle_item"));Handlebars.registerPartial("settleItem",Hualala.TplLib.get("tpl_settle_item")),Handlebars.registerHelper("checkItemType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),this.set({layoutTpl:a,listTpl:b,itemTpl:c})},initModal:function(){var a=this;a.modal=new Hualala.UI.ModalDialog({id:"account_query_settle",clz:"account-modal",title:"选择所管辖的结算账户",backdrop:"static"}),a.$body=a.modal._.body,a.$footer=a.modal._.footer;var b=a.get("layoutTpl"),c=b({clz:"",title:"选择财务所管辖的结算账户"});a.$body.html(c),a.$resultBox=a.$body.find(".result-box")},mapRenderData:function(a){var b=this,c=b.get("roleType"),d=b.get("mutiSelect"),e=b.get("itemsCache"),f=b.model,g=f.getRoleInfoByType(c),h=$XP(g,"items",[]);e=e?e:h,b.set("itemsCache",e);var i=_.map(a,function(a){var b=$XP(a,"settleUnitID"),c=_.find(e,function(a){return a==b})?"checked":"";return IX.inherit(a,{type:d?"checkbox":"radio",clz:"bind-item",settleUnitNameLabel:$XP(a,"settleUnitName",""),checked:c})});return i},render:function(a){var b=this,c=b.get("listTpl"),d=b.mapRenderData(a),e=c({settleList:{list:d}});b.$resultBox.html(e)},bindEvent:function(){var c=this;this.on({show:function(){c.modal.show()},hide:function(){c.modal.hide()},load:function(){c.origSettleData?c.render(c.origSettleData):c.querySettleCallServer({},function(a){"000"!=a.resultcode?b({msg:$XP(a,"resultmsg",""),type:"danger"}):c.render($XP(a,"data.records",[]))})}}),c.$resultBox.tooltip({selector:"[title]"}),c.$resultBox.delegate(":radio,:checkbox","change",function(){{var b=a(this),d=this.checked?!0:!1,e=b.val(),f=c.get("mutiSelect"),g=c.get("roleType");c.model}c.updateItemsCache(g,e,f,d)}),c.$footer.delegate(".btn","click",function(){var d=a(this),e=d.hasClass("btn-close")?"cancel":"ok",f=c.get("itemsCache");if("cancel"==e)c.emit("hide"),c.parentView.updateRoleBindStatus(c.get("roleType"));else{if(!f||0==f.length)return void b({msg:"请选择要绑定的结算账户",type:"danger"});c.bindItems(),c.emit("hide")}})},updateItemsCache:function(a,b,c,d){var e=this,f=e.get("itemsCache");c?d?f.push(b):f=_.without(f,b):f=[b],e.set("itemsCache",f)},bindItems:function(){var a=this,b=a.model,c=a.get("roleType");b.updateRoleItemsBind(c,a.get("itemsCache"))}}),Hualala.User.BindSettleAccountModal=c}(jQuery,window),function(a){IX.ns("Hualala.User");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip),c=(Hualala.UI.LoadingModal,Stapes.subclass({constructor:function(a){this.set({sessionData:Hualala.getSessionData()}),this.$trigger=$XP(a,"trigger",null),this.model=$XP(a,"model",null),this.parentView=$XP(a,"parentView",null),this.modal=null,this.$resultBox=null,this.set({accountID:this.model.get("accountID"),roleType:$XP(a,"roleType"),itemsCache:null}),this.queryModel=new Hualala.Shop.QueryModel,this.$body=null,this.$footer=null,this.$resultBox=null,this.loadTemplates(),this.initModal(),this.bindEvent(),this.emit("load")}}));c.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_role_bind_shop")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shops_tree")),c=Handlebars.compile(Hualala.TplLib.get("tpl_collapse_btn")),d=Handlebars.compile(Hualala.TplLib.get("tpl_shop_checkbox"));Handlebars.registerPartial("collapseBtn",Hualala.TplLib.get("tpl_collapse_btn")),Handlebars.registerPartial("item",Hualala.TplLib.get("tpl_shop_checkbox")),this.set({layoutTpl:a,listTpl:b,collapseBtnTpl:c,itemTpl:d})},initModal:function(){var a=this;a.modal=new Hualala.UI.ModalDialog({id:"account_query_shop",clz:"account-modal",title:"选择所管辖的店铺",backdrop:"static"}),a.$body=a.modal._.body,a.$footer=a.modal._.footer;var b=a.get("layoutTpl"),c=b({clz:"",title:"选择区域经理所管辖的店铺"});a.$body.html(c),a.$resultBox=a.$body.find(".result-box")},chkShopBinded:function(a){var b=this,c=b.get("itemsCache");return _.find(c,function(b){return b==a})?!0:!1},mapShopTree:function(){var a=this,b=a.queryModel,c=b.getCities(),d=(b.getAreas(),function(c){var d=b.getShops(c),e=0,f=_.map(d,function(b){var c=$XP(b,"shopID"),d=$XP(b,"shopName"),f=a.chkShopBinded(c);return f&&e++,{nodeClz:"col-sm-4",nodeType:"shop",id:c,name:d,parentID:$XP(b,"areaID"),hideCollapse:"hidden",checked:f?"checked":""}}),g=_.reject(f,function(a){return"checked"==a.checked});return{shops:f,checked:g.length>0?"":"checked",expanded:e>0?"in":""}}),e=function(a){var c=b.getAreas(a),e=_.map(c,function(a){var b=$XP(a,"areaID"),c=$XP(a,"areaName"),e=$XP(a,"shopLst",[]);return IX.inherit({nodeClz:"",nodeType:"area",id:b,name:c,parentID:$XP(a,"cityID"),hideCollapse:""},d(e))}),f=_.reject(e,function(a){return"checked"==a.checked});return{areas:e,checked:f.length>0?"":"checked"}};return _.map(c,function(a){var b=$XP(a,"cityID",""),c=$XP(a,"cityName",""),d=$XP(a,"areaLst",[]);return IX.inherit({nodeClz:"",nodeType:"city",id:b,name:c,parentID:"root",hideCollapse:""},e(d))})},mapRenderData:function(){var a=this,b=a.get("roleType"),c=a.get("itemsCache"),d=a.model,e=d.getRoleInfoByType(b),f=$XP(e,"items",[]);return c=c?c:f,a.set("itemsCache",c),a.mapShopTree()},render:function(){var a=this,b=a.get("listTpl"),c=a.mapRenderData(),d=b({cities:c});a.$resultBox.html(d)},bindEvent:function(){var c=this;this.on({show:function(){c.modal.show()},hide:function(){c.modal.hide()},load:function(){c.queryModel.init($XP(c.get("sessionData"),"user"),function(a){c.queryModel=a,c.render(),c.emit("show")})}});var d=function(b){if("root"!=b){var c=a(":checkbox[value="+b+"]"),e=c.attr("data-parent"),f=c.val(),g=c.attr("name"),h=a("#"+g+"_"+f).find(":checkbox"),i=_.reject(h,function(a){return!!a.checked});c[0].checked=0==i.length?!0:!1,d(e)}};c.$body.delegate(":checkbox","change",function(){var b=a(this),c=b.attr("name"),e=this.checked?!0:!1,f=b.val(),g=b.attr("data-parent");("area"==c||"city"==c)&&a("#"+c+"_"+f).find(":checkbox").each(function(){this.checked=e}),d(g)}),c.$body.delegate('.btn-link[data-toggle="collapse"]',"click",function(){var b=a(this),c=b.find(".glyphicon"),d=c.hasClass("glyphicon-chevron-down");c.removeClass().addClass(d?"glyphicon glyphicon-chevron-up":"glyphicon glyphicon-chevron-down")}),c.$footer.delegate(".btn","click",function(){var d=a(this),e=d.hasClass("btn-close")?"cancel":"ok",f=c.getBindItems();if("cancel"==e)c.emit("hide"),c.parentView.updateRoleBindStatus(c.get("roleType"));else{if(!f||0==f.length)return void b({msg:"请选择要绑定的店铺",type:"danger"});c.bindItems(),c.emit("hide")}})},getBindItems:function(){var b=this,c=b.$body.find(":checked[name=shop]"),d=_.map(c,function(b){return a(b).val()});return d},bindItems:function(){var a=this,b=a.model,c=a.get("roleType"),d=a.getBindItems();b.updateRoleItemsBind(c,d)}}),Hualala.User.BindShopMultiModal=c}(jQuery,window),function(){IX.ns("Hualala.User");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip),b=Stapes.subclass({constructor:function(a){if(this.callServer=$XP(a,"callServer",null),!this.callServer)throw"callServer is empty!"}});b.proto({init:function(a){this.set({queryID:$XP(a,"queryID",""),ds_user:new IX.IListManager})},updatePagerParams:function(a){var b=this,c="queryID";_.each(a,function(a,d){c.indexOf(d)>-1&&b.set(d,a)})},getPagerParams:function(){return{queryID:this.get("queryID")}},updateDataStore:function(a){var b=this,d=b.get("ds_user"),e=_.map(a,function(a){var b=$XP(a,"accountID"),e=new c(a);return d.register(b,e),b});return e},resetDataStore:function(){var a=this,b=a.get("ds_user");b.clear()},removeUsers:function(a){var b=this,c=b.get("ds_user");a||c.clear(),a=IX.isArray(a)?a:[a],_.each(a,function(a){c.unregister(a)})},load:function(b,c){var d=this;d.updatePagerParams(b),d.callServer(d.getPagerParams(),function(b){"000"==b.resultcode?(d.updateDataStore($XP(b,"data.records",[])),d.updatePagerParams($XP(b,"data.page",{}))):a({msg:$XP(b,"resultmsg",""),type:"danger"}),c(d)})},getUsers:function(a){var b=this,c=b.get("ds_user"),d=a&&IX.isArray(a)?c.get(a):c.getAll(),e=_.map(d,function(a){return a.getAll()});return IX.Debug.info("DEBUG: User List Model Data : "),IX.Debug.info(e),e},getUserModelByUserID:function(a){var b=this,c=b.get("ds_user");return c.get(a)},getUserModelByUserLoginName:function(a){var b=this,c=b.get("ds_user"),d=c.getAll();return _.find(d,function(b){return b.get("loginName")==a})},addItem:function(a){var b=this,c=b.get("ds_user"),d=a.get("accountID");c.register(d,a)}}),Hualala.User.UserListModel=b;var c=Stapes.subclass({constructor:function(a){this.resetPWDCallServer=Hualala.Global.resetPWDInShopGroupChildAccount,this.editUserCallServer=Hualala.Global.updateShopGroupChildAccount,this.addUserCallServer=Hualala.Global.addShopGroupChildAccount,this.removeCallServer=Hualala.Global.removeShopGroupChildAccount,this.unbindMobileCallServer=Hualala.Global.unbindMobileInShopGroupChildAccount,this.bindMobileCallServer=Hualala.Global.bindMobileInShopGroupChildAccount,this.updateRoleBindingCallServer=Hualala.Global.updateRoleBinding,this.queryRoleBindingCallServer=Hualala.Global.queryRoleBinding,this.set("ds_role",new IX.IListManager),IX.isEmpty(a)||this.updateUserModel(a),this.bindEvent()}});c.proto({updateUserModel:function(a){this.set(a),this.updateRoleStore()},updateRoleStore:function(a){var b=this,c=b.get("ds_role"),d=IX.isEmpty(a)?","+this.get("roleType")+",":a,e=Hualala.TypeDef.SiteRoleType,c=b.get("ds_role");c.clear();var f=_.map(e,function(a){var b=$XP(a,"roleType"),e=null;if(IX.isString(d))e=IX.inherit(a,{binded:d.indexOf(","+b+",")>=0?!0:!1});else{var f=_.find(d,function(a){return $XP(a,"type")==b});e=IX.inherit(a,{binded:f?!0:!1,items:$XP(f,"items",[])})}return c.register(b,e),e});b.set("roles",f)},getRoleInfoByType:function(a){var b=this,c=b.get("ds_role");return c.get(a)},updateRoleItemsBind:function(a,b){var c=this,d=c.getRoleInfoByType(a);d.items=b||[]},updateRoleBind:function(a,b){var c=this,d=c.getRoleInfoByType(a);d.binded=b?!0:!1},getRoleBindings:function(){var a=this,b=a.get("ds_role"),c=b.getAll(),d=_.reject(c,function(a){return!$XP(a,"binded")});return d=_.map(d,function(a){return{type:$XP(a,"roleType"),items:$XP(a,"items",[])}})},bindEvent:function(){var b=this;this.on({addUser:function(c){var d=$XF(c,"successFn"),e=$XF(c,"failFn"),f=$XP(c,"params",{});b.addUserCallServer(f,function(c){"000"!=c.resultcode?(a({msg:$XP(c,"resultmsg",""),type:"danger"}),e()):(a({msg:"保存成功!",type:"success"}),b.updateUserModel($XP(c,"data.records")[0]),d())})},editUser:function(c){var d=$XF(c,"successFn"),e=$XF(c,"failFn"),f=$XP(c,"params",{});b.editUserCallServer(f,function(c){"000"!=c.resultcode?(a({msg:$XP(c,"resultmsg",""),type:"danger"}),e()):(a({msg:"保存成功!",type:"success"}),b.set(f),d())})},resetPWD:function(b){var c=this,d=($XP(b,"params.loginPWD",""),$XP(b,"params",{})),e=$XF(b,"successFn"),f=$XF(b,"failFn");d=IX.inherit(d,{accountID:c.get("accountID")}),c.resetPWDCallServer(d,function(b){"000"!=b.resultcode?(a({msg:$XP(b,"resultmsg",""),type:"danger"}),f()):(a({msg:"保存成功!",type:"success"}),e())})},remove:function(c){var d=$XF(c,"successFn");b.removeCallServer({accountID:b.get("accountID")},function(b){"000"!=b.resultcode?a({msg:$XP(b,"resultmsg",""),type:"danger"}):(a({msg:"删除成功!",type:"success"}),d())})},editRole:function(c){var d=$XF(c,"successFn"),e=$XF(c,"failFn"),f={accountID:b.get("accountID"),roles:JSON.stringify(b.getRoleBindings())};b.updateRoleBindingCallServer(f,function(b){"000"!=b.resultcode?(a({msg:$XP(b,"resultmsg",""),type:"danger"}),e()):(a({msg:"保存成功!",type:"success"}),d())})},unbindMobile:function(c){var d=$XF(c,"successFn");b.unbindMobileCallServer({accountID:b.get("accountID")},function(c){"000"!==c.resultcode?a({msg:$XP(c,"resultmsg",""),type:"danger"}):(a({msg:"解绑定成功!",type:"success"}),b.set("mobileBinded",0),d())})},bindMobile:function(b){var c=this,d=$XF(b,"successFn"),e=$XF(b,"failFn"),f=IX.inherit($XP(b,"params",{}),{groupName:c.get("groupLoginName")});c.bindMobileCallServer(f,function(b){"000"!=b.resultcode?(a({msg:$XP(b,"resultmsg",""),type:"danger"}),e()):(a({msg:"绑定成功!",type:"success"}),c.set({userMobile:$XP(f,"userMobile"),mobileBinded:1}),d())})},queryRoleBinding:function(c){var d=$XF(c,"successFn"),e=$XF(c,"failFn");b.queryRoleBindingCallServer({accountID:b.get("accountID")},function(c){"000"!=c.resultcode?(a({msg:$XP(c,"resultmsg",""),type:"danger"}),e()):(b.updateRoleStore($XP(c,"data.roles",null)),d())})}})}}),Hualala.User.BaseUserModel=c}(jQuery,window),function(){IX.ns("Hualala.User");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.Shop.CardListModel.subclass({constructor:function(){this.origData=null,this.dataStore=new IX.IListManager}}));a.proto({initDataStore:function(a){var b=this;b.origData=a,_.each(b.origData,function(a){b.dataStore.register($XP(a,"shopID"),a)})},load:function(a,b){var c=this;c.updatePagerParams(a);var d=c.get("pageNo"),e=c.get("pageSize"),f=c.get("cityID"),g=c.get("areaID"),h=c.get("keywordLst"),i=0,j=(d-1)*e,k=e*d,l=0,m=[];m=g.length>0?_.filter(c.origData,function(a){return $XP(a,"areaID")==g}):c.origData,m=f.length>0?_.filter(m,function(a){return $XP(a,"cityID")==f}):m,m=h.length>0?_.filter(m,function(a){return $XP(a,"shopName")==h}):m,i=m.length,l=Math.ceil(i/e),m=_.filter(m,function(a,b){return b>=j&&k>b}),c.updateDataStore(m,d),c.updatePagerParams({pageCount:l,totalSize:i,pageNo:d,pageSize:e}),b(c)}}),Hualala.User.QueryShopResultModel=a}(jQuery,window),function(a){IX.ns("Hualala.User");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip),c=(Hualala.UI.LoadingModal,[{act:"reviewRole",label:"查看权限",clz:"btn-info"},{act:"editRole",label:"修改权限",clz:"btn-warning"},{act:"unbindMobile",label:"解绑手机",clz:"btn-warning"},{act:"resetPWD",label:"重置密码",clz:"btn-warning"},{act:"editUser",label:"修改账号",clz:"btn-warning"},{act:"remove",label:"删除账号",clz:"btn-danger"}]),d=Stapes.subclass({constructor:function(){this.$container=null,this.$resultBox=null,this.$list=null,this.$pager=null,this.$queryBar=null,this.$emptyBar=null,this.loadTemplates()}});d.proto({init:function(a){if(this.$container=$XP(a,"container",null),this.model=$XP(a,"model",null),!this.$container||!this.model)throw"User List View Init Failed!";this.initLayout(),this.keywordLst=""},initLayout:function(){var a=this.get("layoutTpl"),b=a();this.$container.append(b),this.$resultBox=this.$container.find(".shop-list"),this.$list=this.$container.find(".shop-list-body"),this.$pager=this.$container.find(".page-selection")},loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_shop_list_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_user_list")),c=Handlebars.compile(Hualala.TplLib.get("tpl_user_query")),d=Handlebars.compile(Hualala.TplLib.get("tpl_user_ctrl")),e=Handlebars.compile(Hualala.TplLib.get("tpl_user_item")),f=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns")),g=Handlebars.compile(Hualala.TplLib.get("tpl_role_binding_info"));Handlebars.registerPartial("userItem",Hualala.TplLib.get("tpl_user_item")),this.set({layoutTpl:a,queryTpl:c,ctrlTpl:d,listTpl:b,btnTpl:f,roleBindingTpl:g,itemTpl:e})},mapUserStatusLabel:function(a){var b=Hualala.TypeDef.UserStatus;return _.find(b,function(b){return $XP(b,"value")==a})},mapListRenderData:function(a){var b=this,c=_.map(a,function(a){return b.mapItemRenderData(a)});return{userItem:{list:c}}},mapItemRenderData:function(a){var b=this,c=b.mapUserStatusLabel($XP(a,"accountStatus"));return IX.inherit(a,{clz:"",accountStatusClz:0==$XP(c,"value")?"label-danger":"label-success",mobileIsBinded:0==$XP(a,"mobileBinded")?!1:!0,accountStatusLabel:$XP(c,"label"),cellClz:0==$XP(a,"mobileBinded")?"text-danger":""})},mapChosenUserData:function(){var a=this,b=a.model.getUsers(),c=[];return c.push({name:"账号",items:_.map(b,function(a){return{code:$XP(a,"accountID"),name:$XP(a,"loginName")+"("+$XP(a,"userName")+")"}
})}),c},render:function(){var a=this,b=a.model,c=b.getPagerParams(),d=$XP(c,"queryID",null);d=IX.isString(d)&&d.length>0?[d]:null;var e=b.getUsers(d),f=a.mapListRenderData(e),g=a.get("listTpl"),h=g(f);a.$emptyBar&&a.$emptyBar.destroy(),a.$list.empty(),0==e.length?(a.$emptyBar=new Hualala.UI.EmptyPlaceholder({container:a.$list}),a.$emptyBar.show()):a.$list.html(h)},rerenderUser:function(b){var c=this,d=c.model,e=d.getUserModelByUserID(b),f=c.mapItemRenderData(e.getAll()),g=c.get("itemTpl"),h=g(f),i=c.$list.find("tr.user-item[data-id="+b+"]");0==i.length?a(h).prependTo(c.$list.find("table.table > tbody")):(i.after(h),i.remove())},initChosenPanel:function(){var b=this,c=new Pymatch([]),d=b.model.getUsers(),e=function(a){c.setNames(_.map(d,function(a){return IX.inherit(a,{name:a.loginName,py:a.py+";"+a.loginName+(a.userMobile?";"+a.userMobile.split(";"):"")})}));var b=c.match(a),e={};return _.each(b,function(a){e[a[0].accountID]=!0}),e};b.$queryBar.find('.navbar-form[role="search"] select').chosen({width:"200px",placeholder_text:"请选择账号",no_results_text:"抱歉，没有找到！",allow_single_deselect:!0,getMatchedFn:e}).change(function(){var c=a(this);b.keywordLst=c.val()})},renderQueryPanel:function(){var b=this,c=this.get("queryTpl"),d=this.mapChosenUserData(),e=b.$container.find(".shop-query");e.length>0&&e.remove(),b.$queryBar=a(c({optGrp:d})),b.$container.prepend(b.$queryBar),b.initChosenPanel()},mapUserBtns:function(a){var b=Hualala.getSessionUser(),d=$XP(b,"loginName",""),e=(a.get("roleType"),a.get("roles")),f=a.get("mobileBinded"),g=a.get("loginName");return e=_.filter(e,function(a){return 1==$XP(a,"binded")}),_.map(c,function(a){var b=$XP(a,"act");return"reviewRole"!=b||e&&0!=e.length?"unbindMobile"==b&&0==f?IX.inherit(a,{clz:a.clz+" hidden disabled"}):"remove"==b&&d==g?IX.inherit(a,{clz:a.clz+" hidden disabled"}):a:IX.inherit(a,{clz:a.clz+" hidden disabled"})})},renderUserCtrl:function(b){var c=this,d=c.get("ctrlTpl"),e=c.model.getUserModelByUserID(b),f=(e.get("roles"),c.mapUserBtns(e)),g=a(d({id:b,btns:f})).hide(),h=c.$list.find("tr[data-id="+b+"]"),i=h.offset(),j=c.$list.find("table tbody").offset(),k=h.height(),l=h.width();c.$list.find(".table-responsive").append(g),g.css({height:k+"px",width:0,display:"block",top:i.top-j.top+"px",right:0}),g.find(".user-ctrl-box").css({width:l+"px",height:k+"px"}),g.animate({width:l+"px"},400)},bindEvent:function(){var b=this;b.$list.on("mouseenter","tr.user-item",function(){var c=a(this),d=c.attr("data-id");b.renderUserCtrl(d);var e=b.$list.find(".user-ctrl[data-id!="+d+"]");e.length>0&&e.trigger("mouseleave")}),b.$list.on("mouseleave",".user-ctrl",function(){{var c=a(this),d=c.attr("data-id"),e=b.$list.find(".user-ctrl[data-id="+d+"]");c.width()}e.animate({width:0},400,function(){e.remove()})}),b.$list.on("click",".user-ctrl .btn",function(){var c=a(this),d=c.attr("data-act"),e=c.parents(".user-ctrl").attr("data-id"),f=b.model.getUserModelByUserID(e),g=f.get("loginName")||"";switch(d){case"reviewRole":b.initReviewRoleModal(e,d);break;case"editRole":b.initSetRoleModal(e,d);break;case"unbindMobile":Hualala.UI.Confirm({title:"手机号解除绑定",msg:"是否解除绑定账号("+g+")的手机号？",okLabel:"解除绑定",okFn:function(){b.model.emit(d,{accountID:e,successFn:function(){b.rerenderUser(e)}})}});break;case"resetPWD":b.initResetPWDModal(e,d);break;case"editUser":b.initUserBaseInfoModal(e,d);break;case"remove":Hualala.UI.Confirm({title:"删除账号",msg:"是否删除账号("+g+")？",okLabel:"删除",okFn:function(){b.model.emit(d,{accountID:e,successFn:function(){var a=b.$list.find("tr.user-item[data-id="+e+"]");b.renderQueryPanel(),a.hide(400,function(){a.remove()})}})}})}}),b.$queryBar.parent().on("click",".shop-query .btn",function(){var c=a(this),d=c.attr("data-act");"query"==d?(b.model.updatePagerParams({queryID:b.keywordLst||null}),b.emit("query",b.model.getPagerParams())):"create"==d&&b.initCreateUserModal(d)}),b.$queryBar.parent().on("keyup",".shop-query .chosen-container",function(){var c=a(this);c.hasClass("chosen-container-active")&&!c.hasClass("chosen-with-drop")&&(c.find("input").first().trigger("blur.chosen"),b.$queryBar.find(".query-btn").trigger("click"))})},moveToTarget:function(a){var b=this,c=$XP(a,"queryID",null);if(c){var d=b.$list.find("tr.user-item[data-id="+c+"]");d.removeClass("shake"),Hualala.Common.smoothScrollMiddle(d,400,function(){setTimeout(function(){d.addClass("shake")},0)})}},initResetPWDModal:function(a,b){var c=this,d=c.model.getUserModelByUserID(a),e=new Hualala.UI.ModalDialog({id:"reset_pwd_modal",clz:"account-modal",title:"重置密码",afterHide:function(){c.resetPWDView=null,c.resetPWDModal=null}});e.show(),c.resetPWDModal=e,c.resetPWDView=new Hualala.User.ResetPWDView({mode:"edit",parentView:c,model:d,evtType:b,successFn:function(){},failFn:function(){}})},initUserBaseInfoModal:function(a,b){var c=this,d=c.model.getUserModelByUserID(a),e=new Hualala.UI.ModalDialog({id:"user_base_modal",clz:"account-modal",title:"修改账号信息",afterHide:function(){c.userBaseInfoView=null,c.userBaseInfoModal=null}});e.show(),c.userBaseInfoModal=e,c.userBaseInfoView=new Hualala.User.UserBaseInfoView({mode:"edit",parentView:c,model:d,evtType:b,successFn:function(a){c.rerenderUser(a.get("accountID")),c.renderQueryPanel()},failFn:function(){}})},initSetRoleModal:function(a,b){var c=this,d=c.model.getUserModelByUserID(a),e=new Hualala.UI.ModalDialog({id:"user_role_modal",clz:"account-modal",title:"修改角色信息",afterHide:function(){c.userRoleModal=null,c.userRoleView=null}});e.show(),c.userRoleModal=e,c.userRoleView=new Hualala.User.UserRoleView({mode:"edit",parentView:c,model:d,evtType:b,successFn:function(a){c.rerenderUser(a.get("accountID"))},failFn:function(){}})},renderRoleBinding:function(a,b,c,d,e){var f=this,g=b._.body,h=b._.footer,i=a.get("loginName"),j=_.map(e,function(a){var b=$XP(a,"items",[]),e=$XP(a,"roleType",""),f=[];return"finance"==e?f=_.map(b,function(a){var b=_.find(d,function(b){return $XP(b,"settleUnitID")==a});return{id:a,name:$XP(b,"settleUnitName","")}}):("manager"==e||"area-manager"==e)&&(f=0==b.length?[]:c.getShops(b),f=_.map(f,function(a){return{id:$XP(a,"shopID"),name:$XP(a,"shopName")}})),IX.inherit(a,{items:f})});j=_.reject(j,function(a){return!$XP(a,"binded")});var k=f.get("roleBindingTpl"),l=f.get("btnTpl"),m=[{clz:"btn-default",name:"cancel",label:"关闭"}],n=k({accountName:i,roles:j});g.html(n),h.html(l({btns:m})),h.find(".btn").click(function(){b.hide()})},initReviewRoleModal:function(a){var c=this,d=c.model.getUserModelByUserID(a);c.shopSchemaModel=null,c.settleData=null;var e=new Hualala.UI.ModalDialog({id:"user_role_info_modal",clz:"account-modal",title:"查看账号权限设置",afterHide:function(){}});e.show();var f=function(a){var b=new Hualala.Shop.QueryModel;b.init({},a)},g=function(a){var c=Hualala.Global.queryAccount;c({},function(c){"000"!=c.resultcode?(b({msg:$XP(c,"resultmsg",""),type:"danger"}),e.hide()):a($XP(c,"data.records"))})};f(function(a){c.shopSchemaModel=a,g(function(a){c.settleData=a,d.emit("queryRoleBinding",{successFn:function(){var a=d.get("roles");c.renderRoleBinding(d,e,c.shopSchemaModel,c.settleData,a),e.show()},failFn:function(){e.hide()}})})})},initCreateUserModal:function(a){var b=this;b.createUserView=new Hualala.User.CreateUserModal({mode:"add",parentView:b,evtType:a,successFn:function(a){b.model.addItem(a),b.rerenderUser(a.get("accountID")),b.renderQueryPanel()},failFn:function(){}})}}),Hualala.User.UserListView=d}(jQuery,window),function(a){IX.ns("Hualala.User");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.UI.LoadingModal,Hualala.Shop.CardListView.subclass({constructor:Hualala.Shop.CardListView.prototype.constructor}));b.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_shop_list_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_list")),c=Handlebars.compile(Hualala.TplLib.get("tpl_bind_shop_item"));Handlebars.registerPartial("shopCard",Hualala.TplLib.get("tpl_bind_shop_item")),Handlebars.registerHelper("checkItemType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),this.set({layoutTpl:a,listTpl:b,itemTpl:c,itemsCache:null})},updateItemsCache:function(a,b,c,d){var e=this,f=e.get("itemsCache");c?d?f.push(b):f=_.without(f,b):f=[b],e.set("itemsCache",f)},mapRenderData:function(a){var b=this,c=b.get("mutiSelect"),d=b.get("userModel"),e=b.get("roleType"),f=d.getRoleInfoByType(e),g=$XP(f,"binded")?$XP(f,"items"):[],h=b.get("itemsCache");h=h?h:g,b.set("itemsCache",h);var i=_.map(a,function(a){var b=$XP(a,"shopID"),d=_.find(h,function(a){return a==b})?"checked":"";return IX.inherit(a,{type:c?"checkbox":"radio",clz:"bind-item",shopNameLabel:$XP(a,"shopName",""),checked:d})});return{shopCard:{list:i}}},render:function(a){var b=this,c=b.model,d=c.getPagerParams(),e=$XP(d,"pageNo");this.set(a);var f=c.getShops(e),g=b.mapRenderData(f),h=b.get("listTpl"),i=h(g);b.$list.empty(),b.$list.html(i),b.initPager({total:c.get("pageCount"),page:c.get("pageNo"),href:"javascript:void(0);"})},bindEvent:function(){var b=this;b.$list.tooltip({selector:"[title]"}),b.$list.delegate(":radio,:checkbox","change",function(){{var c=a(this),d=this.checked?!0:!1,e=c.val(),f=b.get("mutiSelect"),g=b.get("roleType");b.get("userModel")}b.updateItemsCache(g,e,f,d)}),b.$pager.on("page",function(a,c){var d=b.model.getPagerParams();d.pageNo=c,b.model.emit("load",IX.inherit(d,{pageNo:$XP(d,"pageNo",1),pageSize:$XP(d,"pageSize",15)}))})},bindItems:function(){var a=this,b=a.get("userModel"),c=a.get("roleType");b.updateRoleItemsBind(c,a.get("itemsCache"))}}),Hualala.User.QueryShopResultView=b}(jQuery,window),function(){IX.ns("Hualala.User");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.UI.LoadingModal),b=(Hualala.User.UserListModel,Hualala.User.UserListView,Stapes.subclass({constructor:function(a){if(this.set({sessionData:Hualala.getSessionData()}),this.container=$XP(a,"container",null),this.view=$XP(a,"view",null),this.model=$XP(a,"model",null),!this.container||!this.view||!this.model)throw"User List init faild!!";this.isReady=!1,this.bindEvent(),this.init()}}));b.proto({init:function(b){this.model.init(b),this.view.init({model:this.model,container:this.container}),this.loadingModal=new a({start:100}),this.isReady=!0,this.emit("load",{})},hasReady:function(){return this.isReady},bindEvent:function(){this.on({load:function(a){var b=this;b.hasReady()||b.init(a),b.model.emit("load",a)}},this),this.model.on({load:function(a){var b=this,c=function(){b.view.emit("render"),b.loadingModal.hide()};b.loadingModal.show(),b.model.load(a,c)},unbindMobile:function(a){var b=this,c=b.model.getUserModelByUserID($XP(a,"accountID"));c.emit("unbindMobile",{successFn:function(){$XF(a,"successFn")()}})},remove:function(a){var b=this,c=$XP(a,"accountID"),d=b.model.getUserModelByUserID(c);d.emit("remove",{successFn:function(){b.model.removeUsers(c),$XF(a,"successFn")()}})},resetPWD:function(a){var b=this,c=b.model.getUserModelByUserID($XP(a,"accountID"));c.emit("resetPWD",a)}},this),this.view.on({render:function(){var a=this;a.view.render(),a.view.renderQueryPanel(),a.view.bindEvent()},query:function(a){var b=this;b.view.moveToTarget(a)}},this)}}),Hualala.User.UserListController=b}(jQuery,window),function(){IX.ns("Hualala.User");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.UI.LoadingModal,Hualala.Shop.QueryController.subclass({constructor:function(a){this.set({sessionData:Hualala.getSessionData()}),this.container=$XP(a,"container",null),this.resultContainer=$XP(a,"resultContainer",null),this.set({accountID:$XP(a,"accountID",""),roleType:$XP(a,"roleType",""),mutiSelect:$XP(a,"mutiSelect",!1),userModel:$XP(a,"userModel")}),this.model=new Hualala.Shop.QueryModel,this.view=new Hualala.Shop.QueryView,this.resultController=new Hualala.User.QueryShopResultController({container:this.resultContainer,model:new Hualala.User.QueryShopResultModel,view:new Hualala.User.QueryShopResultView}),this.init()}}));a.proto({init:function(){var a=this;a.bindEvent(),a.model.emit("load",function(){if(!a.model.hasReady())throw"Shop Query Init Failed!";a.resultController.initDataStore(a.model.getShops(),{accountID:a.get("accountID"),roleType:a.get("roleType"),mutiSelect:a.get("mutiSelect"),userModel:a.get("userModel")}),a.view.emit("init"),a.emit("reset")})},bindEvent:function(){this.on({reload:function(){var a=this;a.model.distory(),a.view.distory(),a.init()},query:function(a){var b=this;IX.Debug.info("DEBUG: User Query Shops Params:"),IX.Debug.info(a),b.resultController&&b.resultController.emit("load",IX.inherit(a,{pageNo:1,pageSize:50}))},bindItems:function(){var a=this;a.resultController&&a.resultController.emit("bindItems")},reset:function(){var a=this,b=a.get("userModel"),c=a.get("roleType"),d=b.getRoleInfoByType(c),e=$XP(d,"binded")?$XP(d,"items"):[];if(e.length>0){a.view.keywordLst=e[0];var f=a.view.model.getShops(e)[0],g=$XP(f,"cityID",-1),h=$XP(f,"areaID",-1);a.view.updateFilterCityLayout(g),a.view.updateFilterAreaLayout(h),a.emit("query",a.view.getQueryParams())}}},this),this.model.on({load:function(a){var b=this,c={accountID:b.get("accountID")};b.model.init(c,a)}},this),this.view.on({init:function(){var a=this;a.view.init({model:a.model,container:a.container})},filter:function(a){var b=this;b.emit("query",a)},query:function(a){var b=this;b.emit("query",a)}},this)}}),Hualala.User.QueryShopController=a}(jQuery,window),function(){IX.ns("Hualala.User");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.UI.LoadingModal,Hualala.Shop.ShopListController.subclass({constructor:Hualala.Shop.ShopListController.prototype.constructor}));a.proto({initDataStore:function(a,b){this.model.initDataStore(a),this.set(b)},bindEvent:function(){this.on({load:function(a){var b=this;b.hasReady()||b.init(a),b.model.emit("load",a)},bindItems:function(){var a=this;a.view.bindItems()}},this),this.model.on({load:function(a){var b=this,c=function(){b.view.emit("render")};b.model.load(a,c)}},this),this.view.on({render:function(){var a=this;a.view.render(this.getAll())},reloadPager:function(){var a=this;a.view.initPager(params)}},this)}}),Hualala.User.QueryShopResultController=a}(jQuery,window),function(a){IX.ns("Hualala.User");var b=function(){{var b=a("#ix_wrapper > .ix-body > .container");new Hualala.User.UserListController({container:b,model:new Hualala.User.UserListModel({callServer:Hualala.Global.queryShopGroupChildAccount}),view:new Hualala.User.UserListView})}};Hualala.User.UserListInit=b}($,window),function(){IX.ns("Hualala.CRM");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip),b=(Hualala.UI.LoadingModal,{text:"",subtext:"",x:"center",y:"top",textAlign:"center"}),c={trigger:"item",formatter:"{a} <br/>{b} : {c} (约{d}%)"},d={show:!0,feature:{mark:{show:!1},dataView:{show:!1,readOnly:!0},restore:{show:!0},saveAsImage:{show:!0}}},e={orient:"vertical",x:"left",y:"50px",data:null},f=[{id:"member_level_chart",clz:"col-xs-12 col-sm-6 ",chartClz:"ix-chart-canvas",label:"会员等级占比图"},{id:"member_gender_chart",clz:"col-xs-12 col-sm-6 ",chartClz:"ix-chart-canvas",label:"会员性别占比"},{id:"member_source_chart",clz:"col-xs-12 col-sm-12 ",chartClz:"ix-chart-canvas",label:"会员来源占比图"}];Hualala.CRM.BaseChartTitle=b,Hualala.CRM.BaseChartTooltip=c,Hualala.CRM.BaseChartToolBox=d,Hualala.CRM.BaseChartLegend=e,Hualala.CRM.MemberSchemaChartConfigs=f;var g=[{clz:"",cols:[{clz:"",label:"会员等级",colspan:"",rowspan:"2"},{clz:"",label:"会员数",colspan:"",rowspan:"2"},{clz:"",label:"所占比率",colspan:"",rowspan:"2"},{clz:"",label:"性别比率",colspan:"3",rowspan:""},{clz:"",label:"来源比率",colspan:"2",rowspan:""},{clz:"",label:"储值余额",colspan:"",rowspan:"2"},{clz:"",label:"积分余额",colspan:"",rowspan:"2"},{clz:"",label:"客单价<br/>(平均每单消费金额)",colspan:"",rowspan:"2"}]},{clz:"",cols:[{clz:"",label:"男",colspan:"",rowspan:""},{clz:"",label:"女",colspan:"",rowspan:""},{clz:"",label:"未知",colspan:"",rowspan:""},{clz:"",label:"线上",colspan:"",rowspan:""},{clz:"",label:"线下",colspan:"",rowspan:""}]}];Hualala.CRM.MemberSchemaTableHeaderConfigs=g;var h=Stapes.subclass({constructor:function(a){if(this.callServer=$XP(a,"callServer",Hualala.Global.queryCrmMemberSchema),!this.callServer)throw"callServer is empty!"}});h.proto({init:function(){this.set({ds_member:new IX.IListManager,memberSummarize:null})},load:function(b,c){var d=this;d.callServer(b,function(b){"000"==b.resultcode?d.updateDataStore($XP(b,"data",{})):a({msg:$XP(b,"resultmsg",""),type:"danger"}),c.apply(d)})},updateDataStore:function(a){var b=this,c=b.get("ds_member"),d=$XP(a,"datasets.cardOverViewSummerrizingDs.data.records",[]),e=$XP(a,"records",[]);_.each(e,function(a){var b=$XP(a,"cardLevelName");c.register(b,a)}),b.set("memberSummarize",d)},getMemberByLevelNames:function(a){var b=this,c=b.get("ds_member");return a=IX.isString(a)?[a]:a,IX.isEmpty(a)?c.getAll():c.getByKeys(a)},getLevelChartData:function(){var a=this,b=a.getMemberByLevelNames();return _.map(b,function(a){return{name:$XP(a,"cardLevelName",""),value:parseInt($XP(a,"cardCount",0))}})},getGenderChartData:function(){var a=this,b=a.get("memberSummarize")[0]||{},c=_.map(Hualala.TypeDef.GENDER,function(a){var c=parseInt($XP(a,"value",0)),d=null,e=null;switch(c){case 0:d="女",e=parseInt($XP(b,"sexFemaleCount",0));break;case 1:d="男",e=parseInt($XP(b,"sexMaleCount",0));break;case 2:d="未知",e=parseInt($XP(b,"sexUnknownCount",0))}return{name:d,value:e}});return c},getSourceChartData:function(){var a=this,b=a.get("memberSummarize")[0]||{},c=[{key:"onLineCount",name:"线上"},{key:"inShopCount",name:"线下"}];return _.map(c,function(a){return{name:$XP(a,"name",""),value:parseInt($XP(b,$XP(a,"key"),0))}})}}),Hualala.CRM.MemberSchemaModel=h}(jQuery,window),function(a){IX.ns("Hualala.CRM");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.UI.LoadingModal),c=Stapes.subclass({constructor:function(){this.$container=null,this.$tableBox=null,this.$chartBox=null,this.$emptyBar=null,this.chartsCfg=Hualala.CRM.MemberSchemaChartConfigs,this.loadingModal=new b({start:100}),this.loadTemplates()}});c.proto({init:function(a){if(this.$container=$XP(a,"container",null),this.model=$XP(a,"model",null),!this.$container||!this.model)throw"CRM Member Schema View Init Failed!";this.initLayout()},loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_crm_schema_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_cmpx_datagrid"));Handlebars.registerHelper("chkColType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),Handlebars.registerPartial("colBtns",Hualala.TplLib.get("tpl_base_grid_colbtns")),this.set({layoutTpl:a,tableTpl:b})},initLayout:function(){var a=this,b=a.get("layoutTpl");a.$container.html(b({charts:a.chartsCfg})),a.$tableBox=a.$container.find(".crm-schema-table"),a.$chartBox=a.$container.find(".crm-schema-chart")},mapTableRenderData:function(){var a=this,b=a.model.getMemberByLevelNames(),c=a.model.get("memberSummarize"),d=Hualala.CRM.MemberSchemaTableHeaderConfigs,e="cardLevelName,cardCount,levelCardCountRate,sexMaleRate,sexFemaleRate,sexUnknownRate,onLineRate,inShopRate,moneyBalanceSum,pointBalanceSum,consumptionPerOrder",f=Hualala.Common.Math,g=function(a){var b=_.map(e.split(","),function(b){var c=$XP(a,b,""),d="",e="",g=function(a){var b=$XP(a,"cardLevelName"),c=0==$XP(a,"isVipPrice",0)?!1:!0,d=1==$XP(a,"discountRate",1)?"不打折":"打"+f.multi($XP(a,"discountRate",1),10)+"折",e=0==$XP(a,"discountRange",0)?"(部分不打折)，":"",g=$XP(a,"discountDescription",""),h=$XP(a,"switchLevelUpPoint",null),i=Handlebars.compile(Hualala.TplLib.get("tpl_crm_card_level_info"));return i({cardLevelName:b,isVipPrice:c,discountRate:d,discountRange:e,discountDescription:IX.isEmpty(g)?"":g+"，",switchLevelUpPoint:h})};switch(b){case"cardCount":d=parseInt(c),e="number";break;case"levelCardCountRate":case"sexMaleRate":case"sexFemaleRate":case"sexUnknownRate":case"onLineRate":case"inShopRate":d=c+"%",e="number";break;case"moneyBalanceSum":case"pointBalanceSum":case"consumptionPerOrder":d=f.prettyNumeric(f.standardPrice(c)),e="number";break;default:d=c,e="text"}return{clz:e,type:"text",value:c,text:d,title:"cardLevelName"==b?g(a):""}});return b},h=_.map(b,function(a){return{clz:"",cols:g(a)}}),i=_.map(c,function(a){var b=g(a);return b.shift(),b.unshift({clz:"title",value:"",text:"总价："}),{clz:"",cols:b}});return{tblClz:"table table-bordered table-striped table-hover ix-data-report",thead:d,rows:h,tfoot:i}},render:function(){var b=this,c=(b.model,b.mapTableRenderData()),d=b.get("tableTpl"),e=d(c);b.$tableBox.html(e),b.bindEvent(),IX.Net.loadJsFiles([Hualala.Global.ECHART_PATH],function(){b.emit("loaded"),_.map(Hualala.CRM.MemberSchemaChartConfigs,function(b){var c=$XP(b,"id"),d=a("#"+c);d.css({height:"500px"});var e=echarts.init(d[0]);d.data("oChart",e),e.showLoading({text:"加载中...",x:"center",y:"center",effect:"spin"})}),b.renderChart()})},renderChart:function(){var b=this,c=(b.model,Hualala.CRM.MemberSchemaChartConfigs),d=Hualala.CRM.BaseChartLegend,e=Hualala.CRM.BaseChartToolBox,f=Hualala.CRM.BaseChartTooltip,g=Hualala.CRM.BaseChartTitle,h="",i=_.map(c,function(a){var c=$XP(a,"id"),i=$XP(a,"label"),j={},k=null;switch(i=IX.inherit(g,{text:i}),series=null,legend=null,c){case"member_level_chart":h="会员等级",series=b.model.getLevelChartData(),k=_.map(b.model.getMemberByLevelNames(),function(a){return $XP(a,"cardLevelName","")}),legend=IX.inherit(d,{data:k});break;case"member_gender_chart":h="会员性别",series=b.model.getGenderChartData(),legend=IX.inherit(d,{data:["男","女","未知"]});break;case"member_source_chart":h="会员来源",series=b.model.getSourceChartData(),legend=IX.inherit(d,{data:["线上","线下"]})}return j=IX.inherit(j,{title:i,tooltip:f,toolbox:e,legend:legend,calculable:!1,series:[{name:h,type:"pie",radius:"55%",center:["50%","40%"],data:series}]}),{id:c,option:j}});_.each(i,function(b){var c=$XP(b,"id"),d=$XP(b,"option",{}),e=a("#"+c),f=e.data("oChart");f.hideLoading(),f.setOption(d)})},hideLoadingModal:function(){this.loadingModal.hide()},showLoadingModal:function(){this.loadingModal.show()},bindEvent:function(){var a=this;a.$tableBox.tooltip({selector:"p[title]"})}}),Hualala.CRM.MemberSchemaView=c}(jQuery,window),function(){IX.ns("Hualala.CRM");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.UI.LoadingModal,Stapes.subclass({constructor:function(a){if(this.set({sessionData:Hualala.getSessionData()}),this.container=$XP(a,"container",null),this.view=$XP(a,"view",null),this.model=$XP(a,"model",null),!this.container||!this.view||!this.model)throw"CRM Schema Controller init faild!!";this.isReady=!1,this.bindEvent(),this.init()}}));a.proto({init:function(){this.model.init(),this.view.init({model:this.model,container:this.container}),this.isReady=!0,this.emit("load",{})},hasReady:function(){return this.isReady},bindEvent:function(){this.on({load:function(a){var b=this,c=function(){b.view.emit("render")};b.view.emit("loading"),b.model.load(a,c)}},this),this.view.on({render:function(){var a=this;a.view.render()},loaded:function(){this.view.hideLoadingModal()},loading:function(){this.view.showLoadingModal()}},this)}}),Hualala.CRM.MemberSchemaController=a}(jQuery,window),function(a){function b(a){return 8==a.length?a.substr(0,4)+"年"+parseInt(a.substr(4,2))+"月"+parseInt(a.substr(6))+"日":parseInt(a.substr(0,2))+"月"+parseInt(a.substr(2))+"日"}IX.ns("Hualala.CRM");var c=Hualala.Global,d=Hualala.UI.TopTip;Hualala.CRM.initParams=function(e){var f=null,g=null,h=null,i=null,j=null,k=null,l=null;c.getCrmParams({groupID:Hualala.getSessionData().site.groupID},function(c){if("000"!=c.resultcode)return void(c.resultmsg&&d({msg:c.resultmsg,type:"danger"}));var m=c.data;h=m.itemID,m.serviceStartTime=b(m.serviceStartTime),m.serviceEndTime=b(m.serviceEndTime),m.pointClearDate=0==+m.pointClearDate?"不清零":b(m.pointClearDate),m.isPointCanPay=0==m.isPointCanPay?"minus":"ok",f=a(Handlebars.compile(Hualala.TplLib.get("tpl_crm_params"))(m)).appendTo(e),i=f.find("input[name=vipServiceTel]"),j=f.find("textarea[name=vipServiceRemark]"),k=i.siblings("p"),l=j.siblings("p"),f.bootstrapValidator({fields:{vipServiceTel:{validators:{notEmpty:{message:"会员服务电话不能为空"},telOrMobile:{message:""}}}}}),g=f.data("bootstrapValidator")}),e.on("click",function(b){var e=a(b.target);if(e.is(".btn-edit, .btn-save")&&b.preventDefault(),e.is(".btn-edit")&&f.removeClass("read-mode").addClass("edit-mode"),e.is(".btn-save")){if(!g.validate().isValid())return;var m=i.val(),n=j.val(),o={itemID:h,vipServiceTel:m,vipServiceRemark:n};c.setCrmParams(o,function(a){return"000"!=a.resultcode?void(a.resultmsg&&d({msg:a.resultmsg,type:"danger"})):(k.text(m),l.text(n),f.removeClass("edit-mode").addClass("read-mode"),void d({msg:"保存成功！",type:"success"}))})}})}}(jQuery,window),function(a){IX.ns("Hualala.CRM"),Hualala.CRM.initVipLevels=function(b){function c(b,c){for(var d,e=[],f=0;d=b[f++];){var g=a("<tr>");for(var h in c){var k=d[h],m=c[h],n=i[h],o=m.type,p=a("<td>").addClass("t-c");n&&!o&&(k=n[k]),o&&(k=j[o](k,h,p)),p.html(k).appendTo(g)}e.push(g)}a("<tbody>").html(e).appendTo(l)}var d=Hualala.Global,e=Hualala.Common,f=(Hualala.TypeDef.CRM,e.formatDateStr),g=e.Math.prettyNumeric,h=(Hualala.UI,Hualala.UI.TopTip),i={isVipPrice:{0:"不享受",1:"享受"},discountRange:{0:"部分打折",1:"全部打折"},isActive:{0:"未启用",1:"已启用"},icos:{0:'<i class="glyphicon glyphicon-minus no"></i>',1:'<i class="glyphicon glyphicon-ok ok"></i>'}},j={date:function(a){return f(a.replace(/-/g,""),12)},number:function(a,b,c){return c.addClass("t-r"),g(a)},ico:function(b,c){return a(i.icos[b]).attr("title",i[c][b])},discountRate:function(a){return 1==a?"不打折":(10*a).toFixed(1)+"折"}},k={cardLevelName:{title:"会员等级名"},description:{title:"等级说明"},isVipPrice:{title:"是否享受会员价",type:"ico"},discountRate:{title:"折扣率",type:"discountRate"},discountRange:{title:"折扣范围"},discountDescription:{title:"折扣描述"},pointRate:{title:"积分系数",type:"number"},switchLevelUpPoint:{title:"等级所需累计消费金额",type:"number"},isActive:{title:"是否启用",type:"ico"},actionTime:{title:"最后修改时间",type:"date"}},l=a("<table>").addClass("table table-bordered table-striped table-hover"),m=a("<thead><tr></tr></thead>").appendTo(l).find("tr"),n=[];for(var o in k)n.push(a("<th>").addClass("t-c").text(k[o].title));m.append(n),b.append(l),d.getVipLevels({isActive:1},function(a){return"000"!=a.resultcode?void(a.resultmsg&&h({msg:a.resultmsg,type:"danger"})):void c(a.data.records||[],k)})}}(jQuery,window),function(a){function b(a){for(var b,c=[],d=0;b=a[d];d++)+b.isActive&&c.push(b);return c}function c(a,b){for(var c,d=a.length-1;c=a[d--];)if(c.saveMoneySetID==b)return c}function d(a){for(var b,c=a.length-1;b=a[c--];)b.checked=+b.isActive?"checked":""}function e(b){b.bootstrapSwitch({onColor:"success",onText:"已开启",offText:"已禁用"}).on("switchChange.bootstrapSwitch",function(b,c){var d=a(this),e=d.data("setid"),g=c?"开启":"禁用";f.switchCrmRechargeSetState({saveMoneySetID:e,isActive:+c},function(a){return"000"!=a.resultcode?(d.bootstrapSwitch("toggleState",!0),void h({msg:g+"失败"+(a.resultmsg?"："+a.resultmsg:""),type:"danger"})):void h({msg:g+"成功！",type:"success"})})})}IX.ns("Hualala.CRM");var f=Hualala.Global,g=Hualala.UI,h=g.TopTip,i=Hualala.Common.parseForm;Hualala.CRM.initRecharge=function(j){function k(){f.getCrmRechargeSets({},function(b){return"000"!=b.resultcode?void(b.resultmsg&&h({msg:b.resultmsg,type:"danger"})):(s=b.data.records||[],d(s),a(o({sets:s})).appendTo(j.empty()),r=j.find("table"),s.length?void e(j.find("table input")):(r.addClass("hidden"),void j.append(n)))})}function l(d){var e=a(d.target).data("setid");v=e,w=void 0===e,u=c(s,e)||{};var i=(w?"添加":"修改")+"会员充值套餐",j=u.switchCardLevelID||0;x=a(p(u)),y=new g.ModalDialog({title:i,html:x}).show();var k=x.find("select");t?k.append(q({levels:t})).val(j):f.getVipLevels({},function(a){return"000"!=a.resultcode?void(a.resultmsg&&h({msg:a.resultmsg,type:"danger"})):(t=b(a.data.records),void k.append(q({levels:t})).val(j))}),x.bootstrapValidator({fields:{setName:{validators:{notEmpty:{message:"套餐名不能为空"}}},setSaveMoney:{validators:{notEmpty:{message:"充值金额不能为空"},numeric:{message:"充值金额必须是金额数字"}}},returnMoney:{validators:{numeric:{message:"返金额数必须是金额数字"}}},returnPoint:{validators:{numeric:{message:"返积分数必须是数字"}}}}}),z=x.data("bootstrapValidator"),y._.footer.find(".btn-ok").on("click",m)}function m(){if(z.validate().isValid()){var a=i(x);w||(a.saveMoneySetID=v),f[w?"addCrmRechargeSet":"updateCrmRechargeSet"](a,function(a){return"000"!=a.resultcode?void(a.resultmsg&&h({msg:a.resultmsg,type:"danger"})):(h({msg:(w?"添加":"修改")+"成功！",type:"success"}),k(),void y.hide())})}}var n=a('<div class="alert alert-warning t-c">暂无任何会员充值套餐。</div>'),o=Handlebars.compile(Hualala.TplLib.get("tpl_crm_recharge_sets")),p=Handlebars.compile(Hualala.TplLib.get("tpl_crm_recharge_set_add_update")),q=Handlebars.compile(Hualala.TplLib.get("tpl_crm_recharge_set_vip_level")),r=null,s=[],t=null,u=null,v=null,w=null,x=null,y=null,z=null;k(),j.on("click",".well .btn, td .btn",l)}}(jQuery,window),function(a){function b(b,c){for(var d,e=[],f=m.crmQueryTableKeys,i='<i class="glyphicon glyphicon-ok ok" title="手机号已绑定"></i>',j=Hualala.PageRoute.createPath,k=0;d=c[k++];){for(var l,n=a("<tr>"),o=0;l=f[o++];){var p=a("<td>"),q=d[l]||"";"customerMobile"==l&&d.cardNO&&(q+="(卡号)",p.attr("title","卡号："+d.cardNO).attr("data-toggle","tooltip").tooltip({trigger:"click | hover",container:"body"})),/customerSex|cardStatus/.test(l)?q=m[l][q]:/saveMoneyTotal|moneyBalance|giveBalance|consumptionTotal|pointBalance/.test(l)?q=h.prettyNumeric(q):/createTime|customerBirthday/.test(l)?q=g.formatDateStr(q.replace(/-/g,"")):"customerMobile"==l&&+d.isMobileChecked?q+=i:"cardID"==l&&(q=a("<a>查看</a>").attr("href",j("crmMemberDetail",[q]))),p.html(q).appendTo(n)}e.push(n)}b.empty().append(e)}function c(a){f.queryCrm(a,function(a){if("000"!=a.resultcode)return void(a.resultmsg&&l({msg:a.resultmsg,type:"danger"}));var c=a.data.records||[],d=a.data.page;b(p,c),q.IXPager({total:d.pageCount,page:d.pageNo,maxVisible:10,href:"javascript:;"})})}function d(a){return/\d{4}\/\d{2}\/\d{2}/.test(a)?a.split("/").join(""):""}function e(a){for(var b,c=[],d=0;b=a[d];d++)+b.isActive&&c.push(b);return c}IX.ns("Hualala.CRM");var f=Hualala.Global,g=Hualala.Common,h=g.Math,i=Hualala.TypeDef.CRM,j=(IX.Date,Hualala.TplLib),k=Hualala.Common.parseForm,l=Hualala.UI.TopTip,m={cardStatus:i.cardStatus,customerSex:i.customerSex,sourceWay:i.sourceWay,crmQueryTableHeads:["姓名","性别","手机号(卡号)","生日","等级","入会日期","储值余额","积分余额","累计储值总额","累计消费总额","状态","查看"],crmQueryTableKeys:["customerName","customerSex","customerMobile","customerBirthday","cardLevelName","createTime","moneyBalance","pointBalance","saveMoneyTotal","consumptionTotal","cardStatus","cardID"]},n=null,o=15,p=null,q=a("<div>").addClass("pull-right"),r=Handlebars.compile(j.get("tpl_crm_recharge_set_vip_level"));Hualala.CRM.initQuery=function(b){var g={pageNo:1,pageSize:o},h=null;a(Handlebars.compile(j.get("tpl_crm_query"))(m)).appendTo(b),b.append(q),b.find("[data-type=datetimepicker]").datetimepicker({format:"yyyy/mm/dd",startDate:"2010/01/01",autoclose:!0,minView:"month",todayBtn:!0,todayHighlight:!0,language:"zh-CN"}),h=b.find("form"),p=b.find("tbody"),$levels=b.find("[name=cardLevelID]"),n?$levels.append(r({levels:n})):f.getVipLevels({},function(a){return"000"!=a.resultcode?void(a.resultmsg&&l({msg:a.resultmsg,type:"danger"})):(n=e(a.data.records),void $levels.append(r({levels:n})))}),c(g),b.find(".well a").on("click",function(){b.find(".more-crm-query").slideToggle(),this.text="收起"==this.text?"更多查询条件":"收起"}),b.find(".well .btn").on("click",function(){var b=k(h);b.createTimeStart=d(b.createTimeStart),b.createTimeEnd=d(b.createTimeEnd),a.extend(g,b),g.pageNo=1,c(g)}),q.on("page",function(a,b){g.pageNo=b,c(g)})}}(jQuery,window),function(a){IX.ns("Hualala.CRM"),Hualala.CRM.initDetail=function(b,c){function d(b){a('<img alt="会员头像" width="100" height="100">').attr("src",b.photoImage?s+b.photoImage:t).appendTo(w);for(var c,d=a("<div>"),e='<i class="glyphicon glyphicon-ok ok" title="已验证"></i>',f=0;c=r.basicInfo[f++];){var g=a("<ul>");for(var h in c){var i=b[h]||"";i&&(/createTime|customerBirthday|lastConsumptionTime/.test(h)?i=n(i.replace(/-/g,""),12):/moneyBalance|shopChargeGiftSum|pointBalance|saveMoneyTotal|pointGetTotal|consumptionTotal/.test(h)?i=o(i):"customerMobile"==h&&+b.isMobileChecked?i+=e:"customerSex"==h&&(i=r[h][i]),g.append(a("<li>").append(a("<label>").text(c[h])).append(a("<span>").html(i))))
}d.append(g)}w.append(d)}function e(b){var c=x.find("thead tr"),d=[],e=x.find("tbody"),f=[],g=r.transDetail,h=r.transType;for(var i in g)d.push(a("<th>").text(g[i]));c.append(d);for(var j,k=0;j=b[k++];){var l=a("<tr>");for(var i in g){var m=j[i]||"";"transTime"==i?m=n(m,12):/consumptionAmount|moneyChange|transAfterMoneyBalanceSum/.test(i)?m=o(m):"transType"==i&&(m=h[m]),a("<td>").text(m).appendTo(l)}f.push(l)}e.append(f)}function f(b){{var c=y.find("thead tr"),d=[],e=y.find("tbody"),f=[],h=r.event;r.eventWay}for(var i in h)d.push(a("<th>").text(h[i]));c.append(d);for(var j,k=0;j=b[k++];){var l=a("<tr>");for(var i in h){var m=j[i];"createTime"==i?m=n(m,12):"eventNews"==i&&(m=g(j.eventWay,j.winFlag)),a("<td>").text(m).appendTo(l)}f.push(l)}e.append(f)}function g(a,b){var c="已兑换";return 20==a?c=1==b?"一等奖":2==b?"二等奖":"三等奖":21==a?c="已领取":22==c&&(c=1==b?"已入围":"未入围"),c}function h(b){var c=z.find("thead tr"),d=[],e=z.find("tbody"),f=[],g=r.gift;for(var h in g)d.push(a("<th>").text(g[h]));c.append(d);for(var i,j=0;i=b[j++];){var k=a("<tr>");for(var h in g){var l=i[h];/createTime|usingTime|validUntilDate/.test(h)?l=n(l,12):/getWay|giftStatus/.test(h)&&(l=r[h][l]),a("<td>").text(l).appendTo(k)}f.push(k)}e.append(f)}function i(b){var c=A.find("thead tr"),d=[],e=A.find("tbody"),f=[],g=r.cardLog,h=r.logType;for(var i in g)d.push(a("<th>").text(g[i]));c.append(d);for(var j,k=0;j=b[k++];){var l=a("<tr>");for(var i in g){var m=j[i];"createTime"==i?m=n(m,12):"logType"==i&&(m=h[m]),a("<td>").text(m).appendTo(l)}f.push(l)}e.append(f)}function j(a,b,c){k[b](a,function(a){if("000"!=a.resultcode)return void(a.resultmsg&&q({msg:a.resultmsg,type:"danger"}));var d="getCrmDetail"==b?a.data:a.data.records||[];c(d)})}if(c){b.addClass("crm-detail");var k=Hualala.Global,l=Hualala.Common,m=Hualala.TypeDef.CRM,n=l.formatDateStr,o=l.Math.prettyNumeric,p=Hualala.TplLib,q=Hualala.UI.TopTip,r={basicInfo:[{customerName:"姓名",customerSex:"性别",customerBirthday:"生日",createTime:"入会时间",createShopName:"入会店铺"},{customerMobile:"手机号",cardNO:"卡号",cardLevelName:"等级",moneyBalance:"现金储值余额",giveBalance:"赠送储值余额",pointBalance:"积分余额"},{saveMoneyTotal:"储值累计",pointGetTotal:"积分累计",consumptionTotal:"消费累计",consumptionCount:"消费次数",lastConsumptionTime:"最后消费时间"}],customerSex:m.customerSex,transDetail:{transTime:"交易时间",transShopName:"交易店铺",transType:"交易类型",consumptionAmount:"消费金额",moneyChange:"储值余额变动",pointChange:"积分余额变动",transAfterMoneyBalanceSum:"交易后储值余额",transAfterPointBalance:"交易后积分余额",transRemark:"交易备注"},transType:m.transType,event:{cardLevelName:"等级",eventName:"活动主题",eventWay:"活动类型",createTime:"参与时间",eventNews:"活动动态"},eventWay:m.eventWay,gift:{giftName:"名称",createTime:"获得时间",getWay:"获得方式",giftStatus:"状态",usingShopName:"使用店铺",usingTime:"使用时间",validUntilDate:"使用截止日期"},getWay:m.getWay,giftStatus:m.giftStatus,cardLog:{createTime:"时间",shopName:"店铺",logType:"类型",operator:"经办人",remark:"备注"},logType:m.logType},s=k.IMAGE_RESOURCE_DOMAIN+"/",t=k.IMAGE_ROOT+"/dino80.png",u={cardID:c},v=a(p.get("tpl_crm_detail")).appendTo(b),w=v.filter(".basic-info"),x=v.find("#transDetail"),y=v.find("#activities"),z=v.find("#vouchers"),A=v.find("#cardLog");v.find(".tab-pane").addClass("table-responsive"),j(u,"getCrmDetail",d),j(u,"getCrmTransDetail",e),j(u,"getCrmUserEvents",f),j(u,"getCrmUserGifts",h),j(u,"getCrmCardLogs",i)}}}(jQuery,window),function(a){IX.ns("Hualala.CRM"),Hualala.CRM.initPreferential=function(b){function c(){if(C.validate().isValid()){var b=k(B);b.startDate=(b.startDate||"0").replace(/\//g,""),b.endDate=(b.endDate||"0").replace(/\//g,""),b.itemID=y.itemID,h.updateCrmPreferential(b,function(c){return"000"!=c.resultcode?void(c.resultmsg&&n({msg:c.resultmsg,type:"danger"})):(n({msg:"修改成功！",type:"success"}),z.replaceWith(f(a.extend(y,b))),void A.hide())})}}function d(a){return v[i.inArray(v,{itemID:a},"itemID")]}function e(a){for(var b,c=[],d=0;b=a[d++];)c.push(f(b));t.html(c)}function f(b){var c=a("<tr>");for(var d in pref){var e=b[d];/startDate|endDate|actionTime/.test(d)?(e=j(e,12),/startDate|endDate/.test(d)&&!e&&(e="不限")):"action"==d?e=a('<a href="javascript:;">修改</a>').data("itemid",b.itemID):/discountType|pointType/.test(d)?e=o[d][e]:"isActive"==d&&(e=a(stateIco[e]).attr("title",o[d][e])),a("<td>").html(e).appendTo(c)}return c}function g(a){h.getCrmPreferential(a,function(a){if("000"!=a.resultcode)return void(a.resultmsg&&n({msg:a.resultmsg,type:"danger"}));var b=a.data.records||[],c=a.data.page;v=b,e(b),u.IXPager({total:c.pageCount,page:c.pageNo,maxVisible:10,href:"javascript:;"})})}var h=Hualala.Global,i=Hualala.Common,j=(Hualala.TypeDef.CRM,i.formatDateStr),k=(i.Math.prettyNumeric,i.parseForm),l=Hualala.TplLib,m=Hualala.UI,n=Hualala.UI.TopTip,o={pref:{shopName:"店铺名称",startDate:"开始日期",endDate:"结束日期",discountType:"折扣促销方式",discountRate:"促销折扣率",pointType:"积分促销方式",pointRate:"促销积分系数",actionTime:"修改时间",isActive:"是否启用",action:"操作"},discountType:{0:"会员保底折扣率",1:"折上折"},pointType:{0:"倍数",1:"叠加"},isActive:{0:"未启用",1:"已启用"},stateIco:{0:'<i class="glyphicon glyphicon-minus no"></i>',1:'<i class="glyphicon glyphicon-ok ok"></i>'}},p={pageNo:1,pageSize:15},q=a(l.get("tpl_crm_pref")),r=q.filter("table"),s=r.find("thead tr"),t=r.find("tbody"),u=a("<div>").addClass("pull-right"),v=null;pref=o.pref,stateIco=o.stateIco,ths=[];for(var w in pref)ths.push(a("<th>").text(pref[w]));s.append(ths),b.append(q),b.append(u),m.createSchemaChosen(a("[name=shopID]"),a("[name=cityID]")),g(p),$queryForm=q.find("form"),q.on("click",".btn",function(){return p.pageNo=1,a.extend(p,k($queryForm)),g(p),!1});var x=Handlebars.compile(l.get("tpl_crm_pref_update")),y=null,z=null,A=null,B=null,C=null;r.on("click","a",function(){var b=a(this),e=a(this).data("itemid");y=d(e)||{};var f=a.extend({},y);f.startDate=j(f.startDate),f.endDate=j(f.endDate),z=b.parent().parent(),B=a(x(f)),B.find("[name=discountType]").eq(+f.discountType).prop("checked",!0),B.find("[name=pointType]").eq(+f.pointType).prop("checked",!0),B.find("[name=isActive]").val(f.isActive),B.find("[name=startDate],[name=endDate]").datetimepicker({format:"yyyy/mm/dd",startDate:"2010/01/01",autoclose:!0,minView:"month",todayBtn:!0,todayHighlight:!0,language:"zh-CN"}),A=new m.ModalDialog({title:"会员促销参数设置",html:B}).show(),B.bootstrapValidator({fields:{startDate:{validators:{date:{format:"YYYY/MM/DD",message:"开始日期格式不正确"}}},endDate:{validators:{date:{format:"YYYY/MM/DD",message:"结束日期格式不正确"}}},discountRate:{validators:{notEmpty:{message:"促销折扣率不能为空"},greaterThan:{message:"促销折扣率大于0且小于或等于1",inclusive:!1,value:0},lessThan:{message:"促销折扣率必须大于0且小于或等于1",inclusive:!0,value:1}}},pointRate:{validators:{notEmpty:{message:"促销积分系数不能为空"},greaterThan:{message:"促销积分系数必须大于或等于1",inclusive:!0,value:1}}}}}),C=B.data("bootstrapValidator"),A._.footer.find(".btn-ok").on("click",c)}),u.on("page",function(a,b){p.pageNo=b,g(p)})}}(jQuery,window),function(a){function b(b,c){var d=a("<tr>");for(var e in c){var f=c[e],g=f.title,h=a("<th>");f.newRow&&(b.append(d),d=a("<tr>")),f.rowspan&&h.attr("rowspan",f.rowspan),f.colspan&&h.attr("colspan",f.colspan),f.sort&&(g="<span></span>"+g,h.addClass("sort").data("key",e)),d.append(h.html(g))}b.append(d)}function c(b,c,d){for(var e,f=[],g=0;e=c[g++];){var h=a("<tr>");for(var i in d){var j=e[i]||"",k=d[i],l=k.type,m=a("sum"==l?"<th>":"<td>");k.ignore||(l&&(j=z[l](j,e,k,m,g)),k.colspan&&m.attr("colspan",k.colspan),m.html(j).appendTo(h))}f.push(h)}b.html(f)}function d(a,b){"CardSum"!=a&&(b.queryStartTime=b.queryStartTime.replace(/\//g,""),b.queryEndTime=b.queryEndTime.replace(/\//g,"")),o["getCrm"+a](b,function(b){if("000"!=b.resultcode)return void(b.resultmsg&&w({msg:b.resultmsg,type:"danger"}));var d=b.data.records||[],e=b.data.datasets[y[a]].data.records||[],h=b.data.page;c(m,d,f),c($tfoot,e,g),"TransDetail"==a&&(i=d),n.IXPager({total:h.pageCount,page:h.pageNo,maxVisible:10,href:"javascript:;"})})}function e(c,e){if(c=c,e=e.addClass(c),h={pageNo:1,pageSize:15},"TransDetail"!=c){g=a.extend({},f);for(var i in g){g[i]={sumWay:"transWay",type:"sum"},"CardSum"==c&&(g[i].sumWay="sourceWay");break}}"CardSum"!=c&&(h={pageNo:1,pageSize:15,queryStartTime:A,queryEndTime:A},j=a(B).appendTo(e),k=j.find("form"),v.createSchemaChosen(a("[name=transShopID]"),a("[name=cityID]")),k.find("[name=queryStartTime], [name=queryEndTime]").datetimepicker({format:"yyyy/mm/dd",startDate:"2010/10/10",autoclose:!0,minView:"month",todayBtn:!0,todayHighlight:!0,language:"zh-CN"}),j.on("click",".btn",function(){h.pageNo=1,a.extend(h,t(k)),d(c,h)}));var o=a(C).appendTo(e);l=o.find("thead"),m=o.find("tbody"),$tfoot=o.find("tfoot"),n=a("<div>").addClass("pull-right").appendTo(e),b(l,f);var p=l.find(".sort");l.on("click",".sort",function(){var b=a(this),e="";p.not(this).removeClass("asc desc"),b.hasClass("asc")?b.removeClass("asc").addClass(e="desc"):b.hasClass("desc")?b.removeClass("desc").addClass(e=""):b.addClass(e="asc"),h.orderBy=e?b.data("key")+" "+e:"",d(c,h)}),d(c,h),n.on("page",function(a,b){h.pageNo=b,d(c,h)})}IX.ns("Hualala.CRM");var f,g,h,i,j,k,l,m,n,o=Hualala.Global,p=Hualala.Common,q=Hualala.TypeDef.CRM,r=p.formatDateStr,s=p.Math.prettyNumeric,t=p.parseForm,u=Hualala.TplLib,v=Hualala.UI,w=Hualala.UI.TopTip,x={1:"线上合计",0:"线下合计","-1":"总计"},y={TransSum:"summerizingGroupByTransWayDs",TransDetail:"detailGroupByTransWayDs",CardSum:"cardCreateSumarizeGroupByTransWayDs",RechargeSum:"summerizingGroupByTransWayDs"},z={date:function(a){return r(a.replace(/-/g,""),12)},number:function(a,b,c,d){return d.addClass("t-r"),s(a)},mobile:function(a,b,c,d){return b.cardNO&&(a+="(卡号)",d.attr("title","卡号："+b.cardNO).attr("data-toggle","tooltip").tooltip({trigger:"click | hover",container:"body"})),a},transType:function(a){return q.transType[a]},viewDetail:function(b,c){return a('<a href="javascript:;">详情</a>').data("transid",c.transID)},sum:function(a,b,c){return x[b[c.sumWay]]+(c.count?"(共"+a+"笔)":"")},shopName:function(a,b,c,d,e){return(c.count?e+". ":"")+(+b[c.shopID]?a:"网上储值")}},A=IX.Date.getDateByFormat(IX.Date.formatDate(new Date),"yyyy/MM/dd"),B=Handlebars.compile(u.get("tpl_crm_query_panel"))({today:A}),C=u.get("tpl_report_table");Hualala.CRM.initTransSum=function(a){f={transShopName:{title:"店铺",type:"shopName",shopID:"transShopID",count:1,rowspan:2},shopCharge:{title:"储值业务",ignore:1,colspan:4},shopConsumption:{title:"消费业务",ignore:1,colspan:5},shopChargeCount:{title:"笔数",type:"number",sort:1,newRow:1},shopChargeSum:{title:"现金金额",type:"number",sort:1},shopChargeGiftSum:{title:"赠送金额",type:"number",sort:1},shopChargeReturnPointSum:{title:"返积分数",type:"number",sort:1},shopConsumptionCount:{title:"笔数",type:"number",sort:1},shopconsumptionAmountSum:{title:"消费金额",type:"number",sort:1},shopMinusMoneySum:{title:"余额支付",type:"number",sort:1},shopConsumeDeductPointSum:{title:"积分抵扣",type:"number",sort:1},shopConsumptionReturnPointSum:{title:"返积分",type:"number",sort:1}},e("TransSum",a)},Hualala.CRM.initTransDetail=function(b){f={transTime:{title:"交易时间",type:"date",sort:1},transShopName:{title:"交易店铺",type:"shopName",shopID:"transShopID"},customerName:{title:"会员姓名"},customerMobile:{title:"手机号(卡号)",type:"mobile"},transType:{title:"交易类型",type:"transType"},consumptionAmount:{title:"消费金额",type:"number",sort:1},moneyChange:{title:"储值余额变动",type:"number",sort:1},pointChange:{title:"积分余额变动",type:"number",sort:1},transRemark:{title:"交易备注"},action:{title:"操作",type:"viewDetail"}},g={transCount:{sumWay:"transWay",type:"sum",count:1,colspan:5},shopconsumptionAmountSum:{type:"number"},moneyChangeSum:{type:"number"},pointChangeSum:{type:"number"},empty:{colspan:3}},e("TransDetail",b),k.prepend('<span>关键字<input type="text" name="keyword" placeholder="手机号/卡号" class="form-control"></span>'),v.fillSelect(a('<span>类型<select name="transType" class="form-control"></span>').appendTo(k).find("select"),q.transType).prepend('<option value="">不限</option>').val(""),m.on("click","a",function(){var b=i[p.inArray(i,{transID:a(this).data("transid")},"transID")].transReceiptsTxt.replace(/\n/g,"<br>"),c=new v.ModalDialog({clz:"modal-trans-detail",title:"会员交易账单详情",html:b}).show();c._.footer.find(".btn-close").remove(),c._.footer.find(".btn-ok").text("确定").attr("data-dismiss","modal")})},Hualala.CRM.initCardSum=function(a){f={createShopName:{title:"店铺",type:"shopName",shopID:"createShopID"}};for(var b=(new Date).getMonth()+1,c=5;c>0;c--){var d=b-c;d=1>d?d+12:d,f["sub"+c+"MonthCardCount"]={title:d+"月新增",type:"number",sort:1}}f.curMonthCardCount={title:"本月新增",type:"number",sort:1},f.cardCount={title:"当前会员总数",type:"number",sort:1},f.useableCardCount={title:"有效会员总数",type:"number",sort:1},e("CardSum",a)},Hualala.CRM.initRechargeSum=function(a){f={transShopName:{title:"店铺",type:"shopName",shopID:"transShopID",rowspan:"2"},saveMoneyCount:{title:"笔数",type:"number",rowspan:"2"},saveMoneyAmountSum:{title:"现金储值金额",type:"number",rowspan:"2"},saveReturnMoneyAmountSum:{title:"赠送储值金额",type:"number",rowspan:"2"},rechargeWay:{title:"收款方式",ignore:1,colspan:5},saveMoneyCashSum:{title:"现金",type:"number",newRow:1},saveMoneyCardSum:{title:"银行卡",type:"number"},saveMoneyCheckSum:{title:"支票",type:"number"},saveMoneyOtherSum:{title:"其他",type:"number"},saveMoneyOnlineChargeSum:{title:"哗啦啦付款",type:"number"}},e("RechargeSum",a)}}(jQuery,window),function(a){function b(b){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container"),e=Handlebars.compile(Hualala.TplLib.get("tpl_order_subnav"));Handlebars.registerPartial("toggle",Hualala.TplLib.get("tpl_site_navbarToggle")),d.empty(),d.html('<div class="crm-subnav clearfix" /><div class="crm-body" ><div class="crm-query-box"></div><div class="crm-result-box"></div></div>');{var f=function(){var a=_.map(b,function(a){var b=_.map($XP(a,"pkeys",[]),function(){return""});return{active:$XP(c,"name")==a.name?"active":"",disabled:"",path:Hualala.PageRoute.createPath(a.name,b)||"#",name:a.name||"",label:a.label||""}});return{toggle:{target:"#order_navbar"},items:a}},g=d.find(".crm-subnav");d.find(".crm-body").addClass("table-responsive")}g.html(e(f()))}function c(){Hualala.PageRoute.getPageContextByPath(),a("#ix_wrapper > .ix-body > .container");b(Hualala.TypeDef.CRMMemberSubNavType);var c=IX.Date.getDateByFormat(new Hualala.Date((new Date).getTime()/1e3).toText(),"yyyyMMdd"),d=_.find(Hualala.TypeDef.CRMMemberSubNavType,function(a){return"crmMemberSchema"==a.name}),e=$XP(d,"pkeys",[]);e=_.map(e,function(a){return"startDate"==a||"endDate"==a?c:""}),document.location.href=Hualala.PageRoute.createPath("crmMemberSchema",e)}function d(){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container");b(Hualala.TypeDef.CRMMemberSubNavType);{var e=d.find(".crm-body");$XP(_.findWhere(Hualala.TypeDef.CRMMemberSubNavType,{name:$XP(c,"name")}),"pkeys"),new Hualala.CRM.MemberSchemaController({container:e,view:new Hualala.CRM.MemberSchemaView,model:new Hualala.CRM.MemberSchemaModel})}}function e(){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container");b(Hualala.TypeDef.CRMMemberSubNavType);{var e=d.find(".crm-body");$XP(_.findWhere(Hualala.TypeDef.CRMMemberSubNavType,{name:$XP(c,"name")}),"pkeys")}Hualala.CRM.initQuery(e)}function f(){var b=Hualala.PageRoute.getPageContextByPath(),c=a("#ix_wrapper > .ix-body > .container");Hualala.UI.BreadCrumb({container:c,hideRoot:!0,nodes:Hualala.PageRoute.getParentNamesByPath()}),Hualala.CRM.initDetail(c,b.params[0])}function g(){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container");b(Hualala.TypeDef.CRMMemberSubNavType);{var e=d.find(".crm-body");$XP(_.findWhere(Hualala.TypeDef.CRMMemberSubNavType,{name:$XP(c,"name")}),"pkeys")}Hualala.CRM.initCardSum(e)}function h(){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container");b(Hualala.TypeDef.CRMDealSubNavType);{var e=d.find(".crm-body");$XP(_.findWhere(Hualala.TypeDef.CRMDealSubNavType,{name:$XP(c,"name")}),"pkeys")}Hualala.CRM.initTransSum(e)}function i(){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container");b(Hualala.TypeDef.CRMDealSubNavType);{var e=d.find(".crm-body");$XP(_.findWhere(Hualala.TypeDef.CRMDealSubNavType,{name:$XP(c,"name")}),"pkeys")}Hualala.CRM.initTransDetail(e)}function j(){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container");b(Hualala.TypeDef.CRMDealSubNavType);{var e=d.find(".crm-body");$XP(_.findWhere(Hualala.TypeDef.CRMDealSubNavType,{name:$XP(c,"name")}),"pkeys")}Hualala.CRM.initRechargeSum(e)}function k(){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container");b(Hualala.TypeDef.CRMParamsSubNavType);{var e=d.find(".crm-body");$XP(_.findWhere(Hualala.TypeDef.CRMParamsSubNavType,{name:$XP(c,"name")}),"pkeys")}Hualala.CRM.initParams(e)}function l(){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container");b(Hualala.TypeDef.CRMParamsSubNavType);{var e=d.find(".crm-body");$XP(_.findWhere(Hualala.TypeDef.CRMParamsSubNavType,{name:$XP(c,"name")}),"pkeys")}Hualala.CRM.initVipLevels(e)}function m(){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container");b(Hualala.TypeDef.CRMParamsSubNavType);{var e=d.find(".crm-body");$XP(_.findWhere(Hualala.TypeDef.CRMParamsSubNavType,{name:$XP(c,"name")}),"pkeys")}Hualala.CRM.initRecharge(e)}function n(){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container");b(Hualala.TypeDef.CRMParamsSubNavType);{var e=d.find(".crm-body");$XP(_.findWhere(Hualala.TypeDef.CRMParamsSubNavType,{name:$XP(c,"name")}),"pkeys")}Hualala.CRM.initPreferential(e)}IX.ns("Hualala.CRM"),Hualala.CRM.CRMPageLayoutInit=b,Hualala.CRM.CRMHomePageInit=c,Hualala.CRM.MemberSchemaInit=d,Hualala.CRM.QueryMemberInit=e,Hualala.CRM.MemberDetailInit=f,Hualala.CRM.CardStatisticInit=g,Hualala.CRM.DealSummaryInit=h,Hualala.CRM.DealDetailInit=i,Hualala.CRM.RechargeReconciliationInit=j,Hualala.CRM.CRMSettingsParamsInit=k,Hualala.CRM.CRMSettingsLevelsInit=l,Hualala.CRM.RechargePackageBusinessInit=m,Hualala.CRM.ShopSpecialPriceInit=n}(jQuery,window),function(a){IX.ns("Hualala.Weixin"),Hualala.Weixin.initReply=function(b,c){function d(a){j.deleteWeixinAutoReplyRole({itemID:a},function(b){return"000"!=b.resultcode?void(b.resultmsg&&o({msg:b.resultmsg,type:"danger"})):(o({msg:"删除成功！",type:"success"}),p.splice(h(a,!0),1),void(p.length?g():f()))})}function e(b,d,e,g,h){var i=g.val(),k=_.findWhere(y,{itemID:i});a.extend(d,l(e)),d.replyContent=k.resTitle,d.mpID=c,d.itemID=d.itemID||"",d.pushMsgType="text",d.replyMsgType="2"==k.resType?"text":"news",d.resourceVaule=1;var m=_.pick(d,"itemID","mpID","pushContentType","replyContent","resourceID","resourceVaule","replyMsgType","pushMsgType","pushContent");j[b?"updateWeixinAutoReplyRole":"addWeixinAutoReplyRole"](m,function(a){return"000"!=a.resultcode?void(a.resultmsg&&o({msg:a.resultmsg,type:"danger"})):(o({msg:(b?"修改":"添加")+"成功！",type:"success"}),x={mpID:c,pageNo:1,pageSize:15},f(),void h.hide())})}function f(){j.getWeixinAutoReplyList(x,function(a){if("000"!=a.resultcode)return void(a.resultmsg&&o({msg:a.resultmsg,type:"danger"}));var b=a.data.records||[],c=a.data.page;p=b,_.each(p,function(a){a.pushMsg=0==a.pushContentType?"消息为“<b>"+a.pushContent+"</b>”":"消息中含“<b>"+a.pushContent+"</b>”"}),g(),t.IXPager({total:c.pageCount,page:c.pageNo,maxVisible:10,href:"javascript:;"})})}function g(){u[p.length?"hide":"show"]();for(var a,b=[],c=0;a=p[c++];)b.push(v(a));s.html(b.join(""))}function h(a,b){for(var c,d=0;c=p[d++];)if(c.itemID==a)return b?d-1:c;return b?-1:null}var i=Hualala.Weixin,j=Hualala.Global,k=Hualala.Common,l=k.parseForm,m=Hualala.TplLib,n=Hualala.UI,o=Hualala.UI.TopTip;if(c){var p,q=a(m.get("tpl_wx_reply_query")).appendTo(b),r=q.find("form"),s=q.find("tbody"),t=a("<div>").addClass("pull-right").appendTo(b),u=n.EmptyPlaceholder({msg:"无相关结果!",container:b}),v=Handlebars.compile(m.get("tpl_wx_reply_query_item")),w=Handlebars.compile(m.get("tpl_wx_reply_add_update")),x={mpID:c,pageNo:1,pageSize:15},y=[];f(),q.on("click",".btn-warning",function(){a.extend(x,l(r)),x.pageNo=1,f()}),t.on("page",function(a,b){x.pageNo=b,f()}),s.on("click",".delete-reply",function(){var b=a(this).data("itemid");n.Confirm({msg:"确定删除？",okFn:function(){d(b)}})}),q.on("click",".update-reply, .btn-success",function(){var b=a(this).data("itemid"),c=b?h(b):{},d=a(w(c)),f=d.find("select"),g=d.find(".form-control-static");d.find("[name=pushContentType]").eq(c.pushContentType||0).prop("checked",!0),i.createResourceChosen(f,g,y,c.resourceID||"").done(function(a){y=a;var g=new n.ModalDialog({title:(b?"修改":"添加")+"微信自动回复规则",html:d}).show();g._.footer.find(".btn-ok").on("click",function(){e(b,c,d,f,g)})})})}}}(jQuery,window),function(a){IX.ns("Hualala.Weixin"),Hualala.Weixin.initSubscribe=function(b,c){var d=Hualala.Weixin,e=Hualala.Global,f=(Hualala.Common,Hualala.TplLib),g=(Hualala.UI,Hualala.UI.TopTip);if(c){var h=a(f.get("tpl_wx_subscribe")).appendTo(b),i=h.find("select"),j=h.find(".form-control-static"),k=h.find("#saveBtn"),l={mpID:c,pushMsgType:"event",pushEvent:"subscribe"},m=[];e.getWeixinSubscribe({mpID:c,pushEvent:'("subscribe")'},function(a){if(k.prop("disabled",!1),"000"!=a.resultcode)return void(a.resultmsg&&g({msg:a.resultmsg,type:"danger"}));var b=a.data.records||[],c=b[0];l=c||l,d.createResourceChosen(i,j,m,l.resourceID).done(function(a){m=a})}),k.on("click",function(){var a=i.val(),b=_.findWhere(m,{itemID:a});l.resourceID=a,l.resourceVaule=1,l.replyContent=b.resTitle,l.replyMsgType="2"==b.resType?"text":"news",e[l.itemID?"updateWeixinSubscribe":"addWeixinSubscribe"](l,function(a){return"000"!=a.resultcode?void(a.resultmsg&&g({msg:a.resultmsg,type:"danger"})):(g({msg:"保存成功！",type:"success"}),void(l.itemID||(l.itemID=a.data.records[0].itemID)))})})}}}(jQuery,window),function(a){IX.ns("Hualala.Weixin"),Hualala.Weixin.initMenu=function(b,c){function d(b){var c=b||[],d=c[0]||{},f=a.parseJSON(d.menuJson||"{}"),g=f.menu||{};J=g.button||[],e()}function e(){for(var b,c=[],d=0;b=J[d];d++){b.id=""+d,b.url&&(b.softType="22",b.softWenChoose=b.url,delete b.url);for(var e,f=a("<dl>").append(dt(b)),g=b.sub_button||[],h=0;e=g[h];h++)e.id=d+""+h,e.url&&(e.softType="22",e.softWenChoose=e.url,delete e.url),f.append(dd(e));c.push(f)}$menuWrap.html(c),$noMenuTip.toggleClass("hidden",!!J.length);var i=K?$menuWrap.find("#"+K.id):null;i&&i[0]?l.call(i,{target:i}):n(null,"showTip","请选择某个菜单项，然后在此选择或者设置相关动作。")}function f(){var b=J.length;if(b>=3)return void D.Alert({msg:"微信一级菜单最多只能创建3个！"});var c=a(editMenuTpl({menuType:"一",max:5})),d=c.find("input"),f=new D.ModalDialog({title:"添加一级菜单",html:c}).show();f._.footer.find(".btn-ok").text("确定").on("click",function(){var b=a.trim(d.val());if(!b)return void G({msg:"请输入菜单名称！"});var c=K={name:b};J.push(c),e(),f.hide()})}function g(a){a.button("importing"),I.attr("disabled","disabled"),F("importWinxinMenu",{mpID:c}).done(function(a){K=null,J=[],G({msg:"导入成功！",type:"success"}),d(a)}).always(function(){j(a)})}function h(a){var b=k();b&&(a&&(a.button("saving"),I.attr("disabled","disabled")),F("saveWinxinMenu",b,null,!1).done(function(){G({msg:"保存成功！",type:"success"})}).always(function(){j(a)}))}function i(a){var b=k();b&&(a.button("publishing"),I.attr("disabled","disabled"),F("publishWinxinMenu",b,null,!1).done(function(){G({msg:"发布成功！",type:"success"})}).always(function(){j(a)}))}function j(a){a&&setTimeout(function(){a.button("reset"),I.removeAttr("disabled")},300)}function k(){for(var a,b=JSON.parse(JSON.stringify(J)),d=0;a=b[d];d++){a.sub_button=a.sub_button||[];var e=a.sub_button;if(!a.type&&!e.length)return G({msg:"一级菜单“"+a.name+"”没有设置动作，也没有添加二级菜单！",type:"warning"}),!1;delete a.id;for(var f,g=0;f=e[g];g++){if(!f.type)return G({msg:"二级菜单“"+f.name+"”没有设置动作！",type:"warning"}),!1;f.sub_button=[],delete f.id}}return{mpID:c,menuJson:JSON.stringify({menu:{button:b}})}}function l(b){var c=a(this),d=c.attr("id"),e=a(b.target),f=m(d),g=f.menu,h=e.data("action");if(e.is("span i")&&h&&N[h]&&N[h](c,f),!c.is(".selected")&&!e.is("span i")){K=g,$menuHover.remove(),$menuWrap.find(".selected").removeClass("selected"),c.addClass("selected").append($menuClick);var i=g.type,j=g.sub_button||[];i||j.length?!i&&j.length?n(null,"showTip","已有子菜单，无法设置动作！"):"click"==i?n(null,"sendMsg"):"view"==i?n(null,"toPage"):"scancode_push"==i&&n(null,"scanCode"):n(null,"chooseAction")}}function m(a){for(var b,c=0;b=J[c];c++){if(a==b.id)return{menu:b,menus:J,index:c};for(var d,e=b.sub_button||[],f=0;d=e[f];f++)if(a==d.id)return{menu:d,menus:e,index:f}}}function n(a,b,c){var d=b||a.data("target"),e=N[d];$actions.hide().filter("#"+d).fadeIn(),e&&e(c)}function o(a){$showTip.text(a)}function q(){for(p in K)/name|id/.test(p)||delete K[p]}function r(){var a=K.key||"",b=a.match(/\d+/),c=b&&b[0]||"",d=$resWrap.html(resSelect).find("select");B.createResourceChosen(d,$resView,L,c).done(function(a){L=a})}function s(){var a=$resWrap.find("select").val();if(!a)return void G({msg:"未选择任何事件回复内容！"});var b=_.find(L,{itemID:a}),c=_.pick(b,"mpID","resTitle");c.resourceID=a,c.resType=2==b.resType?"text":"news",c.pushEvent="('CLICK')",F("WeixinMenuClick",c,null,!1).done(function(){K.type="click",K.key="Resources:"+a,G({msg:"菜单设置成功！（保存菜单后生效）",type:"success"})})}function t(){B.createLinkSelector($selectWrap,$contentWrap,M,K.softType,K.softWenChoose)}function u(){var a=$selectWrap.find("select").val();if(!a)return void G({msg:"未选择任何链接类型！",type:"warning"});var b=$contentWrap.find("select, input"),c=b.val();return b[0]&&!c?void G({msg:"未选择或填写任何链接内容！",type:"warning"}):(K.type="view",K.softType=a,K.softWenChoose=c||"",void G({msg:"菜单设置成功！（保存菜单后生效）",type:"success"}))}function v(){K.type="scancode_push",K.key="scanMenu"}function w(b,c){var d=c.menu,f=(d.id,d.sub_button||[]),g=f.length;if(d.type)return void D.Alert({msg:"该菜单已有动作，要添加子菜单，请先取消此菜单的动作!"});if(g>=5)return void D.Alert({msg:"微信二级菜单最多只能创建5个！"});var h=a(editMenuTpl({menuType:"二",max:13})),i=h.find("input"),j=new D.ModalDialog({title:"添加二级菜单",html:h}).show();j._.footer.find(".btn-ok").text("确定").on("click",function(){var b=a.trim(i.val());if(!b)return void G({msg:"请输入菜单名称！"});var c=K={name:b};f.push(c),d.sub_button=f,e(),j.hide()})}function x(b,c){var d=c.menu,e=1==d.id.length?"一":"二",f=1==d.id.length?"5":"13",g=a(editMenuTpl({name:d.name,menuType:e,max:f})),h=g.find("input"),i=new D.ModalDialog({title:"编辑菜单名称",html:g}).show();i._.footer.find(".btn-ok").text("确定").on("click",function(){var c=a.trim(h.val());return c?(d.name=c,b.find("b").text(c),void i.hide()):void G({msg:"请输入菜单名称！"})})}function y(a,b){D.Confirm({msg:"确定删除？",okFn:function(){b.menus.splice(b.index,1),K&&!m(K.id)&&(K=null),e()}})}function z(a,b){if(0!=b.index){var c=b.index,d=b.menu,f=b.menus,g=f[c-1];f[c-1]=d,f[c]=g,e()}}function A(a,b){var c=b.index,d=b.menu,f=b.menus,g=f.length-1;if(c!=g){var h=f[c+1];f[c+1]=d,f[c]=h,e()}}if(c){var B=Hualala.Weixin,C=(Hualala.Global,Hualala.Common),D=Hualala.UI,E=Hualala.TplLib,F=C.loadData,G=D.TopTip,H=a(E.get("tpl_wx_menu")).appendTo(b),I=b.find("#menuPanel button");$menuWrap=b.find("#menuWrap"),dt=Handlebars.compile('<dt id="{{id}}"><i class="caret"></i><b>{{name}}</b></dt>'),dd=Handlebars.compile('<dd id="{{id}}"><b>{{name}}</b></dd>'),editMenuTpl=Handlebars.compile(E.get("tpl_wx_menu_edit")),$menuClick=a(E.get("tpl_wx_menu_ops")),$menuHover=$menuClick.clone(),$noMenuTip=b.find("#noMenuTip"),$actions=b.find("#actionPanel > div"),$showTip=b.find("#showTip"),resSelect='<select class="link-select"></select>',$resWrap=$actions.find(".res-wrap"),$resView=$actions.find(".res-preview"),$selectWrap=$actions.find(".link-select-wrap"),$contentWrap=$actions.find(".link-content-wrap"),$save=b.find("#saveBtn");var J=[],K=null,L=[],M={},N={addMenu:f,importMenu:g,saveMenu:h,publishMenu:i,toAction:n,showTip:o,chooseAction:q,sendMsg:r,saveMsg:s,toPage:t,saveLink:u,scanCode:v,addSubMenu:w,editMenu:x,deleteMenu:y,moveMenuUp:z,moveMenuDown:A};F("getWeixinAccounts",{mpID:c}).done(d),$menuWrap.on("mouseenter","dt, dd",function(){var b=a(this);b.is(".selected")||b.append($menuHover)}).on("mouseleave","dt, dd",function(){$menuHover.remove()}).on("click","dt, dd",l),H.on("click",function(b){var c=a(b.target),d=c.data("action");!c.is("dt, dd, .glyphicon")&&d&&N[d]&&N[d](c)})}}}(jQuery,window),function(a,b){IX.ns("Hualala.Weixin"),Hualala.Weixin.initAdvertorial=function(c){function d(){J=[],u.hide(),z.addClass("dn"),A.addClass("dn"),v.show(),p.loadData("getAdvertorials",I,null,"data").done(function(a){a.records=a.records||[],_.each(a.records,function(a){a.time=p.formatDateStr(a.actionTime,8)}),J=a.records,e(a)}).always(function(){v.hide()})}function e(a){u.show().html(H(a));var b=a.page;w.IXPager({total:b.pageCount,page:b.pageNo,maxVisible:10,href:"javascript:;"}),z.toggleClass("dn",!J.length),A.toggleClass("dn",!J.length),x.toggleClass("dn",!!J.length),J.length&&u.find("li").eq(0).click()}function f(){return y.is(".editing")?void s({msg:"请先保存当前正在编辑的软文！",type:"warning"}):(u.find(".current").removeClass("current"),G=null,C.val(""),D.text(K),adEditor.setContent(""),y.addClass("editing"),A.removeClass("dn"),void z.addClass("dn"))}function g(){y.addClass("editing"),z.attr("disabled","disabled")}function h(a){r.Confirm({msg:"确定删除？",okFn:function(){m(a,"deleting"),p.loadData("deleteAdvertorial",{itemID:G.itemID},null,!1).done(function(){var a=p.inArray(J,G,"itemID");u.find("[data-id="+G.itemID+"]").remove(),J.splice(a,1),G=null,u.find("li").eq(0).click(),J.length||(I.pageNo=1,d()),s({msg:"删除成功!",type:"success"})}).always(function(){n(a)})}})}function i(b){var c=a.trim(C.val());if(!c)return s({msg:"请输入软文标题！",type:"warning"}),void C.focus();m(b,"saving");var d=adEditor.getContent(),e=G?G.groupName:e,f=G?j:k;f(b,{title:c,body:d,groupName:K})}function j(a,b){b.itemID=G.itemID,p.loadData("updateAdvertorial",b,null,!1).done(function(){I.pageNo=1,d(),y.removeClass("editing"),z.removeAttr("disabled","disabled"),s({msg:"保存成功!",type:"success"})}).always(function(){n(a)})}function k(b,c){p.loadData("createAdvertorial",c).done(function(b){G=b[0],G.time=p.formatDateStr(G.actionTime,8),J.unshift(G),y.removeClass("editing"),x.addClass("dn"),a(H({records:b})).prependTo(u.show()).click(),s({msg:"保存成功!",type:"success"})}).always(function(){n(b)})}function l(){return y.removeClass("editing"),J.length?G?(z.removeAttr("disabled"),C.val(G.title),adEditor.setContent(G.body),void a(b).scrollTop(0)):void u.find("li").eq(0).click():(z.addClass("dn"),A.addClass("dn"),void x.removeClass("dn"))}function m(a,b){a&&(a.button(b),a.attr("disabled","disabled"))}function n(a){a&&setTimeout(function(){a.button("reset").removeAttr("disabled")},300)}var o=Hualala.Weixin,p=Hualala.Common,q=Hualala.TplLib,r=Hualala.UI,s=Hualala.UI.TopTip,t=a(q.get("tpl_wx_advertorial")).appendTo(c),u=c.find("#adList ul"),v=c.find(".ad-loading"),w=c.find(".ad-pager"),x=c.find("#adList .alert"),y=c.find("#adCont"),z=y.find(".panel-head .btn"),A=y.find("article"),B=y.find(".ad-title"),C=y.find(".ad-title-input"),D=y.find(".ad-sub-title"),E=y.find(".ad-preview");UM.delEditor("adEditor");var F=o.getEmotions();dataHolder={},toolbar=o.extendUM(F,dataHolder),adEditor=UM.getEditor("adEditor",{toolbar:["source | undo redo | bold italic underline strikethrough | superscript subscript | forecolor backcolor | removeformat |","insertorderedlist insertunorderedlist | selectall cleardoc paragraph | fontfamily fontsize","| justifyleft justifycenter justifyright justifyjustify |","wxlink unlink | image video | map","| horizontal print preview","drafts"]});var G,H=Handlebars.compile(["{{#each records}}",'<li data-id="{{itemID}}">',"<h3>{{title}}</h3>","<h6>{{time}}  {{groupName}}</h6>","</li>","{{/each}}"].join("")),I={pageNo:1,pageSize:10},J=[],K=Hualala.getSessionSite().groupName,L={addAd:f,editAd:g,delAd:h,saveAd:i,concelEdit:l};u.on("click","li",function(){if(y.is(".editing"))return void s({msg:"请先保存或者取消当前正在编辑的软文！",type:"warning"});var c=a(this);u.find("li").removeClass("current"),c.addClass("current"),G=_.findWhere(J,{itemID:c.data("id")+""}),B.text(G.title),C.val(G.title),D.text(G.time+"  "+G.groupName),E.html(G.body),adEditor.setContent(G.body),A.removeClass("dn"),z.removeClass("dn"),a(b).scrollTop(0)
}),t.on("click",".btn",function(){var b=a(this),c=b.data("action");c&&L[c]&&L[c](b)}),w.on("page",function(a,b){I.pageNo=b,d()}),d()}}(jQuery,window),function(a,b){IX.ns("Hualala.Weixin"),Hualala.Weixin.initContent=function(c){function d(a,b,c){var d=c.find("select, input"),e=!c.is(".hidden")&&d[0]&&!d.val(),f=a.resTitle&&a.imgPath&&(0!=b||a.digest)&&a.resType&&!e?!0:!1,g=a.resTitle?a.imgPath?0!=b||a.digest?a.resType?e?"请选择或输入当前图文的链接内容！":"":"请选择当前图文的链接类型！":"请输入图文摘要！":"请上传当前图文的图片！":"请输入当前图文的标题！";return f||u({msg:g}),f}function e(b){var c=b.itemID,e=b.resType,h=a.parseJSON(b.resContent).resources,i=h[0],j=a(z(i)),k=j.filter(".res-wrap"),l=j.filter(".res-form"),m=l.find(".res-title"),n=l.find(".res-digest"),o=l.find(".link-select-wrap"),q=l.find(".link-content-wrap"),r=(c?"修改":"添加")+(1==e?"多":"单")+"图文消息",s=new t.ModalDialog({title:r,html:j,sizeCls:"modal-lg"}).show();s._.body.addClass("clearfix"),p.createResourceView(b,null,!0).appendTo(k);var v=k.find(".res-single, .active");if(m.on("change",function(){i.resTitle=this.value,v.find("h4, h6").text(this.value)}),n.on("change",function(){i.digest=this.value,v.find("p").text(this.value)}),o.on("change","select",function(){i.resType=this.value,i.resTypeContent.resType=this.value,q.is(".hidden")&&delete i.resTypeContent.urlOrCity}),q.on("change","select, input",function(){i.resTypeContent.urlOrCity=this.value}),p.createLinkSelector(o,q,L,i.resType,i.resTypeContent.urlOrCity),t.imgUpload(l.find(".btn"),function(b){i.imgPath=b.url;var c=v.index(),d=parseFloat((+b.imgHWP).toFixed(2)),e=(d?"="+(0==c?Math.round(160/d)+"x160":"75x75"):"")+"$&",f=A+b.url.replace(/\.\w+$/,e)+"?quality=70";v.find("img, .img").replaceWith(a("<img>").attr("src",f))}),s._.footer.find(".btn-ok").on("click",function(){if(d(i,e,q)&&(c||1!=e||i==h[1]||(k.find(".res-mask").eq(1).click(),d(i,e,q)))){var j=c?f:g,l=a.extend({},b),m={isMul:b.resType,resources:h};l.resTitle=h[0].resTitle,l.resContent=JSON.stringify(m),l=_.pick(l,"itemID","resTitle","resType","resContent"),j(l,b,s)}}),1==e){l.find(".digest-wrap").hide();var w=a('<i class="glyphicon glyphicon-remove" title="删除"></i>');h.length>2&&k.find(".res-mask").last().append(w);var x=k.find(".add-sub-res");h.length>=K&&x.addClass("disabled"),k.on("click",".res-mask",function(b){var c=a(this).parent(),f=c.index(),g=a(b.target);if(g.is(".glyphicon-remove")){c.remove(),h.pop();var j=k.find(".res-mask").eq(f-1);return h.length>2&&j.append(w),c.is(".active")&&(i=h[f-1],j.click()),void(h.length<K&&x.removeClass("disabled"))}!c.is(".active")&&d(i,e,q)&&(i=h[f],k.find(".active").removeClass("active"),c.addClass("active"),v=c,m.val(i.resTitle),p.createLinkSelector(o,q,L,i.resType,i.resTypeContent.urlOrCity))}),k.on("click",".add-sub-res",function(){if(d(i,e,q)){if(x.is(".disabled"))return void u({msg:"多图文最多只能添加8项！"});var b={resType:1,resTypeContent:{}};b.resTitle="标题"+(k.find(".res-mask").length+1),h.push(b),$res=a(M),$res.find("h6").text(b.resTitle),a(this).before($res);var c=$res.find(".res-mask").click();h.length>2&&c.append(w),h.length>=K&&x.addClass("disabled")}})}}function f(a,b,c){r.loadData("updateWeixinContent",a,null,!1).done(function(){o(),c.hide(),u({msg:"修改成功!",type:"success"})})}function g(a,b,c){r.loadData("createWeixinContent",a).done(function(a){return u({msg:"添加成功!",type:"success"}),c.hide(),x?(H.unshift(a[0]),v.empty(),j(),void E.hide()):o()})}function h(a){t.Confirm({msg:"确定删除？",okFn:function(){r.loadData("deleteWeixinContent",{itemID:a.itemID},null,!1).done(function(){if(u({msg:"删除成功!",type:"success"}),!x)return o();var b=r.inArray(H,a,"itemID");H.splice(b,1),v.empty(),j(),H.length||(F.hide(),E.show())})}})}function i(){!x&&!w&&H.length-I<50&&l();var a=C.scrollTop()+C.height(),b=D.offset().top+D.height(),c=1==D.find(".res-view:last-child").css("opacity");a>b&&I<H.length&&c&&j(H.slice(I,I+J))}function j(a){var b=a||H.slice(0,I);if(b.length){for(var c=v.length,d=[],e=0;c>e;e++)d.push([]);for(var f,e=0;f=b[e];e++){var g=p.createResourceView(f).append(y),h=e%c;a&&g.addClass("animating").css("opacity",0),d[h].push(g)}for(var i,e=0;i=d[e];e++)v.eq(e).append(i),a&&k(i);a&&(I+=J)}}function k(b){return b.length?(F.show(),void b.shift().animate({opacity:1},400,"linear",function(){a(this).removeClass("animating"),k(b)})):(C.scroll(),F.hide(),void(I>=H.length&&x&&F.show().text("全部加载完毕！")))}function l(a){w=!0,F.show(),G.pageNo++,r.loadData("getWeixinContents",G,null,"data").done(function(b){var c=b.records||[],d=b.page||{};return H.push.apply(H,c),d.pageNo>=d.pageCount&&(x=!0),c.length?void(a&&a(H.slice(I,I+J))):void E.show()}).always(function(){w=!1,F.hide()})}function m(){var a=n();v!=a&&(v=a,D.html(v.empty()),H.length&&j())}function n(){var c,d=a(b).width();return c=d>960?4:d>720&&960>=d?3:d>480&&720>=d?2:1,B[c]}function o(){G.pageNo=0,H=[],I=0,v.empty(),l(j)}var p=Hualala.Weixin,q=Hualala.Global,r=Hualala.Common,s=Hualala.TplLib,t=Hualala.UI,u=Hualala.UI.TopTip;c.html(s.get("tpl_wx_content"));var v,w,x,y=s.get("tpl_wx_res_action"),z=Handlebars.compile(s.get("tpl_wx_res_edit")),A=q.IMAGE_RESOURCE_DOMAIN+"/",B={1:a("<div></div>").addClass("col-xs-12"),2:a("<div></div><div></div>").addClass("col-xs-6"),3:a("<div></div><div></div><div></div>").addClass("col-xs-4"),4:a("<div></div><div></div><div></div><div></div>").addClass("col-xs-3")},C=a(b),D=c.find(".fall"),E=c.find(".no-cont"),F=c.find(".loading-tip"),G={pageNo:0,pageSize:50},H=[],I=0,J=20,K=8;m(),l(j),C.off(".wxCont").on("resize.wxCont",_.throttle(m,200)).on("scroll.wxCont",_.throttle(i,200)),D.on("click",".res-view",function(b){var c=a(this);if(!c.is(".animating")){var d=_.findWhere(H,{itemID:c.attr("resid")}),f=a(b.target);f.is(".del-res")?h(d):f.is(".edit-res")&&e(d)}}),c.on("click","#addContOne",function(){var a={resTitle:"标题1",resType:"0"},b=[{resTitle:"标题1",resTypeContent:{}}],c={isMul:"0",resources:b};a.resContent=JSON.stringify(c),e(a)}),c.on("click","#addContMulti",function(){var a={resTitle:"标题1",resType:"1"},b=[{resTitle:"标题1",resTypeContent:{}}];b.push({resTitle:"标题2",resTypeContent:{}});var c={isMul:"1",resources:b};a.resContent=JSON.stringify(c),e(a)});var L={},M=s.get("tpl_wx_res_sub")}}(jQuery,window),function(a){IX.ns("Hualala.Weixin"),Hualala.Weixin.initText=function(b){function c(){v.show(),u.empty(),C=[],n.loadData("getWeixinTexts",D,null,"data").done(function(a){var b=a.page;w.IXPager({total:b.pageCount,page:b.pageNo,maxVisible:10,href:"javascript:;"}),s=b.pageNo>=b.pageCount,C=a.records||[],x.toggleClass("dn",!!C.length),C.length&&(_.each(C,function(a){a.txtCont=m.parseEmotions(a.resContent,E)}),u.html(B(C)))}).always(function(){v.hide()})}function d(a){var b=a?a.attr("itemid"):"",c=a?_.findWhere(C,{itemID:b}):{resType:"2"};r={txt:c,$txt:a},A.val(c.resTitle),G.setContent(c.txtCont||""),z.text((a?"修改":"添加")+"文本消息"),t.hide(),y.show()}function e(a){p.Confirm({msg:"确定删除？",okFn:function(){var b=a.attr("itemid");n.loadData("deleteWeixinText",{itemID:b},null,!1).done(function(){q({msg:"删除成功!",type:"success"});var d=_.findWhere(C,{itemID:b}),e=n.inArray(C,d,"itemID");return C.splice(e,1),C.length||s?(a.remove(),void x.toggleClass("dn",!!C.length)):(D.pageNo=1,void c())})}})}function f(){d()}function g(b){if(r){var c=a.trim(A.val()),d=a.trim(k(G.getContent())),e=c?d?"":"请输入内容！":"请输入标题";if(e)return void q({msg:e,type:"warning"});b.attr("disabled","disabled").button("saving");var f=r.txt,g=r.$txt,j=a.extend({},f,{resTitle:c,resContent:d}),l=g?h:i;l(_.pick(j,"itemID","resTitle","resType","resContent"),b,f,g)}}function h(a,b){n.loadData("updateWeixinContent",a,null,!1).done(function(){D.pageNo=1,c(),setTimeout(function(){q({msg:"修改成功!",type:"success"}),j()},1e3)}).always(function(){l(b)})}function i(b,c){n.loadData("createWeixinContent",b).done(function(b){var c=b[0];c.txtCont=m.parseEmotions(c.resContent,E),C.unshift(c),x.hide(),a(B([c])).prependTo(u),setTimeout(function(){q({msg:"修改成功!",type:"success"}),j()},1e3)}).always(function(){l(c)})}function j(){r=null,t.show(),y.hide()}function k(b){for(var c,d=a("<div>").html(b).contents(),e="",f=0;c=d[f++];)e+=3==c.nodeType?c.nodeValue:"img"==c.nodeName.toLowerCase()?"/"+c.alt:"a"==c.nodeName.toLowerCase()?'<a href="'+c.href+'">'+k(c.innerHTML)+"</a>":k(c.innerHTML);return e}function l(a){setTimeout(function(){a.button("reset").removeAttr("disabled")},1e3)}var m=Hualala.Weixin,n=(Hualala.Global,Hualala.Common),o=Hualala.TplLib,p=Hualala.UI,q=Hualala.UI.TopTip;b.html(o.get("tpl_wx_text"));var r,s,t=b.find("#viewing"),u=t.find("#txts"),v=t.find("#loading"),w=t.find(".txt-pager"),x=t.find(".alert-warning"),y=b.find("#editing"),z=y.find(".pt"),A=y.find("#txtTitle"),B=Handlebars.compile(o.get("tpl_wx_txts")),C=[],D={pageNo:1,pageSize:10},E=m.getEmotions(),F={};UM.delEditor("txtEditor"),m.extendUM(E,F);var G=UM.getEditor("txtEditor",{toolbar:["qqemotion wxlink unlink | undo redo | selectall cleardoc"]});G.execCommand("cleardoc");var H={editTxt:d,delTxt:e,addTxt:f,saveTxt:g,concelEdit:j};c(),w.on("page",function(a,b){D.pageNo=b,c()}),b.on("click",".btn, #txts > li",function(b){var c=a(this),d=a(b.target),e=c.data("action")||d.data("action"),f=H[e];e&&f&&f(c)})}}(jQuery,window),function(){function a(){return[{url:"CD/wKgCIVNWKH6hmHQGAAAHEjWPAZs514.gif",title:"微笑"},{url:"CD/wKgCH1NWKH6XWC2eAAAGLnAf7-c591.gif",title:"撇嘴"},{url:"CD/wKgCH1NWKH6MDGgnAAAHDLr8VAc015.gif",title:"色"},{url:"CD/wKgCIVNWKH6n-9spAAAHPEQTyEQ985.gif",title:"发呆"},{url:"CD/wKgCIVNWKH77iHinAAAHuTE4C2A482.gif",title:"得意"},{url:"CD/wKgCH1NWKH7Zf7edAAAHSgtCCG8416.gif",title:"流泪"},{url:"CD/wKgCH1NWKH6xyGFAAAAN5AitwJQ082.gif",title:"害羞"},{url:"CD/wKgCIVNWKH6YRAi2AAAPWXBFl_s040.gif",title:"闭嘴"},{url:"CD/wKgCIVNWKH7U4BSWAAASR42ZkF8934.gif",title:"睡"},{url:"CD/wKgCH1NWKH6fU-ScAAAM4kuzwSw947.gif",title:"大哭"},{url:"CD/wKgCH1NWKH6kRnZ4AAAOhNr-C2A640.gif",title:"尴尬"},{url:"CD/wKgCIVNWKH-5Hxl0AAAfYSRbMUk617.gif",title:"发怒"},{url:"CD/wKgCIVNWKH-Cy2QiAAAIxwh7gJ8587.gif",title:"调皮"},{url:"CD/wKgCH1NWKH_DZSQYAAAGyAJA_uI043.gif",title:"呲牙"},{url:"CD/wKgCH1NWKH--YrfCAAAPpiODsBY933.gif",title:"惊讶"},{url:"CD/wKgCIVNWKH_RQooVAAAGGnFweWw274.gif",title:"难过"},{url:"CD/wKgCIVNWKH_PlZg3AAAFhd405eU255.gif",title:"酷"},{url:"CD/wKgCH1NWKH-rvyFaAAANJobRVnA139.gif",title:"冷汗"},{url:"CD/wKgCH1NWKH_zy_40AAAfyfLjzW0528.gif",title:"抓狂"},{url:"CD/wKgCIVNWKIDmLODOAAAfx7thOIU847.gif",title:"吐"},{url:"CD/wKgCIVNWKID4WKyxAAAHEBEwsog704.gif",title:"偷笑"},{url:"CD/wKgCH1NWKICsFM_3AAAHSNA129k556.gif",title:"可爱"},{url:"CD/wKgCH1NWKIDtm2xhAAALwnkTd8E528.gif",title:"白眼"},{url:"CD/wKgCIVNWKIChwcKbAAAHntrRtOU292.gif",title:"傲慢"},{url:"CD/wKgCIVNWKIDoIMNzAAAI0YNpmX8518.gif",title:"饥饿"},{url:"CD/wKgCH1NWKICzMaRiAAAJjqlzh0s106.gif",title:"困"},{url:"CD/wKgCH1NWKIClntTjAAAPrv0u1iE580.gif",title:"惊恐"},{url:"CD/wKgCIVNWKIDTeBDAAAALTUiZH1E231.gif",title:"流汗"},{url:"CD/wKgCIVNWKICY8xuSAAAMvksAY_c342.gif",title:"憨笑"},{url:"CD/wKgCH1NWKIGa3CXNAAAW5RugBIc941.gif",title:"大兵"},{url:"CD/wKgCH1NWKIHTKKpZAAAG9OMVt48363.gif",title:"奋斗"},{url:"CD/wKgCIVNWKIGw3p30AAAUNliA67o282.gif",title:"咒骂"},{url:"CD/wKgCIVNWKIHS-AKHAAAcFXdc82Q472.gif",title:"疑问"},{url:"CD/wKgCH1NWKIG5_BNwAAAQ3fqvFkA245.gif",title:"嘘"},{url:"CD/wKgCH1NWKIGigs9mAAAIXKFk83E124.gif",title:"晕"},{url:"CD/wKgCIVNWKIGptYlqAAA0UDIQLFg977.gif",title:"折磨"},{url:"CD/wKgCIVNWKIGYPIIjAAAFiWXFty8768.gif",title:"衰"},{url:"CD/wKgCH1NWKIGtyC8hAAAEq48_kyg648.gif",title:"骷髅"},{url:"CD/wKgCH1NWKIGOfYHZAAAGisisHhw165.gif",title:"敲打"},{url:"CD/wKgCIVNWKIKjx8PKAAAHBpwa4CY851.gif",title:"再见"},{url:"CD/wKgCIVNWKIL_MnpUAAAnbBIu5y0245.gif",title:"擦汗"},{url:"CD/wKgCH1NWKILZEx53AAANKIT20WQ983.gif",title:"抠鼻"},{url:"CD/wKgCH1NWKIKV60t7AAA0N2DE7bc169.gif",title:"鼓掌"},{url:"CD/wKgCIVNWKIL59hU5AAAQ54o41Kk036.gif",title:"糗大了"},{url:"CD/wKgCIVNWKILEbQCZAAAGI_0O4X8576.gif",title:"坏笑"},{url:"CD/wKgCH1NWKIL4kuL3AAASVA6Ifk4545.gif",title:"左哼哼"},{url:"CD/wKgCH1NWKILHWREjAAAUKj4EcvQ524.gif",title:"右哼哼"},{url:"CD/wKgCIVNWKILQMPcYAAAOZSkc7Jw649.gif",title:"哈欠"},{url:"CD/wKgCIVNWKIPuGPqAAAAG25fNuM8445.gif",title:"鄙视"},{url:"CD/wKgCH1NWKIKMa-JLAAAY2TnURuo416.gif",title:"委屈"},{url:"CD/wKgCH1NWKIPMPmP1AAAMAaVr23I453.gif",title:"快哭了"},{url:"CD/wKgCIVNWKIOOgnj1AAAOkx4Bh_Q822.gif",title:"阴险"},{url:"CD/wKgCIVNWKIOeUKLLAAAF_GTXs6Q904.gif",title:"亲亲"},{url:"CD/wKgCH1NWKIO1xGMuAAAICHoJBFw359.gif",title:"吓"},{url:"CD/wKgCH1NWKIPN2fzNAAAJOoITboY253.gif",title:"可怜"},{url:"CD/wKgCIVNWKIO0xK32AAAGLs6b_Ro551.gif",title:"菜刀"},{url:"CD/wKgCIVNWKIPqGwCbAAAEkqSp4Sw833.gif",title:"西瓜"},{url:"CD/wKgCH1NWKIObPGkbAAAT0DNHWAo512.gif",title:"啤酒"},{url:"CD/wKgCH1NWKIPa_VUOAAAKJHslunM338.gif",title:"篮球"},{url:"CD/wKgCIVNWKIPZZ5N8AAAF_WKxMqw106.gif",title:"乒乓"},{url:"CD/wKgCIVNWKISwryuSAAAKa9RcamE946.gif",title:"咖啡"},{url:"CD/wKgCH1NWKISyfwdlAAAEcPmAmvc991.gif",title:"饭"},{url:"CD/wKgCH1NWKISLlrJrAAAE9SamlGU206.gif",title:"猪头"},{url:"CD/wKgCIVNWKISAOssoAAADy2tCJ7o039.gif",title:"玫瑰"},{url:"CD/wKgCIVNWKISr6e_dAAAD3L7K5vE917.gif",title:"凋谢"},{url:"CD/wKgCH1NWKIT4_u6FAAAUpYIuysE035.gif",title:"示爱"},{url:"CD/wKgCH1NWKITgj9d5AAAEh2XzeLs214.gif",title:"爱心"},{url:"CD/wKgCIVNWKITxvLsxAAAKujCDjJU510.gif",title:"心碎"},{url:"CD/wKgCIVNWKITkdjGzAAAQNAagCHU699.gif",title:"蛋糕"},{url:"CD/wKgCH1NWKISIFHmqAAAD91kg-JE423.gif",title:"闪电"},{url:"CD/wKgCH1NWKITiVZFvAAAEiniNOl4497.gif",title:"炸弹"},{url:"CD/wKgCIVNWKITI_Kz4AAADOMg7F1U036.gif",title:"刀"},{url:"CD/wKgCIVNWKIX0UCPGAAAOXyFMKrE161.gif",title:"足球"},{url:"CD/wKgCH1NWKITMNY5JAAAIk5fThiw184.gif",title:"瓢虫"},{url:"CD/wKgCH1NWKIWI9sApAAAJllKthhY471.gif",title:"便便"},{url:"CD/wKgCIVNWKIX4NcPwAAAExrdFHOM457.gif",title:"月亮"},{url:"CD/wKgCIVNWKIXj--DBAAAEu_hcC4k274.gif",title:"太阳"},{url:"CD/wKgCH1NWKIXq0Gx-AAAEfxCtQPg896.gif",title:"礼物"},{url:"CD/wKgCH1NWKIXgdKPvAAAGHeYffaA847.gif",title:"拥抱"},{url:"CD/wKgCIVNWKIWyKM5FAAAF7ovU57E277.gif",title:"强"},{url:"CD/wKgCIVNWKIWPKrOXAAAGATpp04Q875.gif",title:"弱"},{url:"CD/wKgCH1NWKIW7CKJJAAAGN4PjHgk736.gif",title:"握手"},{url:"CE/wKgCH1NWKIWII8xPAAAGC-ylE0I030.gif",title:"胜利"},{url:"CD/wKgCIVNWKIX9Fcn-AAAGN720qlg404.gif",title:"抱拳"},{url:"CD/wKgCIVNWKIWhnWQNAAANYEzopPo145.gif",title:"勾引"},{url:"CE/wKgCH1NWKIWRtwPHAAAGLccwr7c365.gif",title:"拳头"},{url:"CE/wKgCH1NWKIWyVvLpAAAF73AN-Og539.gif",title:"差劲"},{url:"CD/wKgCIVNWKIblO0ySAAAGFsLpii0260.gif",title:"爱你"},{url:"CD/wKgCIVNWKIb3ntxnAAAIVqQUcy4531.gif",title:"NO"},{url:"CE/wKgCH1NWKIac15IHAAAEw64jKVA529.gif",title:"OK"},{url:"CE/wKgCH1NWKIbSXxzGAAAKtzujC9w203.gif",title:"爱情"},{url:"CD/wKgCIVNWKIbgjhDrAAACjgWZXP4623.gif",title:"飞吻"},{url:"CD/wKgCIVNWKIb9abFsAAAFYZ2yllA765.gif",title:"跳跳"},{url:"CE/wKgCH1NWKIaHBEHzAAAEX99eGAg355.gif",title:"发抖"},{url:"CE/wKgCH1NWKIepcK-tAAANYvdRETc255.gif",title:"怄火"},{url:"CE/wKgCIVNWKIfwhBJGAAALwyRDuF8811.gif",title:"转圈"},{url:"CE/wKgCIVNWKIfJFeNwAAAHBGnVicw191.gif",title:"磕头"},{url:"CE/wKgCH1NWKIfoDJwQAAAUtOcKYmU453.gif",title:"回头"},{url:"CE/wKgCH1NWKIe5FEqLAAAGXUlhmqw064.gif",title:"跳绳"},{url:"CE/wKgCIVNWKIeb6F2UAAAI1QqtQ7Y764.gif",title:"挥手"},{url:"CE/wKgCIVNWKIe8INuBAAAG9HJo2zM848.gif",title:"激动"},{url:"CE/wKgCH1NWKIfndJHDAAAJi-oVE34806.gif",title:"街舞"},{url:"CE/wKgCH1NWKIedbP9SAAAFps_xS8w196.gif",title:"献吻"},{url:"CE/wKgCIVNWKIizikDBAAAIdrn1ytM011.gif",title:"左太极"},{url:"CE/wKgCIVNWKIjSNEstAAAIeX2ucII889.gif",title:"右太极"}]}function b(){return[{value:"1",title:"软文",type:"select",subTitle:"软文",api:"getAdvertorials",params:{},keys:["itemID","title"],urlTpl:"share/{{arg1}}"},{value:"2",title:"集团首页",urlTpl:"index.htm?sc=wechat&mpid=${mpID}&g={{g}}"},{value:"3",title:"店铺预定搜索网页",type:"select",subTitle:"城市",api:"getCities",params:{isActive:1},keys:["cityID","cityName"],firstItem:{cityID:"0",cityName:"附近"},urlTpl:"shop/common.htm?{{arg2}}&sc=wechat&mpid=${mpID}&g={{g}}"},{value:"4",title:"订座点菜具体店铺",type:"select",subTitle:"店铺",api:"queryShop",params:{},keys:["shopID","shopName"],urlTpl:"shop/shop.htm?t=0&i={{arg1}}&sc=wechat&mpid=${mpID}&g={{g}}"},{value:"5",title:"店铺外卖搜索网页",type:"select",subTitle:"城市",api:"getCities",params:{isActive:1},keys:["cityID","cityName"],firstItem:{cityID:"0",cityName:"附近"},urlTpl:"shop/takeaway.htm?{{arg2}}&sc=wechat&mpid=${mpID}&g={{g}}&"},{value:"6",title:"外卖自提具体店铺",type:"select",subTitle:"店铺",api:"queryShop",params:{},keys:["shopID","shopName"],urlTpl:"shop/shop.htm?t=1&i={{arg1}}&sc=wechat&mpid=${mpID}&g={{g}}"},{value:"7",title:"附近店铺",urlTpl:"shop/near.htm"},{value:"8",title:"(新)成为会员",urlTpl:"crm/vip_details.htm?sc=wechat&mpid=${mpID}&g={{g}}"},{value:"9",title:"(新)我的会员卡",urlTpl:"crm/vip_details.htm?sc=wechat&mpid=${mpID}&g={{g}}"},{value:"10",title:"成为会员",urlTpl:"vip/register.htm?sc=wechat&mpid=${mpID}&g={{g}}"},{value:"11",title:"我的会员卡",urlTpl:"vip/main.htm?sc=wechat&mpid=${mpID}&g={{g}}"},{value:"12",title:"我的代金券",urlTpl:"user/event.htm?sc=wechat&mpid=${mpID}"},{value:"13",title:"我的订单页",urlTpl:"user/order.htm?sc=wechat&mpid=${mpID}"},{value:"14",title:"我的账户",urlTpl:"user/user.htm?sc=wechat&mpid=${mpID}&g={{g}}"},{value:"15",title:"会员活动列表",urlTpl:"vip/intro.htm?sc=wechat&mpid=${mpID}&g={{g}}"},{value:"16",title:"会员具体活动",type:"select",subTitle:"会员活动",api:"getCrmEvents",params:{},keys:["eventIdWay","eventName"],urlTpl:"vip/event{{arg3}}.htm?e={{arg1}}&sc=wechat&mpid=${mpID}&g={{g}}"},{value:"17",title:"用户活动",type:"select",subTitle:"用户活动",api:"getUserEvents",params:{eventStatus:1},keys:["eventItemID","eventSubjects"],urlTpl:"events/event.htm?i={{arg1}}&sc=wechat&mpid=${mpID}&g={{g}}"},{value:"18",title:"用户反馈",urlTpl:"user/feedback.htm?sc=wechat&mpid=${mpID}&g={{g}}"},{value:"19",title:"代金券交易",type:"select",subTitle:"城市",api:"getCities",params:{isActive:1},keys:["cityID","cityName"],firstItem:{cityID:"0",cityName:"附近"},urlTpl:"voucher/list.htm?sc=wechat&mpid=${mpID}&g={{g}}&c={{arg1}}"},{value:"20",title:"排队取号搜索",urlTpl:"table/near.htm?sc=wechat&mpid=${mpID}&g={{g}}"},{value:"21",title:"报名活动",type:"select",subTitle:"用户活动",api:"getUserEvents",params:{eventStatus:1,gameWay:20},keys:["eventItemID","eventSubjects"],urlTpl:"events/apply.htm?i={{arg1}}&sc=wechat&mpid=${mpID}&g={{g}}"},{value:"22",title:"自定义链接",type:"input",subTitle:"内容",urlTpl:"{{arg1}}"}]}IX.ns("Hualala.Weixin"),Hualala.Weixin.getEmotions=a,Hualala.Weixin.getLinkTypes=b}(jQuery,window),function(a){function b(a,b,c){var d=Handlebars.compile(Hualala.TplLib.get("tpl_order_subnav"));Handlebars.registerPartial("toggle",Hualala.TplLib.get("tpl_site_navbarToggle")),b.empty(),b.html('<div class="page-subnav clearfix" /><div class="page-body clearfix"></div>');var e=function(){var b=_.map(c,function(b){var c=_.map($XP(b,"pkeys",[]),function(){return""});return{active:a==b.name?"active":"",disabled:"",path:Hualala.PageRoute.createPath(b.name,c)||"#",name:b.name||"",label:b.label||""}});return{toggle:{target:"#order_navbar"},items:b}},f=b.find(".page-subnav");f.html(d(e()))}function c(b,c){function d(){var b=a('<div class="bs-callout weixin-brand"><select class="form-control" />微信公共账号</div>').insertAfter(".page-subnav").find("select");f.fillSelect(b,m,"mpID","mpName",!1).val(l).on("change",function(){l=a(this).val(),l&&c&&c(g.empty(),l)}),l&&c&&c(g.empty(),l)}var e=Hualala.getSessionSite().groupID,f=Hualala.UI,g=b.find(".page-body");return k==e?void d():void Hualala.Global.getWeixinAccounts({},function(a){return"000"!=a.resultcode?void(a.resultmsg&&f.TopTip({msg:a.resultmsg,type:"danger"})):(m=_.map(a.data.records||[],function(a){return{mpID:a.mpID,mpName:a.mpName}}),k=e,m.length&&(l=m[0].mpID),void d())})}function d(b,c,d,e,f){function g(){h.createChosen(b,d,"itemID","resName",k,!1,e||"").on("change",function(){c.html(n.createResourceView(_.findWhere(d,{itemID:this.value}),j))}).change(),l.resolve(d)}var h=Hualala.UI,i=Hualala.PageRoute,j=n.getEmotions(),k={width:"100%",matchField:"resTitle"},l=a.Deferred();return f&&(k.width=f),d&&d.length?g():Hualala.Global.getWeixinResources({isActive:1,resType:"(0,1,2)"},function(b){if("000"!=b.resultcode)return void(b.resultmsg&&h.TopTip({msg:b.resultmsg,type:"danger"}));if(d=b.data.records||[],_.each(d,function(a){a.resName=("2"==a.resType?"(文本)":"(图文)")+a.resTitle}),!d.length){var c=a('<div>尚无可用素材资源，无法进行此操作！您可以先在<a href="" data-page="wxContent" />或者<a href="" data-page="wxText" />下添加一些素材资源。</div>');return $a=c.find("a").each(function(){var b=a(this),c=i.createPath(b.data("page")),d=i.getPageContextByPath(c).label;b.attr("href",c).text(d)}),modal=h.Alert({msg:c}),void $a.on("click",function(){modal.hide()})}g()}),l.promise()}function e(a,b){var b=b||n.getEmotions(),c=Hualala.Global.IMAGE_RESOURCE_DOMAIN+"/group1/M00/00/",d=Handlebars.compile('<img src="{{url}}" alt="{{title}}" />');return a.replace(/\/[\u4E00-\u9FA5]+/g,function(a){for(var e,f=a.slice(1),g=0;e=b[g++];)if(0==f.indexOf(e.title))return f.replace(e.title,d({url:c+e.url,title:e.title}));return a})}function f(b,c,d){var f=b.resType;if(2==f)return c=c||n.getEmotions(),e(b.resContent,c);for(var g,h=b.itemID,i=a.parseJSON(b.resContent),j=a("<div>").attr("resid",h).addClass("res-view "+(1==f?"multi":"")),k=i.resources||[],l=Hualala.Global.IMAGE_RESOURCE_DOMAIN+"/",m=0;g=k[m];m++){var o=a("<div>"),p=l+g.imgPath+"?quality=70";0==f?o.addClass("res-single").append(a("<h4>").text(g.resTitle)).append(h?a("<img>").attr("src",p):'<div class="img">封面图片</div>').append(a("<p>").text(g.digest)):0==m?(o.addClass("res-cover").append(h?a("<img>").attr("src",p):'<div class="img">封面图片</div>').append(a("<h4>").text(g.resTitle)),d&&o.addClass("active").append('<div class="res-mask"><i class="glyphicon glyphicon-pencil"></i></div>')):(o.addClass("res-sub").append(h?a("<img>").attr("src",p):'<div class="img">缩略图</div>').append(a("<h6>").text(g.resTitle)),d&&o.append('<div class="res-mask"><i class="glyphicon glyphicon-pencil" title="编辑"></i></div>')),j.append(o)}return 1==f&&d&&j.append('<div class="add-sub-res"><div><i class="glyphicon glyphicon-plus"></i></div></div>'),j}function g(a,b,c,d,e){var f=g,h=f.linkTypes||n.getLinkTypes();c=c||{},f.linkTypes=h,d=d||1,e=e||"",f.renderLinkContent=f.renderLinkContent||function(a,b,c,d){var e=Hualala.UI,f=b.find(".link-name"),g=b.find(".link-content"),h=a.subTitle,i=a.type;if(b.toggleClass("hidden",!i),f.text("链接"+h),g.html(i?"select"==i?'<select class="form-control">':'<input class="form-control" placeholder="完整URL，如：http://m.hualala.com">':""),"input"==i&&g.find("input").val(d),"select"==i){var j=a.api,k=c[j];keys=a.keys,Hualala.Common.loadData(j,a.params,k).done(function(b){if(b=b||[],!b.length)return void e.TopTip({msg:"获取"+h+"信息为空！",type:"warning"});c[j]||(c[j]=_.map(b,function(a){return"getCrmEvents"==j?{eventIdWay:a.eventID+"-"+a.eventWay,eventName:a.eventName,py:a.py}:_.pick(a,keys.concat(["py"]))}));var f=a.firstItem||!1;e.createChosen(g.find("select"),c[j],keys[0],keys[1],{width:"100%"},f,d).change()})}},Hualala.UI.fillSelect(a.html('<select class="form-control"></select>').find("select"),h,"value","title",!1).val(d).on("change",function(){f.renderLinkContent(h[this.value-1],b,c,e),e=""}).change()}function h(b){b=b||n.getEmotions();for(var c,d=a("<ul></ul><div></div>"),e=d.filter("ul"),f=0;c=b[f];f++)a("<li>").attr("title",c.title).data("url",c.url).append(a("<i>").css("background-position",24*-f+"px 0")).appendTo(e);return d}function i(a,b){var c=Hualala.getSessionSite().groupID,d=location.href,e=d.indexOf("mu.dianpu")>-1?"mu.":d.indexOf("dohko.dianpu")>-1?"dohko.":"",f="http://"+e+"m.hualala.com/",h=g.linkTypes||n.getLinkTypes(),i=Handlebars.compile(h[a-1].urlTpl),j={arg1:b,g:c};if(3==a||5==a)j.arg2=0==b?"t=near":"c="+b;else if(16==a){var k=b.split("-"),l=k[0],m=k[1];j.arg1=l,j.arg3=20==m?"_turntable":""}var o=i(j);return 22==a?o:f+o}function j(b,c){return b&&UM.registerUI("qqemotion",function(c){var d=this,e=a.eduibutton({icon:"emotion",title:"表情"}),f=a.eduipopup().css("zIndex",d.options.zIndex+1).addClass("edui-popup-"+c).edui(),g=f.getBodyContainer().html(h(b)).on("click",function(){return!1}),i=g.find("div"),j=Hualala.Global.IMAGE_RESOURCE_DOMAIN+"/group1/M00/00/";return g.on("mouseenter","li",function(){var b=a(this),c=b.data("url");i.show().html(a("<img>").attr("src",j+c))}),g.on("mouseleave","li",function(){i.hide()}).on("click","li",function(){var b=a(this),c=b.data("url"),e=b.attr("title");d.execCommand("inserthtml",'<img src="'+j+c+'" alt="'+e+'" style="width: 24px; height: 24px" />'),f.hide()}),f.on("beforeshow",function(){var a=this.root();a.parent().length||d.$container.find(".edui-dialog-container").append(a),i.empty(),UM.setTopEditor(d)}).attachTo(e,{offsetTop:-5,offsetLeft:10,caretLeft:11,caretTop:-8}),d.addListener("selectionchange",function(){var a=this.queryCommandState(c);e.edui().disabled(-1==a).active(1==a)}),e}),c&&UM.registerUI("wxlink",function(b){var d=this;$btn=a.eduibutton({icon:"link",title:"链接"});var e=Hualala.UI,f=Hualala.TplLib.get("tpl_wx_txt_link");return $btn.on("click",function(){var b=a(f),h=b.find(".link-select-wrap"),j=b.find(".link-content-wrap"),k=new e.ModalDialog({title:"添加链接",html:b}).show();g(h,j,c),k._.footer.find(".btn-ok").text("确定").on("click",function(){var a=h.find("select").val(),b=j.find("select, input").val();if(!a)return void e.TopTip({msg:"请选择链接类型！",type:"warning"});if(void 0!==b&&!b)return void e.TopTip({msg:"请选择或输入链接！",type:"warning"});var c=i(a,b).replace(/^\s+|\s+$/g,"");c&&d.execCommand("link",{href:c,_href:c}),k.hide()})}),d.addListener("selectionchange",function(){var a=this.queryCommandState(b);$btn.edui().disabled(-1==a).active(1==a)}),$btn}),["source | undo redo | bold italic underline strikethrough | superscript subscript | forecolor backcolor | removeformat |","insertorderedlist insertunorderedlist | selectall cleardoc paragraph | fontfamily fontsize","| justifyleft justifycenter justifyright justifyjustify |","wxlink unlink | qqemotion image video  | map","| horizontal print preview","drafts"]}IX.ns("Hualala.Weixin");var k,l,m,n=Hualala.Weixin;a.extend(n,{createResourceChosen:d,parseEmotions:e,createResourceView:f,createLinkSelector:g,extendUM:j,homeInit:function(){location.href=Hualala.PageRoute.createPath("wxReply")},replyInit:function(){var d=Hualala.PageRoute.getPageContextByPath().name,e=a("#ix_wrapper > .ix-body > .container");b(d,e,Hualala.TypeDef.WeixinAdminSubNavType),c(e,n.initReply)},subscribeInit:function(){var d=Hualala.PageRoute.getPageContextByPath().name,e=a("#ix_wrapper > .ix-body > .container");b(d,e,Hualala.TypeDef.WeixinAdminSubNavType),c(e,n.initSubscribe)},menuInit:function(){var d=Hualala.PageRoute.getPageContextByPath().name,e=a("#ix_wrapper > .ix-body > .container");b(d,e,Hualala.TypeDef.WeixinAdminSubNavType),c(e,n.initMenu)},advertorialInit:function(){var c=Hualala.PageRoute.getPageContextByPath().name,d=a("#ix_wrapper > .ix-body > .container");b(c,d,Hualala.TypeDef.WeixinMaterialSubNavType),n.initAdvertorial(d.find(".page-body"))},contentInit:function(){var c=Hualala.PageRoute.getPageContextByPath().name,d=a("#ix_wrapper > .ix-body > .container");b(c,d,Hualala.TypeDef.WeixinMaterialSubNavType),n.initContent(d.find(".page-body"))},textInit:function(){var c=Hualala.PageRoute.getPageContextByPath().name,d=a("#ix_wrapper > .ix-body > .container");b(c,d,Hualala.TypeDef.WeixinMaterialSubNavType),n.initText(d.find(".page-body"))}})}(jQuery,window),function(){IX.ns("Hualala.MCM");var a=Hualala.MCM,b=Stapes.subclass({constructor:function(a){if(this.callServer=$XP(a,"callServer",null),!this.callServer)throw"callServer is empty!";this.queryKeys=$XP(a,"queryKeys",[]),this.pagerKeys="pageCount,totalSize,pageNo,pageSize".split(","),this.queryParamsKeys=null,this.hasPager=$XP(a,"hasPager",!0),this.recordModel=$XP(a,"recordModel",c),this.gridType=$XP(a,"gridType","")}});b.proto({init:function(a){this.set(IX.inherit({ds_record:new IX.IListManager,ds_items:new IX.IListManager,ds_page:new IX.IListManager},this.hasPager?{pageCount:0,totalSize:0,pageNo:$XP(a,"pageNo",1),pageSize:$XP(a,"pageSize",15)}:{})),this.queryParamsKeys=this.hasPager?this.queryKeys.concat(this.pagerKeys):this.queryKeys},updatePagerParams:function(a){var b=this,c=b.queryParamsKeys.join(",");_.each(a,function(a,d){c.indexOf(d)>-1&&b.set(d,a)})},getPagerParams:function(){var a=this,b={};return _.each(a.queryParamsKeys,function(c){b[c]=a.get(c)}),b},updateDataStore:function(a,b){var c=this,d=c.get("ds_record"),e=c.get("ds_page");b=c.hasPager?b:1;var f=_.map(a,function(a){var e=b+"_"+IX.id(),f=new c.recordModel(IX.inherit(a,{__id__:e,__gridtype__:c.gridType}));return d.register(e,f),e});e.register(b,f)},load:function(a,b){var c=this;c.updatePagerParams(a),c.callServer(c.getPagerParams(),function(a){"000"==a.resultcode?(c.updateDataStore($XP(a,"data.records",[]),$XP(a,"data.pageNo")),c.updatePagerParams($XP(a,"data",{}))):toptip({msg:$XP(a,"resultmsg",""),type:"danger"}),b(c)})},getRecordsByPageNo:function(a){var b=this,c=b.get("ds_record"),d=b.get("ds_page");a=b.hasPager?a:1;var e=_.map(c.getByKeys(d.get(a)),function(a){return a.getAll()});return IX.Debug.info("DEBUG: Query Result Model PageData"),IX.Debug.info(e),e},getRecordModelByID:function(a){var b=this,c=b.get("ds_record");return c.get(a)}}),a.GiftMgrResultModel=b;var c=Stapes.subclass({constructor:function(a){this.set(a),this.bindEvent()}});c.proto({bindEvent:function(){var a=this;a.on({"delete":function(a){var b=$XP(a,"itemID"),c=$XF(a,"successFn"),d=$XF(a,"faildFn");Hualala.Global.deleteMCMGift({giftItemID:b},function(a){"000"==$XP(a,"resultcode")?c(a):d(a)})},createGift:function(b){var c=$XP(b,"params",{}),d=$XF(b,"successFn"),e=$XF(b,"failFn");a.set(c),IX.Debug.info("DEBUG: Gift Wizard Form Post Params:"),IX.Debug.info(a.getAll()),Hualala.Global.createMCMGift(a.getAll(),function(a){"000"==$XP(a,"resultcode")?d(a):e(a)})},editGift:function(b){var c=$XP(b,"params",{}),d=$XF(b,"successFn"),e=$XF(b,"failFn");a.set(c),IX.Debug.info("DEBUG: Gift Wizard Form Post Params:"),IX.Debug.info(a.getAll()),Hualala.Global.editMCMGift(a.getAll(),function(a){"000"==$XP(a,"resultcode")?d(a):e(a)})},saveCache:function(b){{var c=$XP(b,"params",{}),d=$XF(b,"successFn");$XF(b,"failFn")}a.set(c),d(a)},bindShops:function(a){var b=$XP(a,"cities",[]),c=$XP(a,"shops",[]),d=_.pluck(c,"shopID"),e=_.pluck(c,"shopName"),f=_.pluck(b,"cityID");this.set({shopIDs:d.join(";"),shopNames:e.join(";"),usingCityIDs:f.join(";")})}},this)}}),a.BaseGiftModel=c;var d=Stapes.subclass({constructor:function(a){self.CardLevelIDSet=null,this.set(a),this.bindEvent()}});d.proto({getEventCardSet:function(){var a=this,b=Hualala.TypeDef.MCMDataSet.EventTypes,c=_.find(b,function(b){return $XP(b,"value")==a.get("eventWay")});return c},getEventCardClz:function(){var a=this,b=Hualala.TypeDef.MCMDataSet.EventTypes,c=_.find(b,function(b){return $XP(b,"value")==a.get("eventWay")});return $XP(c,"type","")},bindEvent:function(){var a=this;a.on({"delete":function(a){var b=$XP(a,"itemID"),c=$XF(a,"successFn"),d=$XF(a,"faildFn");Hualala.Global.deleteMCMEvent({eventID:b},function(a){"000"==$XP(a,"resultcode")?c(a):d(a)})},switchEvent:function(a){var b=$XP(a,"post",{}),c=$XF(a,"successFn"),d=$XF(a,"faildFn");Hualala.Global.switchMCMEvent(b,function(a){"000"==$XP(a,"resultcode")?c(a):d(a)})},update:function(b){var c=$XF(b,"successFn"),d=$XF(b,"faildFn");Hualala.Global.getMCMEventByID({eventID:a.get("eventID")},function(b){if("000"==$XP(b,"resultcode")){var e=$XP(b,"data.records")[0];a.set(e),c(b)}else d(b)})},saveCache:function(b){{var c=$XP(b,"params",{}),d=$XF(b,"successFn");$XF(b,"failFn")}a.set(c),d(a)},loadCardLevelIDs:function(b){var c=$XF(b,"successFn"),d=$XF(b,"faildFn");Hualala.Global.getVipLevels({},function(b){"000"==$XP(b,"resultcode")?(a.CardLevelIDSet=$XP(b,"data.records",[]),c(b)):(a.CardLevelIDSet=null,d(b))})},createEvent:function(b){var c=$XF(b,"successFn"),d=$XF(b,"faildFn");Hualala.Global.createEvent($XP(b,"params"),function(b){if("000"==$XP(b,"resultcode")){var e=$XP(b,"data");a.set(e),c(b)}else d(b)})},editEvent:function(b){var c=$XF(b,"successFn"),d=$XF(b,"faildFn"),e=a.getAll();Hualala.Global.editEvent(IX.inherit(e,$XP(b,"params")),function(b){if("000"==$XP(b,"resultcode")){var e=$XP(b,"data");a.set(e),c(b)}else d(b)})}},this)}}),a.BaseEventModel=d}(jQuery,window),function(a){IX.ns("Hualala.MCM");var b=Hualala.MCM,c=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip),d=[{key:"giftType",clz:"",label:"礼品类型"},{key:"giftName",clz:"text",label:"礼品名称"},{key:"createTime",clz:"date",label:"创建时间"},{key:"createBy",clz:"text",label:"创建人"},{key:"rowControl",clz:"",label:"操作"}],e=[{key:"eventWay",clz:"eventWay",label:"活动类型"},{key:"eventName",clz:"text",label:"活动名称"},{key:"userCount",clz:"num",label:"人气"},{key:"eventStartDate",clz:"date",label:"活动日期"},{key:"operator",clz:"text",label:"创建人"},{key:"isActive",clz:"",label:"活动开关"},{key:"rowControl",clz:"ctrlrow",label:"操作"}],f=function(a,b,c){var d=this,e=Hualala.PageRoute.getPageContextByPath(),f=$XP(e,"name"),g=(d.model.queryKeys,{value:"",text:""}),h=$XP(a,c,""),i=Hualala.Common.formatDateTimeValue;
switch(c){case"giftType":var j=d.get("giftCardTpl"),k=$XP(a,"giftValue",0),l=Hualala.TypeDef.MCMDataSet.GiftTypes,m=_.find(l,function(a){return $XP(a,"value")==h}),n=j({clz:$XP(m,"type",""),label:k,unit:$XP(m,"unit","")});g.value=h,g.text=n,g.colspan=1,g.rowspan=2;break;case"createTime":g.value=h,g.text=IX.Date.getDateByFormat(i(h),"yyyy/MM/dd HH:mm");break;case"createBy":var o=!IX.isEmpty(h)&&IX.isString(h)?JSON.parse(h):{};g.value=$XP(o,"userID",""),g.text=$XP(o,"userName","")+"<br/>"+$XP(o,"userMobile","");break;case"eventWay":var p=d.get("eventCardTpl"),q=Hualala.TypeDef.MCMDataSet.EventTypes,r=_.find(q,function(a){return $XP(a,"value")==h}),s=$XP(r,"label","");if("mcmEventMgr"==f){var n=p({clz:0!=$XP(a,"isActive")?$XP(r,"type",""):"disable",label:s});g.value=h,g.text=n,g.colspan=1,g.rowspan=1}break;case"eventStartDate":g.value=h;var t=h,u=$XP(a,"eventEndDate","");g.text=IX.Date.getDateByFormat(i(t),"yyyy/MM/dd")+"至"+IX.Date.getDateByFormat(i(u),"yyyy/MM/dd");break;case"operator":var o=!IX.isEmpty(h)&&IX.isString(h)?JSON.parse(h):{};g.value=$XP(o,"userID",""),g.text=$XP(o,"userName","")+"<br/>"+$XP(o,"userMobile","");break;case"isActive":var v=$XP(a,"isActive",0);g.value=h,g.text='<input type="checkbox" name="switch_event" data-event-id="'+v+'" '+(0!=h?"checked ":"")+' data-key="'+$XP(a,"__id__","")+'"  />';break;case"rowControl":if("mcmGiftsMgr"==f&&(g={type:"button",rowspan:2,colspan:1,btns:[{label:"修改",link:"javascript:void(0);",clz:"btn-block btn-link edit-gift",id:$XP(a,"giftItemID",""),key:$XP(a,"__id__",""),type:"edit"},{label:"删除",link:"javascript:void(0);",clz:"btn-block btn-link delete-gift",id:$XP(a,"giftItemID",""),key:$XP(a,"__id__"),type:"delete"},{label:"使用详情",link:"javascript:void(0);",clz:"btn-block btn-link detail-gift",id:$XP(a,"giftItemID",""),key:$XP(a,"__id__"),type:"detail"}]}),"mcmEventMgr"==f){var w=$XP(a,"isActive",0);g={type:"button",rowspan:1,colspan:1,btns:[{label:"修改",link:"javascript:void(0);",clz:"btn-block btn-link edit-event "+(0!=w?"hidden":""),id:$XP(a,"eventID",""),key:$XP(a,"__id__",""),type:"edit"},{label:"删除",link:"javascript:void(0);",clz:"btn-block btn-link delete-event "+(0!=w?"hidden":""),id:$XP(a,"eventID",""),key:$XP(a,"__id__"),type:"delete"},{label:"查看",link:"javascript:void(0);",clz:"btn-block btn-link detail-event",id:$XP(a,"eventID",""),key:$XP(a,"__id__"),type:"detail"},{label:"活动跟踪",link:"javascript:void(0);",clz:"btn-block btn-link track-event "+(0!=w?"":"hidden"),id:$XP(a,"eventID",""),key:$XP(a,"__id__"),type:"track"}]}}break;default:g.value=g.text=$XP(a,c,"")}return g};b.mapGiftsQueryResultRenderData=function(a){var b=this,c=Hualala.PageRoute.getPageContextByPath(),e=$XP(c,"name"),g="col-md-12",h="  table-hover mcm-grid",i=d,j=function(a,c){var d=_.map(i,function(a){return{key:$XP(a,"key",""),clz:$XP(a,"clz","")}}),e={clz:"",type:"text"},g=_.map(d,function(d){var g=f.apply(b,[a,c,$XP(d,"key","")]);return IX.inherit(e,g,{clz:$XP(d,"clz","")})});return g},k=_.map(a,function(a,b){var c={clz:"",cols:j(a,b)};if("mcmGiftsMgr"==e){var d={subRows:[{clz:"gift-rule",cols:[{clz:"",colspan:3,rowspan:1,html:"礼品规则："}]}]};c=IX.inherit(c,d)}return c}),l=[{clz:"hidden",cols:[]}];return{clz:g,tblClz:h,isEmpty:a&&0!=a.length?!1:!0,colCount:i.length,thead:i,rows:k,tfoot:l}},b.mapEventsQueryResultRenderData=function(a){var b=this,c=Hualala.PageRoute.getPageContextByPath(),d=($XP(c,"name"),"col-md-12"),g="  table-hover mcm-grid",h=e,i=function(a,c){var d=_.map(h,function(a){return{key:$XP(a,"key",""),clz:$XP(a,"clz","")}}),e={clz:"",type:"text"},g=_.map(d,function(d){var g=f.apply(b,[a,c,$XP(d,"key","")]);return IX.inherit(e,g,{clz:$XP(d,"clz","")})});return g},j=_.map(a,function(a,b){var c={clz:"",cols:i(a,b)};return c}),k=[{clz:"hidden",cols:[]}];return{clz:d,tblClz:g,isEmpty:a&&0!=a.length?!1:!0,colCount:h.length,thead:h,rows:j,tfoot:k}},b.bundleGiftsQueryResultEvent=function(){var d=this;d.$result.on("click",".btn-link",function(){var e=a(this),f=e.attr("data-type"),g=e.attr("data-id"),h=e.attr("data-key"),i=d.model.getRecordModelByID(h);switch(f){case"edit":{new Hualala.MCM.MCMWizardModal({parentView:d,mode:"edit",successFn:function(){},failFn:function(){},model:i,modalClz:"mcm-gift-modal",wizardClz:"mcm-gift-wizard",modalTitle:"编辑礼品",onWizardInit:function(a,c,d){b.initGiftBaseInfoStep.call(this,a,c,d)},onStepCommit:function(a){Hualala.MCM.onGiftWizardStepCommit.call(this,a)},onStepChange:function(a,b,c,d){Hualala.MCM.onGiftWizardStepChange.call(this,a,b,c,d)},bundleWizardEvent:function(){Hualala.MCM.bundleGiftWizardEvent.call(this)},wizardStepsCfg:Hualala.MCM.GiftWizardCfg,wizardCtrls:Hualala.MCM.WizardCtrls})}break;case"delete":d.emit("deleteItem",{id:h,key:g,successFn:function(){c({msg:"删除成功",type:"success"});var a=e.parents("tr"),b=a.next(".gift-rule");a.remove(),b.remove()},faildFn:function(a){c({msg:$XP(a,"resultmsg",""),type:"danger"})}});break;case"detail":var j=Hualala.PageRoute.createPath("mcmGiftDetail",[g]);Hualala.PageRoute.jumpPage(j)}}),d.$result.on("mouseover","tr.gift-rule",function(){var b=a(this);b.prev("tr").addClass("hover")}).on("mouseout","tr.gift-rule",function(){var b=a(this);b.prev("tr").removeClass("hover")})},b.bundleEventsQueryResultEvent=function(){var b=this;b.$result.on("click",".btn-link",function(){var d=a(this),e=d.attr("data-type"),f=d.attr("data-id"),g=d.attr("data-key"),h=b.model.getRecordModelByID(g);switch(e){case"edit":{new Hualala.MCM.MCMWizardModal({parentView:b,mode:"edit",successFn:function(){},failFn:function(){},model:h,modalClz:"mcm-event-modal",wizardClz:"mcm-event-wizard",modalTitle:"创建活动",onWizardInit:function(a,b,c){Hualala.MCM.initEventBaseInfoStep.call(this,a,b,c)},onStepCommit:function(a){Hualala.MCM.onEventWizardStepCommit.call(this,a)},onStepChange:function(a,b,c,d){Hualala.MCM.onEventWizardStepChange.call(this,a,b,c,d)},bundleWizardEvent:function(){Hualala.MCM.bundleEventWizardEvent.call(this)},wizardStepsCfg:Hualala.MCM.EventWizardCfg,wizardCtrls:Hualala.MCM.WizardCtrls})}break;case"delete":b.emit("deleteItem",{id:g,key:f,successFn:function(){c({msg:"删除成功",type:"success"});var a=d.parents("tr");a.remove()},faildFn:function(a){c({msg:$XP(a,"resultmsg",""),type:"danger"})}});break;case"detail":j.call(b,d);break;case"track":var i=Hualala.PageRoute.createPath("mcmEventTrack",[f]);Hualala.PageRoute.jumpPage(i)}})},b.renderQueryResult=function(a){var b=this,c=Hualala.PageRoute.getPageContextByPath(),d=$XP(c,"name");if(b.$result.empty(),b.$result.html(b.get("resultTpl")(a)),"mcmEventMgr"==d){var e=b.$result.find(":checkbox[name=switch_event]");k.call(b,e)}};var g=function(a,b){var c=this,d=a.attr("data-key"),e=c.model.getRecordModelByID(d),f=e.getEventCardClz(),g=a.parents("tr"),h=g.find(".eventWay");h.find(".event-card").removeClass(0!=b?"disable":f).addClass(0!=b?f:"disable")},h=function(a){var b=a.parents("tr"),c=b.find(".ctrlrow");c.find(".edit-event, .delete-event").addClass("hidden"),c.find(".track-event").removeClass("hidden")},i=function(a){var b=function(){var b=a.getEventCardSet();return{card:{clz:$XP(b,"type",""),label:$XP(b,"label","")}}},c=function(){var b="eventName,cardLevelLabel,eventRemark,deductPoints,sendPoints,eventRules".split(","),c={};return _.each(b,function(b){switch(b){case"cardLevelLabel":c[b]=a.get("cardLevelID");break;case"deductPoints":case"sendPoints":c[b]=parseInt(a.get(b));break;default:c[b]=a.get(b)}}),IX.inherit(c,{infoLabelClz:"col-sm-3"})},d=function(){var b="EGiftID,EGiftName,EGiftOdds,EgiftSendCount,EGiftSingleCount,EGiftTotalCount,EGiftEffectTimeHours,EGiftValidUnitDayCount".split(","),c="EGiftID",d=0,e=a.getAll(),f=[];_.each(e,function(a,b){0==b.indexOf(c)&&d++});for(var g=1;d>=g;g++){var h=_.map(b,function(b){return a.get(b+"_"+g)}),i=_.object(b,h);i=IX.inherit(i,{level:g+"等奖",surplusCount:parseInt($XP(i,"EGiftTotalCount",0))-parseInt(i,"EgiftSendCount",0)}),f.push(i)}return f=_.reject(f,function(a){return 0!=$XP(a,c)}),{colCount:b.length,giftItems:f,hasGifts:f.length>0?!0:!1}};return IX.inherit(c(),b(),d())};b.mapEventDetailRenderData=i;var j=function(b){var d=this,e=(b.attr("data-id"),b.attr("data-key")),f=d.model.getRecordModelByID(e),g=Handlebars.compile(Hualala.TplLib.get("tpl_event_detail")),h=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns"));Handlebars.registerPartial("card",Hualala.TplLib.get("tpl_event_card"));var j=new Hualala.UI.ModalDialog({id:"event_detail",clz:"evtdetail-modal",title:"活动详情",afterRemove:function(){}});j._.footer.html(h({btns:[{clz:"btn-default",name:"cancel",label:"关闭"}]})),j._.footer.find(".btn-default").attr("data-dismiss","modal"),f.emit("update",{successFn:function(){var b=i.call(d,f),c=a(g(b));j._.body.append(c),j.show()},faildFn:function(a){c({msg:$XP(a,"resultmsg",""),type:"danger"})}})},k=function(b){var d=this;b.each(function(){var b=a(this),e="已启用",f="未启用";b.bootstrapSwitch({size:"normal",onColor:"primary",offColor:"default",onText:e,offText:f}).on("switchChange.bootstrapSwitch",function(b,e){var f=a(this),i=f.attr("data-event-id"),j=f.attr("data-key");d.emit("switchEvent",{eventID:i,isActive:+e,key:j,successFn:function(){c({msg:(+e?"开启":"关闭")+"活动成功",type:"success"}),g.call(d,f,+e),h.call(d,f,+e)},faildFn:function(a){f.bootstrapSwitch("toggleState",!0),c({msg:$XP(a,"resultmsg",""),type:"danger"})}})})})},l=Stapes.subclass({constructor:function(a){this.$container=null,this.$resultBox=null,this.$result=null,this.$pager=null,this.set("mapResultRenderData",$XF(a,"mapResultRenderData")),this.set("renderResult",$XF(a,"renderResult")),this.set("bundleEvent",$XF(a,"bundleEvent")),this.loadTemplate()}});l.proto({init:function(a){if(this.$container=$XP(a,"container",null),this.model=$XP(a,"model",null),!this.$container||!this.model)throw"Query Result View Init Faild!";this.initLayout()},loadTemplate:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_shop_list_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_base_datagrid")),c=Handlebars.compile(Hualala.TplLib.get("tpl_gift_card")),d=Handlebars.compile(Hualala.TplLib.get("tpl_event_card"));Handlebars.registerPartial("colBtns",Hualala.TplLib.get("tpl_base_grid_colbtns")),Handlebars.registerHelper("chkColType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),this.set({layoutTpl:a,resultTpl:b,giftCardTpl:c,eventCardTpl:d})},initLayout:function(){var a=this.get("layoutTpl"),b=a();this.$container.append(b),this.$resultBox=this.$container.find(".shop-list"),this.$result=this.$container.find(".shop-list-body"),this.$pager=this.$container.find(".page-selection"),this.initPager(),this.bindEvent()},initPager:function(a){var b=this;if(b.model.hasPager){var c={total:0,page:1,maxVisible:10,leaps:!0};this.$pager.IXPager(IX.inherit(c,a))}},mapRenderData:function(){var a=this.get("mapResultRenderData"),b=IX.isFn(a)?a.apply(this,arguments):null;return b},renderRecords:function(){var a=this.get("renderResult");IX.isFn(a)&&a.apply(this,arguments)},render:function(){var a=this,b=a.model,c=b.hasPager,d=b.getPagerParams(),e=$XP(d,"pageNo",1),f=b.getRecordsByPageNo(e),g=a.mapRenderData(f);a.renderRecords(g),c&&a.initPager({total:b.get("pageCount"),page:b.get("pageNo"),href:"javascript:void(0);"})},bindEvent:function(){var a=this,b=this.get("bundleEvent");IX.isFn(b)&&b.apply(this,arguments),a.model.hasPager&&a.$pager.on("page",function(b,c){var d=a.model.getPagerParams();d.pageNo=c,a.model.emit("load",IX.inherit(d,{pageNo:$XP(d,"pageNo",1),pageSize:$XP(d,"pageSize",15)}))})}}),b.QueryResultView=l}(jQuery,window),function(){IX.ns("Hualala.MCM");var a=Hualala.UI.LoadingModal,b=Hualala.MCM,c=Stapes.subclass({constructor:function(a){if(this.set({sessionData:Hualala.getSessionData()}),this.container=$XP(a,"container",null),this.view=$XP(a,"view",null),this.model=$XP(a,"model",null),!this.view||!this.model||!this.container)throw"Query Result init faild!";this.isReady=!1,this.bindEvent(),this.bindModelEvent(),this.bindViewEvent()}});c.proto({init:function(b){this.model.init(b),this.view.init({model:this.model,container:this.container}),this.loadingModal=new a({start:100}),this.isReady=!0},hasReady:function(){return this.isReady},bindEvent:function(){this.on({load:function(a){var b=this;b.hasReady()||b.init(a),b.model.emit("load",a)}},this)},bindModelEvent:function(){this.model.on({load:function(a){var b=this,c=function(){b.view.emit("render"),b.loadingModal.hide()};b.loadingModal.show(),b.model.load(a,c)}},this)},bindViewEvent:function(){this.view.on({render:function(){var a=this;a.view.render()},deleteItem:function(a){var b=this,c=$XP(a,"id"),d=$XP(a,"key"),e=$XF(a,"successFn"),f=$XF(a,"faildFn"),g=b.model.getRecordModelByID(c);g.emit("delete",{itemID:d,successFn:function(a){e(a)},faildFn:function(a){f(a)}})},switchEvent:function(a){var b=this,c=_.pick(a,"eventID","isActive"),d=$XP(a,"key"),e=b.model.getRecordModelByID(d);e.emit("switchEvent",{post:c,successFn:$XF(a,"successFn"),faildFn:$XF(a,"faildFn")})}},this)}}),b.QueryResultControler=c}(jQuery,window),function(){IX.ns("Hualala.MCM");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.Shop.QueryModel.subclass({constructor:function(a){this.origCities=[],this.origAreas=[],this.origShops=[],this.queryKeys=$XP(a,"queryKeys",[]),this.isReady=!1,this.callServer=Hualala.Global.getShopQuerySchema}}));a.proto({getQueryParams:function(){var a=this,b=_.map(a.queryKeys,function(b){return a.get(b)}),c=_.object(a.queryKeys,b);return IX.Debug.info("DEBUG: Order Query Model Query Params:"),IX.Debug.info(c),c}}),Hualala.MCM.QueryModel=a}(jQuery,window),function(a){IX.ns("Hualala.MCM");Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip;Hualala.MCM.QueryFormKeys={GiftMgrQueryKeys:["giftName","giftType"],GiftSendStatisticQueryKeys:["startTime","endTime","getWay","giftStatus","giftItemID"],GiftUsedStatisticQueryKeys:["startTime","endTime","usingShopID","giftItemID"],EventMgrQueryKeys:["eventName","eventWay","isActive","eventStartDate","eventEndDate"],EventTrackBaseQueryKeys:["eventID","keyword","cardLevelID"]},Hualala.MCM.QueryFormElsCfg={giftName:{type:"text",label:"礼品名称",defaultVal:"",validCfg:{validators:{}}},giftType:{type:"combo",label:"礼品类型",defaultVal:"",validCfg:{validators:{}}},search:{type:"button",clz:"btn btn-warning",label:"查询"},addGift:{type:"button",clz:"btn btn-warning",label:"添加礼品"},giftItemID:{type:"hidden",defaultVal:"",validCfg:{validators:{}}},timeRange:{type:"section",label:"发出时间",min:{type:"datetimepicker",defaultVal:"",validCfg:{group:".min-input",validators:{}}},max:{type:"datetimepicker",defaultVal:"",validCfg:{group:".max-input",validators:{}}}},getWay:{type:"combo",label:"发出方式",defaultVal:"",validCfg:{validators:{}}},giftStatus:{type:"combo",label:"状态",defaultVal:"",validCfg:{validators:{}}},usingShopID:{type:"combo",label:"适用店铺",defaultVal:"",validCfg:{validators:{}}},eventName:{type:"text",label:"活动名称",defaultVal:"",validCfg:{validators:{}}},eventWay:{type:"combo",label:"活动类型",defaultVal:"",validCfg:{validators:{}}},isActive:{type:"combo",label:"活动状态",defaultVal:"",validCfg:{validators:{}}},eventTime:{type:"section",label:"起止日期",min:{type:"datetimepicker",defaultVal:"",validCfg:{group:".min-input",validators:{}}},max:{type:"datetimepicker",defaultVal:"",validCfg:{group:".max-input",validators:{}}}},addEvent:{type:"button",clz:"btn btn-warning",label:"添加活动"},winFlag:{type:"combo",label:"中奖情况",defaultVal:"",validCfg:{validators:{}}},eventID:{type:"hidden",defaultVal:"",validCfg:{validators:{}}},keyword:{type:"text",label:"关键字",defaultVal:"",validCfg:{validators:{}}},cardLevelID:{type:"combo",label:"会员等级",defaultVal:"-1",validCfg:{validators:{}}}};var b=new IX.IListManager;_.each(Hualala.MCM.QueryFormElsCfg,function(a,c){var d=$XP(a,"type"),e="col-xs-2 col-sm-2 col-md-4 control-label";if("section"==d){var f=minID=c+"_min_"+IX.id(),g=c+"_max_"+IX.id(),h="eventTime"==c?"eventStartDate":"startTime",i="eventTime"==c?"eventEndDate":"endTime",j=IX.inherit($XP(a,"min",{}),{id:minID,name:h,clz:"col-xs-5 col-sm-5 col-md-4"}),k=IX.inherit($XP(a,"max",{}),{id:g,name:i,clz:"col-xs-5 col-sm-5 col-md-4"});b.register(c,IX.inherit(a,{id:f,labelClz:"col-xs-2 col-sm-2 col-md-2 control-label",min:j,max:k}))}else b.register(c,IX.inherit(a,{id:c+"_"+IX.id(),name:c,labelClz:e},"button"!=$XP(a,"type")?{clz:"col-xs-8 col-sm-8 col-md-8"}:null))}),Hualala.MCM.bundleGiftsQueryEvent=function(){var b=this;b.$queryBox.on("click",".btn",function(){var c=a(this).attr("name");if("addGift"==c){new Hualala.MCM.MCMWizardModal({parentView:b,mode:"create",successFn:function(){},failFn:function(){},model:new Hualala.MCM.BaseGiftModel,modalClz:"mcm-gift-modal",wizardClz:"mcm-gift-wizard",modalTitle:"创建礼品",onWizardInit:function(a,b,c){Hualala.MCM.initGiftBaseInfoStep.call(this,a,b,c)},onStepCommit:function(a){Hualala.MCM.onGiftWizardStepCommit.call(this,a)},onStepChange:function(a,b,c,d){Hualala.MCM.onGiftWizardStepChange.call(this,a,b,c,d)},bundleWizardEvent:function(){Hualala.MCM.bundleGiftWizardEvent.call(this)},wizardStepsCfg:Hualala.MCM.GiftWizardCfg,wizardCtrls:Hualala.MCM.WizardCtrls})}else"search"==c&&b.emit("query",b.getQueryParams())})},Hualala.MCM.bundleEventsQueryEvent=function(){var b=this;b.$queryBox.on("click",".btn",function(){var c=a(this).attr("name");if("addEvent"==c){new Hualala.MCM.MCMWizardModal({parentView:b,mode:"create",successFn:function(){},failFn:function(){},model:new Hualala.MCM.BaseEventModel,modalClz:"mcm-event-modal",wizardClz:"mcm-event-wizard",modalTitle:"创建活动",onWizardInit:function(a,b,c){Hualala.MCM.initEventBaseInfoStep.call(this,a,b,c)},onStepCommit:function(a){Hualala.MCM.onEventWizardStepCommit.call(this,a)},onStepChange:function(a,b,c,d){Hualala.MCM.onEventWizardStepChange.call(this,a,b,c,d)},bundleWizardEvent:function(){Hualala.MCM.bundleEventWizardEvent.call(this)},wizardStepsCfg:Hualala.MCM.EventWizardCfg,wizardCtrls:Hualala.MCM.WizardCtrls})}else"search"==c&&b.emit("query",b.getQueryParams())})},Hualala.MCM.mapGiftQueryFormRenderData=function(){var a=this,c=(a.model.queryKeys,{cols:[{colClz:"col-md-4",items:b.getByKeys(["giftName"])},{colClz:"col-md-4",items:b.getByKeys(["giftType"])},{colClz:"col-md-2",items:b.getByKeys(["search"])},{colClz:"col-md-2 "+(a.hasAddBtn?"":"hidden"),items:b.getByKeys(["addGift"])}]});return{query:c}},Hualala.MCM.mapEventQueryFormRenderData=function(){var a=this,c=(a.model.queryKeys,{cols:[{colClz:"col-md-3",items:b.getByKeys(["eventName"])},{colClz:"col-md-3",items:b.getByKeys(["eventWay"])},{colClz:"col-md-3",items:b.getByKeys(["isActive"])},{colClz:"col-md-6",items:b.getByKeys(["eventTime"])},{colClz:"col-md-offset-2 col-md-2",items:b.getByKeys(["search"])},{colClz:"col-md-2",items:b.getByKeys(["addEvent"])}]});return{query:c}},Hualala.MCM.mapGiftDetailGetWayQueryFormRenderData=function(){var a=this,c=(a.model.queryKeys,{cols:[{colClz:"col-md-4",items:b.getByKeys(["timeRange"])},{colClz:"col-md-3",items:b.getByKeys(["getWay"])},{colClz:"col-md-3",items:b.getByKeys(["giftStatus"])},{colClz:"col-md-2",items:b.getByKeys(["search","giftItemID"])}]});return{query:c}},Hualala.MCM.mapGiftDetailUsedQueryFormRenderData=function(){var a=this,c=(a.model.queryKeys,{cols:[{colClz:"col-md-4",items:b.getByKeys(["timeRange"])},{colClz:"col-md-3",items:b.getByKeys(["usingShopID"])},{colClz:"col-md-offset-1 col-md-2",items:b.getByKeys(["search","giftItemID"])}]});return{query:c}},Hualala.MCM.mapEventTrackQueryFormRenderData=function(){var a=this,c=(a.model.queryKeys,a.$container.data("eventDetail")),d=$XP(c,"eventWay"),e={cols:[{colClz:"col-md-4",items:b.getByKeys(["keyword"])},{colClz:"col-md-3",items:b.getByKeys(["cardLevelID"])},{colClz:"col-md-2",items:b.getByKeys(["search","eventID"])}]};return("20"==d||"22"==d)&&(e={cols:[{colClz:"col-md-4",items:b.getByKeys(["keyword"])},{colClz:"col-md-3",items:b.getByKeys(["cardLevelID"])},{colClz:"col-md-3",items:b.getByKeys(["winFlag"])},{colClz:"col-md-2",items:b.getByKeys(["search","eventID"])}]}),{query:e}};var c=Hualala.Order.QueryView.subclass({constructor:function(a){this.isReady=!1,this.$container=null,this.$queryBox=null,this.loadTemplates(),this.hasAddBtn=$XP(a,"hasAddBtn",!0),this.set("mapRenderDataFn",$XF(a,"mapRenderDataFn")),this.set("bundleQueryEvent",$XF(a,"bundleQueryEvent")),this.set("initQueryFormEls",$XP(a,"initQueryFormEls",null))}});c.proto({renderLayout:function(){var b=this,c=b.get("layoutTpl"),d=(b.model,b.mapRenderLayoutData()),e=c(d);b.$queryBox=a(e),b.$container.html(b.$queryBox),b.get("initQueryFormEls")?IX.isFn(b.get("initQueryFormEls"))&&b.get("initQueryFormEls").call(b):b.initQueryFormEls()},bindEvent:function(){var a=this,b=a.get("bundleQueryEvent");b.call(a)},getQueryParams:function(){var a=this,b=(a.model.queryKeys,a.$queryBox.find("form")),c=b.serializeArray();return c=_.map(c,function(a){var b=$XP(a,"name"),c=$XP(a,"value","");return"startDate"==b||"endDate"==b?(c=IX.isEmpty(c)?"":IX.Date.getDateByFormat(c,"yyyyMMdd"),{name:b,value:c}):a}),c=_.object(_.pluck(c,"name"),_.pluck(c,"value")),a.model.set(c),IX.Debug.info("DEBUG: Order Query Model Query Params:"),IX.Debug.info(c),c},initQueryFormEls:function(){var a=this,b=a.model.getQueryParams(),c=Hualala.PageRoute.getPageContextByPath(),d=$XP(c,"name");if("mcmEventMgr"==d&&(a.initEventTypeComboOpts($XP(b,"eventWay","")),a.initEventIsActiveComboOpts($XP(b,"isActive","")),a.initEventTimePicker($XP(b,"eventStartDate",""),$XP(b,"eventEndDate"))),"mcmGiftsMgr"==d&&a.initGiftTypeComboOpts($XP(b,"giftType","")),"mcmGiftDetail"==d){var e=a.$container.attr("id"),c=Hualala.PageRoute.getPageContextByPath(),d=$XP(c,"name");a.initEventTimePicker($XP(b,"startTime",""),$XP(b,"endTime","")),a.$queryBox.find(":hidden[name=giftItemID]").val($XP(c,"params",[])[0]),console.info(a.container),"tab_send"==e?(a.initGiftDetailGetWayComboOpts($XP(b,"getWay","")),a.initGiftDetailGiftStatusComboOpts($XP(b,"giftStatus",""))):a.initShopChosenPanel($XP(b,"usingShopID",""))}"mcmEventTrack"==d&&(a.initCardLevelComboOpts(),a.initWinTypeComboOpts())},initGiftDetailGetWayComboOpts:function(a){var b=this,c=Hualala.TypeDef.MCMDataSet.GiftDistributeTypes;if(!IX.isEmpty(c)){c=_.map(c,function(b){var c=$XP(b,"value"),d=$XP(b,"label");return{value:c,label:d,selected:c==a?"selected":""}});var d=b.get("comboOptsTpl"),e=d({opts:c}),f=b.$queryBox.find("select[name=getWay]");f.html(e)}},initGiftDetailGiftStatusComboOpts:function(a){var b=this,c=Hualala.TypeDef.MCMDataSet.GiftStatus;if(!IX.isEmpty(c)){c=_.map(c,function(b){var c=$XP(b,"value"),d=$XP(b,"label");return{value:c,label:d,selected:c==a?"selected":""}});var d=b.get("comboOptsTpl"),e=d({opts:c}),f=b.$queryBox.find("select[name=giftStatus]");f.html(e)}},initGiftTypeComboOpts:function(a){var b=this,c=Hualala.TypeDef.MCMDataSet.GiftTypes;if(!IX.isEmpty(c)){c=_.map(c,function(b){var c=$XP(b,"value"),d=$XP(b,"label");return{value:c,label:d,selected:c==a?"selected":""}});var d=b.get("comboOptsTpl"),e=d({opts:c}),f=b.$queryBox.find("select[name=giftType]");f.html(e)}},initEventTypeComboOpts:function(a){var b=this,c=Hualala.TypeDef.MCMDataSet.EventTypes;if(!IX.isEmpty(c)){c=_.map(c,function(b){var c=$XP(b,"value"),d=$XP(b,"label");return{value:c,label:d,selected:c==a?"selected":""}});var d=b.get("comboOptsTpl"),e=d({opts:c}),f=b.$queryBox.find("select[name=eventWay]");f.html(e)}},initEventIsActiveComboOpts:function(a){var b=this,c=Hualala.TypeDef.MCMDataSet.EventIsActive;if(!IX.isEmpty(c)){c=_.map(c,function(b){var c=$XP(b,"value"),d=$XP(b,"label");return{value:c,label:d,selected:c==a?"selected":""}});var d=b.get("comboOptsTpl"),e=d({opts:c}),f=b.$queryBox.find("select[name=isActive]");f.html(e)}},initEventTimePicker:function(){var a=this;a.$queryBox.find("[data-type=datetimepicker]").datetimepicker({format:"yyyy/mm/dd",startDate:"2010/01/01",autoclose:!0,minView:"month",todayBtn:!0,todayHighlight:!0,language:"zh-CN"})},renderShopChosenRenderOptions:function(a){var b=this,c=Handlebars.compile(Hualala.TplLib.get("tpl_shop_optgroup")),d=_.groupBy(a,function(a){return $XP(a,"cityID")}),e=[];_.each(d,function(a,b){var c=$XP(a[0],"cityName",""),d=_.map(a,function(a){return IX.inherit(a,{clz:""})});e.push({cityName:c,cityID:b,options:d})}),b.$queryBox.find("select[name=usingShopID]").html(c({items:e})),b.$queryBox.find("select[name=usingShopID]").prepend('<option value="" selected></option>')},initShopChosenPanel:function(){var a=this,b=new Pymatch([]),c=[];Hualala.Global.getShopQuerySchema({},function(d){if("000"==$XP(d,"resultcode")){c=$XP(d,"data.shops",[]),a.renderShopChosenRenderOptions(c);var e=function(a){b.setNames(_.map(c,function(a){return IX.inherit(a,{name:$XP(a,"shopName"),value:$XP(a,"shopID")})}));var d=b.match(a),e={};return _.each(d,function(a){e[a[0].shopID]=!0}),e};a.$queryBox.find("select[name=usingShopID]").chosen({width:"200px",placeholder_text:"请选择店铺",no_results_text:"抱歉，没有找到！",allow_single_deselect:!1,getMatchedFn:e})}})},initCardLevelComboOpts:function(){var a=this,b=Hualala.TypeDef.MCMDataSet.EventCardLevels,c=function(){var c=a.get("comboOptsTpl"),d=c({opts:b}),e=a.$queryBox.find("select[name=cardLevelID]");e.html(d)};Hualala.Global.getVipLevels({},function(a){if("000"==$XP(a,"resultcode")){var d=_.filter($XP(a,"data.records",[]),function(a){return 1==$XP(a,"isActive")});b=b.concat(_.map(d,function(a){return{value:$XP(a,"cardLevelID"),label:$XP(a,"cardLevelName")}})),c()}else c()})},initWinTypeComboOpts:function(){var a=this,b=null,c="",d=a.$container.data("eventDetail"),e=$XP(d,"eventWay");if("20"==e?(b=Hualala.TypeDef.MCMDataSet.WinTypes,c="中奖情况"):"22"==e&&(b=Hualala.TypeDef.MCMDataSet.JoinTypes,c="参与状态"),!IX.isEmpty(b)){b=_.map(b,function(a){var b=$XP(a,"value"),c=$XP(a,"label");return{value:b,label:c}});var f=a.get("comboOptsTpl"),g=f({opts:b}),h=a.$queryBox.find("select[name=winFlag]");h.html(g),h.parents(".form-group").find("label").html(c)}}}),Hualala.MCM.QueryView=c}(jQuery,window),function(){IX.ns("Hualala.MCM");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.Shop.QueryController.subclass({constructor:function(a){if(this.set({sessionData:Hualala.getSessionData()}),this.container=$XP(a,"container",null),this.resultController=$XP(a,"resultController",null),this.model=$XP(a,"model",null),this.view=$XP(a,"view",null),!(this.container&&this.model&&this.view&&this.resultController))throw"QueryController init faild!";this.init()}}));a.proto({}),Hualala.MCM.QueryController=a}(jQuery,window),function(a){IX.ns("Hualala.MCM");{var b=Hualala.MCM;Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.UI.LoadingModal}b.GiftWizardCfg=[{id:"gift_base_info",label:"基本信息"},{id:"gift_rule",label:"使用规则"}],b.EventWizardCfg=[{id:"event_base_info",label:"基本信息"},{id:"event_rule",label:"活动规则"},{id:"event_gift",label:"设置礼品、奖品"},{id:"event_on",label:"预览并启用"}],b.WizardCtrls=[{clz:"btn-default btn-prev",name:"prev",label:"上一步",loadingText:"请稍候..."},{clz:"btn-default btn-cancel",name:"cancel",label:"取消",loadingText:"取消"},{clz:"btn-default btn-next",name:"next",label:"下一步",loadingText:"请稍候..."},{clz:"btn-default btn-finish",name:"finish",label:"启用",loadingText:"提交中..."}];var c=Stapes.subclass({constructor:function(a){this.parentView=$XP(a,"parentView"),this.mode=$XP(a,"mode","create"),this.successFn=$XF(a,"successFn"),this.faildFn=$XF(a,"faildFn"),this.modal=null,this.$body=null,this.$wizard=null,this.wizardID="mcm_wizard",this.wizardClz=$XP(a,"wizardClz",""),this.wizardStepsCfg=$XP(a,"wizardStepsCfg",[]),this.wizardCtrls=$XP(a,"wizardCtrls",[]),this.model=$XP(a,"model",null),this.modalClz=$XP(a,"modalClz",""),this.modalTitle=$XP(a,"modalTitle",""),this.stepViewHT=new IX.IListManager,this.onWizardInit=$XF(a,"onWizardInit"),this.onStepCommit=$XF(a,"onStepCommit"),this.onStepChange=$XF(a,"onStepChange"),this.bundleWizardEvent=$XF(a,"bundleWizardEvent"),this.loadTemplates(),this.initModal(),this.renderWizardLayout(),this.initWizard(),this.enableGoToNextStep=!1,this.bundleWizardEvent.call(this)}});c.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_wizard_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns"));Handlebars.registerPartial("stepAction",Hualala.TplLib.get("tpl_shop_modal_btns")),this.set({layoutTpl:a,btnTpl:b})},initModal:function(){var a=this;a.modal=new Hualala.UI.ModalDialog({id:"mcm_wizard_modal",clz:a.modalClz,title:a.modalTitle,hideCloseBtn:!0,backdrop:"static",showFooter:!1,afterHide:function(){}}),a.$body=a.modal._.body,a.modal.show()},mapWizardLayoutData:function(){var a=this,b=[],c=[];return b=_.map(a.wizardStepsCfg,function(a,b){return c.push({id:$XP(a,"id")}),IX.inherit(a,{idx:b+1})}),{id:a.wizardID,clz:a.wizardClz,stepNavs:b,steps:c,btns:a.wizardCtrls}},renderWizardLayout:function(){var a=this,b=a.mapWizardLayoutData(),c=a.get("layoutTpl"),d=c(b);a.$body.html(d),a.modal.show()},initWizard:function(){var b=this;b.$wizard=b.$body.find("#"+b.wizardID),b.$wizard.bsWizard({tabClass:"tabClass",nextSelector:".btn[name=next]",previousSelector:".btn[name=prev]",finishSelector:".btn[name=finish]",onTabClick:function(){return!1},onInit:function(c,d,e){var f=(a("li:eq("+e+")",b.$wizard),b.getTabContentIDByIndex(d,e)),g=a("#"+f,b.$wizard);b.onWizardInit.call(b,g,f,b.mode)},onNext:function(c){var d=a(c.find("a[data-toggle]").attr("href")),e=d.attr("id");0==b.enableGoToNextStep&&b.onStepCommit.call(b,e);var f=b.enableGoToNextStep;return b.enableGoToNextStep=!1,f},onPrevious:function(b){{var c=a(b.find("a[data-toggle]").attr("href"));c.attr("id")}return!0},onTabChange:function(){b.onStepChange.apply(b,arguments)},onTabShow:function(){},onFinish:function(c){var d=a(c.find("a[data-toggle]").attr("href")),e=d.attr("id");b.onStepCommit.call(b,e)}})},switchWizardCtrlStatus:function(a){var b=this;b.$wizard.find(".wizard-ctrl .btn").button(a)},getNextStep:function(){var a=this;a.enableGoToNextStep=!0,a.$wizard.bsWizard("next")},getPrevieousStep:function(){var a=this;a.enableGoToNextStep=!0,a.$wizard.bsWizard("previeous")},getTabContentIDByIndex:function(b,c){var d=a("li:eq("+c+")",b),e=d.find("a[data-toggle]").attr("href").replace("#","");return e},registerStepView:function(a,b){var c=this;c.stepViewHT.register(a,b)},getStepView:function(a){return this.stepViewHT.get(a)},switchViewMode:function(a){this.mode=a}}),b.MCMWizardModal=c}(jQuery,window),function(a){IX.ns("Hualala.MCM");var b=Hualala.MCM,c=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.Common.getMinuteIntervalOptions({startLabel:"立即生效",end:Hualala.Constants.SecondsOfDay/60})),d={giftItemID:{type:"hidden",defaultVal:""},giftType:{type:"combo",label:"礼品类型",defaultVal:"10",options:_.reject(Hualala.TypeDef.MCMDataSet.GiftTypes,function(a){return IX.isEmpty($XP(a,"value"))}),validCfg:{validators:{notEmpty:{message:"请选择礼品类型"}}}},giftValue:{type:"text",label:"礼品价值",defaultVal:"",prefix:"￥",surfix:"元",validCfg:{validators:{notEmpty:{message:"请输入礼品价值"},numeric:{message:"礼品价值必须为数字"},greaterThan:{inclusive:!1,value:0,message:"礼品价值必须大于0"}}}},giftName:{type:"text",label:"礼品名称",defaultVal:"",validCfg:{validators:{notEmpty:{message:"礼品名称不能为空"}}}},giftRemark:{type:"textarea",label:"礼品描述",defaultVal:"",validCfg:{validators:{notEmpty:{message:"礼品描述不能为空"}}}},validityDays:{type:"text",label:"有效天数",defaultVal:"30",surfix:"天",validCfg:{validators:{notEmpty:{message:"请输入有效天数"},numeric:{message:"有效天数必须为数字"},integer:{message:"有效天数必须是整数"},between:{inclusive:!1,min:0,max:1e4,message:"礼品价值必须在0到10000天之间"}}}},egiftEffectTimeHours:{type:"combo",label:"生效时间",defaultVal:"0",options:_.reduce(c,function(a,b,c){return 1==c&&(a=[a]),b.value>=180?a.concat(b):a}),validCfg:{validators:{}}},isHolidaysUsing:{type:"radiogrp",label:"节假日是否可用",defaultVal:"0",options:Hualala.TypeDef.MCMDataSet.GiftIsHolidayUsing,validCfg:{validators:{}}},usingTimeType:{type:"checkboxgrp",label:"使用时段",defaultVal:"1,2,3,4,5",options:Hualala.TypeDef.MCMDataSet.GiftUsingTimeTypes,validCfg:{validators:{notEmpty:{message:"请选择使用时段"}}}},foodScope:{type:"radiogrp",label:"菜谱范围",defaultVal:"0",options:Hualala.TypeDef.MCMDataSet.GiftFoodScope,validCfg:{}},supportOrderType:{type:"combo",label:"业务支持",defaultVal:"2",options:Hualala.TypeDef.MCMDataSet.GiftSupportOrderTypes,validCfg:{validators:{}}},isOfflineCanUsing:{type:"radiogrp",label:"到店使用",defaultVal:"0",options:Hualala.TypeDef.MCMDataSet.GiftIsOfflineUsing,validCfg:{validators:{}}},moneyLimitType:{type:"combo",label:"金额限制",defaultVal:"0",options:Hualala.TypeDef.MCMDataSet.GiftMonetaryLimitTypes,validCfg:{validators:{}}},moenyLimitValue:{type:"text",label:"",defaultVal:"100",prefix:"￥",surfix:"元，使用一张",validCfg:{validators:{notEmpty:{message:"请输入限制金额"},numeric:{message:"限制金额必须为数字"},greaterThan:{inclusive:!1,value:0,message:"现值金额必须大于0"}}}},shopNames:{type:"selectShops",label:"可使用店铺",defaultVal:"所有店铺适用"}},e=new IX.IListManager;
_.each(d,function(a,b){var c=$XP(a,"type"),d="col-sm-offset-1 col-sm-3 control-label";if("radiogrp"==c||"checkboxgrp"==c){var f=_.map($XP(a,"options"),function(a){return IX.inherit(a,{id:b+"_"+IX.id(),name:b,clz:"radiogrp"==c?" radio-inline":" checkbox-inline"})});e.register(b,IX.inherit(a,{id:b+"_"+IX.id(),options:f,labelClz:d,clz:"col-sm-7"}))}else"selectShops"==c?e.register(b,IX.inherit(a,{id:b+"_"+IX.id(),name:b,labelClz:d,clz:"col-sm-7"})):e.register(b,IX.inherit(a,{id:b+"_"+IX.id(),name:b,labelClz:d,clz:"col-sm-5"}))}),b.GiftSetFormElsHT=e;var f=function(a){var b=Hualala.TypeDef.MCMDataSet.GiftTypes;return _.find(b,function(b){return $XP(b,"value")==a})};b.getGiftTypeSet=f;var g=function(){var a=this,b=a.formKeys,c=_.map(b,function(b){var c=e.get(b),d=$XP(c,"type");if("combo"==d){var g=a.model.get(b)||$XP(c,"dafaultVal"),h=_.map($XP(c,"options"),function(a){return IX.inherit(a,{selected:$XP(a,"value")==g?"selected":""})});return IX.inherit(c,{disabled:"edit"==a.mode&&"giftType"==b?"disabled":"",value:g,options:h})}if("text"==d&&"giftName"==b){var i=$XP(Hualala.getSessionSite(),"groupName",""),j=a.model.get("giftType")||$XP(e.get("giftType"),"defaultVal"),k=$XP(f(j),"label");return IX.inherit(c,{value:i+k,disabled:"disabled"})}return"text"==d&&"giftValue"==b?IX.inherit(c,{value:a.model.get(b)||$XP(c,"dafaultVal"),disabled:"edit"==a.mode?"disabled":""}):IX.inherit(c,{value:a.model.get(b)||$XP(c,"dafaultVal")})});return c},h="giftItemID,giftType,giftValue,giftName,giftRemark".split(","),i=Stapes.subclass({constructor:function(a){if(this.mode=$XP(a,"mode",""),this.container=$XP(a,"container",""),this.parentView=$XP(a,"parentView"),this.model=$XP(a,"model"),this.successFn=$XF(a,"successFn"),this.failFn=$XF(a,"failFn"),this.mapFormElsData=$XF(a,"mapFormElsData"),!this.model||!this.parentView)throw"Gift Base Info View init faild!";this.loadTemplates(),this.initBaseCfg(),this.formParams=this.model.getAll(),this.renderForm(),this.initUIComponents(),this.bindEvent()}});i.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_mcm_base_form")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns"));Handlebars.registerHelper("checkFormElementType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),Handlebars.registerHelper("isInputGroup",function(a,b,c){return a||b?c.fn(this):c.inverse(this)}),this.set({layoutTpl:a,btnTpl:b})},initBaseCfg:function(){this.formKeys=h},renderForm:function(){var a=this,b=a.mapFormElsData.call(a),c=a.get("layoutTpl"),d=(a.get("btnTpl"),c({formClz:"wizard-step-form form-feedback-out",items:b}));a.container.html(d)},initUIComponents:function(){},bindEvent:function(){var b=this,c=b.initValidFieldOpts();b.container.find("form").bootstrapValidator({trigger:"blur",fields:c}).on("error.field.bv",function(c){{var d=a(c.target);d.data("bootstrapValidator")}b.failFn(b.model)}).on("success.form.bv",function(c){c.preventDefault();var d=a(c.target),e=(d.data("bootstrapValidator"),b.mode+"Gift",b.serializeForm());IX.Debug.info("DEBUG: Gift Wizard Form Params:"),IX.Debug.info(e),b.model.emit("saveCache",{params:e,failFn:function(){b.failFn.call(b)},successFn:function(){b.successFn.call(b)}})}),b.container.on("change","select[name=giftType]",function(){var c=a(this),d=c.val(),e=a(":text[name=giftValue]",b.container),f=e.parents(".form-group").find("> label");f.text(42==d?"积分点数":"礼品价值"),b.container.find(":text[name=giftName]").trigger("change")}),b.container.on("change",":text[name=giftValue]",function(){var c=a(this),d=c.val();!isNaN(d)&&b.container.find(":text[name=giftName]").trigger("change")}),b.container.on("change",":text[name=giftName]",function(){var c=a(this),d=a(":text[name=giftValue]",b.container).val(),e=a("select[name=giftType]",b.container).val(),g=f(e);groupName=$XP(Hualala.getSessionSite(),"groupName",""),val=groupName+d+(IX.isEmpty(d)?"":$XP(g,"unit"))+$XP(g,"label",""),c.val(val)})},initValidFieldOpts:function(){var a=this,b=_.reject(a.formKeys,function(a){return"giftItemID"==a}),c={};return _.each(b,function(a){{var b=e.get(a);$XP(b,"type")}c[a]=$XP(b,"validCfg",{})}),c},serializeForm:function(){{var b=this,c=b.formKeys,d={};_.map(c,function(c){{var f=e.get(c);$XP(f,"type")}d[c]=a("[name="+c+"]",b.container).val()})}return d}}),b.GiftBaseInfoStepView=i,b.initGiftBaseInfoStep=function(a,c,d){var e=this,f=new b.GiftBaseInfoStepView({mode:d,container:a,parentView:e,model:e.model,successFn:function(){var a=this;a.parentView.switchWizardCtrlStatus("reset"),a.parentView.getNextStep()},failFn:function(){var a=this;a.parentView.switchWizardCtrlStatus("reset")},mapFormElsData:g});e.registerStepView(c,f)},b.onGiftWizardStepChange=function(c,d,e,f){var g=this,h=(g.getTabContentIDByIndex(d,e),g.getTabContentIDByIndex(d,f)),i=a("#"+h,g.$wizard),j=g.getStepView(h);return-1==e&&0==f?!0:(j||(1==f&&b.initGiftRuleStep.call(g,i,h,g.mode),0==f&&b.initGiftBaseInfoStep.call(g,i,h,g.mode)),!0)},b.onGiftWizardStepCommit=function(a){var b=this,c=b.getStepView(a),d=c.container,e=d.find("form"),f=e.data("bootstrapValidator");b.switchWizardCtrlStatus("loading"),f.validate()},b.bundleGiftWizardEvent=function(){var b=this;b.$wizard.find(".wizard-ctrl .btn-cancel").on("click",function(){var c=(a(this),b.$wizard.bsWizard("currentIndex")),d=b.getTabContentIDByIndex(b.$wizard.find(".wizard-nav"),c),e=(b.stepViewHT.get(d),b.model.get("accountID"));e||0!=c?Hualala.UI.Confirm({title:"取消创建礼品",msg:"是否取消创建礼品的操作？<br/>之前的操作将不生效！",okLabel:"确定",okFn:function(){b.modal.hide()}}):b.modal.hide()})}}(jQuery,window),function(a){IX.ns("Hualala.MCM");var b=Hualala.MCM,c=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,b.GiftSetFormElsHT),d="giftItemID,validityDays,egiftEffectTimeHours,isHolidaysUsing,usingTimeType,foodScope,supportOrderType,isOfflineCanUsing,moneyLimitType,moenyLimitValue,shopNames".split(","),e=function(){var a=this,b=a.formKeys,d=_.map(b,function(b){var d=c.get(b),e=$XP(d,"type");if("combo"==e){var f=a.model.get(b)||$XP(d,"defaultVal"),g=_.map($XP(d,"options"),function(a){return IX.inherit(a,{selected:$XP(a,"value")==f?"selected":""})});return IX.inherit(d,{disabled:"edit"==a.mode&&"giftType"==b?"disabled":"",value:f,options:g})}if("radiogrp"==e||"checkboxgrp"==e){var f=a.model.get(b)||$XP(d,"defaultVal");"checkboxgrp"==e&&(f=f.split(","));var g=_.map($XP(d,"options"),function(a){var b="checkboxgrp"==e?_.contains(f,$XP(a,"value")+"")?!0:!1:$XP(a,"value")==f;return IX.inherit(a,{checked:b?"checked":""})});return IX.inherit(d,{options:g})}return IX.inherit(d,{value:a.model.get(b)||$XP(d,"defaultVal")})});return d},f=b.GiftBaseInfoStepView.subclass({constructor:b.GiftBaseInfoStepView.prototype.constructor});f.proto({initBaseCfg:function(){this.formKeys=10==this.model.get("giftType")?d:[]},initUIComponents:function(){var c=this,d=c.model.get("moneyLimitType")||0,e=a(":text[name=moenyLimitValue]"),f=e.parents(".form-group"),g=c.model.get("shopNames")||"",h=c.model.get("shopIDs")||"";f[0==d?"addClass":"removeClass"]("hidden"),c.chooseShop=new b.ChooseShopModal({parentView:c,trigger:c.container.find("div[name=shopNames]"),modalTitle:"选择店铺",modalClz:"choose-shop-modal",chosenShopNames:g||"不限店铺",chosenShopIDs:IX.isEmpty(h)?null:h.split(";")})},renderForm:function(){var a=this,b=a.model.get("giftType"),c=a.mapFormElsData.call(a),d=a.get("layoutTpl"),e=(a.get("btnTpl"),d({formClz:"wizard-step-form form-feedback-out",items:c}));a.container.html(e),40==b?a.container.append("<p>顾客在获取会员充值类礼品后，将直接充入其会员储值余额账户中！"):42==b&&a.container.append("<p>顾客在获取会员积分类礼品后，将直接充入其会员积分余额账户中！")},bindEvent:function(){var b=this,c=b.initValidFieldOpts();b.container.find("form").bootstrapValidator({trigger:"blur",fields:c}).on("error.field.bv",function(c){{var d=a(c.target);d.data("bootstrapValidator")}b.failFn(b.model)}).on("success.form.bv",function(c){c.preventDefault();var d=a(c.target),e=(d.data("bootstrapValidator"),b.mode+"Gift"),f=b.serializeForm();IX.Debug.info("DEBUG: Gift Wizard Form Params:"),IX.Debug.info(f),b.model.emit(e,{params:f,failFn:function(){b.failFn.call(b)},successFn:function(){b.successFn.call(b),b.parentView.modal.hide()}})}),b.container.on("change","select[name=moneyLimitType]",function(){var b=a(this),c=b.val(),d=a(":text[name=moenyLimitValue]"),e=d.parents(".form-group");e[0==c?"addClass":"removeClass"]("hidden")})},getCheckboxVal:function(b){var c=a(":checkbox[name="+b+"]:checked"),d=[];return c.each(function(){var b=a(this);d.push(b.val())}),d.join(",")},getRadiboxVal:function(b){var c=a(":radio[name="+b+"]:checked");return c.val()},serializeForm:function(){{var b=this,d=b.formKeys,e={};_.map(d,function(d){var f=c.get(d),g=$XP(f,"type");e[d]="checkboxgrp"==g?b.getCheckboxVal(d):"radiogrp"==g?b.getRadiboxVal(d):a("[name="+d+"]",b.container).val()||""})}return e}}),b.GiftRuleStepView=f,b.initGiftRuleStep=function(a,c,d){var f=this,g=new b.GiftRuleStepView({mode:d,container:a,parentView:f,model:f.model,successFn:function(){var a=this;a.parentView.switchWizardCtrlStatus("reset"),a.parentView.getNextStep()},failFn:function(){var a=this;a.parentView.switchWizardCtrlStatus("reset")},mapFormElsData:e});f.registerStepView(c,g)}}(jQuery,window),function(a){IX.ns("Hualala.MCM");var b=Hualala.MCM,c=new Hualala.Shop.QueryModel;c.extend({chosenShops:[],chosenCitys:[],initChosenData:function(a){var b=this;if(!IX.isEmpty(a)&&0!=a.length){var c=b.getShops(a),d=_.map(c,function(a){return $XP(a,"cityID")});d=b.getCities(_.uniq(d)),b.chosenShops=c,b.chosenCitys=d}},clearChosenData:function(){this.chosenShops=[],this.chosenCitys=[]},getChosenData:function(){return{cities:this.chosenCitys,shops:this.chosenShops}},mapComboOptions:function(){var a=this,b=a.chosenShops,c=a.getShops();c=_.reject(c,function(a){var c=$XP(a,"shopID"),d=_.find(b,function(a){return $XP(a,"shopID")==c});return c==$XP(d,"shopID")}),c=_.groupBy(c,"cityID");var d=[];return _.each(c,function(b,c){var e=a.getCities(c)[0];d.push({cityID:c,cityName:$XP(e,"cityName"),options:b})}),IX.Debug.info("DEBUG: Combo Shop Options:"),IX.Debug.info(d),d},mapChosenDataOptions:function(){var a=this,b=a.chosenShops,c=_.groupBy(b,"cityID"),d=[];return _.each(c,function(b,c){var e=a.getCities(c)[0];d.push({cityID:c,cityName:$XP(e,"cityName"),options:b})}),IX.Debug.info("DEBUG: Combo Chosen Shop Options:"),IX.Debug.info(d),d}}),b.ShopQueryModel=c;var d=Stapes.subclass({constructor:function(a){this.parentView=$XP(a,"parentView"),this.trigger=$XP(a,"trigger"),this.modal=null,this.$body=null,this.model=c,this.modalTitle=$XP(a,"modalTitle",""),this.modalClz=$XP(a,"modalClz",""),this.chosenShopIDs=$XP(a,"chosenShopIDs",[]),this.chosenShopNames=$XP(a,"chosenShopNames",[]),this.loadTemplates(),this.initInput(),this.initModal()}});d.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_mcm_queryshops")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns")),c=Handlebars.compile(Hualala.TplLib.get("tpl_shop_optgroup")),d=Handlebars.compile(Hualala.TplLib.get("tpl_shop_choose"));Handlebars.registerPartial("ctrlbtns",Hualala.TplLib.get("tpl_shop_modal_btns")),Handlebars.registerPartial("optgroup",Hualala.TplLib.get("tpl_shop_optgroup")),this.set({layoutTpl:a,btnTpl:b,optGrpTpl:c,inputTpl:d})},initInput:function(){var a=this,b=a.get("inputTpl");a.trigger.html(b({shopNames:a.chosenShopNames})),a.trigger.on("click",".btn-choose",function(){return a.modal.show(),a.renderLayout(),!1})},initModal:function(){var a=this;a.modal=new Hualala.UI.ModalDialog({id:"mcm_choose_shop_modal",clz:a.modalClz,title:a.modalTitle,hideCloseBtn:!0,backdrop:"static",showFooter:!0,afterHide:function(){}}),a.$body=a.modal._.body,a.$footer=a.modal._.footer},renderLayout:function(){var a=this;a.model.init({},function(){a.model.initChosenData(a.chosenShopIDs);var b=a.model.mapComboOptions(),c=a.model.mapChosenDataOptions(),d=a.get("layoutTpl"),e={chooseShopOpts:{comboName:"choose_shops",items:b},chosenShopOpts:{comboName:"chosen_shops",items:c},btns:[{clz:"btn-warning btn-block",name:"add_all",label:"全部添加>>"},{clz:"btn-warning btn-block",name:"add_items",label:"添加>"},{clz:"btn-warning btn-block",name:"delete_items",label:"<删除"},{clz:"btn-warning btn-block",name:"delete_all",label:"<<全部删除>"}]},f=d(e);a.$body.html(f),a.bindEvent()})},refreshCombo:function(){var b=this,c=b.model.mapComboOptions(),d=b.model.mapChosenDataOptions(),e=b.get("optGrpTpl"),f=e({items:c}),g=e({items:d});a("select[name=choose_shops]").html(f),a("select[name=chosen_shops]").html(g)},bindEvent:function(){var b=this;b.$body.on("mouseup","select.form-control > optgroup",function(){var b=a(this);b.hasClass("open")?b.removeClass("open").find("> option").hide():b.addClass("open").find("> option").show()}),b.$body.on("mouseup","select.form-control option",function(a){a.stopPropagation()}),b.$body.on("click",".select-center .btn",function(){var c=a(this),d=c.attr("name"),e=a("select[name=choose_shops]",b.$body),f=a("select[name=chosen_shops]",b.$body),g=[];switch(d){case"add_all":g=b.model.getShops(),g=_.map(g,function(a){return $XP(a,"shopID")}),b.model.clearChosenData();break;case"add_items":e.find("option:selected").each(function(b,c){g.push(a(c).attr("value"))}),f.find("option").each(function(b,c){g.push(a(c).attr("value"))});break;case"delete_all":b.model.clearChosenData();break;case"delete_items":f.find("option:not(:selected)").each(function(b,c){g.push(a(c).attr("value"))})}b.model.initChosenData(g),b.refreshCombo()}),b.$footer.on("click",".btn-ok",function(){var c=(a(this),b.model.getChosenData()),d=_.pluck($XP(c,"shops"),"shopName");b.parentView.model.emit("bindShops",c),b.trigger.find(".choose-shop-val").html(0==d.length?"不限店铺":d.join(";")),b.modal.hide()})}}),b.ChooseShopModal=d}(jQuery,window),function(a){IX.ns("Hualala.MCM");var b=Hualala.MCM,c=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,{eventID:{type:"hidden",defaultVal:""},eventName:{type:"text",label:"活动主题",defaultVal:"",validCfg:{validators:{notEmpty:{message:"活动主题不能为空"}}}},cardLevelID:{type:"combo",label:"顾客范围",defaultVal:"-1",options:Hualala.TypeDef.MCMDataSet.EventCardLevels,validCfg:{validators:{notEmpty:{message:"顾客范围不能为空"}}}},eventWay:{type:"combo",label:"活动类型",defaultVal:"20",options:_.reject(Hualala.TypeDef.MCMDataSet.EventTypes,function(a){return IX.isEmpty($XP(a,"value"))}),validCfg:{validators:{notEmpty:{message:"活动类型不能为空"}}}},eventRemark:{type:"textarea",label:"描述",defaultVal:"",validCfg:{validators:{notEmpty:{message:"活动说明不能为空"}}}},dateRange:{type:"section",label:"起止日期",min:{type:"datetimepicker",defaultVal:"",validCfg:{group:".min-input",validators:{notEmpty:{message:"请输入起始时间"}}}},max:{type:"datetimepicker",defaultVal:"",validCfg:{group:".max-input",validators:{notEmpty:{message:"请输入结束时间"}}}}},chkDeductPoints:{type:"checkboxgrp",label:"",defaultVal:"",options:[{value:1,label:"参与活动扣减积分"}],validCfg:{validators:{}}},deductPoints:{type:"text",label:"扣减积分",defaultVal:"0",validCfg:{validators:{notEmpty:{message:"请输入扣减积分值"},numeric:{message:"扣减积分必须为数字"},greaterThan:{inclusive:!0,value:0,message:"扣减积分必须大于或等于0"}}}},chkSendPoints:{type:"checkboxgrp",label:"",defaultVal:"",options:[{value:1,label:"参与活动赠送积分"}],validCfg:{validators:{}}},sendPoints:{type:"text",label:"赠送积分",defaultVal:"0",validCfg:{validators:{notEmpty:{message:"请输入赠送积分值"},numeric:{message:"赠送积分必须为数字"},greaterThan:{inclusive:!0,value:0,message:"赠送积分必须大于或等于0"}}}},radioCountCycleDays:{type:"radiogrp",label:"会员参与次数",defaultVal:"0",options:Hualala.TypeDef.MCMDataSet.EventCountCycleDays,validCfg:{}},partInTimes:{type:"inputCountCycleDays",label:"",defaultVal:"1",options:_.map([1,2,3,4,5,6,7,15,30,60,90],function(a){return{value:a,label:a+"天"}}),partInTimes:{validCfg:{validators:{notEmpty:{message:"请输入参与次数"},numeric:{message:"参与次数必须为数字"},greaterThan:{inclusive:!1,value:0,message:"参与次数必须大于0"}}}}},isVipBirthdayMonth:{type:"radiogrp",label:"仅本月会员生日可参与",defaultVal:"0",options:Hualala.TypeDef.MCMDataSet.IsVIPBirthdayMonth,validCfg:{}},maxPartInPerson:{type:"text",label:"最大报名人数",defaultVal:"0",validCfg:{validators:{notEmpty:{message:"请输入最大报名人数"},numeric:{message:"最大报名人数必须为数字"},greaterThan:{inclusive:!0,value:0,message:"最大报名人数必须大于或等于0"}}}}}),d=new IX.IListManager;_.each(c,function(a,b){var c=$XP(a,"type"),e="col-sm-offset-1 col-sm-3 control-label";if("section"==c){var f=minID=b+"_min_"+IX.id(),g=b+"_max_"+IX.id(),h="eventStartDate",i="eventEndDate",j=IX.inherit($XP(a,"min",{}),{id:minID,name:h,clz:"col-xs-3 col-sm-3 col-md-3"}),k=IX.inherit($XP(a,"max",{}),{id:g,name:i,clz:"col-xs-3 col-sm-3 col-md-3"});d.register(b,IX.inherit(a,{id:f,labelClz:e,min:j,max:k}))}else if("inputCountCycleDays"==c){var l=$XP(a,"options"),m={id:"countCycleDays_"+IX.id(),name:"countCycleDays",options:l},n={id:"partInTimes_"+IX.id(),name:"partInTimes",validCfg:$XP(a,"partInTimes.validCfg",{})};d.register(b,IX.inherit(a,{labelClz:e,clz:"col-sm-8",countCycleDays:m,partInTimes:n}))}else if("radiogrp"==c||"checkboxgrp"==c){var o=_.map($XP(a,"options"),function(a){return IX.inherit(a,{id:b+"_"+IX.id(),name:b,clz:"radiogrp"==c?" radio-inline":" checkbox-inline"})});d.register(b,IX.inherit(a,{id:b+"_"+IX.id(),options:o,labelClz:e,clz:"col-sm-7"}))}else"selectShops"==c?d.register(b,IX.inherit(a,{id:b+"_"+IX.id(),name:b,labelClz:e,clz:"col-sm-7"})):d.register(b,IX.inherit(a,{id:b+"_"+IX.id(),name:b,labelClz:e,clz:"col-sm-5"}))}),b.EventSetFormElsHT=d;var e="eventID,eventName,cardLevelID,eventWay,eventRemark".split(","),f=function(){var a=this,b=a.formKeys,c=_.map(b,function(b){var c=d.get(b),e=$XP(c,"type");if("combo"==e&&"cardLevelID"==b){var f=a.model.get(b)||$XP(c,"dafaultVal"),g=_.map(a.model.CardLevelIDSet,function(a){return{value:$XP(a,"cardLevelID"),label:$XP(a,"cardLevelName"),isActive:$XP(a,"isActive")}});g=_.filter(g,function(a){return"1"==$XP(a,"isActive")});var h=$XP(c,"options",[]).concat(g);return h=_.map(h,function(a){return IX.inherit(a,{selected:$XP(a,"value")==f?"selected":""})}),IX.inherit(c,{value:f,options:h})}if("combo"==e){var f=a.model.get(b)||$XP(c,"dafaultVal"),h=_.map($XP(c,"options"),function(a){return IX.inherit(a,{selected:$XP(a,"value")==f?"selected":""})});return IX.inherit(c,{disabled:"edit"==a.mode&&"eventWay"==b?"disabled":"",value:f,options:h})}return IX.inherit(c,{value:a.model.get(b)||$XP(c,"dafaultVal")})});return c},g=b.GiftBaseInfoStepView.subclass({constructor:function(a){var b=this;if(this.mode=$XP(a,"mode",""),this.container=$XP(a,"container",""),this.parentView=$XP(a,"parentView"),this.model=$XP(a,"model"),this.successFn=$XF(a,"successFn"),this.failFn=$XF(a,"failFn"),this.mapFormElsData=$XF(a,"mapFormElsData"),!this.model||!this.parentView)throw"Event Base Info View init faild!";this.loadTemplates(),this.initBaseCfg(),this.formParams=this.model.getAll(),this.renderForm(function(){b.initUIComponents(),b.bindEvent()})}});g.proto({initBaseCfg:function(){this.formKeys=e},renderForm:function(a){var b=this,c=function(){var c=b.mapFormElsData.call(b),d=b.get("layoutTpl"),e=(b.get("btnTpl"),d({formClz:"wizard-step-form form-feedback-out",items:c}));b.container.html(e),a()};b.model.emit("loadCardLevelIDs",{successFn:function(){c()},failFn:function(){c()}})},initUIComponents:function(){},bindEvent:function(){var b=this,c=b.initValidFieldOpts();b.container.find("form").bootstrapValidator({trigger:"blur",fields:c}).on("error.field.bv",function(c){{var d=a(c.target);d.data("bootstrapValidator")}b.failFn(b.model)}).on("success.form.bv",function(c){c.preventDefault();var d=a(c.target),e=(d.data("bootstrapValidator"),b.mode+"Event",b.serializeForm());IX.Debug.info("DEBUG: Event Wizard Form Params:"),IX.Debug.info(e),b.model.emit("saveCache",{params:e,failFn:function(){b.failFn.call(b)},successFn:function(){b.successFn.call(b)}})})},initValidFieldOpts:function(){var a=this,b=_.reject(a.formKeys,function(a){return"eventID"==a}),c={};return _.each(b,function(a){{var b=d.get(a);$XP(b,"type")}c[a]=$XP(b,"validCfg",{})}),c},serializeForm:function(){{var b=this,c=b.formKeys,e={};_.map(c,function(c){{var f=d.get(c);$XP(f,"type")}e[c]=a("[name="+c+"]",b.container).val()})}return e},switchViewMode:function(a){this.mode=a,this.parentView.switchViewMode(a)}}),b.EventBaseInfoStepView=g;var h=function(a,c,d){var e=this,g=new b.EventBaseInfoStepView({mode:d,container:a,parentView:e,model:e.model,successFn:function(){var a=this;a.parentView.switchWizardCtrlStatus("reset"),a.parentView.getNextStep()},failFn:function(){var a=this;a.parentView.switchWizardCtrlStatus("reset")},mapFormElsData:f});e.registerStepView(c,g)};b.initEventBaseInfoStep=h;var i=function(c,d,e,f){var g=this,h=(g.getTabContentIDByIndex(d,e),g.getTabContentIDByIndex(d,f)),i=a("#"+h,g.$wizard),j=g.getStepView(h),k=["initEventBaseInfoStep","initEventRuleStep","initEventGiftSetStep","initEventOpenStep"];return-1==e&&0==f?!0:(j?1==f&&j.refresh():b[k[f]].call(g,i,h,g.mode),!0)};b.onEventWizardStepChange=i,b.onEventWizardStepCommit=function(a){var b=this,c=b.getStepView(a),d=c.container,e=d.find("form"),f=e.data("bootstrapValidator");b.switchWizardCtrlStatus("loading"),"event_on"==a?c.submit():f.validate()},b.bundleEventWizardEvent=function(){var b=this;b.$wizard.find(".wizard-ctrl .btn-cancel").on("click",function(){var c=(a(this),b.$wizard.bsWizard("currentIndex")),d=b.getTabContentIDByIndex(b.$wizard.find(".wizard-nav"),c),e=(b.stepViewHT.get(d),b.model.get("accountID"));e||0!=c?Hualala.UI.Confirm({title:"取消创建活动",msg:"是否取消创建活动的操作？<br/>之前的操作将不生效！",okLabel:"确定",okFn:function(){b.modal.hide()}}):b.modal.hide()})}}(jQuery,window),function(a){IX.ns("Hualala.MCM");var b=Hualala.MCM,c=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,b.EventSetFormElsHT),d="dateRange,chkDeductPoints,deductPoints,chkSendPoints,sendPoints,radioCountCycleDays,partInTimes,isVipBirthdayMonth,maxPartInPerson".split(","),e=function(){var a=this,b=a.formKeys,d=_.map(b,function(b){var d=c.get(b),e=$XP(d,"type");if("section"==e){var f=a.model.get("eventStartDate")||"",g=a.model.get("eventEndDate")||"";return IX.inherit(d,{min:IX.inherit($XP(d,"min"),{value:IX.Date.getDateByFormat(Hualala.Common.formatDateTimeValue(f),"yyyy/MM/dd")}),max:IX.inherit($XP(d,"max"),{value:IX.Date.getDateByFormat(Hualala.Common.formatDateTimeValue(g),"yyyy/MM/dd")})})}if("checkboxgrp"==e&&"chkDeductPoints"==b){var h=a.model.get("deductPoints")||0,i=_.map($XP(d,"options"),function(a){return IX.inherit(a,{checked:h>0?"checked":""})});return IX.inherit(d,{options:i})}if("checkboxgrp"==e&&"chkSendPoints"==b){var h=a.model.get("sendPoints")||0,i=_.map($XP(d,"options"),function(a){return IX.inherit(a,{checked:h>0?"checked":""})});return IX.inherit(d,{options:i})}if("radiogrp"==e&&"radioCountCycleDays"==b){var j=a.model.get("countCycleDays")||0,k=a.model.get("partInTimes")||0,h=0;h=0==j&&0==k?0:0!==j&&0!=k?2:1;var i=_.map($XP(d,"options"),function(a){return IX.inherit(a,{checked:h==$XP(a,"value")?"checked":""})});return IX.inherit(d,{options:i})}if("inputCountCycleDays"==e){var j=a.model.get("countCycleDays")||0,k=a.model.get("partInTimes")||0;return IX.inherit(d,{countCycleDays:IX.inherit($XP(d,"countCycleDays"),{options:_.map($XP(d,"countCycleDays.options"),function(a){return IX.inherit(a,{selected:$XP(a,"value")==j?"selected":""})})}),partInTimes:IX.inherit($XP(d,"partInTimes"),{value:k})})}if("combo"==e){var h=a.model.get(b)||$XP(d,"defaultVal"),i=_.map($XP(d,"options"),function(a){return IX.inherit(a,{selected:$XP(a,"value")==h?"selected":""})});return IX.inherit(d,{disabled:"edit"==a.mode&&"giftType"==b?"disabled":"",value:h,options:i})}if("radiogrp"==e||"checkboxgrp"==e){var h=a.model.get(b)||$XP(d,"defaultVal");"checkboxgrp"==e&&(h=h.split(","));var i=_.map($XP(d,"options"),function(a){var b="checkboxgrp"==e?_.contains(h,$XP(a,"value")+"")?!0:!1:$XP(a,"value")==h;return IX.inherit(a,{checked:b?"checked":""})});return IX.inherit(d,{options:i})}return IX.inherit(d,{value:a.model.get(b)||$XP(d,"defaultVal")})});return d},f=b.EventBaseInfoStepView.subclass({constructor:b.EventBaseInfoStepView.prototype.constructor});f.proto({initBaseCfg:function(){this.formKeys=d},initUIComponents:function(){var a=this,b=a.model.get("eventWay");if(a.initDatePicker(),a.setSwitcherLayout(a.container.find(":checkbox[name=chkDeductPoints]")),a.setSwitcherLayout(a.container.find(":checkbox[name=chkSendPoints]")),a.setRadioCountCycleDaysLayout(a.container.find(":radio[name=radioCountCycleDays]")),22!=b?a.container.find(":text[name=maxPartInPerson]").parents(".form-group").hide():a.container.find(":text[name=maxPartInPerson]").parents(".form-group").show(),40==b||41==b){a.container.find(":checkbox[name=chkDeductPoints],:text[name=deductPoints]").parents(".form-group").hide();var c=a.container.find(":checkbox[name=chkSendPoints]").clone(!0),d=a.container.find(":checkbox[name=chkSendPoints]").parent();d.empty().append(c).append("分享人获得积分")}else{a.container.find(":checkbox[name=chkDeductPoints],:text[name=deductPoints]").parents(".form-group").show();var c=a.container.find(":checkbox[name=chkSendPoints]").clone(!0),d=a.container.find(":checkbox[name=chkSendPoints]").parent();d.empty().append(c).append("参与活动赠送积分")}},initDatePicker:function(){var a=this;a.container.find("[data-type=datetimepicker]").datetimepicker({format:"yyyy/mm/dd",startDate:"2010/01/01",autoclose:!0,minView:"month",todayBtn:!0,todayHighlight:!0,language:"zh-CN"})},bindEvent:function(){var b=this,c=b.initValidFieldOpts();b.container.find("form").bootstrapValidator({trigger:"blur",fields:c}).on("error.field.bv",function(c){{var d=a(c.target);d.data("bootstrapValidator")}b.failFn(b.model)}).on("success.form.bv",function(c){c.preventDefault();var d=a(c.target),e=(d.data("bootstrapValidator"),b.mode+"Event"),f=b.serializeForm();IX.Debug.info("DEBUG: Event Wizard Form Params:"),IX.Debug.info(f),b.model.emit(e,{params:f,failFn:function(){b.failFn.call(b)},successFn:function(){b.successFn.call(b),b.switchViewMode("edit")}})}),b.container.find(":checkbox[name=chkDeductPoints]").on("change",function(){b.setSwitcherLayout(a(this))}),b.container.find(":checkbox[name=chkSendPoints]").on("change",function(){b.setSwitcherLayout(a(this))}),b.container.find(":radio[name=radioCountCycleDays]").on("change",function(){b.setRadioCountCycleDaysLayout(a(this))}),b.container.find("form [data-type=datetimepicker]").on("change",function(){var c=a(this),d=c.attr("name");b.container.find("form").bootstrapValidator("revalidateField",d)})},setSwitcherLayout:function(a){var b=a.is(":checked"),c=a.parents(".form-group").next(".form-group");c[b?"removeClass":"addClass"]("hidden"),c.find(":text").attr("disabled",b?!1:!0)},setRadioCountCycleDaysLayout:function(a){var b=this,c=b.getRadiboxVal(a.attr("name")),d=a.parents(".form-group").next(".form-group"),e=d.find(".cycle-label, select[name=countCycleDays]"),f=d.find(":text[name=partInTimes]");0==c?(d.hide(),f.attr("disabled",!0)):1==c?(d.show(),e.addClass("hidden"),f.attr("disabled",!1)):(d.show(),e.removeClass("hidden"),f.attr("disabled",!1))},getCheckboxVal:function(b){var c=a(":checkbox[name="+b+"]:checked"),d=[];return c.each(function(){var b=a(this);d.push(b.val())}),d.join(",")},getRadiboxVal:function(b){var c=a(":radio[name="+b+"]:checked");return c.val()},initValidFieldOpts:function(){var a=this,b=_.reject(a.formKeys,function(a){return"eventID"==a}),d={};return _.each(b,function(a){{var b=c.get(a);$XP(b,"type")}"dateRange"==a?(d.eventStartDate=$XP(b,"min.validCfg",{}),d.eventEndDate=$XP(b,"max.validCfg",{})):"partInTimes"==a?d.partInTimes=$XP(b,"partInTimes.validCfg",{}):d[a]=$XP(b,"validCfg",{})}),d},serializeForm:function(){{var b=this,d=b.formKeys,e={},f=function(){var c=IX.Date.getDateByFormat(a(":text[name=eventStartDate]",b.container).val(),"yyyyMMdd"),d=IX.Date.getDateByFormat(a(":text[name=eventEndDate]",b.container).val(),"yyyyMMdd");return{eventStartDate:c,eventEndDate:d}},g=function(){var c=b.model.get("eventWay");return 40==c||41==c?0:a(":checkbox[name=chkDeductPoints]",b.container).is(":checked")?a(":text[name=deductPoints]",b.container).val():0},h=function(){b.model.get("eventWay");return a(":checkbox[name=chkSendPoints]",b.container).is(":checked")?a(":text[name=sendPoints]",b.container).val():0},i=function(){var c=b.getRadiboxVal("radioCountCycleDays"),d=0,e=0;return d=2>c?0:a("[name=countCycleDays]",b.container).val(),e=0==c?0:a(":text[name=partInTimes]",b.container).val(),{countCycleDays:d,partInTimes:e}};_.map(d,function(d){var j=c.get(d),k=($XP(j,"type"),null);switch(d){case"dateRange":k=f(),e=IX.inherit(e,k);break;case"chkDeductPoints":case"chkSendPoints":case"radioCountCycleDays":break;case"deductPoints":k=g(),e.deductPoints=k;break;case"sendPoints":k=h(),e.sendPoints=k;break;case"partInTimes":k=i(),e=IX.inherit(e,k);break;case"isVipBirthdayMonth":k=b.getRadiboxVal(d),e[d]=k;break;case"maxPartInPerson":k=22==b.model.get("eventWay")?a(":text[name=maxPartInPerson]",b.container).val():0,e[d]=k}return d})}return e},refresh:function(){var a=this;this.formParams=this.model.getAll(),a.initUIComponents()}}),b.EventRuleStepView=f,b.initEventRuleStep=function(a,c,d){var f=this,g=new b.EventRuleStepView({mode:d,container:a,parentView:f,model:f.model,successFn:function(){var a=this;a.parentView.switchWizardCtrlStatus("reset"),a.parentView.getNextStep()},failFn:function(){var a=this;a.parentView.switchWizardCtrlStatus("reset")},mapFormElsData:e});f.registerStepView(c,g)}}(jQuery,window),function(a){IX.ns("Hualala.MCM");for(var b=Hualala.MCM,c=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.Common.getMinuteIntervalOptions({startLabel:"立即生效",end:Hualala.Constants.SecondsOfDay/60})),d=new IX.IListManager,e="EGiftID,EGiftName,EGiftTotalCount,EGiftValidUntilDayCount,EGiftOdds,EGiftEffectTimeHours".split(","),f=3,g=["","一等奖","二等奖","三等奖"],h={EGiftID:{type:"hidden",defaultVal:""},EGiftName:{type:"pickgift",defaultVal:"",label:"奖品名称",validCfg:{validators:{notEmpty:{message:"请选择奖品"}}}},EGiftTotalCount:{type:"text",label:"奖品总数",defaultVal:"0",surfix:"个",validCfg:{validators:{notEmpty:{message:"请输入奖品总数"},numeric:{message:"奖品总数必须为数字"},greaterThan:{inclusive:!0,value:0,message:"奖品总数必须大于或等于0"}}}},EGiftValidUntilDayCount:{type:"text",label:"有效天数",defaultVal:"30",surfix:"天",validCfg:{validators:{notEmpty:{message:"请输入有效天数"},numeric:{message:"有效天数必须为数字"},greaterThan:{inclusive:!0,value:0,message:"有效天数必须大于或等于0"}}}},EGiftOdds:{type:"text",label:"中奖概率百分比",defaultVal:"0",surfix:"%",help:"输入值在0.0001~100之间。如：0.01%表示万分之一的几率。",validCfg:{validators:{notEmpty:{message:"请输入中奖概率"},between:{min:1e-4,max:100,message:"中奖概率百分比值在0.0001~100之间"}}}},EGiftEffectTimeHours:{type:"combo",label:"生效时间",defaultVal:"0",options:_.reduce(c,function(a,b,c){return 1==c&&(a=[a]),b.value>=180?a.concat(b):a}),validCfg:{validators:{}}}},i=1;f>=i;i++){var j="col-sm-offset-1 col-sm-3 control-label";_.each(h,function(a,b){{var c=b+"_"+i;$XP(a,"type")}d.register(c,IX.inherit(a,{id:c+"_"+IX.id(),name:c,labelClz:j,clz:"col-sm-6"}))})}var k=function(){for(var a=this,b=a.formKeys,c=a.model.get("eventWay"),e=[],h=1;f>=h;h++){var i=g[h],j="mcm-evtgift-panel ",k=a.model.get("EGiftID_"+h);(0!=k&&!IX.isEmpty(k)||1==h)&&(j+=" isActive "),(21==c||30==c)&&(j+=" singlegift ");var l={clz:"btn-warning btn-add",name:"addGift",label:"添加中奖等级"},m={clz:"btn-default btn-del",name:"deleteGift",label:"删除"+i},n={giftLevelName:i,clz:j,btns:1==h?[l]:h==f?[m]:[m,l]},o=_.map(b,function(b){var c=b+"_"+h,e=d.get(c),f=$XP(e,"type"),g=null;if("combo"==f){var g=a.model.get(c)||$XP(e,"defaultVal"),i=_.map($XP(e,"options"),function(a){return IX.inherit(a,{selected:$XP(a,"value")==g?"selected":""})});return IX.inherit(e,{value:g,options:i})}return IX.inherit(e,{value:a.model.get(c)||$XP(e,"defaultVal")})});e.push(IX.inherit(n,{isDivForm:!0,formClz:"mcm-evtgift-form",items:o}))}return e},l=Stapes.subclass({constructor:function(a){if(this.mode=$XP(a,"mode",""),this.container=$XP(a,"container",""),this.parentView=$XP(a,"parentView"),this.model=$XP(a,"model"),this.successFn=$XF(a,"successFn"),this.failFn=$XF(a,"failFn"),this.mapFormElsData=$XF(a,"mapFormElsData"),!this.model||!this.parentView)throw"Event Gift Set View init faild!";this.loadTemplates(),this.initBaseCfg(),this.renderForm(),this.initUIComponents(),this.bindEvent()
}});l.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_mcm_event_giftset")),b=Handlebars.compile(Hualala.TplLib.get("tpl_mcm_base_form")),c=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns"));Handlebars.registerPartial("baseform",Hualala.TplLib.get("tpl_mcm_base_form")),Handlebars.registerPartial("ctrlbtns",Hualala.TplLib.get("tpl_shop_modal_btns")),Handlebars.registerHelper("checkFormElementType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),Handlebars.registerHelper("isInputGroup",function(a,b,c){return a||b?c.fn(this):c.inverse(this)}),this.set({layoutTpl:a,formTpl:b,btnTpl:c})},initBaseCfg:function(){this.formKeys=e},initUIComponents:function(){var a=this;a.container.find(".isActive:last").addClass("isCurrent")},bindEvent:function(){var c=this,d=c.initValidFieldOpts();c.container.on("click",".panel-footer .btn",function(){var b=a(this),d=b.attr("name");c.container.find(".mcm-evtgift-panel").removeClass("isCurrent"),"addGift"==d?b.parents(".mcm-evtgift-panel").next(".mcm-evtgift-panel").addClass("isActive isCurrent"):(b.parents(".mcm-evtgift-panel").removeClass("isActive"),b.parents(".mcm-evtgift-panel").prev(".mcm-evtgift-panel").addClass("isActive isCurrent"),c.resetGiftSet(b.parents(".mcm-evtgift-panel")))}),c.container.find("form").bootstrapValidator({trigger:"blur",fields:d}).on("error.field.bv",function(b){{var d=a(b.target);d.data("bootstrapValidator")}c.failFn(c.model)}).on("success.form.bv",function(b){b.preventDefault();var d=a(b.target),e=(d.data("bootstrapValidator"),c.mode+"Event",c.serializeForm());IX.Debug.info("DEBUG: Event Wizard Form Params:"),IX.Debug.info(e),c.model.emit("editEvent",{params:e,failFn:function(){c.failFn.call(c)},successFn:function(){c.successFn.call(c)}})}),c.container.on("click",".btn[name=pickgift]",function(){{var c=a(this);new b.PickGiftModal({trigger:c,selectedFn:function(b,c){var d=$XP(b,"giftItemID",""),e=$XP(b,"giftName",""),f=c.parents(".mcm-evtgift-panel"),g=parseInt(f.attr("data-index"))+1;a("[name=EGiftID_"+g+"]",f).val(d),a("[name=EGiftName_"+g+"]",f).val(e)}})}})},resetGiftSet:function(b){var c=this,d=parseInt(b.attr("data-index"))+1,e=c.formKeys;_.each(e,function(c){var e=c+"_"+d,f=a("[name="+e+"]",b);switch(c){case"EGiftID":case"EGiftName":f.val("");break;case"EGiftEffectTimeHours":case"EGiftTotalCount":case"EGiftOdds":f.val(0);break;case"EGiftValidUntilDayCount":f.val(30)}})},renderForm:function(){var a=this,b=a.mapFormElsData.call(a),c=a.get("layoutTpl"),d=c({gifts:b});a.container.html(d)},initValidFieldOpts:function(){for(var a=this,b=_.reject(a.formKeys,function(a){return"EGiftID"==a}),c={},e=1;f>=e;e++)_.each(b,function(a){{var b=a+"_"+e,f=d.get(b);$XP(f,"type")}c[b]=$XP(f,"validCfg",{})});return c},serializeForm:function(){for(var b=this,c=b.formKeys,d={},e=1;f>=e;e++)_.each(c,function(c){var f=c+"_"+e;d[f]=a("[name="+f+"]",b.container).val()});return d}}),b.EventGiftSetStepView=l,b.initEventGiftSetStep=function(a,c,d){var e=this,f=new b.EventGiftSetStepView({mode:d,container:a,parentView:e,model:e.model,successFn:function(){var a=this;a.parentView.switchWizardCtrlStatus("reset"),a.parentView.getNextStep()},failFn:function(){var a=this;a.parentView.switchWizardCtrlStatus("reset")},mapFormElsData:k});e.registerStepView(c,f)}}(jQuery,window),function(a){IX.ns("Hualala.MCM");var b=Hualala.MCM,c=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,[{key:"giftType",clz:"",label:"礼品类型"},{key:"giftName",clz:"text",label:"礼品名称"}]),d=function(a,b,c){{var d=this,e=Hualala.PageRoute.getPageContextByPath(),f=($XP(e,"name"),d.model.queryKeys,{value:"",text:""}),g=$XP(a,c,"");Hualala.Common.formatDateTimeValue}switch(c){case"giftType":var h=(d.get("giftCardTpl"),$XP(a,"giftValue",0),Hualala.TypeDef.MCMDataSet.GiftTypes),i=_.find(h,function(a){return $XP(a,"value")==g});f.value=g,f.text=$XP(i,"label","");break;default:f.value=f.text=$XP(a,c,"")}return f},e=function(a){var b=this,e=Hualala.PageRoute.getPageContextByPath(),f=($XP(e,"name"),"col-md-12"),g="  table-hover mcm-grid",h=c,i=function(a,c){var e=_.map(h,function(a){return{key:$XP(a,"key",""),clz:$XP(a,"clz","")}}),f={clz:"",type:"text"},g=_.map(e,function(e){var g=d.apply(b,[a,c,$XP(e,"key","")]);return IX.inherit(f,g,{clz:$XP(e,"clz","")})});return g},j=_.map(a,function(a,b){var c={clz:"",cols:i(a,b)};return c}),k=[{clz:"hidden",cols:[]}];return{clz:f,tblClz:g,isEmpty:a&&0!=a.length?!1:!0,colCount:h.length,thead:h,rows:j,tfoot:k}},f=function(a){{var b=this,c=Hualala.PageRoute.getPageContextByPath();$XP(c,"name")}b.$result.empty(),b.$result.html(b.get("resultTpl")(a))},g=function(){var a=this,b=a.model.getQueryParams();a.initGiftTypeComboOpts($XP(b,"giftType",""))},h=function(){var b=this;b.$result.on("dblclick",".mcm-grid > tbody > tr",function(){{var b=a(this);b.find("p[data-value]")}b.addClass("selected")})},i=Stapes.subclass({constructor:function(a){this.trigger=$XP(a,"trigger"),this.selectedFn=$XF(a,"selectedFn"),this.modal=null,this.$body=null,this.panel=null,this.initModal(),this.initPanel(),this.bindEvent()}});i.proto({initModal:function(){var a=this;a.modal=new Hualala.UI.ModalDialog({id:"mcm_pickgift_modal",clz:"mcm-pickgift-modal",title:"选择礼品、奖品",hideCloseBtn:!1,backdrop:"static",showFooter:!1,afterHide:function(){}}),a.$body=a.modal._.body,a.modal.show()},initPanel:function(){var a=this;this.panel=new b.QueryController({container:a.$body,resultController:new b.QueryResultControler({container:a.$body,model:new b.GiftMgrResultModel({callServer:Hualala.Global.getMCMGifts,queryKeys:Hualala.MCM.QueryFormKeys.GiftMgrQueryKeys,gridType:"giftlist",recordModel:b.BaseGiftModel}),view:new b.QueryResultView({mapResultRenderData:e,renderResult:f,bundleEvent:h})}),model:new b.QueryModel({queryKeys:Hualala.MCM.QueryFormKeys.GiftMgrQueryKeys}),view:new b.QueryView({hasAddBtn:!1,mapRenderDataFn:b.mapGiftQueryFormRenderData,bundleQueryEvent:b.bundleGiftsQueryEvent,initQueryFormEls:g})})},bindEvent:function(){var b=this;b.$body.on("dblclick",".mcm-grid > tbody > tr",function(){var c=a(this),d=c.find("p[data-value]");b.selectedFn({giftItemID:d.eq(0).attr("data-value"),giftName:d.eq(1).attr("data-value")},b.trigger),b.modal.hide()})}}),b.PickGiftModal=i}(jQuery,window),function(){IX.ns("Hualala.MCM");var a=Hualala.MCM,b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,function(){var b=this,c=b.model,d=a.mapEventDetailRenderData,e=d.call(b,c);return e}),c=Stapes.subclass({constructor:function(a){if(this.mode=$XP(a,"mode",""),this.container=$XP(a,"container",""),this.parentView=$XP(a,"parentView"),this.model=$XP(a,"model"),this.successFn=$XF(a,"successFn"),this.failFn=$XF(a,"failFn"),this.mapFormElsData=$XF(a,"mapFormElsData"),!this.model||!this.parentView)throw"Event Base Info View init faild!";this.loadTemplates(),this.renderForm(),this.initUIComponents(),this.bindEvent()}});c.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_event_openstep")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns"));Handlebars.registerPartial("evtdetail",Hualala.TplLib.get("tpl_event_detail")),Handlebars.registerPartial("card",Hualala.TplLib.get("tpl_event_card")),this.set({layoutTpl:a,btnTpl:b})},renderForm:function(){var a=this,b=a.mapFormElsData.call(a),c=a.get("layoutTpl"),d=c(b);a.container.html(d)},initUIComponents:function(){},bindEvent:function(){},submit:function(){var a=this,b=a.model.get("eventID");a.model.emit("switchEvent",{params:{eventID:b,isActive:1},failFn:function(){a.failFn.call(a)},successFn:function(){a.successFn.call(a),a.parentView.modal.hide()}})}}),a.EventOpenStepView=c,a.initEventOpenStep=function(c,d,e){var f=this,g=new a.EventOpenStepView({mode:e,container:c,parentView:f,model:f.model,successFn:function(){var a=this;a.parentView.switchWizardCtrlStatus("reset"),a.parentView.getNextStep()},failFn:function(){var a=this;a.parentView.switchWizardCtrlStatus("reset")},mapFormElsData:b});f.registerStepView(d,g)}}(jQuery,window),function(){IX.ns("Hualala.MCM");var a=Hualala.MCM,b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Stapes.subclass({constructor:function(a){this.set(a),this.bindEvent()}}));b.proto({bindEvent:function(){var a=this;a.on({},a)}}),a.BaseGiftSendModel=b;var c=function(a){var b=Hualala.TypeDef.MCMDataSet.GiftDistributeTypes;return _.find(b,function(b){return $XP(b,"value")==a})};a.getGiftGetWayTypeSet=c;var d=function(a){var b=Hualala.TypeDef.MCMDataSet.GiftStatus;return _.find(b,function(b){return $XP(b,"value")==a})};a.getGiftStatusTypeSet=d;var e=[{key:"getWay",clz:"text",label:"发出方式"},{key:"createTime",clz:"date",label:"发出时间"},{key:"validUntilDate",clz:"date",label:"有效日期"},{key:"giftStatus",clz:"text",label:"状态"},{key:"userName",clz:"text",label:"姓名"},{key:"userSex",clz:"text",label:"性别"},{key:"userMobile",clz:"text",label:"手机号"}],f=function(a,b,e){var f={value:"",text:""},g=$XP(a,e,""),h=$XP(a,"userInfo",{}),i=Hualala.Common.formatDateTimeValue;switch(e){case"getWay":g=c(g),f.value=$XP(g,"value",""),f.text=$XP(g,"label","");break;case"createTime":f.value=g,f.text=IX.Date.getDateByFormat(i(g),"yyyy/MM/dd HH:mm");break;case"validUntilDate":f.value=g,f.text=IX.Date.getDateByFormat(i(g),"yyyy/MM/dd");break;case"giftStatus":g=d(g),f.value=$XP(g,"value",""),f.text=$XP(g,"label","");break;case"userName":f.value=f.text=$XP(h,"userName","");break;case"userSex":g=_.find(Hualala.TypeDef.GENDER,function(a){return $XP(a,"value")==$XP(h,"userSex","")}),f.value=$XP(g,"value",""),f.text=$XP(g,"label","");break;case"userMobile":f.value=f.text=$XP(h,"userMobile","")}return f};a.mapGiftDetailQuerySendRenderData=function(a){var b=this,c="col-md-12",d=" table-hover mcm-grid",g=e,h=function(a,c){var d=_.map(g,function(a){return{key:$XP(a,"key",""),clz:$XP(a,"clz","")}}),e={clz:"",type:"text"},h=_.map(d,function(d){var g=f.apply(b,[a,c,$XP(d,"key","")]);return IX.inherit(e,g,{clz:$XP(d,"clz","")})});return h},i=_.map(a,function(a,b){var c={clz:"",cols:h(a,b)};return c}),j=[{clz:"hidden",cols:[]}];return{clz:c,tblClz:d,isEmpty:a&&0!=a.length?!1:!0,colCount:g.length,thead:g,rows:i,tfoot:j}}}(jQuery,window),function(){IX.ns("Hualala.MCM");var a=Hualala.MCM,b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Stapes.subclass({constructor:function(a){this.set(a),this.bindEvent()}}));b.proto({bindEvent:function(){var a=this;a.on({},a)}}),a.BaseGiftUsedModel=b;var c=[{key:"getWay",clz:"text",label:"获得方式"},{key:"createTime",clz:"date",label:"获得时间"},{key:"validUntilDate",clz:"date",label:"使用时间"},{key:"giftStatus",clz:"text",label:"使用店铺"},{key:"userName",clz:"text",label:"姓名"},{key:"userSex",clz:"text",label:"性别"},{key:"userMobile",clz:"text",label:"手机号"}],d=function(b,c,d){var e={value:"",text:""},f=$XP(b,d,""),g=$XP(b,"userInfo",{}),h=Hualala.Common.formatDateTimeValue;switch(d){case"getWay":f=a.getGiftGetWayTypeSet(f),e.value=$XP(f,"value",""),e.text=$XP(f,"label","");break;case"createTime":e.value=f,e.text=IX.Date.getDateByFormat(h(f),"yyyy/MM/dd HH:mm");break;case"validUntilDate":e.value=f,e.text=IX.Date.getDateByFormat(h(f),"yyyy/MM/dd");break;case"giftStatus":f=a.getGiftStatusTypeSet(f),e.value=$XP(f,"value",""),e.text=$XP(f,"label","");break;case"userName":e.value=e.text=$XP(g,"userName","");break;case"userSex":f=_.find(Hualala.TypeDef.GENDER,function(a){return $XP(a,"value")==$XP(g,"userSex","")}),e.value=$XP(f,"value",""),e.text=$XP(f,"label","");break;case"userMobile":e.value=e.text=$XP(g,"userMobile","")}return e};a.mapGiftDetailQueryUsedRenderData=function(a){var b=this,e="col-md-12",f=" table-hover mcm-grid",g=c,h=function(a,c){var e=_.map(g,function(a){return{key:$XP(a,"key",""),clz:$XP(a,"clz","")}}),f={clz:"",type:"text"},h=_.map(e,function(e){var g=d.apply(b,[a,c,$XP(e,"key","")]);return IX.inherit(f,g,{clz:$XP(e,"clz","")})});return h},i=_.map(a,function(a,b){var c={clz:"",cols:h(a,b)};return c}),j=[{clz:"hidden",cols:[]}];return{clz:e,tblClz:f,isEmpty:a&&0!=a.length?!1:!0,colCount:g.length,thead:g,rows:i,tfoot:j}}}(jQuery,window),function(a){IX.ns("Hualala.MCM");var b=Hualala.MCM,c=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip);b.GiftDetailDonateGiftCtrlFormKeys="giftItemID,regMobile,giftCount,chkSendSms,smsContent".split(","),b.GiftDetailPayGiftCtrlFormKeys="giftItemID,regMobile,giftCount,validUntilDate,recirculable,getRemark,chkSendSms,smsContent".split(","),b.GiftDetailPayGiftOnlineCtrlFormKeys="giftItemID,voucherName,voucherValue,voucherTotalCount,voucherPrice,settleUnitID,settleUnitName,transTime,sponsorMobile,sponsorType".split(",");var d={giftItemID:{type:"hidden",defaultVal:""},regMobile:{type:"text",label:"用户手机号码",defaultVal:"",validCfg:{validators:{notEmpty:{message:"请输入用户手机号"},mobile:{message:"请输入正确的手机号"}}}},giftCount:{type:"text",label:"赠送张数",defaultVal:"1",validCfg:{validators:{notEmpty:{message:"请输入赠送张数"},integer:{message:"请输入正确的赠送张数"},between:{inclusive:!0,min:1,max:1e5,message:"请输入大于1到100000之间的整数"}}}},chkSendSms:{type:"switcher",label:"发送短信",defaultVal:1,onLabel:"发送",offLabel:"不发送",validCfg:{validators:{}}},smsContent:{type:"textarea",label:"短信内容",defaultVal:"",validCfg:{validators:{notEmpty:{message:"请输入短信内容"}}}},validUntilDate:{type:"text",label:"券到期日",defaultVal:"",validCfg:{validators:{notEmpty:{message:"请选择券到期日"},date:{format:"YYYY/MM/DD",message:"请选择正确的日期"}}}},recirculable:{type:"switcher",label:"转售",defaultVal:1,onLabel:"可以",offLabel:"不可以",validCfg:{validators:{}}},getRemark:{type:"textarea",label:"备注",defaultVal:"",validCfg:{validators:{notEmpty:{message:"请输入备注信息"}}}},voucherName:{type:"hidden",defaultVal:""},voucherValue:{type:"hidden",defaultVal:""},voucherTotalCount:{type:"text",label:"数量",defaultVal:"1",validCfg:{validators:{notEmpty:{message:"请输入出售数量"},integer:{message:"请输入正确的出售数量"},between:{inclusive:!0,min:1,max:1e5,message:"请输入大于1到100000之间的整数"}}}},voucherPrice:{type:"text",label:"单价",defaultVal:"",validCfg:{validators:{notEmpty:{message:"请输入券单价"},numeric:{message:"请输数字"},callback:{message:"请输入正确格式的单价",callback:function(a){var b=a.toString().movePoint(2).split("."),c=b[1];return c?!1:!0}}}}},settleUnitID:{type:"hidden",defaultVal:""},settleUnitName:{type:"pickaccount",label:"结算主体",disabled:"disabled",validCfg:{validators:{notEmpty:{message:"选择结算主体"}}}},transTime:{type:"section",label:"出售日期",min:{type:"datetimepicker",defaultVal:"",readonly:"readonly",validCfg:{group:".min-input",validators:{}}},max:{type:"datetimepicker",defaultVal:"",readonly:"readonly",validCfg:{group:".max-input",validators:{}}}},sponsorMobile:{type:"text",label:"联系电话",defaultVal:"",validCfg:{validators:{notEmpty:{message:"请输入联系电话"}}}}},e=new IX.IListManager;_.each(d,function(a,b){var c=$XP(a,"type"),d="col-sm-offset-1 col-sm-3 control-label";if("section"==c){var f=minID=b+"_min_"+IX.id(),g=b+"_max_"+IX.id(),h="transStartTime",i="transEndTime",j=IX.inherit($XP(a,"min",{}),{id:minID,name:h,clz:"col-xs-3 col-sm-3 col-md-3"}),k=IX.inherit($XP(a,"max",{}),{id:g,name:i,clz:"col-xs-3 col-sm-3 col-md-3"});e.register(b,IX.inherit(a,{id:f,labelClz:d,min:j,max:k}))}else e.register(b,IX.inherit(a,{id:b+"_"+IX.id(),name:b,labelClz:d,clz:"col-sm-5"}))}),b.mapDonateGiftFormRenderData=function(){var a=this,b=a.formKeys,c=a.parentView,d=_.map(b,function(a){{var b=e.get(a);$XP(b,"type")}return IX.inherit(b,{id:$XP(b,"id","")+"_"+IX.id().replaceAll("ix",""),value:"giftItemID"==a?$XP(c,"giftItemID",""):$XP(b,"defaultVal","")})});return d},b.mapPayGiftFormRenderData=function(){var a=this,b=a.formKeys,c=a.parentView,d=_.map(b,function(a){{var b=e.get(a);$XP(b,"type")}return IX.inherit(b,{id:$XP(b,"id","")+"_"+IX.id().replaceAll("ix",""),value:"giftItemID"==a?$XP(c,"giftItemID",""):$XP(b,"defaultVal",""),label:"giftCount"==a?"支付张数":$XP(b,"label","")})});return d},b.mapPayGiftOnlineFormRenderData=function(){var a=this,b=a.formKeys,c=a.parentView,d=_.map(b,function(a){{var b=e.get(a);$XP(b,"type")}return IX.inherit(b,{id:$XP(b,"id","")+"_"+IX.id().replaceAll("ix",""),value:"giftItemID"==a?$XP(c,"giftItemID",""):$XP(b,"defaultVal","")})});return d},b.initDonateGiftFormUIComponent=function(){var b=this,c=b.get("btnTpl");b.$form.find("textarea[name=smsContent]").parents(".form-group").hide(),b.$form.find(":checkbox[name=chkSendSms]").each(function(){var b=a(this),c=b.attr("data-onLabel"),d=b.attr("data-offLabel");b.bootstrapSwitch({size:"normal",onColor:"primary",offColor:"default",onText:c,offText:d})}),b.$panelFooter.html(c({btns:[{clz:"btn-warning pull-right",name:"submit",label:"确认赠送"}]}))},b.initPayGiftFormUIComponent=function(){var b=this,c=b.get("btnTpl");b.$form.find("textarea[name=smsContent]").parents(".form-group").hide(),b.$form.find(":checkbox[name=chkSendSms], :checkbox[name=recirculable]").each(function(){var b=a(this),c=b.attr("data-onLabel"),d=b.attr("data-offLabel");b.bootstrapSwitch({size:"normal",onColor:"primary",offColor:"default",onText:c,offText:d})}),b.$form.find(":text[name=validUntilDate]").datetimepicker({format:"yyyy/mm/dd",startDate:"2010/01/01",autoclose:!0,minView:"month",todayBtn:!0,todayHighlight:!0,language:"zh-CN"}),b.$panelFooter.html(c({btns:[{clz:"btn-warning pull-right",name:"submit",label:"确认支付"}]}))},b.initPayGiftOnlineFormUIComponent=function(){var a=this,b=a.get("btnTpl");a.$form.find("[data-type=datetimepicker]").datetimepicker({format:"yyyy/mm/dd",startDate:"2010/01/01",autoclose:!0,minView:"month",todayBtn:!0,todayHighlight:!0,language:"zh-CN"}),a.$panelFooter.html(b({btns:[{clz:"btn-warning pull-right",name:"submit",label:"申请出售"}]})),h.call(a)},b.bundleDonateGiftFormEvent=function(){var b=this,d=b.parentView,e=(d.mGiftDetail,b.$form.find("textarea[name=smsContent]")),g=i.call(b);b.$form.find(":checkbox[name=chkSendSms]").on("switchChange.bootstrapSwitch",function(c,d){a(this);1==d?(e.val(f.call(b)),e.parents(".form-group").show()):b.$form.find("textarea[name=smsContent]").parents(".form-group").hide()}),b.$form.on("keyup",":text[name=giftCount]",function(){var c=(a(this),f.call(b));b.$form.find("textarea[name=smsContent]").val(c)}),b.$form.bootstrapValidator({trigger:"blur",fields:g}).on("error.field.bv",function(b){{var c=a(b.target);c.data("bootstrapValidator")}}).on("success.form.bv",function(d){d.preventDefault();var e=a(d.target),f=(e.data("bootstrapValidator"),l.call(b));IX.Debug.info("DEBUG: Donate Gift Form Params:"),IX.Debug.info(f),Hualala.Global.giftDetailDonateGift(f,function(a){$XP(a,"resultcode","000")?(c({msg:"提交成功",type:"success"}),b.initFormPanel()):c({msg:$XP(a,"resultmsg",""),type:"danger"})})}),b.$panelFooter.find(".btn[name=submit]").on("click",function(){var a=b.$form.data("bootstrapValidator");a.validate()})},b.bundlePayGiftFormEvent=function(){var b=this,d=b.parentView,e=(d.mGiftDetail,b.$form.find("textarea[name=smsContent]")),g=j.call(b);b.$form.find(":checkbox[name=chkSendSms]").on("switchChange.bootstrapSwitch",function(c,d){a(this);1==d?(e.val(f.call(b)),e.parents(".form-group").show()):b.$form.find("textarea[name=smsContent]").parents(".form-group").hide()}),b.$form.on("keyup",":text[name=giftCount]",function(){var c=(a(this),f.call(b));b.$form.find("textarea[name=smsContent]").val(c)}),b.$form.bootstrapValidator({trigger:"blur",fields:g}).on("error.field.bv",function(b){{var c=a(b.target);c.data("bootstrapValidator")}}).on("success.form.bv",function(d){d.preventDefault();var e=a(d.target),f=(e.data("bootstrapValidator"),m.call(b));IX.Debug.info("DEBUG: Pay Gift Form Params:"),IX.Debug.info(f),Hualala.Global.giftDetailDonateGift(f,function(a){$XP(a,"resultcode","000")?(c({msg:"提交成功",type:"success"}),b.initFormPanel()):c({msg:$XP(a,"resultmsg",""),type:"danger"})})}),b.$panelFooter.find(".btn[name=submit]").on("click",function(){var a=b.$form.data("bootstrapValidator");a.validate()}),b.$form.find(":text[name=validUntilDate]").on("change",function(){b.$form.bootstrapValidator("revalidateField","validUntilDate")})},b.bundlePayGiftOnlineFormEvent=function(){var b=this,d=b.parentView,e=(d.mGiftDetail,k.call(b));b.$form.bootstrapValidator({trigger:"blur",fields:e}).on("error.field.bv",function(b){{var c=a(b.target);c.data("bootstrapValidator")}}).on("success.form.bv",function(d){d.preventDefault();var e=a(d.target),f=(e.data("bootstrapValidator"),n.call(b));IX.Debug.info("DEBUG: Pay Gift Online Form Params:"),IX.Debug.info(f),Hualala.Global.giftDetailPayGiftOnline(f,function(a){$XP(a,"resultcode","000")?(c({msg:"提交成功",type:"success"}),b.initFormPanel()):c({msg:$XP(a,"resultmsg",""),type:"danger"})})}),b.$panelFooter.find(".btn[name=submit]").on("click",function(){var a=b.$form.data("bootstrapValidator");a.validate()})};var f=function(){var a=this,b=a.parentView,c=b.mGiftDetail,d=c.get("records")[0],e=Hualala.getSessionSite(),f=$XP(e,"groupName",""),g=a.$form.find(':text[name="giftCount"]').val(),h=Handlebars.compile(Hualala.TplLib.get("tpl_gift_sms")),i=h({groupName:f,giftCount:g,giftName:$XP(d,"giftName",""),site:Hualala.Global.HualalaWebSite});return i},g=function(a){var b=this,c=Handlebars.compile(Hualala.TplLib.get("tpl_account_opt")),d=_.map(a,function(a){return IX.inherit(a,{name:a.settleUnitName,value:a.settleUnitID})});d.unshift({name:"",value:""}),b.$form.find("select[name=settleUnitName]").html(c({items:d}))},h=function(){var b=this,c=new Pymatch([]),d=[];Hualala.Global.queryAccount({},function(e){if("000"==$XP(e,"resultcode")){d=$XP(e,"data.records",[]),g.call(b,d);var f=function(a){c.setNames(_.map(d,function(a){return IX.inherit(a,{name:a.settleUnitName,value:a.settleUnitID})}));var b=c.match(a),e={};return _.each(b,function(a){e[a[0].settleUnitID]=!0}),e};b.$form.find("select[name=settleUnitName]").chosen({width:"200px",placeholder_text:"请选择结算主体",no_results_text:"抱歉，没有找到！",allow_single_deselect:!1,getMatchedFn:f}).change(function(){var c=a(this);b.$form.find(":hidden[name=settleUnitID]").val(c.val())})}})},i=function(){var a=this,b=_.reject(a.formKeys,function(a){return"giftItemID"==a}),c={};return _.each(b,function(a){{var b=e.get(a);$XP(b,"type")}c[a]=$XP(b,"validCfg",{})}),c},j=function(){var a=this,b=_.reject(a.formKeys,function(a){return"giftItemID"==a}),c={};return _.each(b,function(a){{var b=e.get(a);$XP(b,"type")}c[a]=$XP(b,"validCfg",{})}),c},k=function(){var a=this,b=_.reject(a.formKeys,function(a){return"giftItemID"==a||"voucherName"==a||"voucherValue"==a||"settleUnitID"==a}),c={};return _.each(b,function(a){var b=e.get(a),d=$XP(b,"type");if("section"==d){var f="transStartTime",g="transStartTime";c[f]=$XP(b,"min.validCfg",{}),c[g]=$XP(b,"max.validCfg",{})}else c[a]=$XP(b,"validCfg",{})}),c},l=function(){{var b=this,c=b.formKeys,d={};_.map(c,function(c){{var f=e.get(c);$XP(f,"type")}d[c]=a("[name="+c+"]",b.$form).val()})}return d},m=function(){{var b=this,c=b.formKeys,d={};_.map(c,function(c){{var f=e.get(c);$XP(f,"type")}d[c]=a("[name="+c+"]",b.$form).val()})}return d},n=function(){{var b=this,c=b.formKeys,d={};_.map(c,function(c){{var f=e.get(c);$XP(f,"type")}d[c]=a("[name="+c+"]",b.$form).val()})}return d},o=Stapes.subclass({constructor:function(a){this.container=$XP(a,"container"),this.parentView=$XP(a,"parentView"),this.formKeys=$XP(a,"formKeys"),this.callServer=$XF(a,"callServer"),this.panelTitle=$XP(a,"panelTitle",""),this.$panelBody=null,this.$panelFooter=null,this.$form=null,this.mapFormElsData=$XF(a,"mapFormElsData"),this.initUIComponents=$XF(a,"initUIComponents"),this.bundleFormEvent=$XF(a,"bundleFormEvent"),this.loadTemplates(),this.initLayout(),this.initFormPanel()}});o.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_giftdetail_formpanel")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns")),c=(Handlebars.compile(Hualala.TplLib.get("tpl_base_datagrid")),Handlebars.compile(Hualala.TplLib.get("tpl_mcm_base_form")));Handlebars.registerHelper("checkFormElementType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),Handlebars.registerHelper("isInputGroup",function(a,b,c){return a||b?c.fn(this):c.inverse(this)}),this.set({layoutTpl:a,btnTpl:b,formTpl:c})},initLayout:function(){var a=this,b=a.get("layoutTpl"),c=b({panelTitle:a.panelTitle});a.container.html(c),a.$panelBody=a.container.find(".panel-body"),a.$panelFooter=a.container.find(".panel-footer")},initFormPanel:function(){var a=this,b=a.get("formTpl"),c=a.mapFormElsData.call(a),d=b({formClz:"form-feedback-out",items:c});a.$panelBody.html(d),a.$form=a.$panelBody.find("form"),a.initUIComponents.call(a),a.bundleFormEvent.call(a)}}),b.MCMGiftDetailFormPanel=o}(jQuery,window),function(a){IX.ns("Hualala.MCM");var b=Hualala.MCM,c=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,b.getGiftTypeSet),d=Stapes.subclass({constructor:function(a){this.container=$XP(a,"container"),this.callServer=Hualala.Global.getMCMGiftDetail,this.pageCtx=Hualala.PageRoute.getPageContextByPath(),this.giftItemID=$XP(this.pageCtx,"params")[0],this.tabViewHT=new IX.IListManager,this.$nav=null,this.$tabs=null,this.mGiftDetail=null,this.breadCrumbs=null,this.loadTemplates(),this.bindEvent(),this.renderLayout()}});d.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_giftdetail_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns")),c=Handlebars.compile(Hualala.TplLib.get("tpl_base_datagrid"));Handlebars.registerPartial("baseinfo",Hualala.TplLib.get("tpl_gift_detail")),Handlebars.registerPartial("card",Hualala.TplLib.get("tpl_gift_card")),Handlebars.registerPartial("grid",Hualala.TplLib.get("tpl_base_datagrid")),Handlebars.registerHelper("chkColType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),this.set({layoutTpl:a,btnTpl:b,gridTpl:c})},bindEvent:function(){this.on({getDetail:function(a){var b=this,c=$XP(a,"post",{}),d=$XF(a,"successFn"),e=$XF(a,"faildFn");b.callServer(c,function(a){"000"==$XP(a,"resultcode")?d.call(b,a):e.call(b,a)})}},this)},initBreadCrumb:function(){var b=this,c=b.$nav,d=Hualala.PageRoute.getParentNamesByPath();b.breadCrumbs=new Hualala.UI.BreadCrumb({container:c,hideRoot:!0,nodes:d,clz:"mcm-crumbs",clickFn:function(){var b=a(this);document.location.href=b.attr("data-href")},mapRenderData:function(a,b,c){var d=_.map(a,function(b,c){var d=$XP(b,"label",""),e=$XP(b,"name",""),f=Hualala.PageRoute.createPath(e,null);return{clz:"crumb",label:d,path:f,name:e,isLastNode:a.length-1==c?!0:!1}});return b===!0&&d.shift(),d.shift(),{clz:c,items:d}}})},mapTabNavData:function(a){return _.map(a,function(a){return IX.inherit(a,{clz:"mcm-detail-tab",id:$XP(a,"value")+"_"+IX.id()})})},mapGiftStatisticGridData:function(a){var b="table-striped table-hover table-condensed",c=$XP(a,"records",[]),d=$XP(a,"total",{}),e=_.reject(Hualala.TypeDef.MCMDataSet.GiftDistributeTypes,function(a){return IX.isEmpty(a.value)||!a.include}),f=_.reject(Hualala.TypeDef.MCMDataSet.GiftStatus,function(a){return IX.isEmpty(a.value)}),g=function(){var a=_.map(e,function(a){return{clz:"",label:$XP(a,"label","")}});return a.push({clz:"",label:"总计"}),a.unshift({clz:"",label:"状态"}),{thead:a}},h=function(a){var b=_.map(a,function(a){var b=_.find(f,function(b){return $XP(b,"value")==$XP(a,"giftstatus")}),c=_.map(e,function(a){return $XP(a,"value")}),d=_.map(c,function(b){var c="sum_"+b,d=$XP(a,c,0);return{clz:"",type:"text",value:d,text:d}});return d.unshift({clz:"",type:"text",value:$XP(a,"giftstatus"),text:$XP(b,"label")}),d.push({clz:"",type:"text",value:$XP(a,"totalCount",0),text:$XP(a,"totalCount",0)}),{clz:"",cols:d}});return{rows:b}},i=function(a){var b=_.map(e,function(b){var c=$XP(b,"value"),d="count_"+c;return{clz:"",value:$XP(a,d,0),text:$XP(a,d,0)}});return b.unshift({clz:"",value:"",text:"总计"}),b.push({clz:"",value:$XP(a,"totalCount",0),text:$XP(a,"totalCount",0)}),{tfoot:[{clz:"",cols:b}]}};return IX.inherit({clz:"",tblClz:b},g(),h(c),i(d))},mapLayoutRenderData:function(a){var b=this,d=$XP(a,"records",[])[0],e=c($XP(d,"giftType")),f=$XP(e,"navs",[]),g={},h={clz:$XP(e,"type",""),label:$XP(d,"giftValue",""),unit:$XP(e,"unit","")};return g=IX.inherit(d,{card:h,giftTypeLabel:$XP(e,"label",""),giftTypeUnit:$XP(e,"unit",""),infoLabelClz:"col-sm-2",navs:b.mapTabNavData(f),grid:b.mapGiftStatisticGridData($XP(a,"myGiftDataset.data",{}))})},renderLayout:function(){var a=this,c=a.giftItemID,d=function(b){var c=a.get("layoutTpl"),d=a.mapLayoutRenderData(b),e=c(d);a.container.html(e),a.$nav=a.container.find(".detail-layout > .nav-bar"),a.$tabs=a.container.find(".detail-tabs"),a.initBreadCrumb(),a.bindPageEvent(),a.$tabs.find(".nav-tabs a:first").tab("show")};a.emit("getDetail",{post:{giftItemID:c},successFn:function(c){a.mGiftDetail=new b.BaseGiftModel($XP(c,"data",{})),d($XP(c,"data",{}))},faildFn:function(){}})},bindPageEvent:function(){var b=this;b.$tabs.find(".nav-tabs a[data-toggle=tab]").on("shown.bs.tab",function(c){var d=a(c.target),e=a(d.attr("href")),f=e.attr("id"),g=b.getTabView(f);if(!g)switch(f){case"tab_send":b.initTabSend(e);break;case"tab_used":b.initTabUsed(e);break;case"tab_give":b.initTabGive(e);break;case"tab_pay":b.initTabPay(e);break;case"tab_onlinesale":b.initTabOnlineSale(e)}})},getTabView:function(a){var b=this,c=b.tabViewHT;return c.get(a)},initTabSend:function(a){var c=this,d=c.tabViewHT,e=Hualala.MCM.QueryFormKeys.GiftSendStatisticQueryKeys,f=new b.QueryController({container:a,resultController:new b.QueryResultControler({container:a,model:new b.GiftMgrResultModel({callServer:Hualala.Global.queryMCMGiftDetailGetWayInfo,queryKeys:e,gridType:"giftsend",recordModel:b.BaseGiftSendModel}),view:new b.QueryResultView({mapResultRenderData:b.mapGiftDetailQuerySendRenderData,renderResult:b.renderQueryResult,bundleEvent:b.bundleGiftsQueryResultEvent})}),model:new b.QueryModel({queryKeys:e}),view:new b.QueryView({mapRenderDataFn:b.mapGiftDetailGetWayQueryFormRenderData,bundleQueryEvent:b.bundleGiftsQueryEvent})});d.register(a.attr("id"),f)},initTabUsed:function(a){var c=this,d=c.tabViewHT,e=Hualala.MCM.QueryFormKeys.GiftUsedStatisticQueryKeys,f=new b.QueryController({container:a,resultController:new b.QueryResultControler({container:a,model:new b.GiftMgrResultModel({callServer:Hualala.Global.queryMCMGiftDetailUsedInfo,queryKeys:e,gridType:"giftsend",recordModel:b.BaseGiftUsedModel}),view:new b.QueryResultView({mapResultRenderData:b.mapGiftDetailQueryUsedRenderData,renderResult:b.renderQueryResult,bundleEvent:b.bundleGiftsQueryResultEvent})}),model:new b.QueryModel({queryKeys:e}),view:new b.QueryView({mapRenderDataFn:b.mapGiftDetailUsedQueryFormRenderData,bundleQueryEvent:b.bundleGiftsQueryEvent})});d.register(a.attr("id"),f)},initTabGive:function(a){var c=this,d=c.tabViewHT,e=new b.MCMGiftDetailFormPanel({container:a,parentView:c,formKeys:b.GiftDetailDonateGiftCtrlFormKeys,callServer:Hualala.Global.giftDetailDonateGift,panelTitle:"赠送",mapFormElsData:b.mapDonateGiftFormRenderData,initUIComponents:b.initDonateGiftFormUIComponent,bundleFormEvent:b.bundleDonateGiftFormEvent});d.register(a.attr("id"),e)},initTabPay:function(a){var c=this,d=c.tabViewHT,e=new b.MCMGiftDetailFormPanel({container:a,parentView:c,formKeys:b.GiftDetailPayGiftCtrlFormKeys,callServer:Hualala.Global.giftDetailDonateGift,panelTitle:"支付",mapFormElsData:b.mapPayGiftFormRenderData,initUIComponents:b.initPayGiftFormUIComponent,bundleFormEvent:b.bundlePayGiftFormEvent});d.register(a.attr("id"),e)},initTabOnlineSale:function(a){var c=this,d=c.tabViewHT,e=new b.MCMGiftDetailFormPanel({container:a,parentView:c,formKeys:b.GiftDetailPayGiftOnlineCtrlFormKeys,callServer:Hualala.Global.giftDetailPayGiftOnline,panelTitle:"网上出售",mapFormElsData:b.mapPayGiftOnlineFormRenderData,initUIComponents:b.initPayGiftOnlineFormUIComponent,bundleFormEvent:b.bundlePayGiftOnlineFormEvent});d.register(a.attr("id"),e)}}),b.GiftDetailPage=d}(jQuery,window),function(a){IX.ns("Hualala.MCM");var b=Hualala.MCM,c=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Stapes.subclass({constructor:function(a){this.set(a),this.bindEvent()}}));c.proto({bindEvent:function(){var a=this;a.on({},a)}}),b.BaseEventTrackModel=c;var d=[{key:"customerName",clz:"text",label:"姓名"},{key:"customerSex",clz:"text",label:"性别"},{key:"cardNO",clz:"text",label:"卡号"},{key:"customerMobile",clz:"text",label:"手机号"},{key:"cardLevelName",clz:"text",label:"等级"},{key:"consumptionTotal",clz:"text",label:"消费累计"},{key:"consumptionCount",clz:"text",label:"消费次数"},{key:"createTime",clz:"text",label:"参与时间"}],e=function(a,b,c){var d={value:"",text:""},e=$XP(a,c,""),f=Hualala.Common.formatDateTimeValue;
switch(c){case"createTime":d.value=e,d.text=IX.Date.getDateByFormat(f(e),"yyyy/MM/dd HH:mm");break;default:d.value=d.text=e}return d};b.mapEventTrackQueryResultRenderData=function(a){var b=this,c="col-md-12",f=" table-hover mcm-grid",g=_.clone(d),h=b.$container.data("eventDetail"),i=$XP(h,"eventWay");20==i?g.push({key:"winFlag",clz:"text",label:"中奖情况"}):22==i&&g.push({key:"winFlag",clz:"text",label:"是否入围"});var j=function(a,c){var d=_.map(g,function(a){return{key:$XP(a,"key",""),clz:$XP(a,"clz","")}}),f={clz:"",type:"text"},h=_.map(d,function(d){var g=e.apply(b,[a,c,$XP(d,"key",""),i]);return IX.inherit(f,g,{clz:$XP(d,"clz","")})});return h},k=_.map(a,function(a,b){var c={clz:"",cols:j(a,b)};return c}),l=[{clz:"hidden",cols:[]}];return{clz:c,tblClz:f,isEmpty:a&&0!=a.length?!1:!0,colCount:g.length,thead:g,rows:k,tfoot:l}},b.bundleEventTrackQueryResultEvent=function(){};var f=function(a){var b=Hualala.TypeDef.MCMDataSet.EventTypes;return _.find(b,function(b){return $XP(b,"eventID")==a})};b.getEventTypeSet=f;var g=Stapes.subclass({constructor:function(a){this.container=$XP(a,"container"),this.callServer=Hualala.Global.getMCMEventByID,this.pageCtx=Hualala.PageRoute.getPageContextByPath(),this.$nav=null,this.breadCrumbs=null,this.loadTemplates(),this.bindEvent(),this.renderLayout()}});g.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_eventtrack_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns")),c=Handlebars.compile(Hualala.TplLib.get("tpl_base_datagrid"));Handlebars.registerPartial("baseinfo",Hualala.TplLib.get("tpl_event_detail")),Handlebars.registerPartial("card",Hualala.TplLib.get("tpl_event_card")),Handlebars.registerPartial("grid",Hualala.TplLib.get("tpl_base_datagrid")),this.set({layoutTpl:a,btnTpl:b,gridTpl:c})},bindEvent:function(){this.on({getDetail:function(a){var b=this,c=$XP(a,"post",{}),d=$XF(a,"successFn"),e=$XF(a,"faildFn");b.callServer(c,function(a){"000"==$XP(a,"resultcode")?d.call(b,a):e.call(b,a)})}},this)},initBreadCrumb:function(){var b=this,c=b.$nav,d=Hualala.PageRoute.getParentNamesByPath();b.breadCrumbs=new Hualala.UI.BreadCrumb({container:c,hideRoot:!0,nodes:d,clz:"mcm-crumbs",clickFn:function(){var b=a(this);document.location.href=b.attr("data-href")},mapRenderData:function(a,b,c){var d=_.map(a,function(b,c){var d=$XP(b,"label",""),e=$XP(b,"name",""),f=Hualala.PageRoute.createPath(e,null);return{clz:"crumb",label:d,path:f,name:e,isLastNode:a.length-1==c?!0:!1}});return b===!0&&d.shift(),d.shift(),{clz:c,items:d}}})},mapLayoutRenderData:function(a){var c=new b.BaseEventModel(a);return b.mapEventDetailRenderData(c)},renderLayout:function(){var a=this,b=$XP(a.pageCtx,"params")[0],c=function(b){var c=a.get("layoutTpl"),d=a.mapLayoutRenderData(b),e=c(d);a.container.html(e),a.$nav=a.container.find(".detail-layout > .nav-bar"),a.$eventTrack=a.container.find(".event-track"),a.$eventTrack.data("eventDetail",b),a.initBreadCrumb(),a.initEventTrackData()};a.emit("getDetail",{post:{eventID:b},successFn:function(a){c($XP(a,"data.records",[])[0])},faildFn:function(){}})},initEventTrackData:function(){{var a=this,c=Hualala.MCM.QueryFormKeys.EventTrackBaseQueryKeys;new b.QueryController({container:a.$eventTrack,resultController:new b.QueryResultControler({container:a.$eventTrack,model:new b.GiftMgrResultModel({callServer:Hualala.Global.getMCMEventTrack,queryKeys:c,gridType:"eventtrack",recordModel:b.BaseEventTrackModel}),view:new b.QueryResultView({mapResultRenderData:b.mapEventTrackQueryResultRenderData,renderResult:b.renderQueryResult,bundleEvent:b.bundleEventTrackQueryResultEvent})}),model:new b.QueryModel({queryKeys:c}),view:new b.QueryView({mapRenderDataFn:b.mapEventTrackQueryFormRenderData,bundleQueryEvent:b.bundleGiftsQueryEvent})})}}}),b.EventTrackPage=g}(jQuery,window),function(a){IX.ns("Hualala.MCM");var b=Hualala.MCM,c=function(){Hualala.PageRoute.jumpPage(Hualala.PageRoute.createPath("mcmGiftsMgr"))},d=function(){var c=(Hualala.PageRoute.getPageContextByPath(),a("#ix_wrapper > .ix-body > .container")),d=Hualala.MCM.QueryFormKeys.GiftMgrQueryKeys;c.html("<h1>礼品管理页</h1>");new b.QueryController({container:c,resultController:new b.QueryResultControler({container:c,model:new b.GiftMgrResultModel({callServer:Hualala.Global.getMCMGifts,queryKeys:d,gridType:"giftlist",recordModel:b.BaseGiftModel}),view:new b.QueryResultView({mapResultRenderData:b.mapGiftsQueryResultRenderData,renderResult:b.renderQueryResult,bundleEvent:b.bundleGiftsQueryResultEvent})}),model:new b.QueryModel({queryKeys:d}),view:new b.QueryView({mapRenderDataFn:b.mapGiftQueryFormRenderData,bundleQueryEvent:b.bundleGiftsQueryEvent})})},e=function(){var c=(Hualala.PageRoute.getPageContextByPath(),a("#ix_wrapper > .ix-body > .container"));c.html("<h1>礼品详情页</h1>");new b.GiftDetailPage({container:c})},f=function(){var c=(Hualala.PageRoute.getPageContextByPath(),a("#ix_wrapper > .ix-body > .container")),d=Hualala.MCM.QueryFormKeys.EventMgrQueryKeys;c.html("<h1>活动管理页</h1>");new b.QueryController({container:c,resultController:new b.QueryResultControler({container:c,model:new b.GiftMgrResultModel({callServer:Hualala.Global.getMCMEvents,queryKeys:d,gridType:"eventlsit",recordModel:b.BaseEventModel}),view:new b.QueryResultView({mapResultRenderData:b.mapEventsQueryResultRenderData,renderResult:b.renderQueryResult,bundleEvent:b.bundleEventsQueryResultEvent})}),model:new b.QueryModel({queryKeys:d}),view:new b.QueryView({mapRenderDataFn:b.mapEventQueryFormRenderData,bundleQueryEvent:b.bundleEventsQueryEvent})})},g=function(){var c=(Hualala.PageRoute.getPageContextByPath(),a("#ix_wrapper > .ix-body > .container"));c.html("<h1>活动跟踪页</h1>");new b.EventTrackPage({container:c})};b.MCMHomePageInit=c,b.MCMGiftsMgrInit=d,b.MCMGiftDetailInit=e,b.MCMEventMgrInit=f,b.MCMEventTrackInit=g}(jQuery,window),function(a){function b(){var b=Hualala.Common.Browser,c=$XP(b,"ie",null)?!0:!1,d=parseInt($XP(b,"ie",0)),e=1==IX.Cookie.get("allowOldVersion")?!0:!1;if(!c||e)return!0;if(d>8)return!0;var f=8==d?"您使用的IE浏览器版本过于陈旧，可能无法获得我们为您提供的良好的用户体验。<br/>我们建议您使用以下的浏览器或插件进行访问！":"您使用的IE浏览器版本过于陈旧，无法使用我们为您提供的管理功能。<br/>请您使用以下提供的浏览器进行访问！",g=[{href:"http://www.microsoft.com/zh-cn/download/internet-explorer-9-details.aspx",icon:"icon-ie9",name:"IE9",desc:"IE9浏览器是微软公司在2009年推出的新一代浏览器，比IE8界面更简洁，采用硬件加速功能，使访问页面更稳定，部分支持HTML5，CSS3特性。"},{href:"http://www.microsoft.com/zh-cn/download/internet-explorer-10-details.aspx",icon:"icon-ie10",name:"IE10",desc:"IE10浏览器是微软公司在2011年推出的IE9的下一代浏览器，在IE9的基础上增强了CSS3解析及硬件加速功能，并支持了HTML5。"},{href:"http://www.google.cn/intl/zh-CN/chrome/",icon:"icon-chrome",name:"Chrome",desc:"Chrome浏览器是由著名的搜索引擎巨头--谷歌(google)公司推出的现代浏览器，访问网页速度更快，稳定性更强，更具安全性，使用界面更加简洁有效，并完全支持HTML5，CSS3标准的特性。"},{href:"http://www.firefox.com.cn/download/",icon:"icon-firefox",name:"Firefox",desc:"FireFox是Mozilla推出的现代浏览器，全面支持HTML5，CSS3标准的特性。访问页面速度更快，更具安全性。"},{href:"http://ie.sogou.com/",icon:"icon-sogou",name:"搜狗浏览器",desc:"搜狗浏览器是搜狐公司推出的双核告诉浏览器--可以切换为全球最快的Webkit内核(Chrome浏览器)同时也可以切换为使用最普遍的IE内核(IE浏览器)，保证良好的兼容性的同时极大的提升网页的浏览速度。"}],h=Handlebars.compile(Hualala.TplLib.get("tpl_site_browserSupport")),i=a(h({msg:f,items:g}));return a("body > #ix_wrapper").remove(),i.appendTo(a("body")),i.find(".btn").click(function(){IX.Cookie.set("allowOldVersion",1),Hualala.Router.check()}),!1}function c(c,d){var e=Hualala.getSessionData(),f=Handlebars.compile(Hualala.TplLib.get("tpl_site_layout")),g=$XP(Hualala.getSessionUser(),"loginName",null)?!0:!1,h=$XP(e,"user.loginName",""),i=!1,j=$XP(e,"site.groupName",""),k=1==IX.Cookie.get("bindMobileWizard")?!1:!0;"admin"==$XP(e,"user.loginName")&&_.find($XP(e,"user.role",[]),function(a){return"admin"==a})&&(i=!0);var l=function(){var a={pcClientPath:Hualala.PageRoute.createPath("pcclient"),hualalaUrl:Hualala.Global.HualalaWebSite,loginName:h,merchantRoot:Hualala.PageRoute.createPath("main"),groupName:j,isLogin:g,logoutPath:Hualala.Global.getLogoutJumpToUrl(),logo:Hualala.Global.getDefaultImage("logo"),isSuperAdmin:i},b={aboutPath:Hualala.PageRoute.createPath("about")||"#",contactPath:Hualala.PageRoute.createPath("contact")||"#",gozapLogo:Hualala.Global.getDefaultImage("gozap")};return{header:a,footer:b}},m=a(f(l())),n=null;if(a("body > #ix_wrapper").remove(),b()){m.appendTo(a("body")),/main|pcclient|about|contact|login/.test(d)&&m.addClass("no-nav"),g&&(n=new Hualala.User.UserMgrModal({$btnGrp:m.find(".user-mgr")}),k&&0==$XP(e,"user.mobileBinded")&&1==$XP(e,"user.loginCount")&&(m.find(".user-mgr .btn[data-target=bind_mobile]").trigger("click"),IX.Cookie.set("bindMobileWizard",1)))}a.fn.bootstrapValidator&&(a.fn.bootstrapValidator.DEFAULT_OPTIONS=a.extend({},a.fn.bootstrapValidator.DEFAULT_OPTIONS,{message:"您输入的数据有误，请核对后再次输入",trigger:"blur",feedbackIcons:{valid:"glyphicon glyphicon-ok",invalid:"glyphicon glyphicon-remove",validating:"glyphicon glyphicon-refresh"}}),a.fn.bootstrapValidator.validators.accuracy={validate:function(a,b,c){var d=$XP(c,"accuracy",null),e=$XP(c,"message","");d=isNaN(d)?null:d;var f=b.val(),g=IX.isEmpty(d)||0==d?"^\\d+$":"^\\d+(\\.\\d{1,"+d+"})?$",h=null;return h=new RegExp(g),isNaN(f)?{valid:!1,message:"只能是数字"}:h.test(f)?!0:{valid:!1,message:e}}})}function d(){var b=(Hualala.getSessionData(),Handlebars.compile(Hualala.TplLib.get("tpl_site_navbar"))),c=Handlebars.compile(Hualala.TplLib.get("tpl_site_navbarToggle")),d=Hualala.getSessionUserRight(),e=function(){var a=new IX.IListManager;IX.iterate(d,function(b){a.register(b.name,b)});var b=_.map(Hualala.TypeDef.SiteNavType,function(b,c,d){var e=a.get(b.name)?!0:!1,f=$XP(b,"subnavs",[]);f=_.map(f,function(a){return{path:Hualala.PageRoute.createPath(a.name)||"#",name:a.name,label:a.label}});var d={active:Hualala.Global.isCurrentPage(b.name)?"active":"",disabled:e?"":"disabled",noPath:e?!1:!0,path:Hualala.PageRoute.createPath(b.name)||"#",name:b.name,label:b.label,isSubNav:"subnav"==b.type?!0:!1,subnavs:f};return d});return{items:b}},f=a(b(e())),g=a(c({target:"#site_navbar"})),h=a("#ix_wrapper .ix-header");h.find("> .container .navbar-collapse").remove(),h.find("> .container").append(f),h.find("> .container > .navbar-header .navbar-toggle").remove(),h.find("> .container > .navbar-header").prepend(g)}function e(){var b=(Hualala.getSessionSite(),Hualala.getSessionUser(),Hualala.getSessionRoles(),Hualala.getSessionPCClient(),Hualala.getSessionUserRight()),c=a("#ix_wrapper > .ix-body > .container"),d=function(){var a=new IX.IListManager,c=null;return IX.iterate(b,function(b){a.register(b.name,b)}),c=_.map(j,function(b){var c=$XP(b,"name"),d=a.get(c)?!0:!1;return IX.inherit(b,{itemClz:$XP(b,"itemClz","")+" "+(d?"":"disabled")})})},e=Handlebars.compile(Hualala.TplLib.get("tpl_site_homepage")),f=a(e({bricks:d()}));c.html(f),f.on("mouseenter mouseleave click",".brick-item",function(b){var c=a(this),d=c.attr("data-pagename"),e=b.type;return c.hasClass("disabled")?!1:void("click"==e?document.location.href=Hualala.PageRoute.createPath(d):c.toggleClass("hover"))})}function f(){var b=Handlebars.compile(Hualala.TplLib.get("tpl_site_login")),c=a(b({bannerImg:Hualala.Global.getDefaultImage("loginBanner")})),d=a("#ix_wrapper > .ix-body > .container");d.html(c);new Hualala.Entry.initLogin({$container:c})}function g(){var b=a("#ix_wrapper > .ix-body"),c=Handlebars.compile(Hualala.TplLib.get("tpl_site_about")),d=a(c());d.replaceAll(b)}function h(){var b=a("#ix_wrapper > .ix-body"),c=Handlebars.compile(Hualala.TplLib.get("tpl_site_contact")),d=a(c());d.replaceAll(b)}function i(){var b=a("#ix_wrapper > .ix-body"),c=Handlebars.compile(Hualala.TplLib.get("tpl_client_download")),d=Hualala.getSessionData(),e=a(c({href:$XP(d,"pcClient.downloadClientAddress","#"),title:$XP(d,"pcClient.version","")}));e.replaceAll(b)}IX.ns("Hualala.Common");var j=[{name:"setting",title:"业务",label:"开通业务•业务参数",brickClz:"home-brick-md-1",itemClz:"brick-item",icon:"icon-setting"},{name:"account",title:"结算",label:"账户设置•提现•结算报表",brickClz:"home-brick-md-2",itemClz:"brick-item",icon:"icon-pay"},{name:"order",title:"订单",label:"查询•报表•菜品排行",brickClz:"home-brick-md-2",itemClz:"brick-item",icon:"icon-order"},{name:"shop",title:"店铺",label:"开店•信息•菜谱",brickClz:"home-brick-md-1",itemClz:"brick-item",icon:"icon-home"},{name:"pcclient",title:"下载",label:"哗啦啦代理程序",brickClz:"home-brick-md-1",itemClz:"brick-item",icon:"icon-download"},{name:"user",title:"权限",label:"用户•权限",brickClz:"home-brick-md-1",itemClz:"brick-item",icon:"icon-lock"},{name:"weixin",title:"微信",label:"网络餐厅•营销",brickClz:"home-brick-md-1",itemClz:"brick-item",icon:"icon-weixin"},{name:"crm",title:"会员",label:"概览•报表•参数•营销",brickClz:"home-brick-md-1",itemClz:"brick-item",icon:"icon-crm"},{name:"mcm",title:"营销",label:"礼品•营销活动",brickClz:"home-brick-md-2",itemClz:"brick-item",icon:"icon-crm"}];Hualala.Common.LoginInit=f,Hualala.Common.initPageLayout=c,Hualala.Common.initSiteNavBar=d,Hualala.Common.HomePageInit=e,Hualala.Common.AboutInit=g,Hualala.Common.ContactInit=h,Hualala.Common.PCClientDownloadInit=i,Hualala.Common.IndexInit=function(){document.location.href=Hualala.PageRoute.createPath("main")}}(jQuery,window),function(a){function b(a,b){if(!$XP(a,"user",null))throw"Permission Deny!!";e=a,b()}function c(a){var c=IX.getTimeInMS();log("Merchant Sys INIT : "+c),Hualala.Global.loadAppData({},function(d){if(log("Load Merchant APP Data in (ms): "+(IX.getTimeInMS()-c)),0!=$XP(d,"resultcode"))throw e=null,document.location.href=Hualala.PageRoute.createPath("login"),"Session Data Load Faild!! resultcode = "+$XP(d,"resultcode","")+"; resultMsg = "+$XP(d,"resultmsg","");b($XP(d,"data",{}),function(){log("Merchant Sys INIT DONE in (ms): "+(IX.getTimeInMS()-c)),a()})},function(){document.location.href=Hualala.PageRoute.createPath("login")})}function d(){IX.nsExisted("Hualala.ajaxEngine.init")&&(a.ajaxSetup({beforeSend:function(b){b.setRequestHeader("X-CSRF-Token",a('meta[name="csrf-token"]').attr("content"))}}),Hualala.ajaxEngine.init({ajaxFn:jQuery.ajax,baseUrl:Hualala.Global.HOME,commonUrl:Hualala.Global.CommonSite,imgUrl:Hualala.Global.IMAGE_ROOT}))}IX.ns("Hualala");var e=null;Hualala.getSessionData=function(){return e},Hualala.getSessionSite=function(){return $XP(e,"site",null)},Hualala.getSessionUser=function(){return $XP(e,"user",null)},Hualala.getSessionRoles=function(){return $XP(e,"roles",[])},Hualala.getSessionPCClient=function(){return $XP(e,"pcClient",null)},Hualala.getSessionUserRight=function(){return $XP(e,"userRight",[])},Hualala.isSessionUser=function(a,b){var c=$XP(e,"user.groupLoginName")+$XP(e,"user.loginName");return e&&c==a+b};var f=!1;Hualala.init=function(){f||(d(),Hualala.PageRoute.start(function(a,b,d){var e="main,pcclient,about,contact,login",f=_.filter(e.split(","),function(a){return"main"!=a}).join(",");return f.indexOf(a)>=0?(Hualala.Common.initPageLayout({},a),e.indexOf(a)<0&&Hualala.Common.initSiteNavBar(a),void(d&&d.apply(null,[a,b]))):void c(function(){Hualala.Common.initPageLayout({},a),e.indexOf(a)<0&&Hualala.Common.initSiteNavBar(a),d&&d.apply(null,[a,b])})}),f=!0)}}(jQuery,window),function(a){function b(a,b,c){var d=a.match(c);if(d){var e=d.shift(),f=e.split("/");f=_.map(f,function(a){var b=_.indexOf(e,a);return b>-1?"_":a}),f.push(""),f.unshift("");var h=f.join("_");g[h]=b}}function c(a,b){var c=f[a];if(!c)return console.err("Can't find route : "+a);var d=$XP(c,"path"),e=$XP(c,"reg"),g=d.match(e),h=function(a){return Hualala.Global.HOME+a};return!g||g.length<1?console.err("The Path of Route ("+a+") is wrong!!"):1==g.length?h(d):g.length>1&&IX.isArray(b)&&g.length-1==b.length?(g.shift(),_.each(g,function(a,c){d=d.replace(a,b[c])}),h(d)):void 0}IX.ns("Hualala.PageRoute");var d=Hualala.Router,e=(Hualala.Global.Route,!1),f={},g={},h=function(){function a(a){if(!IX.isFn(IX.getNS(a)))return!1;for(var b=e.get(a),c=IX.getNS(a),d=0;d<b.length;d++)f[b[d]].init=c;return e.remove(a),!0}function b(){return g=IX.loop(g,[],function(b,c){return a(c)||b.push(c),b}),0==g.length}function c(){g=IX.Array.toSet(g),IX.checkReady(b,IX.emptyFn,40,{maxAge:15e3,expire:function(){}})}function d(a,b){var c=null;if(IX.isFn(b))c=b;else{if(!IX.isString(b))throw"Configuration failed : Invalid Page Initialized for "+a;IX.nsExisted(b)&&(c=IX.getNS(b))}return IX.isFn(c)?f[a].init=c:(e.put(b,a),void g.push(b))}var e=new IX.I1ToNManager,g=[];return{start:function(){setTimeout(c,1)},detect:d}}(),i=[{name:"login",path:"/#login",reg:/login$/,bodyClz:"",PageInitiator:"Hualala.Common.LoginInit",label:"登录"},{name:"main",path:"/#home",reg:/home$/,bodyClz:"home",PageInitiator:"Hualala.Common.HomePageInit",label:"首页"},{name:"shop",path:"/#shop",reg:/shop$/,bodyClz:"",PageInitiator:"Hualala.Shop.HomePageInit",parentName:"main",label:"店铺管理"},{name:"shopCreate",path:"/#shop/create",reg:/shop\/create$/,bodyClz:"",PageInitiator:"Hualala.Shop.CreateShopInit",parentName:"shop",label:"创建店铺"},{name:"shopInfo",path:"/#shop/{id}/info",reg:/shop\/(.*)\/info$/,bodyClz:"",PageInitiator:"Hualala.Shop.BaseInfoMgrInit",parentName:"shop",label:"店铺信息"},{name:"shopMenu",path:"/#shop/{id}/menu",reg:/shop\/(.*)\/menu$/,bodyClz:"",PageInitiator:"Hualala.Shop.FoodMenuMgrInit",parentName:"shop",label:"菜单管理"},{name:"setting",path:"/#setting",reg:/setting$/,bodyClz:"",PageInitiator:"Hualala.Setting.ShopMgrInit",parentName:"main",label:"业务设置"},{name:"account",path:"/#account",reg:/account$/,bodyClz:"",PageInitiator:"Hualala.Account.AccountListInit",parentName:"main",label:"资金结算"},{name:"accountDetail",path:"/#account/{id}/detail",reg:/account\/(.*)\/detail$/,bodyClz:"",PageInitiator:"Hualala.Account.AccountMgrInit",parentName:"account",label:"账户明细"},{name:"user",path:"/#user",reg:/user$/,bodyClz:"",PageInitiator:"Hualala.User.UserListInit",parentName:"main",label:"用户管理"},{name:"order",path:"/#order",reg:/order$/,bodyClz:"",PageInitiator:"Hualala.Order.OrderChartInit",parentName:"main",label:"订单报表"},{name:"orderQuery",path:"/#order/query/b{begin}/e{end}/c{cityID}/n{shopID}/s{status}/m{mobile}/o{orderKey}/i{minAmount}/a{maxAmount}",reg:/order\/query\/b(.*)\/e(.*)\/c(.*)\/n(.*)\/s(.*)\/m(.*)\/o(.*)\/i(.*)\/a(.*)$/,bodyClz:"",PageInitiator:"Hualala.Order.QueryOrderInit",parentName:"main",label:"订单查询"},{name:"orderQueryDay",path:"/#order/query/day/b{begin}/e{end}/c{cityID}/n{shopID}/s{status}",reg:/order\/query\/day\/b(.*)\/e(.*)\/c(.*)\/n(.*)\/s(.*)/,bodyClz:"",PageInitiator:"Hualala.Order.QueryOrderByDayDetailInit",parentName:"main",label:"订单日汇总"},{name:"orderQueryDuring",path:"/#order/query/during/b{begin}/e{end}/c{cityID}/n{shopID}/s{status}",reg:/order\/query\/during\/b(.*)\/e(.*)\/c(.*)\/n(.*)\/s(.*)/,bodyClz:"",PageInitiator:"Hualala.Order.QueryOrderByDuringDetailInit",parentName:"main",label:"订单期间汇总"},{name:"orderDishesHot",path:"/#order/dishes/hot/b{begin}/e{end}/c{cityID}/n{shopID}/s{foodCategoryName}",reg:/order\/dishes\/hot\/b(.*)\/e(.*)\/c(.*)\/n(.*)\/s(.*)/,bodyClz:"",PageInitiator:"Hualala.Order.QueryOrderDishesHotInit",parentName:"main",label:"菜品销量排行"},{name:"orderQueryCustomer",path:"/#order/customer/b{begin}/e{end}/c{cityID}/n{shopID}/m{mobile}/u{customerName}",reg:/order\/customer\/b(.*)\/e(.*)\/c(.*)\/n(.*)\/m(.*)\/u(.*)/,bodyClz:"",PageInitiator:"Hualala.Order.QueryOrderCustomerInit",parentName:"main",label:"顾客统计"},{name:"mcm",path:"/#mcm",reg:/mcm$/,bodyClz:"",PageInitiator:"Hualala.MCM.MCMHomePageInit",parentName:"main",label:"营销"},{name:"mcmGiftsMgr",path:"/#mcm/gifts",reg:/mcm\/gifts$/,bodyClz:"",PageInitiator:"Hualala.MCM.MCMGiftsMgrInit",parentName:"mcm",label:"礼品管理"},{name:"mcmGiftDetail",path:"/#mcm/gift/{giftItemID}/detail",reg:/mcm\/gift\/(.*)\/detail$/,bodyClz:"",PageInitiator:"Hualala.MCM.MCMGiftDetailInit",parentName:"mcmGiftsMgr",label:"礼品使用详情"},{name:"mcmEventMgr",path:"/#mcm/evts",reg:/mcm\/evts$/,bodyClz:"",PageInitiator:"Hualala.MCM.MCMEventMgrInit",parentName:"mcm",label:"营销活动管理"},{name:"mcmEventTrack",path:"/#mcm/evt/{eventID}/track",reg:/mcm\/evt\/(.*)\/track$/,bodyClz:"",PageInitiator:"Hualala.MCM.MCMEventTrackInit",parentName:"mcmEventMgr",label:"活动跟踪"},{name:"crm",path:"/#crm",reg:/crm$/,bodyClz:"",PageInitiator:"Hualala.CRM.CRMHomePageInit",parentName:"main",label:"会员管理"},{name:"crmMemberSchema",path:"/#crm/member/schema",reg:/crm\/member\/schema$/,bodyClz:"",PageInitiator:"Hualala.CRM.MemberSchemaInit",parentName:"crm",label:"会员概览"},{name:"crmQueryMember",path:"/#crm/member/query",reg:/crm\/member\/query/,bodyClz:"",PageInitiator:"Hualala.CRM.QueryMemberInit",parentName:"crm",label:"会员查询"},{name:"crmMemberDetail",path:"/#crm/member/{id}/detail",reg:/crm\/member\/(.*)\/detail$/,bodyClz:"",PageInitiator:"Hualala.CRM.MemberDetailInit",parentName:"crmQueryMember",label:"会员详情"},{name:"crmCardStats",path:"/#crm/member/cardstat",reg:/crm\/member\/cardstat$/,bodyClz:"",PageInitiator:"Hualala.CRM.CardStatisticInit",parentName:"crm",label:"入会统计"},{name:"crmDealSummary",path:"/#crm/deal/sum",reg:/crm\/deal\/sum/,bodyClz:"",PageInitiator:"Hualala.CRM.DealSummaryInit",parentName:"crm",label:"储值消费汇总"},{name:"crmDealDetail",path:"/#crm/deal/detail",reg:/crm\/deal\/detail/,bodyClz:"",PageInitiator:"Hualala.CRM.DealDetailInit",parentName:"crm",label:"交易明细"},{name:"crmRechargeReconciliation",path:"/#crm/deal/recharge",reg:/crm\/deal\/recharge/,bodyClz:"",PageInitiator:"Hualala.CRM.RechargeReconciliationInit",parentName:"crm",label:"储值对账"},{name:"crmParameter",path:"/#crm/settings/params",reg:/crm\/settings\/params$/,bodyClz:"",PageInitiator:"Hualala.CRM.CRMSettingsParamsInit",parentName:"crm",label:"会员系统参数"},{name:"crmCardLevels",path:"/#crm/settings/levels",reg:/crm\/settings\/levels$/,bodyClz:"",PageInitiator:"Hualala.CRM.CRMSettingsLevelsInit",parentName:"crm",label:"会员等级"},{name:"crmRechargePackageBusiness",path:"/#crm/settings/recharge",reg:/crm\/settings\/recharge$/,bodyClz:"",PageInitiator:"Hualala.CRM.RechargePackageBusinessInit",parentName:"crm",label:"充值套餐"},{name:"crmShopSpecialPrice",path:"/#crm/settings/ssp",reg:/crm\/settings\/ssp/,bodyClz:"",PageInitiator:"Hualala.CRM.ShopSpecialPriceInit",parentName:"crm",label:"店铺特惠"},{name:"weixin",path:"/#weixin",reg:/weixin$/,bodyClz:"",PageInitiator:"Hualala.Weixin.homeInit",parentName:"main",label:"微信管理"},{name:"wxReply",path:"/#weixin/admin/reply",reg:/weixin\/admin\/reply$/,bodyClz:"wx-reply",PageInitiator:"Hualala.Weixin.replyInit",parentName:"weixin",label:"自动回复"},{name:"wxSubscribe",path:"/#weixin/admin/subscribe",reg:/weixin\/admin\/subscribe$/,bodyClz:"wx-subscribe",PageInitiator:"Hualala.Weixin.subscribeInit",parentName:"weixin",label:"关注自动回复"},{name:"wxMenu",path:"/#weixin/admin/menu",reg:/weixin\/admin\/menu$/,bodyClz:"wx-menu",PageInitiator:"Hualala.Weixin.menuInit",parentName:"weixin",label:"自定义菜单"},{name:"wxQrCode",path:"/#weixin/admin/qrcode",reg:/weixin\/admin\/qrcode$/,bodyClz:"wx-qrcode",PageInitiator:"Hualala.Weixin.qrCodeInit",parentName:"weixin",label:"二维码维护"},{name:"wxAdvertorial",path:"/#weixin/material/advertorial",reg:/weixin\/material\/advertorial$/,bodyClz:"wx-advertorial",PageInitiator:"Hualala.Weixin.advertorialInit",parentName:"weixin",label:"软文管理"},{name:"wxContent",path:"/#weixin/material/content",reg:/weixin\/material\/content$/,bodyClz:"wx-content",PageInitiator:"Hualala.Weixin.contentInit",parentName:"weixin",label:"图文管理"},{name:"wxText",path:"/#weixin/material/text",reg:/weixin\/material\/text$/,bodyClz:"wx-text",PageInitiator:"Hualala.Weixin.textInit",parentName:"weixin",label:"文本管理"},{name:"pcclient",path:"/#download",reg:/download$/,bodyClz:"",PageInitiator:"Hualala.Common.PCClientDownloadInit",parentName:"main",label:"客户端下载"},{name:"about",path:"/#about",reg:/about$/,bodyClz:"",PageInitiator:"Hualala.Common.AboutInit",parentName:"main",label:"关于"},{name:"contact",path:"/#contact",reg:/contact$/,bodyClz:"",PageInitiator:"Hualala.Common.ContactInit",parentName:"main",label:"联系我们"},{name:"index",path:"",reg:/(.*)$/,bodyClz:"",PageInitiator:"Hualala.Common.IndexInit"}];IX.iterate(i,function(a){var c=IX.inherit({bodyClz:"ix-minor",path:""},a),d=$XP(a,"name"),e=$XP(a,"path"),g=$XP(a,"reg");b(e,d,g),f[d]={name:d,bodyClz:$XP(c,"bodyClz",""),path:e,reg:$XP(c,"reg",null),parentName:$XP(a,"parentName",null),label:$XP(a,"label","")};var i="PageInitiator"in c?c.PageInitiator:null;IX.isString(i)||IX.isFn(i)||(i=IX.emptyFn),h.detect(d,i)}),h.start();var j=a("body");Hualala.PageRoute.start=function(a){e=!0,d.flush().config({mode:"history",root:Hualala.Global.HOME}),_.each(f,function(b,c){var e=$XP(b,"reg"),f=$XF(b,"init"),g=null;g=function(d){IX.Debug.info("INFO: Init Page : ["+c+"]"),IX.Debug.info("INFO: Page Arguments : ["+d+"]"),j.removeClass().addClass(b.bodyClz),IX.isFn(a)&&a(c,d,f)},d.add(e,g)}),d.listen().check()},Hualala.PageRoute.createPath=c,Hualala.PageRoute.getCurrentPath=function(){return location.hash},Hualala.PageRoute.getPageContextByPath=function(a){var b=a||Hualala.Router.getFragment(),c=_.filter(f,function(a){return!!b.match(a.reg)}),d=null;return 0==c.length?null:1==c.length?(d=b.match(c[0].reg),d.shift(),IX.inherit({params:d},c[0])):(c=_.filter(c,function(a){return"index"!=a.name}),d=b.match(c[c.length-1].reg),d.shift(),IX.inherit({params:d},c[c.length-1]))},Hualala.PageRoute.getParentNamesByPath=function(a){for(var b=Hualala.PageRoute.getPageContextByPath(a),c=$XP(b,"name",null),d=[];!IX.isEmpty(c);){d.unshift({name:c,label:$XP(b,"label",""),path:Hualala.PageRoute.createPath(c,b.params)});var e=$XP(b,"parentName",null);b=IX.isEmpty(e)?null:$XP(f,e,null),c=$XP(b,"name",null)}return d[d.length-1].isLastNode=!0,d},Hualala.PageRoute.getPageLabelByName=function(a){if(!a)return null;var b=f[a];return b?b.label:null},Hualala.PageRoute.jumpPage=function(a){document.location.href=a}}(jQuery,window);
//# sourceMappingURL=pages.min.map