/*! Hualala-Merchant-Management 2014-10-09 */

!function(a){IX.ns("Hualala.Entry");var b=[{name:"group_name",type:"text",palceholder:"请输入集团主账号",clz:"form-control input-md",key:"groupName",field:{validators:{notEmpty:{message:"集团主账号不能为空"}}}},{name:"group_subname",type:"text",palceholder:"请输入集团子账号",clz:"form-control input-md",key:"childName",field:{validators:{}}},{name:"login_pwd",type:"passowrd",palceholder:"请输入登陆密码",clz:"form-control input-md",key:"password",field:{validators:{notEmpty:{message:"密码不能为空"},callback:{callback:function(a){var b=6,c=32;return a.length<6||a.length>32?{valid:!1,message:"密码长度必须在"+b+"位到"+c+"位之间"}:{valid:!0}}}}}},{name:"login_auth",type:"text",palceholder:"请输入验证码",clz:"form-control input-md",key:"authCode",field:{validators:{notEmpty:{message:"验证码不能为空"}}}}],c=function(b){var c=a($XP(b,"container")),d=c.find(".auth-img"),e=c.find(".progress"),f=Hualala.Global.genAuthCode,g=function(a){e[a?"removeClass":"addClass"]("hidden"),d[a?"addClass":"removeClass"]("hidden")},h=function(a){g(!0),f({},function(b){var c=null;"000"==$XP(b,"resultcode")?c=$XP(b,"data.code",null):(Hualala.UI.TopTip({type:"warning",msg:"获取验证码失败"}),g()),a(c)})},i=function(a){return a?(d.attr("src",a),void setTimeout(function(){g()},500)):void setTimeout(function(){h(i)},1e3)},j=function(){c.delegate(".auth-img","click",function(b){d=a(b.target),h(i)})},k=function(){h(i),j()};return k(),{genCode:function(){h(i)}}};Hualala.Entry.initLogin=function(d){if(!d||0==d.length)return void console.err("Login Form init failed!");var e=Hualala.Global.loginCallServer,f={},g=d.find("#login_sub"),h=g.parent().find(".progress"),i=d.find(".ix-authcode"),j=(new c({container:i}),function(a){h[a?"removeClass":"addClass"]("hidden"),g[a?"addClass":"removeClass"]("hidden")}),k=function(){var a={};return _.each(b,function(b){var c=$XP(b,"name"),d=$XP(b,"field");a[c]=d}),a},l=function(){var c={};return _.each(b,function(b){var e=$XP(b,"name"),f=$XP(b,"key"),g=a("[name="+e+"]",d).val();c[f]=g}),c},m=function(){f=k(),d.bootstrapValidator({trigger:"blur",fields:f}).on("error.field.bv",function(b){{var c=a(b.target);c.data("bootstrapValidator")}j()}).on("success.form.bv",function(b){b.preventDefault();var c=a(b.target),d=(c.data("bootstrapValidator"),l());IX.Debug.info("INFO: Login Params : "),IX.Debug.info(d),e(d,function(a){0==a.resultcode?document.location.href=Hualala.PageRoute.createPath("main"):Hualala.UI.TopTip({type:"danger",msg:$XP(a,"resultmsg")}),j()})}),d.delegate("#login_sub","click",function(){j(!0);var a=d.data("bootstrapValidator");a.validate()})};m()}}(jQuery,window),function(){IX.ns("Hualala.Shop");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip),b=Stapes.subclass({constructor:function(){this.origCities=[],this.origAreas=[],this.origShops=[],this.isReady=!1,this.callServer=Hualala.Global.getShopQuerySchema}});b.proto({init:function(b,c){var d=this;d.isReady=!1,d.callServer(b,function(b){"000"==b.resultcode?(d.origCities=$XP(b,"data.cities",[]),d.origAreas=$XP(b,"data.areas",[]),d.origShops=$XP(b,"data.shops",[]),d.initDataModel(),d.isReady=!0):(a({msg:$XP(b,"resultmsg",""),type:"danger"}),d.isReady=!1),c(d)})},initDataModel:function(){var a=this,b=new IX.IListManager,c=new IX.IListManager,d=new IX.IListManager;_.each(this.origCities,function(c){var d=$XP(c,"cityID"),e=_.filter(a.origShops,function(a){return $XP(a,"cityID")==d}),f=_.filter(a.origAreas,function(a){return $XP(a,"cityID")==d});e=_.pluck(e,"shopID"),f=_.pluck(f,"areaID"),b.register(d,IX.inherit(c,{shopLst:e,areaLst:f}))}),_.each(this.origAreas,function(b){var d=$XP(b,"areaID"),e=_.filter(a.origShops,function(a){return $XP(a,"areaID")==d});e=_.pluck(e,"areaID"),c.register(d,IX.inherit(b,{shopLst:e}))}),_.each(this.origShops,function(a){var b=$XP(a,"shopID");d.register(b,a)}),a.set({ds_city:b,ds_area:c,ds_shop:d})},hasReady:function(){return this.isReady},getCities:function(a){a=IX.isEmpty(a)?null:IX.isString(a)?[a]:a;var b=this.get("ds_city"),c=null;return c=b[a?"getByKeys":"getAll"](a)},getShops:function(a){a=IX.isEmpty(a)?null:IX.isString(a)?[a]:a;var b=this.get("ds_shop"),c=null;return c=b[a?"getByKeys":"getAll"](a)},getShopsByAreaID:function(a){if(!a)return null;var b=this.get("ds_shop"),c=_.filter(b.getAll(),function(b){var c=$XP(b,"areaID");return a==c});return 0==c.length?null:c},getShopsByCityID:function(a){if(!a)return null;var b=this.get("ds_shop"),c=_.filter(b.getAll(),function(b){var c=$XP(b,"cityID");return a==c});return 0==c.length?null:c},getAreas:function(a){a=IX.isEmpty(a)?null:IX.isString(a)?[a]:a;var b=this.get("ds_area"),c=null;return c=b[a?"getByKeys":"getAll"](a)},destroy:function(){this.origCities=[],this.origAreas=[],this.origShops=[],this.isReady=!1}}),Hualala.Shop.QueryModel=b}(jQuery,window),function(a){IX.ns("Hualala.Shop");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Stapes.subclass({constructor:function(){this.isReady=!1,this.needShopCreate=!1,this.$container=null,this.$queryBox=null,this.$filter=null,this.$query=null,this.loadTemplates()}}));b.proto({init:function(a){if(this.model=$XP(a,"model",null),this.needShopCreate=$XP(a,"needShopCreate",!1),this.$container=$XP(a,"container",null),!this.model||!this.$container||0==this.$container.length)throw"Init Query View Failed!!";this.keywordLst=null,this.renderLayout(),this.bindEvent(),this.isReady=!0,this.emit("filter",this.getFilterParams())},hasReady:function(){return this.isReady},loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_shop_query")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_filter"));Handlebars.registerPartial("shopCity",Hualala.TplLib.get("tpl_shop_filter")),Handlebars.registerPartial("toggle",Hualala.TplLib.get("tpl_site_navbarToggle")),this.set({queryTpl:a,filterTpl:b})},mapChosenShopData:function(){var a=this,b=this.model.getCities(),c=[];return _.each(b,function(b){var d=$XP(b,"cityName",""),e=($XP(b,"cityID",""),$XP(b,"shopLst")),f=a.model.getShops(e);c.push({name:d,items:_.map(f,function(a){return{code:$XP(a,"shopID"),name:$XP(a,"shopName")}})})}),c},mapRenderLayoutData:function(){var a=this.model.getCities(),b=(this.model.getShops(),this.mapFilterData({type:"city",name:"城市：",focus:0,data:a})),c=this.mapChosenShopData();return{clz:"",shopCity:b,toggle:{target:"#shop_query"},needShopCreate:this.needShopCreate,optGrp:c}},renderLayout:function(){var b=this,c=b.get("queryTpl"),d=(b.model,b.mapRenderLayoutData()),e=c(d);this.$queryBox=a(e),this.$container.prepend(this.$queryBox),this.$filter=this.$queryBox.find(".filter"),this.$query=this.$queryBox.find(".query"),this.initShopChosenPanel()},mapFilterData:function(a){var b=$XP(a,"data",[]),c=$XP(a,"type"),d=$XP(a,"name"),e=$XP(a,"focus",0),f={type:c,name:d,items:[]},g=0,h={focusClz:"",type:c,code:-1,name:"全部",count:0};return f.items=_.map(b,function(a){var b=c+"Count",d=parseInt($XP(a,b,0));return g+=d,{focusClz:"",type:c,code:$XP(a,c+"ID",""),name:$XP(a,c+"Name",""),count:d}}),h=IX.inherit(h,{count:g,focusClz:""}),f.items.unshift(h),f.items[e].focusClz="disabled",f},initShopChosenPanel:function(){var b=this,c=new Pymatch([]),d=b.model.getShops(),e=function(a){c.setNames(_.map(d,function(a){return IX.inherit(a,{name:a.shopName})}));var b=c.match(a),e={};return _.each(b,function(a){e[a[0].shopID]=!0}),e};b.$query.find('.navbar-form[role="search"] select').chosen({width:"200px",placeholder_text:"请选择店铺名称",no_results_text:"抱歉，没有找到！",allow_single_deselect:!0,getMatchedFn:e}).change(function(){var c=a(this);b.keywordLst=c.val()})},renderAreaFilter:function(a){var b=this,c=b.get("filterTpl"),d=(b.model,b.mapFilterData({type:"area",name:"区域：",focus:0,data:a})),e=c(d);this.$filter.find(".area").remove(),this.$filter.append(e),this.initShopChosenPanel()},updateFilterCityLayout:function(a){var b=this,c=null;-1!=a?(c=b.model.getCities(a),c=$XP(c[0],"areaLst",null),c=b.model.getAreas(c),b.renderAreaFilter(c)):b.$filter.find(".area").remove(),b.$filter.find(".btn-link[data-city]").removeClass("disabled"),b.$filter.find(".btn-link[data-city="+a+"]").addClass("disabled")},updateFilterAreaLayout:function(a){var b=this;b.$filter.find(".btn-link[data-area]").removeClass("disabled"),b.$filter.find(".btn-link[data-area="+a+"]").addClass("disabled")},bindEvent:function(){var b=this;this.$filter.on("click",".btn-link[data-city]",function(){var c=a(this),d=c.attr("data-city");b.updateFilterCityLayout(d),b.emit("filter",b.getFilterParams())}),this.$filter.on("click",".btn-link[data-area]",function(){var c=a(this),d=c.attr("data-area");b.updateFilterAreaLayout(d),b.emit("filter",b.getFilterParams())}),this.$query.on("click",".create-shop",function(){a(this);document.location.href=Hualala.PageRoute.createPath("shopCreate")}),this.$query.on("click",".query-btn",function(){var c=(a(this),b.keywordLst||null),d=null,e=-1,f=-1;IX.isEmpty(c)||(d=b.model.getShops(c)[0],e=$XP(d,"cityID",-1),f=$XP(d,"areaID",-1)),b.updateFilterCityLayout(e),b.updateFilterAreaLayout(f),b.emit("query",b.getQueryParams())}),this.$query.on("keyup",".chosen-container",function(){var c=a(this);c.hasClass("chosen-container-active")&&!c.hasClass("chosen-with-drop")&&(c.find("input").first().trigger("blur.chosen"),b.$query.find(".query-btn").trigger("click"))})},destroy:function(){this.isReady=!1,this.needShopCreate=!1,this.$container.find(".shop-query").remove(),this.$queryBox=null,this.$filter=null,this.$query=null},getFilterParams:function(){var a=this,b=a.$filter.find(".btn-link.disabled"),c=b.filter("[data-city]").attr("data-city"),d=b.filter("[data-area]").attr("data-area");return c=c&&-1!=c?c:"",d=d&&-1!=d?d:"",{cityID:c,areaID:d,keywordLst:""}},getQueryParams:function(){var a=this,b=a.keywordLst||null,c=a.getFilterParams(),d=a.model.getShops();return b=IX.isEmpty(b)?"":$XP(_.find(d,function(a){return $XP(a,"shopID")==b}),"shopName",""),IX.inherit(c,{keywordLst:b})}}),Hualala.Shop.QueryView=b}(jQuery,window),function(){IX.ns("Hualala.Shop");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.Shop.QueryModel),b=Hualala.Shop.QueryView,c=Stapes.subclass({constructor:function(c){this.set({sessionData:Hualala.getSessionData()}),this.container=$XP(c,"container",null),this.needShopCreate=$XP(c,"needShopCreate",!1),this.resultController=$XP(c,"resultController",null),this.model=new a,this.view=new b,this.init()}});c.proto({init:function(){var a=this;a.bindEvent(),a.model.emit("load",function(){if(!a.model.hasReady())throw"Shop Query Init Failed!!";a.view.emit("init")})},bindEvent:function(){this.on({reload:function(){var a=this;a.model.distory(),a.view.distory(),a.init()},query:function(a){var b=this;IX.Debug.info("DEBUG: Shop Query Controller Query Params : "),IX.Debug.info(a),b.resultController&&b.resultController.emit("load",IX.inherit(a,{pageNo:1,pageSize:15}))}},this),this.model.on({load:function(a){var b=this,c=$XP(b.get("sessionData"),"user",{});b.model.init(c,a)}},this),this.view.on({init:function(){var a=this;a.view.init({model:a.model,needShopCreate:a.needShopCreate,container:a.container})},filter:function(a){var b=this;b.emit("query",a)},query:function(a){var b=this;b.emit("query",a)}},this)}}),Hualala.Shop.QueryController=c}(jQuery,window),function(){IX.ns("Hualala.Shop");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip),b=Stapes.subclass({constructor:function(a){if(this.callServer=$XP(a,"callServer",null),!this.callServer)throw"callServer is empty!"}});b.proto({init:function(a){this.set({pageCount:0,totalSize:0,pageNo:$XP(a,"pageNo",1),pageSize:$XP(a,"pageSize",15),cityID:$XP(a,"cityID",""),areaID:$XP(a,"areaID",""),keywordLst:$XP(a,"keywordLst",""),ds_shop:new IX.IListManager,ds_page:new IX.IListManager})},updatePagerParams:function(a){var b=this,c="pageCount,totalSize,pageNo,pageSize,cityID,areaID,keywordLst";_.each(a,function(a,d){c.indexOf(d)>-1&&b.set(d,a)})},getPagerParams:function(){return{pageNo:this.get("pageNo"),pageSize:this.get("pageSize"),cityID:this.get("cityID"),areaID:this.get("areaID"),keywordLst:this.get("keywordLst")}},updateDataStore:function(a,b){var d=this,e=d.get("ds_shop"),f=d.get("ds_page"),g=_.map(a,function(a){var b=$XP(a,"shopID"),d=new c(a);return e.register(b,d),b});f.register(b,g)},resetDataStore:function(){var a=this,b=a.get("ds_shop"),c=a.get("ds_page");b.clear(),c.clear()},load:function(b,c){var d=this;d.updatePagerParams(b),d.callServer(d.getPagerParams(),function(b){"000"==b.resultcode?(d.updateDataStore($XP(b,"data.records",[]),$XP(b,"data.page.pageNo")),d.updatePagerParams($XP(b,"data.page",{}))):a({msg:$XP(b,"resultmsg",""),type:"danger"}),c(d)})},getShops:function(a){var b=this,c=b.get("ds_shop"),d=b.get("ds_page"),e=_.map(c.getByKeys(d.get(a)),function(a){return a.getAll()});return IX.Debug.info("DEBUG: Shop Card List Model PageData : "),IX.Debug.info(e),e},getShopModelByShopID:function(a){var b=this,c=b.get("ds_shop");return c.get(a)},updateShopStatus:function(a,b,c){var d=this,e=d.get("ds_shop"),f=e.get(a);f.emit("switchShopStatus",{status:b,failFn:c})},updateShopBusinessStatus:function(a,b){var c=this,d=c.get("ds_shop"),e=$XP(a,"shopID"),f=d.get(e);f.emit("switchBusinessStatus",{name:$XP(a,"name"),id:$XP(a,"id"),status:$XP(a,"status",0),failFn:b})}}),Hualala.Shop.CardListModel=b;var c=Stapes.subclass({constructor:function(a){this.switchShopStatusCallServer=Hualala.Global.switchShopStatus,this.switchShopBusinessStatusCallServer=Hualala.Global.switchShopServiceFeatureStatus,this.set(a),this.bindEvent()}});c.proto({switchShopStatus:function(b,c){var d=this,e=d.get("shopID");d.set("status",b),IX.Debug.info("DEBUG: Base Shop Model ["+d.get("shopID")+"] Status :"+b),this.switchShopStatusCallServer({shopID:e,status:b},function(f){"000"!==f.resultcode?(a({msg:$XP(f,"resultmsg",""),type:"danger"}),d.set("status",b?0:1),c(e)):a({msg:"切换成功!",type:"success"})})},switchShopBusinessStatus:function(b){var c=this,d=c.get("shopID"),e=$XF(b,"failFn"),f=$XP(b,"name"),g=$XP(b,"id"),h=$XP(b,"status"),i=function(a,b){var d=c.get("serviceFeatures").split(",");1==b?d.push(a):d=_.filter(d,function(b){return b!==a}),c.set("serviceFeatures",d.join(","))};i(f,h),IX.Debug.info("DEBUG: Switch Shop ["+c.get("shopID")+"] ServiceFeature: "+c.get("serviceFeatures")),this.switchShopBusinessStatusCallServer({shopID:d,serviceFeatures:f,operation:h},function(b){"000"!==b.resultcode?(a({msg:$XP(b,"resultmsg",""),type:"danger"}),i(f,h?0:1),e({shopID:d,id:g})):a({msg:"切换成功!",type:"success"})})},bindEvent:function(){var b=this;this.on({switchShopStatus:function(a){var b=$XP(a,"status"),c=$XF(a,"failFn");this.switchShopStatus(b,c)},switchBusinessStatus:function(a){this.switchShopBusinessStatus(a)},setServiceParams:function(c){var d=$XF(c,"callServer"),e=$XP(c,"params",{}),f=$XP(c,"serviceID"),g=b.get("shopID"),h=$XF(c,"failFn"),i=$XF(c,"successFn");d(IX.inherit(e,{shopID:g,strType:f}),function(c){if("000"!==c.resultcode)a({msg:$XP(c,"resultmsg",""),type:"danger"}),h();else{var d={},g=b.get("revParamJson")||null;g=g?JSON.parse(g):{},g=IX.inherit(g,d),d[f]=e,b.set("revParamJson",JSON.stringify(g)),i(),a({msg:"配置成功!",type:"success"})}})}})}})}(jQuery,window),function(a){IX.ns("Hualala.Shop");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Stapes.subclass({constructor:function(){this.$container=null,this.$resultBox=null,this.$list=null,this.$pager=null,this.emptyBar=null,this.loadTemplates()}}));b.proto({init:function(a){if(this.$container=$XP(a,"container",null),this.model=$XP(a,"model",null),!this.$container||!this.model)throw"CardList View Init Failed!";this.initLayout()},initLayout:function(){var a=this.get("layoutTpl"),b=a();this.$container.append(b),this.$resultBox=this.$container.find(".shop-list"),this.$list=this.$container.find(".shop-list-body"),this.$pager=this.$container.find(".page-selection"),this.initPager(),this.bindEvent()},initPager:function(a){var b={total:0,page:1,maxVisible:10,leaps:!0};this.$pager.IXPager(IX.inherit(b,a))},bindEvent:function(){var b=this;b.$list.tooltip({selector:"[title]"}),b.$list.on("click",".btn[data-href]",function(){var b=a(this),c=b.attr("data-href");IX.isEmpty(c)||(document.location.href=c)}),b.$pager.on("page",function(a,c){var d=b.model.getPagerParams();d.pageNo=c,b.model.emit("load",IX.inherit(d,{pageNo:$XP(d,"pageNo",1),pageSize:$XP(d,"pageSize",15)}))})},loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_shop_list_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_list")),c=Handlebars.compile(Hualala.TplLib.get("tpl_shop_card")),d=Handlebars.compile(Hualala.TplLib.get("tpl_shop_tags"));Handlebars.registerPartial("shopTag",Hualala.TplLib.get("tpl_shop_tags")),Handlebars.registerPartial("shopCard",Hualala.TplLib.get("tpl_shop_card")),this.set({layoutTpl:a,listTpl:b,itemTpl:c,tagTpl:d})},mapTags:function(a){var b="areaName,cuisineName1,cuisineName2".split(","),c=_.map(b,function(b){return $XP(a,b,null)});return _.filter(c,function(a){return!IX.isEmpty(a)})},mapRenderData:function(a){var b=this,c=function(a){return _.map(a,function(a){return{clz:"label-info",tag:a}})},d=_.map(a,function(a){var d=$XP(a,"address",""),e=Hualala.Common.strByteLength(d),f="";return f=72>e?d:Hualala.Common.substrByte(d,70)+"...",{clz:"",id:$XP(a,"shopID",""),name:$XP(a,"shopName",""),img:Hualala.Common.getSourceImage($XP(a,"imagePath",""),{width:100,height:100,quality:50}),tags:c(b.mapTags(a)),address:d,slugAddr:f,tel:$XP(a,"tel",""),infoHref:Hualala.PageRoute.createPath("shopInfo",[$XP(a,"shopID","")]),menuHref:Hualala.PageRoute.createPath("shopMenu",[$XP(a,"shopID","")]),checked:1==$XP(a,"status")?"checked":""}});return{shopCard:{list:d}}},initSwitcher:function(b){var c=this;c.$list.find(b).bootstrapSwitch({size:"normal",onColor:"success",offColor:"default",onText:"已开通",offText:"未开通"}),c.$list.find(b).on("switchChange.bootstrapSwitch",function(d,e){var f=a(this),g=f.attr("data-shop"),e=e?1:0;c.model.updateShopStatus(g,e,function(a){c.$list.find(b).filter("[data-shop="+a+"]").bootstrapSwitch("toggleState",!0)})})},render:function(){var a=this,b=a.model,c=b.getPagerParams(),d=$XP(c,"pageNo"),e=b.getShops(d),f=a.mapRenderData(e),g=a.get("listTpl"),h=g(f);a.emptyBar&&a.emptyBar.destroy(),a.$list.empty(),0==e.length?(a.emptyBar=new Hualala.UI.EmptyPlaceholder({container:a.$list}),a.emptyBar.show()):a.$list.html(h),a.initPager({total:b.get("pageCount"),page:b.get("pageNo"),href:"javascript:void(0);"}),a.initSwitcher(":checkbox[name=switcher]")}}),Hualala.Shop.CardListView=b;var c=b.subclass({constructor:function(){this.$container=null,this.$resultBox=null,this.$list=null,this.$pager=null,this.emptyBar=null,this.loadTemplates()}});c.proto({bindEvent:function(){var b=this;b.$list.tooltip({selector:"[title]"}),b.$pager.on("page",function(a,c){var d=b.model.getPagerParams();d.pageNo=c,b.model.emit("load",IX.inherit(d,{pageNo:$XP(d,"pageNo",1),pageSize:$XP(d,"pageSize",15)}))}),b.$list.on("click",".btn[data-business]",function(){var c=a(this),d=c.attr("data-shop"),e=c.attr("data-business"),f=c.attr("data-business-id");b.initBusinessModal(c,d,e,f)})},loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_shop_list_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_list")),c=Handlebars.compile(Hualala.TplLib.get("tpl_shop_list_item")),d=Handlebars.compile(Hualala.TplLib.get("tpl_shop_tags"));Handlebars.registerPartial("shopTag",Hualala.TplLib.get("tpl_shop_tags")),Handlebars.registerPartial("shopItem",Hualala.TplLib.get("tpl_shop_list_item")),this.set({layoutTpl:a,listTpl:b,itemTpl:c,tagTpl:d})},getBusinessDesc:function(a,b,c){var d=null,e=null,f=null,g="",h=Hualala.TypeDef.MinuteIntervalOptions(),i=function(a){var b=_.find(h,function(b){return $XP(b,"value")==a});return $XP(b,"label","")};switch(a){case 10:d=Handlebars.compile(Hualala.TplLib.get("tpl_shop_commonreserve_desc")),e="advanceTime,noticeTime,minAmount,reserveTableTime,reserveTableDesc,payMethod".split(","),f=_.map(e,function(a){var b=$XP(c,a,"");switch(a){case"advanceTime":b=IX.isEmpty(b)||0==b?"不限制顾客提前预定时间":"顾客需提前"+i(b)+"预订, ";break;case"noticeTime":b=IX.isEmpty(b)||0==b?"订单立即通知餐厅":"订单提前"+i(b)+"通知餐厅, ";break;case"minAmount":b=IX.isEmpty(b)||0==b?"":"最低消费"+b+Hualala.Constants.CashUnit+", ";break;case"reserveTableTime":b=IX.isEmpty(b)||0==b?"":"留位"+i(b)+", ";break;case"reserveTableDesc":b=IX.isEmpty(b)?"":b+",";break;case"payMethod":b=(0==b?"仅支持在线支付":1==b?"仅支持线下支付":"线上及线下支付均支持")+", "}return b});break;case 11:d=Handlebars.compile(Hualala.TplLib.get("tpl_shop_justeat_desc")),e="servicePeriods,holidayFlag,minAmount,advanceTime,noticeTime,reserveTableTime,reserveTableDesc,payMethod".split(","),f=_.map(e,function(a){var b=$XP(c,a,"");switch(a){case"servicePeriods":b="开放时间段："+b.replace(",","-").replace(/([\d]{2})([\d]{2})/g,"$1:$2")+", ";break;case"holidayFlag":b=(0==b?"工作日及节假日均开放":1==b?"仅节假日开放":"仅工作日开放")+", ";break;case"minAmount":b=IX.isEmpty(b)||0==b?"":"最低消费"+b+Hualala.Constants.CashUnit+", ";break;case"advanceTime":b=IX.isEmpty(b)||0==b?"不限制顾客提前预定时间":"顾客需提前"+i(b)+"预订, ";break;case"noticeTime":b=IX.isEmpty(b)||0==b?"订单立即通知餐厅":"订单提前"+i(b)+"通知餐厅, ";break;case"reserveTableTime":b=IX.isEmpty(b)||0==b?"":"留位"+i(b)+", ";break;case"reserveTableDesc":b=IX.isEmpty(b)?"":b+",";break;case"payMethod":b=(0==b?"仅支持在线支付":1==b?"仅支持线下支付":"线上及线下支付均支持")+", "}return b});break;case 41:d=Handlebars.compile(Hualala.TplLib.get("tpl_shop_spotorder_desc")),e=0==b?"isDinner,supportCommitToSoftware,checkSpotOrder,payBeforeCommit".split(","):"isDinner,supportCommitToSoftware,fetchFoodMode".split(","),f=_.map(e,function(a){var d=$XP(c,a,"");switch(a){case"isDinner":d=0==b?!0:!1;break;case"supportCommitToSoftware":d=(1==d?"支持":"不支持")+"下单到餐饮软件, ";break;case"fetchFoodMode":d="下单后"+(1==d?"凭牌号":2==d?"直接":"凭流水号")+"在收银台取餐, ";break;case"checkSpotOrder":d=(1==d?"支持":"不支持")+"顾客通过手机结账, ";break;case"payMethodAtShop":d=(1==d?"餐前先通过手机结账":2==d?"餐后可通过手机结账":"不能用手机结账")+", ";break;case"payBeforeCommit":d=(1==d?"餐前":"餐后")+"结账, "}return d})}return(11==a||41==a||10==a)&&(g=d(_.object(e,f)),g=g.slice(0,g.lastIndexOf(","))),g},getShopBusiness:function(a){var b=this,c=Hualala.TypeDef.ShopBusiness,d=new IX.IListManager,e=$XP(a,"serviceFeatures",""),f=$XP(a,"revParamJson",null);f=f?JSON.parse(f):{};var g=null;return _.each(c,function(c){var g=$XP(c,"id"),h=$XP(c,"name");switcherStatus=e.indexOf(h)>=0?1:0,businessInfo=$XP(f,g.toString(),{}),operationMode=$XP(a,"operationMode",null);var i=IX.inherit(c,businessInfo,{switcherStatus:switcherStatus,shopID:$XP(a,"shopID"),desc:b.getBusinessDesc(g,operationMode,businessInfo)});d.register(h,i)}),g=_.filter(d.getAll(),function(a){return 1==$XP(a,"businessIsSupported",!1)})},mapBusinessRenderData:function(a){var b=this,c=b.getShopBusiness(a);return _.map(c,function(a){var b=$XP(a,"name"),c="icon-"+b,d="switcher_business",e=1==$XP(a,"switcherStatus")?"checked":"";return{icon:c,label:$XP(a,"label"),switcherName:d,shopID:$XP(a,"shopID"),type:b,id:$XP(a,"id"),open:e,desc:$XP(a,"desc","")}})},chkHasAccountRole:function(){var a=Hualala.getSessionUser(),b=$XP(a,"role");roles=Hualala.getSessionRoles();var c=_.find(roles,function(a){var c=$XP(a,"roleType"),d=_.find(b,function(b){return $XP(a,"id")==b});return!!d&&("account"==c||"all"==c)});return!!c},mapRenderData:function(a){var b=this,c=_.map(a,function(a){return{clz:"",shopID:$XP(a,"shopID",""),shopName:$XP(a,"shopName",""),hideAccount:b.chkHasAccountRole()?"":"hidden",settleName:$XP(a,"settleName",""),switcherName:"switcher_status",shopOpen:1==$XP(a,"status")?"checked":"",business:b.mapBusinessRenderData(a)}});return{shopItem:{list:c}}},initSwitcher:function(b){var c=this;c.$list.find(b).bootstrapSwitch({size:"normal",onColor:":checkbox[name=switcher_business]"==b?"primary":"success",offColor:"default",onText:"已开通",offText:"未开通"}),c.$list.find(b).on("switchChange.bootstrapSwitch",function(d,e){var f=a(this),g=f.attr("name"),h=f.attr("data-shop"),e=e?1:0,i=f.attr("data-business"),j=f.attr("data-business-id");"switcher_status"==g?c.model.updateShopStatus(h,e,function(a){c.$list.find(b).filter("[data-shop="+a+"]").bootstrapSwitch("toggleState",!0)}):c.model.updateShopBusinessStatus({shopID:h,name:i,id:j,status:e},function(a){c.$list.find(b).filter("[data-shop="+$XP(a,"shopID")+"][data-business-id="+$XP(a,"id")+"]").bootstrapSwitch("toggleState",!0)})})},render:function(){var a=this,b=a.model,c=b.getPagerParams(),d=$XP(c,"pageNo"),e=b.getShops(d),f=a.mapRenderData(e),g=a.get("listTpl"),h=g(f);a.emptyBar&&a.emptyBar.destroy(),a.$list.empty(),0==e.length?(a.emptyBar=new Hualala.UI.EmptyPlaceholder({container:a.$list}),a.emptyBar.show()):a.$list.html(h),a.initPager({total:b.get("pageCount"),page:b.get("pageNo"),href:"javascript:void(0);"}),a.initSwitcher(":checkbox[name=switcher_business]"),a.initSwitcher(":checkbox[name=switcher_status]")},initBusinessModal:function(a,b,c,d){{var e=this;new Hualala.Setting.editServiceView({triggerEl:a,serviceID:d,serviceName:c,model:e.model.getShopModelByShopID(b)})}}}),Hualala.Shop.ShopListView=c}(jQuery,window),function(){IX.ns("Hualala.Shop");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.UI.LoadingModal),b=(Hualala.Shop.ShopListModel,Hualala.Shop.ShopListView,Stapes.subclass({constructor:function(a){if(this.set({sessionData:Hualala.getSessionData()}),this.container=$XP(a,"container",null),this.view=$XP(a,"view",null),this.model=$XP(a,"model",null),!this.view||!this.model||!this.container)throw"Shop List init faild!!";this.isReady=!1,this.bindEvent()}}));b.proto({init:function(b){this.model.init(b),this.view.init({model:this.model,container:this.container}),this.loadingModal=new a({start:100}),this.isReady=!0},hasReady:function(){return this.isReady},bindEvent:function(){this.on({load:function(a){var b=this;b.hasReady()||b.init(a),b.model.emit("load",a)}},this),this.model.on({load:function(a){var b=this,c=function(){b.view.emit("render"),b.loadingModal.hide()};b.loadingModal.show(),b.model.load(a,c)}},this),this.view.on({render:function(){var a=this;a.view.render()},reloadPager:function(a){var b=this;b.view.initPager(a)}},this)}}),Hualala.Shop.ShopListController=b}(jQuery,window),function(a){function b(b){this.cfg=a.extend({},c,b),this.sContent="",this.$searchBox=a(this.cfg.searchBox),this.$mapResult=a(this.cfg.mapResult),this.map="",this.searchArea=!0,this.mapPoint={}}var c={data:{isSearchMap:!1,keyword:"",shopName:"",tel:"",address:"",city:"",area:"",lng:"",lat:""},searchBox:".search-box",mapResult:".map-result",mapCanvasId:"mapCanvas",load:function(){},serach:function(){}};b.prototype={init:function(){var b=this,c=b.cfg.data;if(b.map=new BMap.Map(b.cfg.mapCanvasId),b.map.addControl(new BMap.NavigationControl),b.map.enableScrollWheelZoom(),b.sContent=['<dl class="map-shop-info">',"<dt>"+c.shopName+"</dt>","<dd>","<p><span>电话：</span>"+c.tel+"</p>","<p><span>地址：</span>"+c.address+"</p>","</dd>","</dl>"].join(""),b[(!c.isSearchMap&&c.lng&&c.lat?"load":"search")+"Map"](c),b.$searchBox[0]){var d=b.$searchBox.find(".map-keyword"),e=b.$searchBox.find(".map-search-btn"),f=a.extend({},b.cfg.data);e.on("click",function(){f.keyword=a.trim(d.val()),b.searchMap(f)})}return this},loadMap:function(a){var b=this;a=a||b.self.cfg.data,b.map.centerAndZoom(new BMap.Point(a.lng,a.lat),14),b.map.enableScrollWheelZoom();var c=new BMap.Marker(new BMap.Point(a.lng,a.lat),{enableMassClear:!0,raiseOnDrag:!0});c.enableDragging(),b.map.addOverlay(c),c.openInfoWindow(new BMap.InfoWindow(b.sContent)),c.addEventListener("click",function(){c.openInfoWindow(new BMap.InfoWindow(b.sContent))}),c.addEventListener("dragend",function(a){b.setResult(a.point.lng,a.point.lat)}),b.setResult(a.lng,a.lat)},searchMap:function(a){var b=this;a=a||b.cfg.data;var c=new BMap.LocalSearch(b.map,{renderOptions:{map:b.map},pageCapacity:1,onInfoHtmlSet:function(a){a.marker.openInfoWindow(new BMap.InfoWindow(b.sContent))},onMarkersSet:function(){}});c.search(a.keyword||a.address||a.area||a.city),c.setSearchCompleteCallback(function(){c.getStatus()!==BMAP_STATUS_SUCCESS&&(b.searchArea?(c.search(a.area),b.searchArea=!1):c.search(a.city))}),c.setMarkersSetCallback(function(a){for(var c=a.length;c--;){var d=a[c].marker;d.enableDragging(),b.setResult(d.point.lng,d.point.lat),d.openInfoWindow(new BMap.InfoWindow(b.sContent)),d.addEventListener("click",function(){var a=this.getPosition();b.setResult(a.lng,a.lat)}),d.addEventListener("dragend",function(a){b.setResult(a.point.lng,a.point.lat)})}})},setResult:function(a,b){var c=this;c.mapPoint={lng:a,lat:b},c.$mapResult[0]&&c.$mapResult.html("您店铺的经度："+a+"    纬度： "+b)}},IX.ns("Hualala.Shop"),Hualala.Shop.map=function(a){return new b(a).init()}}(jQuery),function(a){function b(a,b,c){var d=g.getCuisines;d({cityID:c},function(c){return"000"!=c.resultcode?void(c.resultmsg&&i({msg:c.resultmsg,type:"danger"})):(e(a,c.data.records,"cuisineID","cuisineName"),void e(b,c.data.records,"cuisineID","cuisineName","--不限--"))})}function c(a,b){var c=g.getAreas;c({cityID:b},function(b){return"000"!=b.resultcode?void(b.resultmsg&&i({msg:b.resultmsg,type:"danger"})):void e(a,b.data.records,"areaID","areaName")})}function d(a){var b=g.getCities;b({isActive:1},function(b){return"000"!=b.resultcode?void(b.resultmsg&&i({msg:b.resultmsg,type:"danger"})):void e(a,b.data.records,"cityID","cityName")})}function e(b,c,d,e,f){var g='<option value="">'+(f||"--请选择--")+"</option>";a.each(c,function(a,b){g+='<option value="'+b[d]+'">'+b[e]+"</option>"}),b.empty().html(g)}function f(a){return a.find("option:selected").text().replace(/-/g,"")}IX.ns("Hualala.Shop");var g=Hualala.Global,h=Hualala.UI,i=h.TopTip;Hualala.Shop.initCreate=function(e){e.bootstrapWizard();var j=e.data("bootstrapWizard"),k=e.find("#tab1"),l=e.find("#tab2"),m=e.find("#tab3"),n=k.find("#cityID"),o=k.find("#areaID"),p=k.find("#cuisineID1"),q=k.find("#cuisineID2");d(n),n.on("change",function(){var d=a(this).val();d&&(c(o,d),b(p,q,d))}),k.find("#openingHoursStart, #openingHoursEnd").timepicker({minuteStep:1,showMeridian:!1,disableFocus:!0,showInputs:!1}),k.bootstrapValidator({fields:{shopName:{message:"店铺名无效",validators:{notEmpty:{message:"店铺名不能为空"},stringLength:{min:2,max:100,message:"店铺名长度必须在2到100个字符之间"}}},cityID:{validators:{notEmpty:{message:"请选择店铺所在城市"}}},tel:{validators:{notEmpty:{message:"店铺电话不能为空"},telOrMobile:{message:""}}},address:{validators:{notEmpty:{message:"店铺地址不能为空"},stringLength:{min:2,max:100,message:"地址长度必须在6到100个字符之间"}}},PCCL:{validators:{notEmpty:{message:"人均消费不能为空"},numeric:{message:"人均消费必须是金额数字"}}},operationMode:{validators:{notEmpty:{message:"请选择店铺运营模式"}}},openingHoursStart:{validators:{notEmpty:{message:"每天营业开始时间不能空"},time:{message:""}}},openingHoursEnd:{validators:{notEmpty:{message:"每天营业结束时间不能空"},time:{message:"",startTimeField:"openingHoursStart"}}},areaID:{validators:{notEmpty:{message:"请选择店铺所在地标"}}},cuisineID1:{validators:{notEmpty:{message:"请选择菜系1"}}}}});var r=k.find("#uploadImg"),s="";r.find("img").attr("src",g.IMAGE_ROOT+"/shop_head_img_default.png"),r.find("button, img").on("click",function(){h.uploadImg({onSuccess:function(a,b){var c=g.IMAGE_RESOURCE_DOMAIN+"/"+a;s=a,r.find("img").attr("src",c),b.modal("hide")}})});var t=null,u=null,v="",w=l.find(".map-search-box"),x=m.find("#shopSettingLink");e.find("#nextStep").on("click",function(){var a=j.activePane();if(a.is("#tab1")){if(!k.data("bootstrapValidator").validate().isValid())return;t=Hualala.Common.parseForm(k),t.shopID=v,t.shopName=t.shopName.replace("（","(").replace("）",")"),t.areaName=f(o),t.cuisineName1=f(p),t.cuisineName2=t.cuisineID2?f(q):"",t.imagePath=s,t.openingHours=t.openingHoursStart+"-"+t.openingHoursEnd;var b=[t.shopName,t.address,t.cuisineName1];t.cuisineName2&&b.push(t.cuisineName2),b.push(t.areaName),t.keywordLst=b.join(" | ");var c=v?g.updateShopBaseInfo:g.createShop;return void c(t,function(a){return"000"!=a.resultcode?void(a.resultmsg&&i({msg:a.resultmsg,type:"danger"})):(v=v||a.data.records[0].shopID,x.attr("href",Hualala.PageRoute.createPath("setting")),j.next(),void(u=Hualala.Shop.map({data:{isSearchMap:!0,shopName:t.shopName,tel:t.tel,address:t.address},searchBox:w})))})}if(a.is("#tab2")){var d=u.mapPoint.lng,e=u.mapPoint.lat,h={shopID:v,mapLongitudeValue:d,mapLatitudeValue:e,mapLongitudeValueBaiDu:d,mapLatitudeValueBaiDu:e},c=g.setShopMap;
c(h,function(a){return"000"!=a.resultcode?void(a.resultmsg&&i({msg:a.resultmsg,type:"danger"})):void 0})}j.next()})}}(jQuery,window),function(a){function b(b,c){b.find("input, select").not(".map-keyword, #openingHoursEnd").each(function(){var b=a(this),d=b.siblings("p");d.text(b.is("#openingHoursStart")?c.openingHours:b.is("select")?g(b):b.val())})}function c(a,b,c,d,e){var g=h.getCuisines;g({cityID:c},function(c){return"000"!=c.resultcode?void(c.resultmsg&&k({msg:c.resultmsg,type:"danger"})):(f(a,c.data.records,"cuisineID","cuisineName"),f(b,c.data.records,"cuisineID","cuisineName","--不限--"),d&&a.val(d),void(e&&b.val(e)))})}function d(a,b,c){var d=h.getAreas;d({cityID:b},function(b){return"000"!=b.resultcode?void(b.resultmsg&&k({msg:b.resultmsg,type:"danger"})):(f(a,b.data.records,"areaID","areaName"),void(c&&a.val(c)))})}function e(a,b){var c=h.getCities;c({isActive:1},function(c){return"000"!=c.resultcode?void(c.resultmsg&&k({msg:c.resultmsg,type:"danger"})):(f(a,c.data.records,"cityID","cityName"),void a.val(b.cityID).trigger("change",[b.areaID,b.cuisineID1,b.cuisineID2]))})}function f(b,c,d,e,f){var g='<option value="">'+(f||"--请选择--")+"</option>";a.each(c,function(a,b){g+='<option value="'+b[d]+'">'+b[e]+"</option>"}),b.empty().html(g)}function g(a){return a.find("option:selected").text().replace(/-/g,"")}IX.ns("Hualala.Shop");var h=Hualala.Global,i=Hualala.UI,j=Hualala.Shop,k=i.TopTip,l=Hualala.Common.parseForm;j.initInfo=function(f,m,n){if(n){var o=j.createShopFuncNav(m,n,f),p=n,q=null,r=null,s=null,t=null,u=null,v=null,w="",x=null,y=h.IMAGE_RESOURCE_DOMAIN+"/",z=null,A=null;h.getShopInfo({shopID:p},function(b){if("000"!=b.resultcode)return void(b.resultmsg&&k({msg:b.resultmsg,type:"danger"}));q=b.data.records[0],j.createShopInfoHead(q,f,function(a){o.before(a)});var g=q.openingHours.split("-");q.openingHoursStart=g[0],q.openingHoursEnd=g[1],q.operationModeName="1"==q.operationMode?"快餐":"正餐";var i=Handlebars.compile(Hualala.TplLib.get("tpl_shop_info"));r=a(i(q)).appendTo(f),s=r.find("#cityID"),t=r.find("#areaID"),u=r.find("#cuisineID1"),v=r.find("#cuisineID2"),s.on("change",function(b,e,f,g){var h=a(this).val();h&&(d(t,h,e),c(u,v,h,f,g))}),e(s,q),r.find("#openingHoursStart, #openingHoursEnd").timepicker({minuteStep:1,showMeridian:!1,disableFocus:!0,showInputs:!1}),r.bootstrapValidator({fields:{shopName:{message:"店铺名无效",validators:{notEmpty:{message:"店铺名不能为空"},stringLength:{min:2,max:100,message:"店铺名长度必须在2到100个字符之间"}}},cityID:{validators:{notEmpty:{message:"请选择店铺所在城市"}}},tel:{validators:{notEmpty:{message:"店铺电话不能为空"},telOrMobile:{message:""}}},address:{validators:{notEmpty:{message:"店铺地址不能为空"},stringLength:{min:2,max:100,message:"地址长度必须在6到100个字符之间"}}},PCCL:{validators:{notEmpty:{message:"人均消费不能为空"},numeric:{message:"人均消费必须是金额数字"}}},operationMode:{validators:{notEmpty:{message:"请选择店铺运营模式"}}},openingHoursStart:{validators:{notEmpty:{message:"每天营业开始时间不能空"},time:{message:""}}},openingHoursEnd:{validators:{notEmpty:{message:"每天营业结束时间不能空"},time:{message:"",startTimeField:"openingHoursStart"}}},areaID:{validators:{notEmpty:{message:"请选择店铺所在地标"}}},cuisineID1:{validators:{notEmpty:{message:"请选择菜系1"}}}}}),z=r.data("bootstrapValidator");var l=r.find("#uploadImg");x=l.find("img").attr("src",h.IMAGE_ROOT+"/shop_head_img_default.png"),w=q.imagePath,w&&x.attr("src",y+w),A=j.map({data:{isSearchMap:!1,shopName:q.shopName,tel:q.tel,address:q.address,lng:q.mapLongitudeValueBaiDu,lat:q.mapLatitudeValueBaiDu}})}),f.on("click",function(c){var d=a(c.target);if(d.is("#uploadImg img, #uploadImg a")&&i.uploadImg({onSuccess:function(a,b){w=a,x.attr("src",y+a),b.modal("hide")}}),d.is("#remarkMap"))if(z.isValidField("shopName")&&z.isValidField("tel")&&z.isValidField("address")){var e=A.mapPoint,f=l(r);A=j.map({data:{isSearchMap:!1,shopName:f.shopName,tel:f.tel,address:f.address,lng:e.lng,lat:e.lat}});var m={shopID:p,mapLongitudeValue:e.lng,mapLatitudeValue:e.lat,mapLongitudeValueBaiDu:e.lng,mapLatitudeValueBaiDu:e.lat};h.setShopMap(m,function(a){return"000"!=a.resultcode?void(a.resultmsg&&k({msg:a.resultmsg,type:"danger"})):void k({msg:"重新标记地图成功！",type:"success"})})}else k({msg:"店铺相关信息填写有误！",type:"danger"});if(d.is("#editBtn")&&r.removeClass("read-mode").addClass("edit-mode"),d.is("#saveBtn")){if(!z.validate().isValid())return;var n=l(r);n.shopID=p,n.shopName=n.shopName.replace("（","(").replace("）",")"),n.areaName=g(t),n.cuisineName1=g(u),n.cuisineName2=n.cuisineID2?g(v):"",n.imagePath=w,n.openingHours=n.openingHoursStart+"-"+n.openingHoursEnd;var o=[n.shopName,n.address,n.cuisineName1];n.cuisineName2&&o.push(n.cuisineName2),o.push(n.areaName),n.keywordLst=o.join(" | "),h.updateShopBaseInfo(n,function(a){return"000"!=a.resultcode?void(a.resultmsg&&k({msg:a.resultmsg,type:"danger"})):(r.removeClass("edit-mode").addClass("read-mode"),k({msg:"保存成功！",type:"success"}),void b(r,n))})}})}}}(jQuery,window),function(a,b){function c(a,b){clearTimeout(a.tId),a.tId=setTimeout(function(){a.call(b)},100)}IX.ns("Hualala.Shop"),Hualala.Shop.initMenu=function(d,e,f){function g(){var a=new Pymatch([]),b=z,c=function(c){a.setNames(_.map(b,function(a){return IX.inherit(a,{name:a.foodName})}));var d=a.match(c),e={};return _.each(d,function(a){e[a[0].foodID]=!0}),e};M.chosen({width:"200px",placeholder_text:"选择或输入菜品名称",no_results_text:"抱歉，没有相关菜品！",allow_single_deselect:!0,getMatchedFn:c}).change(function(){k()})}function h(){var c=a(b).scrollTop()+a(b).height(),d=P.offset().top+P.height();c>d&&A<z.length&&m()}function j(a,b){if(a.files&&a.files[0]){var c=new FileReader;c.onload=function(a){b.attr("src",a.target.result)},c.readAsDataURL(a.files[0])}}function k(){var b=N.filter(":checked"),c=a.trim(L.val()),d=a.trim(M.val());c||d||b.length?(C={},c&&(C.takeawayTag=c),d&&(C.foodID=d),b.each(function(){"isHasImage"==this.id?C.isHasImage="0":C[this.id]="1"})):C=null,A=0,m()}function m(a){z=o(),O.text(z.length),0==A&&P.empty(),P.append(G({foods:z.slice(a?0:A,A+B)})),A+=B,P.find("img").lazyload()}function n(a,b){for(var c=x[a].foods,d=c.length;d--;)if(c[d].foodID==b)return c[d];return null}function o(){var b=[];if(y)b=x[y].foods;else for(var c in x)b.push.apply(b,x[c].foods);for(p in C)b=a.grep(b,function(a){return a[p]==C[p]});return b}function q(a){var b={};for(i=0,l=a.length;l>i;i++){var c=a[i],d=c.foodCategoryID;if(b[d]=b[d]||{foods:[],foodCategoryName:c.foodCategoryName},c.foodID){r(c),c.takeoutPackagingFee=c.takeoutPackagingFee>0?parseFloat(c.takeoutPackagingFee):"",(-1==c.prePrice||c.prePrice==c.price)&&(c.prePrice=c.price,c.price=""),(-1==c.vipPrice||c.vipPrice>=c.prePrice)&&(c.vipPrice=""),c.price=c.price||"",c.prePrice=c.prePrice||"",c.vipPrice=c.vipPrice||"";var e=b[d].foods,f={unit:c.unit?c.unit+":":"",price:c.price?"￥"+parseFloat(c.price):"",prePrice:c.prePrice?"￥"+parseFloat(c.prePrice):"",vipPrice:c.vipPrice?"￥"+parseFloat(c.vipPrice):""},g=s(e,c,"foodID");-1==g?(c.units=[f],e.push(c)):e[g].units.push(f)}}return b}function r(a){var b=a.imgePath;if(b){var c=a.imageHWP,d=92,e=c>1?d:Math.round(d/c),f=c>1?Math.round(d*c):d;a.imgSrc=imgHost+b.replace(/\.\w+$/,(c?"="+e+"x"+f:"")+"$&?quality=70")}else a.imgSrc=imgRoot+"dino80.png";a.discountIco=1==a.isDiscount?"glyphicon-ok":"glyphicon-minus",a.takeawayIco=a.takeawayTag>0?"glyphicon-ok":"glyphicon-minus",a.activeIco=1==a.foodIsActive?"glyphicon-ok":"glyphicon-minus"}function s(a,b,c){for(var d=0,e=a.length;e>d;d++)if(a[d][c]==b[c])return d;return-1}if(f){var t=Hualala.Global,u=Hualala.UI,v=u.TopTip,w=f;imgHost=t.IMAGE_RESOURCE_DOMAIN+"/",imgRoot=t.IMAGE_ROOT+"/";var x=null,y="",z=null,A=0,B=10,C=null,D=["hotTag","takeawayTag","isDiscount"],E=null,F=null,G=Handlebars.compile(Hualala.TplLib.get("tpl_food")),H=Handlebars.compile(Hualala.TplLib.get("tpl_edit_food")),I=a(Hualala.TplLib.get("tpl_shop_menu")),J=null,K=I.find("#foodSearch"),L=K.find("#takeawayTag"),M=K.find("#foodName"),N=K.find("input[type=checkbox]"),O=(I.find(".tbl-foods thead"),I.find("#foodSearchInfo span")),P=I.find(".tbl-foods tbody"),Q=null,R=null,S=null;t.getShopMenu({shopID:w},function(b){if("000"!=b.resultcode)return void(b.resultmsg&&v({msg:b.resultmsg,type:"danger"}));x=q(b.data.records),m();var c=I.find("#foodClassBox").append(a('<span class="current-food-class"></span>').text("全部菜品 ("+z.length+")"));for(var e in x){var f=x[e];a("<span></span>").data("id",e).text(f.foodCategoryName+" ("+f.foods.length+")").appendTo(c)}J=c.find("span");var h=Handlebars.compile(Hualala.TplLib.get("tpl_food_name"));M.html(h({classifiedFoods:x})),g(),I.appendTo(d)}),a(b).on("scroll",function(){c(h)}),a(document).on("change",function(b){var c=a(b.target);if(c.is("#takeawayTag , #foodSearch input[type=checkbox]")&&k(),c.is(".form-food input[type=radio]")&&c.closest("div").find("label").removeClass("active").find("input:checked").parent().addClass("active"),c.is(".food-pic input")){var d=Q.filter(".food-pic");c.val()&&(d.addClass("loading"),j(c[0],d.find("img")),d.submit())}}),top.imgCallback=function(b){var c=Q.filter(".food-pic"),d=a.parseJSON(b),e=d.status;if("success"==e){var f=d.url,g=d.imageHWP||"";F.imgePath=f,g&&(F.imageHWP=g),FileReader||c.find("img").attr("src",imgHost+f.replace(/\.\w+$/,(g?"=200x"+Math.round(200*g):"")+"$&?quality=70"))}else v({msg:e+"：菜品图片上传失败"});c.removeClass("loading"),a("#imgResponse").remove()},P.on("click","tr",function(){var b=a(this);E=n(b.data("cid"),b.data("id"));var c=["isSpecialty","isRecommend","isNew"],d=E.imgePath,e=E.imageHWP;E.foodPic=d?imgHost+d.replace(/\.\w+$/,(e?"=200x"+Math.round(200*E.imageHWP):"")+"$&?quality=70"):imgRoot+"food_bg.png",E.hotTag1=imgRoot+"hottag1.png",E.hotTag2=imgRoot+"hottag2.png",E.hotTag3=imgRoot+"hottag3.png",Q=a(H(E)),R=new u.ModalDialog({id:"editFood",title:"修改菜品",html:Q,hideCloseBtn:!1}).show(),R._.footer.find(".btn-ok").text("保存修改"),R._.footer.find(".btn-close").text("返回"),S=Q.filter(".form-food").bootstrapValidator({fields:{minOrderCount:{validators:{notEmpty:{message:"起售份数不能为空"},integer:{message:"起售份数必须是整数"},between:{min:1,max:99,message:"起售份数必须在1到99之间"}}}}}).data("bootstrapValidator"),F={shopID:w,foodID:b.data("id")};for(var f=c.length;f--;){var g=c[f];F[g]="0",1==E[g]&&Q.find("input[name=foodIco][value="+g+"]").prop("checked",!0).trigger("change")}for(var f=D.length;f--;){var h=D[f];Q.find("input[name="+h+"][value="+E[h]+"]").prop("checked",!0).trigger("change")}Q.find("input[name=isActive][value="+E.foodIsActive+"]").prop("checked",!0).trigger("change")}),a(document).on("click",function(b){var c=a(b.target);if(c.is("#editFood .btn-ok")){if(!S.validate().isValid())return;var d=Q.find("input[name=foodIco]:checked").not("[value=none]");d[0]&&(F[d.val()]="1");for(var e=D.length;e--;){var f=D[e];F[f]=Q.find("input[name="+f+"]").filter(":checked").val()}F.isActive=Q.find("input[name=isActive]:checked").val(),F.minOrderCount=Q.find("input[name=minOrderCount]").val(),F.tasteList=a.trim(Q.find("input[name=tasteList]").val()),t.updateFood(F,function(b){return"000"!=b.resultcode?void(b.resultmsg&&v({msg:b.resultmsg,type:"danger"})):(R.hide(),a.extend(E,F),E.foodIsActive=E.isActive,r(E),P.empty(),void m(!0))})}c.is("#foodClassBox span")&&(J.removeClass("current-food-class"),c.addClass("current-food-class"),y=c.data("id"),L.val(""),M.val(""),N.prop("checked",!1),C=null,A=0,m())})}}}(jQuery,window),function(){}(jQuery,window),function(a){IX.ns("Hualala.Shop"),Hualala.Shop.createShopInfoHead=function(b,c,d){var e=c||a("#ix_wrapper > .ix-body > .container"),f=a('<div class="bs-callout shop-info-head"></div>');!d&&f.appendTo(e);var g=function(b){var c={shopName:b.shopName,shopUrl:Hualala.Common.getShopUrl(b.shopID),shopListLink:Hualala.PageRoute.createPath("shop"),checked:1==b.status?"checked":""},e=Handlebars.compile(Hualala.TplLib.get("tpl_shop_info_head"));f.append(a(e(c))).find("input").bootstrapSwitch({onColor:"success",onText:"已开通",offText:"未开通"}).on("switchChange.bootstrapSwitch",function(c,d){var e=a(this);Hualala.Global.switchShopStatus({shopID:b.shopID,status:d},function(a){return"000"!=a.resultcode?(e.bootstrapSwitch("toggleState",!0),void(a.resultmsg&&Hualala.UI.TopTip({msg:a.resultmsg,type:"danger"}))):void 0})}),f.find("#resetPwd").on("click",function(){var c=Handlebars.compile(Hualala.TplLib.get("tpl_set_shop_client_pwd")),d=a(c(b)),e=new Hualala.UI.ModalDialog({id:"resetCltPwdDlg",title:"重置客户端密码",html:d,sizeCls:"modal-sm",hideCloseBtn:!1}).show(),f=d.find(".has-feedback"),g=f.find(".form-control-feedback"),h=f.find("small"),i=d.find("#shopClinetPwd").data("validate",!1).on("blur",function(){var b=a(this),c=a.trim(b.val()).length;b.data("validate",!1),c?6>c||c>16?h.text("密码长度必须在6到16个字符之间"):(h.text(""),b.data("validate",!0)):h.text("密码不能为空");var d=b.data("validate");f.toggleClass("has-success",d).toggleClass("has-error",!d),g.toggleClass("glyphicon-ok",d).toggleClass("glyphicon-remove",!d)});d.find("#showPwd").change(function(){i.attr("type",this.checked?"text":"password")}),e._.footer.find(".btn-ok").on("click",function(){i.trigger("blur").data("validate")&&Hualala.Global.setShopClientPwd({shopID:b.shopID,hLLAgentLoginPWD:i.val()},function(a){return"000"!=a.resultcode?void(a.resultmsg&&Hualala.UI.TopTip({msg:a.resultmsg,type:"danger"})):(e.hide(),void Hualala.UI.TopTip({msg:"重置客户端密码成功！",type:"success"}))})})}),d&&d(f)};return a.isPlainObject(b)?void g(b):void Hualala.Global.getShopInfo({shopID:b},function(a){if("000"!=a.resultcode)return void(a.resultmsg&&Hualala.UI.TopTip({msg:a.resultmsg,type:"danger"}));var b=a.data.records[0];g(b)})},Hualala.Shop.createShopFuncNav=function(b,c,d){var e=["shopInfo","shopMenu"],f=Hualala.PageRoute,g=a('<ul class="nav navbar-nav"></ul>'),h=d||a("#ix_wrapper > .ix-body > .container");for(i=0,l=e.length;l>i;i++){var j=e[i],k=j==b,m=k?"javascript:;":f.createPath(j,[c]),n=f.getPageLabelByName(j);a("<li></li>").toggleClass("active",k).append(a("<a></a>").attr("href",m).text(n)).appendTo(g)}return a('<div class="navbar navbar-default shop-func-nav"></div>').append(g).appendTo(h)};var b=function(){{var b=a("#ix_wrapper > .ix-body > .container");new Hualala.Shop.QueryController({needShopCreate:!0,container:b,resultController:new Hualala.Shop.ShopListController({container:b,model:new Hualala.Shop.CardListModel({callServer:Hualala.Global.queryShop}),view:new Hualala.Shop.CardListView})})}};Hualala.Shop.HomePageInit=b;var c=function(b,c){var d=a("#ix_wrapper > .ix-body > .container");Hualala.UI.BreadCrumb({container:d,hideRoot:!0,nodes:Hualala.PageRoute.getParentNamesByPath()}),Hualala.Shop.initInfo(d,b,c)};Hualala.Shop.BaseInfoMgrInit=c;var d=function(b,c){var d=a("#ix_wrapper > .ix-body > .container");Hualala.UI.BreadCrumb({container:d,hideRoot:!0,nodes:Hualala.PageRoute.getParentNamesByPath()}),Hualala.Shop.createShopInfoHead(c,d),Hualala.Shop.createShopFuncNav(b,c,d),Hualala.Shop.initMenu(d,b,c)};Hualala.Shop.FoodMenuMgrInit=d;var e=function(){var b=a("#ix_wrapper > .ix-body > .container");Hualala.UI.BreadCrumb({container:b,hideRoot:!0,nodes:Hualala.PageRoute.getParentNamesByPath()});var c=Handlebars.compile(Hualala.TplLib.get("tpl_shop_create")),d=a(c({pcClientPath:Hualala.PageRoute.createPath("pcclient")}));b.append(d),Hualala.Shop.initCreate(d)};Hualala.Shop.CreateShopInit=e}(jQuery,window),function(a){IX.ns("Hualala.Setting");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,{advanceTime:{type:"combo",label:"用户提前预订时间",defaultVal:0,options:Hualala.TypeDef.MinuteIntervalOptions(),validCfg:{validators:{notEmpty:{message:"用户提前预订时间不能为空"}}}},noticeTime:{type:"combo",label:"订单提前通知时间",defaultVal:0,options:Hualala.TypeDef.MinuteIntervalOptions(),validCfg:{validators:{notEmpty:{message:"订单提前通知时间不能为空"}}}},minAmount:{type:"text",label:"最低消费金额",prefix:"￥",surfix:Hualala.Constants.CashUnit,defaultVal:0,validCfg:{validators:{notEmpty:{message:"最低消费金额不能为空"},numeric:{message:"最低消费金额必须为数字"},greaterThan:{inclusive:!0,value:0,message:"最低消费金额必须大于或等于0"}}}},serviceAmount:{type:"text",label:"服务费",prefix:"￥",surfix:Hualala.Constants.CashUnit,defaultVal:0,validCfg:{validators:{numeric:{message:"服务费必须为数字"},greaterThan:{inclusive:!0,value:0,message:"服务费必须大于或等于0"}}}},freeServiceAmount:{type:"text",label:"免服务费菜品金额",prefix:"￥",surfix:Hualala.Constants.CashUnit,defaultVal:0,validCfg:{validators:{numeric:{message:"免服务费菜品金额必须为数字"},greaterThan:{inclusive:!0,value:0,message:"免服务费菜品金额必须大于或等于0"}}}},holidayFlag:{type:"combo",label:"节假日开放",defaultVal:0,options:Hualala.TypeDef.HolidayFlagOptions,validCfg:{validators:{notEmpty:{message:"节假日开放不能为空"}}}},openDays:{type:"text",label:"开放服务天数",surfix:"天",defaultVal:"",validCfg:{validators:{notEmpty:{message:"开放服务天数不能为空"},digits:{message:"开放服务天数必须为数字"},greaterThan:{inclusive:!0,value:0,message:"开放服务天数必须大于或等于0"}}}},servicePeriods:{type:"section",label:"开放时段",min:{type:"timepicker",surfix:'<span class="glyphicon glyphicon-time"></span>',defaultVal:"",validCfg:{group:".min-input",validators:{notEmpty:{message:"起始时间不能为空"}}}},max:{type:"timepicker",surfix:'<span class="glyphicon glyphicon-time"></span>',defaultVal:"",validCfg:{group:".max-input",validators:{notEmpty:{message:"结束时间不能为空"}}}}},reserveTableTime:{type:"combo",label:"留位时间",defaultVal:0,options:Hualala.TypeDef.MinuteIntervalOptions(60),validCfg:{validators:{notEmpty:{message:"留位时间不能为空"},numeric:{message:"留位时间必须为数字"},greaterThan:{inclusive:!0,value:0,message:"留位时间必须大于或等于0"}}}},reserveTableDesc:{type:"text",label:"留位特别说明",defaultVal:"",validCfg:{validators:{stringLength:{max:40,message:"留位特别说明不能超过40个字"}}}},takeawayDeliveryAgent:{type:"text",label:"配送单位",defaultVal:"自助配送",validCfg:{}},takeawayDeliveryTime:{type:"text",label:"预计送餐所需时间",surfix:"分钟",defaultVal:"",validCfg:{validators:{notEmpty:{message:"预计送餐所需时间不能为空"},numeric:{message:"预计送餐所需时间必须为数字"},greaterThan:{inclusive:!0,value:0,message:"预计送餐所需时间必须大于或等于0"}}}},takeawayScope:{type:"text",label:"送餐范围",surfix:"公里",defaultVal:"",validCfg:{validators:{notEmpty:{message:"送餐范围不能为空"},numeric:{message:"送餐范围必须为数字"},greaterThan:{inclusive:!0,value:0,message:"送餐范围必须大于或等于0"}}}},takeawayScopeDesc:{type:"text",label:"送餐范围说明",defaultVal:"",validCfg:{validators:{stringLength:{max:200,message:"送餐范围说明不能超过200个字"}}}},submitSMSTemplateID:{type:"hidden",defaultVal:""},checkSMSTemplateID:{type:"hidden",defaultVal:""},payMethod:{type:"combo",label:"可选支付方式",defaultVal:0,options:Hualala.TypeDef.PayMethodOptions,validCfg:{validators:{notEmpty:{message:"可选支付方式不能为空"}}}},needInputTableName:{type:"switcher",label:"下单时输入桌号",defaultVal:1,onLabel:"需要",offLabel:"不需要",validCfg:{validators:{}}},supportInvoice:{type:"switcher",label:"提供发票",defaultVal:1,onLabel:"需要",offLabel:"不需要",validCfg:{validators:{}}},supportCommitToSoftware:{type:"switcher",label:"下单到餐饮软件",defaultVal:1,onLabel:"支持",offLabel:"不支持",validCfg:{validators:{}}},payMethodAtShop:{type:"combo",label:"店内支付方式",defaultVal:0,options:Hualala.TypeDef.PayMethodAtShopOptions,validCfg:{validators:{notEmpty:{message:"店内支付方式不能为空"}}}},checkSpotOrder:{type:"switcher",label:"支持手机结账",defaultVal:0,onLabel:"支持",offLabel:"不支持",validCfg:{validators:{}}},payBeforeCommit:{type:"switcher",label:"支持餐前结账",defaultVal:1,onLabel:"支持",offLabel:"不支持",validCfg:{validators:{}}},fetchFoodMode:{type:"combo",label:"取餐模式",defaultVal:0,options:Hualala.TypeDef.FetchFoodModeOptions,validCfg:{validators:{notEmpty:{message:"取餐模式不能为空"}}}}}),c=new IX.IListManager;_.each(b,function(a,b){var d=$XP(a,"type"),e="col-sm-offset-1 col-sm-3 control-label";if("section"==d){var f=minID=b+"_min_"+IX.id(),g=b+"_max_"+IX.id(),h=b+"_min",i=b+"_max",j=IX.inherit($XP(a,"min",{}),{id:minID,name:h,clz:"col-sm-3"}),k=IX.inherit($XP(a,"max",{}),{id:g,name:i,clz:"col-sm-3"});c.register(b,IX.inherit(a,{id:f,labelClz:e,min:j,max:k}))}else c.register(b,IX.inherit(a,{id:b+"_"+IX.id(),name:b,labelClz:e,clz:"col-sm-5"}))});var d=Stapes.subclass({constructor:function(a){if(this.$trigger=$XP(a,"triggerEl"),this.serviceID=$XP(a,"serviceID",null),this.serviceName=$XP(a,"serviceName",null),this.model=$XP(a,"model",null),this.serviceList=Hualala.TypeDef.ShopBusiness,this.modal=null,!this.serviceID||!this.serviceName||!this.model)throw"Service View init failed!";if(this.loadTemplates(),this.serviceInfo=this.getServiceInfo("id",this.serviceID),this.callServer=$XP(this.serviceInfo,"callServer",""),IX.isFn(this.callServer))this.callServer=this.callServer;else{if(!IX.isString(this.callServer))throw"Configuration failed : Invalid Page Initialized for "+this.callServer;IX.nsExisted(this.callServer)&&(this.callServer=IX.getNS(this.callServer))}var b=this.model.get("revParamJson")||null;b=b?JSON.parse(b):{},this.formParams=$XP(b,this.serviceID),this.initModal(),this.renderForm(),this.bindEvent(),this.emit("show")}});d.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_shop_service_form_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns"));Handlebars.registerHelper("checkFormElementType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),Handlebars.registerHelper("isInputGroup",function(a,b,c){return a||b?c.fn(this):c.inverse(this)}),this.set({layoutTpl:a,btnTpl:b})},initModal:function(){var a=this;a.modal=new Hualala.UI.ModalDialog({id:"service_edit",clz:"service-modal",title:a.getModalTitle(),afterRemove:function(){}})},initSwitcher:function(b){var c=this;c.modal._.body.find(b).each(function(){var b=a(this),c=b.attr("data-onLabel"),d=b.attr("data-offLabel");b.bootstrapSwitch({size:"normal",onColor:"primary",offColor:"default",onText:c,offText:d})})},initTimePicker:function(a){var b=this;b.modal._.body.find(a).timepicker({minuteStep:30,showSeconds:!1,showMeridian:!1,disableFocus:!0,showInputs:!1})},getServiceInfo:function(a,b){var c=this,d=c.model.get("operationMode"),e=IX.inherit({},_.find(this.serviceList,function(c){return c[a]==b}));return IX.isEmpty($XP(e,"operationMode"))||(e=IX.inherit(e,{formKeys:$XP(e,"operationMode."+d)})),e},getModalTitle:function(){return $XP(this.serviceInfo,"label")+"配置"},bindEvent:function(){var b=this,c=b.initValidFieldOpts();this.on({show:function(){this.modal.show()},hide:function(){this.modal.hide()}}),b.modal._.dialog.find(".btn").on("click",function(){var c=a(this),d=c.attr("name");if("cancel"==d)b.emit("hide");else{var e=b.modal._.body.find("form").data("bootstrapValidator");c.button("提交中..."),e.validate()}}),b.modal._.body.find("form").bootstrapValidator({trigger:"blur",fields:c}).on("error.field.bv",function(b){{var c=a(b.target);c.data("bootstrapValidator")}}).on("success.form.bv",function(c){c.preventDefault();var d=a(c.target),e=(d.data("bootstrapValidator"),b.serializeForm());IX.Debug.info("DEBUG: Shop Business Service Edit View Form Params : "),IX.Debug.info(e),b.model.emit("setServiceParams",{callServer:b.callServer,params:e,serviceID:b.serviceID,failFn:function(){b.modal._.footer.find(".btn[name=submit]").button("reset")},successFn:function(){b.modal._.footer.find(".btn[name=submit]").button("reset"),b.emit("hide")}})})},decodeTimeStr:function(a){return 0==a.length?"":a.substr(0,2)+":"+a.substr(2)},encodeTimeStr:function(a,b){return(a+","+b).replace(/\:/g,"")},mapServiceFormElsData:function(){var a=this,b=$XP(a.serviceInfo,"formKeys","").split(","),d=_.map(b,function(b){var d=c.get(b),e=$XP(d,"type");if("section"==e&&"servicePeriods"==b){var f=$XP(a.formParams,b,"").split(",");return f=_.map(f,function(b){return a.decodeTimeStr(b)}),IX.inherit(d,{min:IX.inherit($XP(d,"min"),{value:f[0]||$XP(d,"min.defaultVal")}),max:IX.inherit($XP(d,"max"),{value:f[1]||$XP(d,"max.defaultVal")})})}if("combo"==e){var f=$XP(a.formParams,b,$XP(d,"defaultVal")),g=_.map($XP(d,"options"),function(a){return IX.inherit(a,{selected:$XP(a,"value")==f?"selected":""})});return IX.inherit(d,{value:$XP(a.formParams,b,$XP(d,"defaultVal")),options:g})}return"switcher"==e?IX.inherit(d,{checked:$XP(a.formParams,b)==$XP(d,"defaultVal")?"checked":""}):IX.inherit(d,{value:$XP(a.formParams,b,$XP(d,"defaultVal"))})});return IX.Debug.info("DEBUG: Shop Business Service Edit View Form Elements : "),IX.Debug.info(d),d},renderForm:function(){var a=this,b=(a.initValidFieldOpts(),a.mapServiceFormElsData()),c=a.get("layoutTpl"),d=a.get("btnTpl"),e=c({formClz:"shop-service-form",items:b});a.modal._.body.html(e),a.modal._.footer.html(d({btns:[{clz:"btn-default",name:"cancel",label:"取消"},{clz:"btn-warning",name:"submit",label:"保存"}]})),a.initSwitcher(":checkbox[data-type=switcher]"),a.initTimePicker("[data-type=timepicker]")},serializeForm:function(){{var b=this,d=$XP(b.serviceInfo,"formKeys","").split(","),e={};_.map(d,function(d){var f=c.get(d),g=$XP(f,"type");if("section"==g&&"servicePeriods"==d){var h=a("[name="+d+"_min]").val(),i=a("[name="+d+"_max]").val();e[d]=b.encodeTimeStr(h,i)}else e[d]="switcher"==g?a("[name="+d+"]").data("bootstrapSwitch").options.state?1:0:a("[name="+d+"]").val()})}return e},initValidFieldOpts:function(){var a=this,b=$XP(a.serviceInfo,"formKeys","").split(","),d={};return _.each(b,function(a){var b=c.get(a),e=$XP(b,"type");if("section"==e){var f=a+"_min",g=a+"_max";d[f]=$XP(b,"min.validCfg",{}),d[g]=$XP(b,"max.validCfg",{})}else d[a]=$XP(b,"validCfg",{})}),d}}),Hualala.Setting.editServiceView=d}(jQuery,window),function(a){IX.ns("Hualala.Setting");var b=function(){{var b=a("#ix_wrapper > .ix-body > .container");new Hualala.Shop.QueryController({needShopCreate:!1,container:b,resultController:new Hualala.Shop.ShopListController({container:b,model:new Hualala.Shop.CardListModel({callServer:Hualala.Global.queryShop}),view:new Hualala.Shop.ShopListView})})}};Hualala.Setting.ShopMgrInit=b}(jQuery,window),function(){IX.ns("Hualala.Account");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip),b=Hualala.Shop.CardListModel,c=b.subclass({constructor:b.prototype.constructor});c.proto({init:function(a){this.set({pageCount:0,totalSize:0,pageNo:$XP(a,"pageNo",1),pageSize:$XP(a,"pageSize",15),transCreateBeginTime:$XP(a,"transCreateBeginTime",""),transCreateEndTime:$XP(a,"transCreateEndTime",""),settleUnitID:$XP(a,"settleUnitID",""),transStatus:$XP(a,"transStatus",""),transType:$XP(a,"transType",""),groupID:$XP(a,"groupID",""),minTransAmount:$XP(a,"minTransAmount",""),maxTransAmount:$XP(a,"maxTransAmount",""),ds_account:new IX.IListManager,ds_page:new IX.IListManager})},updatePagerParams:function(a){var b=this,c="pageCount,totalSize,pageNo,pageSize,transCreateBeginTime,transCreateEndTime,settleUnitID,transStatus,transType,groupID,minTransAmount,maxTransAmount";_.each(a,function(a,d){c.indexOf(d)>-1&&b.set(d,a)})},getPagerParams:function(){return{pageNo:this.get("pageNo"),pageSize:this.get("pageSize"),settleUnitID:this.get("settleUnitID"),transCreateBeginTime:this.get("transCreateBeginTime"),transCreateEndTime:this.get("transCreateEndTime"),transStatus:this.get("transStatus"),transType:this.get("transType"),groupID:this.get("groupID"),minTransAmount:this.get("minTransAmount"),maxTransAmount:this.get("maxTransAmount")}},updateDataStore:function(a,b){var c=this,e=c.get("ds_account"),f=c.get("ds_page"),g=_.map(a,function(a){var b=$XP(a,"settleUnitID"),c=new d(a);return e.register(b,c),b});f.register(b,g)},resetDataStore:function(){var a=this,b=a.get("ds_account"),c=a.get("ds_page");b.clear(),c.clear()},load:function(b,c){var d=this;d.updatePagerParams(b),d.callServer(d.getPagerParams(),function(b){"000"==b.resultcode?(d.updateDataStore($XP(b,"data.records",[]),$XP(b,"data.page.pageNo")),d.updatePagerParams(IX.inherit($XP(b,"data",{}),$XP(b,"data.page",{})))):a({msg:$XP(b,"resultmsg",""),type:"danger"}),c(d)})},getAccounts:function(a){var b=this,c=b.get("ds_account"),d=b.get("ds_page"),e=_.map(c.getByKeys(d.get(a)),function(a){return a.getAll()});return IX.Debug.info("DEBUG: Account List Model PageData :"),IX.Debug.info(e),e},getAccountModelByID:function(a){var b=this,c=b.get("ds_account");return c.get(a)}}),Hualala.Account.AccountListModel=c;var d=Stapes.subclass({constructor:function(a){!IX.isEmpty(a)&&this.set(a),this.bindEvent()}});d.proto({bindEvent:function(){var b=this;b.on({load:function(a){var c=$XP(a,"settleUnitID"),d=$XF(a,"cbFn"),e=Hualala.Global.queryAccount,f=$XP(Hualala.getSessionSite(),"groupID","");e({settleUnitID:c,groupID:f},function(a){var e=$XP(a,"data.records",[]);if(0==e.length)throw"get Account Data ("+c+") Failed!";b.set(e[0]),d()})},withdrawCash:function(c){var d=Hualala.Global.withdrawCash,e=$XP(c,"params",{}),f=b.get("settleUnitID"),g=$XF(c,"failFn"),h=$XF(c,"successFn"),i=b.get("poundageAmount")||0,j=b.get("poundageMinAmount")||0;d(IX.inherit(e,{settleUnitID:f,poundageAmount:i,poundageMinAmount:j}),function(c){if("000"!==c.resultcode)a({msg:$XP(c,"resultmsg",""),type:"danger"}),g();else{var d=$XP(e,"transAmount",0),f=b.get("settleBalance")||0,i=Hualala.Common.Math.sub(f-d);b.set("settleBalance",i),h(),a({msg:"提现成功!",type:"success"})}})},"delete":function(c){var d=Hualala.Global.deleteAccount,e=b.get("settleUnitID"),f=$XP(Hualala.getSessionSite(),"groupID",""),g=$XF(c,"failFn"),h=$XF(c,"successFn");d({settleUnitID:e,groupID:f},function(b){"000"!==b.resultcode?(a({msg:$XP(b,"resultmsg",""),type:"danger"}),g(e)):(a({msg:"删除成功!",type:"success"}),h(e))})},edit:function(c){var d=Hualala.Global.editAccount,e=b.get("settleUnitID"),f=$XP(Hualala.getSessionSite(),"groupID",""),g=$XF(c,"failFn"),h=$XF(c,"successFn");d(IX.inherit($XP(c,"params",{}),{groupID:f,settleUnitID:e}),function(d){"000"!==d.resultcode?(a({msg:$XP(d,"resultmsg",""),type:"danger"}),g(e)):(a({msg:"修改成功!",type:"success"}),b.set($XP(c,"params",{})),h(e))})},add:function(c){var d=Hualala.Global.addAccount,e=$XP(Hualala.getSessionSite(),"groupID",""),f=$XF(c,"failFn"),g=$XF(c,"successFn");d(IX.inherit($XP(c,"params",{}),{groupID:e}),function(d){"000"!==d.resultcode?(a({msg:$XP(d,"resultmsg",""),type:"danger"}),f()):(a({msg:"添加成功!",type:"success"}),b.set($XP(c,"params",{})),g())})}})}}),Hualala.Account.BaseAccountModel=d;var e=c.subclass({constructor:function(){this.callServer=Hualala.Global.queryAccountTransDetail}});e.proto({init:function(a){this.set({pageCount:0,totalSize:0,pageNo:$XP(a,"pageNo",1),pageSize:$XP(a,"pageSize",15),transCreateBeginTime:$XP(a,"transCreateBeginTime",""),transCreateEndTime:$XP(a,"transCreateEndTime",""),settleUnitID:$XP(a,"settleUnitID",""),transStatus:$XP(a,"transStatus",""),transType:$XP(a,"transType",""),groupID:$XP(a,"groupID",""),minTransAmount:$XP(a,"minTransAmount",""),maxTransAmount:$XP(a,"maxTransAmount",""),ds_trans:new IX.IListManager,ds_page:new IX.IListManager})},updateDataStore:function(a,b){var c=this,d=c.get("ds_trans"),e=c.get("ds_page"),g=_.map(a,function(a){var b=$XP(a,"SUATransItemID"),c=new f(a);return d.register(b,c),b});e.register(b,g)},resetDataStore:function(){var a=this,b=a.get("ds_trans"),c=a.get("ds_page");b.clear(),c.clear()},load:function(b,c){var d=this;d.updatePagerParams(b),d.callServer(d.getPagerParams(),function(b){"000"==b.resultcode?(d.updateDataStore($XP(b,"data.records",[]),$XP(b,"data.page.pageNo")),d.updatePagerParams(IX.inherit($XP(b,"data",{}),$XP(b,"data.page",{})))):a({msg:$XP(b,"resultmsg",""),type:"danger"}),c(d)})},getDataByPageNo:function(a){var b=this,c=b.get("ds_trans"),d=b.get("ds_page"),e=_.map(c.getByKeys(d.get(a)),function(a){return a.getAll()});return IX.Debug.info("DEBUG: Account TransList Model PageData :"),IX.Debug.info(e),e},getModelByID:function(a){var b=this,c=b.get("ds_trans");return c.get(a)}}),Hualala.Account.AccountTransListModel=e;var f=d.subclass({constructor:d.prototype.constructor});f.proto({bindEvent:function(){}}),Hualala.Account.BaseTransactionModel=f;var g=Hualala.Shop.QueryModel.subclass({constructor:function(){this.origCities=[],this.origAreas=[],this.origShops=[],this.isReady=!1,this.callServer=Hualala.Global.getAccountQueryShop}});Hualala.Account.AccountQueryShopModel=g;var h=Hualala.Shop.CardListModel.subclass({constructor:function(){this.origData=null,this.dataStore=new IX.IListManager}});h.proto({initDataStore:function(a){var b=this;b.origData=a,_.each(b.origData,function(a){b.dataStore.register($XP(a,"shipID"),a)})},load:function(a,b){var c=this;c.updatePagerParams(a);var d=c.get("pageNo"),e=c.get("pageSize"),f=c.get("cityID"),g=c.get("areaID"),h=c.get("keywordLst"),i=0,j=(d-1)*e,k=e*d,l=0,m=[];m=g.length>0?_.filter(c.origData,function(a){return $XP(a,"areaID")==g
}):c.origData,m=f.length>0?_.filter(m,function(a){return $XP(a,"cityID")==f}):m,m=h.length>0?_.filter(m,function(a){return $XP(a,"shopName")==h}):m,i=m.length,l=Math.ceil(i/e),m=_.filter(m,function(a,b){return b>=j&&k>b}),c.updateDataStore(m,d),c.updatePagerParams({pageCount:l,totalSize:i,pageNo:d,pageSize:e}),b(c)}}),Hualala.Account.AccountQueryShopResultModel=h}(jQuery,window),function(a){IX.ns("Hualala.Account");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.Shop.CardListView),c=b.subclass({constructor:b.prototype.constructor});c.proto({loadTemplates:function(){{var a=Handlebars.compile(Hualala.TplLib.get("tpl_account_list_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_account_list")),c=Handlebars.compile(Hualala.TplLib.get("tpl_account_card"));Handlebars.compile(Hualala.TplLib.get("tpl_addAccount_Card"))}Handlebars.registerPartial("accountCard",Hualala.TplLib.get("tpl_account_card")),Handlebars.registerPartial("addAccountCard",Hualala.TplLib.get("tpl_addAccount_Card")),this.set({layoutTpl:a,listTpl:b,itemTpl:c})},initLayout:function(){var a=this.get("layoutTpl"),b=a();this.$container.append(b),this.$resultBox=this.$container.find(".account-list"),this.$list=this.$container.find(".account-list-body"),this.$pager=this.$container.find(".page-selection"),this.initPager(),this.bindEvent(),this.bindCardEvent()},bindCardEvent:function(){var b=this;b.$list.on("click",".btn.withdraw",function(){{var c=a(this),e=c.parents(".bank-card").attr("data-id");new d({triggerEl:c,settleUnitID:e,model:b.model.getAccountModelByID(e),parentView:b})}}),b.$list.on("click",".create-account",function(){{var c=a(this);new Hualala.Account.AccountEditView({triggerEl:c,mode:"add",model:null,parentView:b})}}),b.on({updateSettleBalance:function(a){var c=a.get("settleUnitID"),d=a.get("settleBalance");b.$container.find("[data-id="+c+"] .cash > strong").html(d)}})},mapRenderData:function(a){var b=_.map(a,function(a){var b=$XP(a,"settleUnitID"),c=0==$XP(a,"defaultAccount",0)?!1:!0,d=Hualala.Common.mapBankInfo($XP(a,"bankCode")),e=Hualala.Common.codeMask($XP(a,"bankAccount",""),0,-4),f=parseFloat($XP(a,"settleBalance",0));return{settleUnitID:b,hasDefault:c,settleUnitName:$XP(a,"settleUnitName",""),disableWithdraw:0>=f?"disabled":"",settleBalance:f,bankIcon:$XP(d,"icon_16",""),bankComName:$XP(d,"name",""),bankAccountStr:$XP(e,"val","").replace(/([\w|*]{4})/g,"$1 ").replace(/([*])/g,"<span>$1</span>"),shopCount:parseInt($XP(a,"shopCount",0)),path:Hualala.PageRoute.createPath("accountDetail",[b])}});return{accountCard:{list:b}}},render:function(){var a=this,b=a.model,c=b.getPagerParams(),d=$XP(c,"pageNo"),e=b.getAccounts(d),f=a.mapRenderData(e),g=a.get("listTpl"),h=g(f);a.emptyBar&&a.emptyBar.destroy(),a.$list.empty(),0==e.length?(a.emptyBar=new Hualala.UI.EmptyPlaceholder({container:a.$list}),a.emptyBar.show()):a.$list.html(h),a.initPager({total:b.get("pageCount"),page:b.get("pageNo"),href:"javascript:void(0);"})},refresh:function(){document.location.reload(!1)}}),Hualala.Account.AccountListView=c;var d=Stapes.subclass({constructor:function(a){if(this.$trigger=$XP(a,"triggerEl"),this.settleUnitID=$XP(a,"settleUnitID",null),this.model=$XP(a,"model",null),this.parentView=$XP(a,"parentView",null),this.modal=null,!this.settleUnitID||!this.model)throw"Withdraw Cash View init failed!";this.loadTemplates(),this.initModal(),this.renderForm(),this.bindEvent(),this.emit("show")}});d.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_withdraw_form")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns"));this.set({layoutTpl:a,btnTpl:b})},initModal:function(){var a=this;a.modal=new Hualala.UI.ModalDialog({id:"account_withdraw",clz:"service-modal",title:"结算账户提现",afterRemove:function(){}})},mapFormElsData:function(){var a=this,b=[{key:"settleUnitName",label:"结算账户名称"},{key:"receiverName",label:"开户名"},{key:"bankName",label:"开户行"},{key:"bankAccount",label:"账号"},{key:"settleBalance",label:"账户余额"}],c=_.map(b,function(b){var c=$XP(b,"key");return{label:$XP(b,"label",""),value:"settleBalance"==c?"<strong>"+a.model.get(c)+"</strong>元":a.model.get(c)}});return{accountInfo:c,formClz:"account-withdraw-form",labelClz:"col-sm-4 control-label",clz:"col-sm-7",id:"transAmount",label:"请输入提现金额",name:"transAmount",value:a.model.get("settleBalance")}},renderForm:function(){var a=this,b=a.mapFormElsData(),c=a.get("layoutTpl"),d=a.get("btnTpl"),e=c(b);a.modal._.body.html(e),a.modal._.footer.html(d({btns:[{clz:"btn-default",name:"cancel",label:"取消"},{clz:"btn-warning",name:"submit",label:"立即提现"}]}))},bindEvent:function(){var b=this;this.on({show:function(){this.modal.show()},hide:function(){this.modal.hide(),this.parentView.emit("updateSettleBalance",b.model)}}),b.modal._.dialog.find(".btn").on("click",function(){var c=a(this),d=c.attr("name");if("cancel"==d)b.emit("hide");else{var e=b.modal._.body.find("form").data("bootstrapValidator");c.button("提交中..."),e.validate()}}),b.modal._.body.find("form").bootstrapValidator({trigger:"blur",fields:{transAmount:{validators:{notEmpty:{message:"提现金额不能为空"},numeric:{message:"提现金额必须为数字"},greaterThan:{inclusive:!1,value:0,message:"提现金额必须大于0"},lessThan:{inclusive:!0,value:b.model.get("settleBalance")},accuracy:{accuracy:2,message:"输入现金只能精确到小数点后2位"}}}}}).on("error.field.bv",function(b){{var c=a(b.target);c.data("bootstrapValidator")}}).on("success.form.bv",function(c){c.preventDefault();var d=a(c.target),e=(d.data("bootstrapValidator"),b.serializeForm());b.model.emit("withdrawCash",{params:e,failFn:function(){b.modal._.footer.find(".btn[name=submit]").button("reset")},successFn:function(){b.modal._.footer.find(".btn[name=submit]").button("reset"),b.emit("hide")}})})},serializeForm:function(){var a=this,b=a.modal._.body;return{transAmount:b.find("#transAmount").val()}}}),Hualala.Account.WithdrawCashView=d;var e={transCreateTime:{type:"section",label:"日期",min:{type:"datetimepicker",surfix:'<span class="glyphicon glyphicon-calendar"></span>',defaultVal:"",validCfg:{group:".min-input",validators:{}}},max:{type:"datetimepicker",surfix:'<span class="glyphicon glyphicon-calendar"></span>',defaultVal:"",validCfg:{group:".max-input",validators:{}}}},transAmount:{type:"section",label:"金额",min:{type:"text",prefix:"￥",surfix:"元",defaultVal:"",validCfg:{validators:{numeric:{message:"金额必须为数字"},greaterThan:{inclusive:!0,value:0,message:"金额必须大于或等于0"}}}},max:{type:"text",prefix:"￥",surfix:"元",defaultVal:"",validCfg:{validators:{numeric:{message:"金额必须为数字"},greaterThan:{inclusive:!0,value:0,message:"金额必须大于或等于0"}}}}},transStatus:{type:"combo",label:"状态",defaultVal:"",options:Hualala.TypeDef.FSMTransStatus,validCfg:{validators:{}}},transType:{type:"combo",label:"类型",defaultVal:"",options:Hualala.TypeDef.FSMTransType,validCfg:{validators:{}}},button:{type:"button",clz:"btn btn-block btn-warning",label:"查询"}},f=new IX.IListManager;_.each(e,function(a,b){var c=$XP(a,"type"),d="col-xs-2 col-sm-2 col-md-2 control-label";if("section"==c){var e=minID=b+"_min_"+IX.id(),g=b+"_max_"+IX.id(),h="transCreateTime"==b?"transCreateBeginTime":"minTransAmount",i="transCreateTime"==b?"transCreateEndTime":"maxTransAmount",j=IX.inherit($XP(a,"min",{}),{id:minID,name:h,clz:"col-xs-5 col-sm-5 col-md-5"}),k=IX.inherit($XP(a,"max",{}),{id:g,name:i,clz:"col-xs-5 col-sm-5 col-md-5"});f.register(b,IX.inherit(a,{id:e,labelClz:d,min:j,max:k}))}else f.register(b,IX.inherit(a,{id:b+"_"+IX.id(),name:b,labelClz:d},"button"!==$XP(a,"type")?{clz:"col-xs-5 col-sm-8 col-md-5"}:null))});var g=[{clz:"",label:"时间"},{clz:"",label:"流水号"},{clz:"",label:"交易状态"},{clz:"",label:"交易类型"},{clz:"",label:"交易金额"},{clz:"",label:"佣金"},{clz:"",label:"手续费"},{clz:"",label:"余额变动"},{clz:"",label:"交易后余额"},{clz:"",label:"操作"}],h=b.subclass({constructor:function(){this.$container=null,this.$queryForm=null,this.$resultBox=null,this.$pager=null,this.loadTemplates()}});h.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_account_detail")),b=Handlebars.compile(Hualala.TplLib.get("tpl_transaQuery_result"));Handlebars.registerPartial("transaQueryForm",Hualala.TplLib.get("tpl_transaQuery_form")),Handlebars.registerPartial("transaQueryResult",Hualala.TplLib.get("tpl_transaQuery_result")),Handlebars.registerHelper("checkFormElementType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),Handlebars.registerHelper("chkColType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),this.set({layoutTpl:a,tableTpl:b})},initLayout:function(){var a=this.get("layoutTpl"),b=[],c="table-striped table-hover",d=g,e={cols:[{colClz:"col-sm-6",items:f.getByKeys(["transCreateTime","transAmount"])},{colClz:"col-sm-4",items:f.getByKeys(["transType","transStatus"])},{colClz:"col-sm-2",items:f.getByKeys(["button"])}]},h=a({query:e,result:{clz:c,thead:d,rows:b}});this.$container.html(h),this.$queryForm=this.$container.find(".query-form"),this.$resultBox=this.$container.find(".query-result"),this.$pager=this.$container.find(".page-selection"),this.render(),this.initQueryEls(),this.bindEvent(),this.bindQueryEvent()},initQueryEls:function(){var b=this;b.$queryForm.find("[data-type=datetimepicker]").datetimepicker({format:"yyyy/mm/dd",startDate:"2010/01/01",autoclose:!0,minView:"month",todayBtn:!0,todayHighlight:!0,language:"zh-CN"}),b.$queryForm.on("click",".input-group-addon",function(){var b=a(this),c=b.prev(":text[data-type=datetimepicker]");c.length>0&&c.datetimepicker("show")})},bindEvent:function(){var b=this;b.$resultBox.tooltip({selector:"[title]"}),b.$resultBox.on("click",".btn[data-href]",function(){var b=a(this),c=b.attr("data-href");IX.isEmpty(c)||(document.location.href=c)}),b.$pager.on("page",function(a,c){var d=b.model.getPagerParams();d.pageNo=c,b.model.emit("load",IX.inherit(d,{pageNo:$XP(d,"pageNo",1),pageSize:$XP(d,"pageSize",15)}))})},bindQueryEvent:function(){var b=this;b.$resultBox.on("click","a[data-orderkey]",function(){{var b=a(this),c=b.attr("data-orderkey")||"",d=b.attr("data-type")||"",e=b.attr("data-id")||"",f=b.attr("data-orderid")||"";new Hualala.Account.AccountTransDetailModal({triggerEl:b,orderKey:c,orderID:f,transType:d,transID:e})}}),b.$queryForm.on("click",".btn",function(){var a=b.getQueryFormParams();b.model.emit("load",a)})},getQueryFormParams:function(){var a=this,b=a.$queryForm.find(">form").serializeArray(),c={};return _.each(b,function(a){var b=$XP(a,"name"),d=$XP(a,"value","");switch(b){case"transCreateBeginTime":case"transCreateEndTime":d=IX.isEmpty(d)?"":IX.Date.getDateByFormat(d,"yyyyMMddHHmmss");break;default:d=IX.isEmpty(d)?"":d}c[b]=d}),IX.Debug.info("DEBUG: Account TransList View Query Form Params : "),IX.Debug.info(c),c},mapTimeData:function(a){var b={value:"",text:""},c="";return IX.isString(a)&&a.length>0&&(c=a.replace(/([\d]{4})([\d]{2})([\d]{2})([\d]{2})([\d]{2})([\d]{2})/g,"$1/$2/$3 $4:$5:$6"),c=IX.Date.getDateByFormat(c,"yyyy/MM/dd HH:mm"),b=IX.inherit({value:a,text:c})),b},mapTransStatus:function(a){a=a+""||"";var b=Hualala.TypeDef.FSMTransStatus,c=_.filter(b,function(b){return $XP(b,"value","")==a});return 0==a.length||0==c.length?{text:"",value:""}:{text:$XP(c[0],"label",""),value:$XP(c[0],"value","")}},mapTransType:function(a){a=a||"";var b=Hualala.TypeDef.FSMTransType,c=_.filter(b,function(b){return $XP(b,"value","")==a});return 0==a.length||0==c.length?{text:"",value:""}:{text:$XP(c[0],"label",""),value:$XP(c[0],"value","")}},mapCashData:function(a){return{text:Hualala.Common.Math.prettyNumeric(a),value:a}},mapTransChanged:function(a){var b=$XP(a,"transAmount",0),c=$XP(a,"transSalesCommission",0),d=$XP(a,"transPoundage",0),e=b-c-d;return{value:e,text:e}},mapColsRenderData:function(a){var b=this,c="transCreateTime,SUATransItemID,transStatus,transType,transAmount,transSalesCommission,transPoundage,transChanged,transAfterBalance,rowControl",d={clz:"",type:"text"},e=_.map(c.split(","),function(c){var e=null;switch(c){case"transCreateTime":e=b.mapTimeData($XP(a,c,""));break;case"SUATransItemID":e={value:$XP(a,c,""),text:$XP(a,c,"")};break;case"transStatus":e=b.mapTransStatus($XP(a,c,""));break;case"transType":e=b.mapTransType($XP(a,c,""));break;case"transAmount":case"transSalesCommission":case"transPoundage":case"transAfterBalance":e=b.mapCashData($XP(a,c,""));break;case"transChanged":e=b.mapTransChanged(a);break;case"rowControl":var f=$XP(a,"transType",""),g=$XP(a,"transStatus",""),h="104,199,202,203,204,205,206,299";e={type:"button",btnClz:h.indexOf(f)>=0||"203"==f&&1>g?"hidden":"",label:"查看",SUATransItemID:$XP(a,"SUATransItemID",""),transType:f,orderKey:$XP(a,"orderKey",""),orderID:$XP(a,"orderID","")}}return IX.inherit(d,e)});return e},mapRenderData:function(a){var b=this,c="table-striped table-hover",d=g,e=_.map(a,function(a){return{clz:"",cols:b.mapColsRenderData(a)}});return{clz:c,isEmpty:0==a.length?!0:!1,colCount:d.length,thead:d,rows:e}},render:function(){var a=this,b=a.model,c=b.getPagerParams(),d=$XP(c,"pageNo"),e=b.getDataByPageNo(d),f=a.mapRenderData(e),g=a.get("tableTpl"),h=g(f);a.$resultBox.empty(),a.$resultBox.html(h),a.initPager({total:b.get("pageCount"),page:b.get("pageNo"),href:"javascript:void(0);"})}}),Hualala.Account.AccountTransListView=h;var i=Hualala.Shop.QueryView.subclass({constructor:Hualala.Shop.QueryView.prototype.constructor});Hualala.Account.AccountQueryShopView=i;var j=b.subclass({constructor:b.prototype.constructor});j.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_shop_list_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_list")),c=Handlebars.compile(Hualala.TplLib.get("tpl_shop_table"));Handlebars.registerPartial("shopTable",Hualala.TplLib.get("tpl_shop_table")),this.set({layoutTpl:a,listTpl:b,itemTpl:c})},mapRenderData:function(a){var b=_.map(a,function(a){return{clz:"",id:$XP(a,"shopID",""),name:$XP(a,"shopName",""),city:$XP(a,"cityName","")}});return{shopTable:{isEmpty:a&&0!=a.length?!1:!0,colCount:3,rows:b}}},render:function(){var a=this,b=a.model,c=b.getPagerParams(),d=$XP(c,"pageNo"),e=b.getShops(d),f=a.mapRenderData(e),g=a.get("listTpl"),h=g(f);a.$list.empty(),a.$list.html(h),a.initPager({total:b.get("pageCount"),page:b.get("pageNo"),href:"javascript:void(0);"})}}),Hualala.Account.AccountQueryShopResultView=j}(jQuery,window),function(){IX.ns("Hualala.Account");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.Account.AccountListModel,Hualala.Account.AccountListView,Hualala.Shop.ShopListController),b=(Hualala.Shop.QueryModel,Hualala.Shop.QueryView,Hualala.Shop.QueryController),c=a.subclass({constructor:a.prototype.constructor});Hualala.Account.AccountListController=c;var d=b.subclass({constructor:function(a){this.set({sessionData:Hualala.getSessionData()}),this.settleUnitID=$XP(a,"settleUnitID",""),this.settleName=$XP(a,"settleName",""),this.shopCount=$XP(a,"shopCount",""),this.container=$XP(a,"container",null),this.needShopCreate=!1,this.model=new Hualala.Account.AccountQueryShopModel,this.view=new Hualala.Account.AccountQueryShopView,this.resultContainer=$XP(a,"resultContainer",null),this.resultController=new Hualala.Account.AccountQueryShopResultController({container:this.resultContainer,model:new Hualala.Account.AccountQueryShopResultModel,view:new Hualala.Account.AccountQueryShopResultView}),this.init()}});d.proto({init:function(){var a=this;a.bindEvent(),a.model.emit("load",function(){if(!a.model.hasReady())throw"Shop Query Init Failed!!";a.resultController.initDataStore(a.model.getShops()),a.view.emit("init")})},bindEvent:function(){this.on({reload:function(){var a=this;a.model.distory(),a.view.distory(),a.init()},query:function(a){var b=this;IX.Debug.info("DEBUG: Account Query Shops Params:"),IX.Debug.info(a),b.resultController&&b.resultController.emit("load",IX.inherit(a,{pageNo:1,pageSize:15}))}},this),this.model.on({load:function(a){var b=this,c={settleUnitID:b.settleUnitID,settleName:b.settleName,shopCount:b.shopCount};b.model.init(c,a)}},this),this.view.on({init:function(){var a=this;a.view.init({model:a.model,needShopCreate:a.needShopCreate,container:a.container})},filter:function(a){var b=this;b.emit("query",a)},query:function(a){var b=this;b.emit("query",a)}},this)}}),Hualala.Account.AccountQueryShopController=d;var e=Hualala.Shop.ShopListController.subclass({constructor:Hualala.Shop.ShopListController.prototype.constructor});e.proto({initDataStore:function(a){this.model.initDataStore(a)},bindEvent:function(){this.on({load:function(a){var b=this;b.hasReady()||b.init(a),b.model.emit("load",a)}},this),this.model.on({load:function(a){var b=this,c=function(){b.view.emit("render")};b.model.load(a,c)}},this),this.view.on({render:function(){var a=this;a.view.render()},reloadPager:function(){var a=this;a.view.initPager(params)}},this)}}),Hualala.Account.AccountQueryShopResultController=e}(jQuery,window),function(){IX.ns("Hualala.Account");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.UI.LoadingModal),b=(Hualala.Account.BaseAccountModel,Stapes.subclass({constructor:function(a){if(this.container=$XP(a,"container",null),this.settleUnitID=$XP(a,"settleUnitID",null),this.model=$XP(a,"accountModel",null),this.view=$XP(a,"mgrView",null),this.transaDetailCtrl=$XP(a,"transaDetailCtrl",null),!(this.container&&this.model&&this.view&&this.transaDetailCtrl))throw"Account Detail Mgr Init Failed!!";this.init()}}));b.proto({init:function(){var a=this;a.bindEvent(),a.model.emit("load",{settleUnitID:a.settleUnitID,cbFn:function(){a.view.emit("init",{model:a.model,container:a.container}),a.view.emit("render")}})},bindEvent:function(){this.on({query:function(){}},this),this.view.on({init:function(a){var b=this;b.view.init(a),b.transaDetailCtrl.init({container:b.container.find(".account-detail-box"),settleUnitID:b.settleUnitID})},render:function(){var a=this;a.view.render()}},this)}}),Hualala.Account.AccountMgrController=b;var c=Stapes.subclass({constructor:function(){this.set({sessionData:Hualala.getSessionData()}),this.container=null,this.settleUnitID=null,this.model=new Hualala.Account.AccountTransListModel,this.view=new Hualala.Account.AccountTransListView}});c.proto({init:function(b){var c=this;if(c.container=$XP(b,"container",null),c.settleUnitID=$XP(b,"settleUnitID",""),c.loadingModal=new a({start:100}),!this.container||!this.model||!this.view)throw"Account Transaction Detail Mgr Init Failed!!";c.bindEvent(),c.model.init({groupID:$XP(c.get("sessionData"),"site.groupID"),settleUnitID:c.settleUnitID}),c.model.emit("load",{pageNo:1,pageSize:15,cbFn:function(a){c.view.emit("init",{container:c.container,model:a}),c.loadingModal.hide()}})},bindEvent:function(){this.model.on({load:function(a){var b=this,c=$XP(a,"cbFn",function(){b.view.emit("render"),b.loadingModal.hide()});b.loadingModal.show(),this.model.load(a,c)}},this),this.view.on({init:function(a){this.view.init(a)},render:function(){this.view.render()}},this)}}),Hualala.Account.TransactionDetailController=c}(jQuery,window),function(a){IX.ns("Hualala.Account");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip),c=[{clz:"btn-success withdraw",act:"withdraw",label:"提现"},{clz:"btn-link",act:"edit",label:"修改银行卡"},{clz:"btn-link",act:"queryShops",label:"查看全部店铺"},{clz:"btn-link",act:"delete",label:"删除此帐户"}],d=Stapes.subclass({constructor:function(){this.$container=null,this.$nav=null,this.breadCrumbs=null,this.$schema=null,this.$detail=null,this.model=null,this.loadTemplates()}});d.proto({init:function(a){if(this.$container=$XP(a,"container",null),this.model=$XP(a,"model",null),!this.$container||!this.model)throw"Account Detail View Init Failed!";this.initLayout()},initLayout:function(){var a=this.get("layoutTpl"),b=a();this.$container.html(b),this.$nav=this.$container.find(".account-nav"),this.$schema=this.$container.find(".account-schema-box"),this.$detail=this.$container.find(".account-detail-box"),this.bindEvent()},initBreadCrumbs:function(){var b=this,c=b.$nav,d=Hualala.PageRoute.getParentNamesByPath();b.breadCrumbs=new Hualala.UI.BreadCrumb({container:c,hideRoot:!0,nodes:d,clz:"account-crumbs",clickFn:function(){var b=a(this);document.location.href=b.attr("data-href")},mapRenderData:function(a,c,d){var e=_.map(a,function(c,d){var e=$XP(c,"label",""),f=$XP(c,"name",""),g=Hualala.PageRoute.createPath(f,[b.model.get("settleUnitID")]);return{clz:"crumb",label:e,path:g,name:f,isLastNode:a.length-1==d?!0:!1}});return c===!0&&e.shift(),{clz:d,items:e}}})},loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_accountMgr_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_account_schema")),c=Handlebars.compile(Hualala.TplLib.get("tpl_withdraw_form"));Handlebars.registerPartial("accountCard",Hualala.TplLib.get("tpl_account_card")),this.set({layoutTpl:a,schemaTpl:b,withDrawTpl:c})},bindEvent:function(){var b=this;b.$schema.on("click",".btn.withdraw",function(){b.withdraw(a(this))}),b.$schema.on("click","[data-act]",function(){var c=a(this).attr("data-act"),d=a(this);switch(c){case"edit":b.editAccount(d);break;case"queryShops":b.queryShops();break;case"delete":b.deleteAccount()}}),b.on({updateSettleBalance:function(a){var c=a.get("settleUnitID"),d=Hualala.Common.Math.prettyNumeric(a.get("settleBalance"));b.$container.find("[data-id="+c+"] .cash > strong").html(d)}})},editAccount:function(a){new g({triggerEl:a,mode:"edit",model:this.model,parentView:this})},withdraw:function(a){{var b=this;new Hualala.Account.WithdrawCashView({triggerEl:a,settleUnitID:b.model.get("settleUnitID"),model:b.model,parentView:b})}},queryShops:function(a){{var b=this;new Hualala.Account.AccountQueryShopModal({triggerEl:a,settleUnitID:b.model.get("settleUnitID"),model:b.model,parentView:b})}},deleteAccount:function(){var a=this;Hualala.UI.Confirm({title:"删除结算账户",msg:"是否删除该账户？",okLabel:"删除",okFn:function(){a.model.emit("delete",{successFn:function(a){document.location.href=Hualala.PageRoute.createPath("account",[a])}})}})},mapRenderData:function(){var a=this,b=a.model,d=c,e=_.filter(IX.clone(d),function(a){return"withdraw"!=$XP(a,"act")}),f=null,g=b.get("settleUnitID")||"",h=0==b.get("defaultAccount")?!1:!0,i=Hualala.Common.mapBankInfo(b.get("bankCode")),j=Hualala.Common.codeMask(b.get("bankAccount")||"",0,-4),k=parseFloat(b.get("settleBalance")||0),l=0>=k?"disabled":"";return f={clz:"pull-left",settleUnitID:g,hasDefault:h,settleUnitName:b.get("settleUnitName")||"",disableWithdraw:l,settleBalance:k,bankIcon:$XP(i,"icon_16",""),bankComName:$XP(i,"name",""),bankAccountStr:$XP(j,"val","").replace(/([\w|*]{4})/g,"$1 ").replace(/([*])/g,"<span>$1</span>"),shopCount:parseInt(b.get("shopCount")||0),path:Hualala.PageRoute.createPath("accountDetail",[g]),isDetail:!0,acts:IX.map(e,function(a,b){return IX.inherit(a,{isFirst:0==b?!0:!1})})},{accountCard:f,acts:_.map(d,function(a){return"queryShops"==$XP(a,"act")?IX.inherit(a,{label:$XP(a,"label","")+"("+parseInt(b.get("shopCount")||0)+")"}):"withdraw"==$XP(a,"act")?IX.inherit(a,{disableWithdraw:l}):a})}},render:function(){var a=this,b=(a.model,a.mapRenderData()),c=a.get("schemaTpl"),d=c(b);a.initBreadCrumbs(),a.$schema.html(d)},refresh:function(){this.render()}}),Hualala.Account.AccountMgrView=d;var e={receiverType:{type:"radiogrp",label:"收款方类型",defaultVal:2,options:Hualala.TypeDef.AccountReceiverTypes,validCfg:{validators:{}}},receiverName:{type:"text",label:"收款单位/姓名",defaultVal:"",validCfg:{validators:{notEmpty:{message:"收款单位/姓名不能为空"},stringLength:{max:20,message:"收款单位/姓名不能超过20个字"}}}},settleUnitName:{type:"text",label:"结算账户名称",defaultVal:"",validCfg:{validators:{notEmpty:{message:"结算账户名称不能为空"},stringLength:{max:50,message:"结算账户名称不能超过50个字"}}}},bankAccount:{type:"text",label:"转账账号",defaultVal:"",validCfg:{validators:{notEmpty:{message:"转账账号不能为空"},stringLength:{max:30,message:"转账账号不能超过30个字"}}}},bankCode:{type:"combo",label:"转账银行",defaultVal:"CMB",options:Hualala.TypeDef.BankOptions,validCfg:{validators:{notEmpty:{message:"转账银行不能为空"}}}},bankName:{type:"text",label:"转账分行",defaultVal:"",prefix:'<span class="bank-name-icon icon-CMB-16"></span>',validCfg:{validators:{notEmpty:{message:"转账分行不能为空"},stringLength:{max:40,message:"转账分行不能超过40个字"}}}},remark:{type:"text",label:"备注",defaultVal:"",validCfg:{validators:{stringLength:{max:250,message:"备注不能超过250个字"}}}},defaultAccount:{type:"switcher",label:"默认账户",defaultVal:1,onLabel:"开启",offLabel:"关闭",validCfg:{validators:{}}},receiverLinkman:{type:"text",label:"姓名",defaultVal:"",prefix:'<span class="glyphicon glyphicon-user"></span>',validCfg:{validators:{notEmpty:{message:"姓名不能为空"},stringLength:{max:20,message:"姓名不能超过20个字"}}}},receiverMobile:{type:"text",label:"手机",defaultVal:"",prefix:'<span class="glyphicon glyphicon-phone"></span>',validCfg:{validators:{notEmpty:{message:"手机不能为空"},stringLength:{max:30,message:"手机不能超过30个字符"}}}},receiverEmail:{type:"text",label:"邮箱",defaultVal:"",prefix:'<span class="glyphicon glyphicon-envelope"></span>',validCfg:{validators:{stringLength:{max:50,message:"邮箱不能超过30个字符"}}}}},f=new IX.IListManager;_.each(e,function(a,b){var c=$XP(a,"type"),d="col-sm-offset-1 col-sm-3 control-label";if("radiogrp"==c){var e=_.map($XP(a,"options"),function(a){return IX.inherit(a,{id:b+"_"+IX.id(),name:b,clz:"col-sm-6"})});f.register(b,IX.inherit(a,{id:"",options:e,labelClz:d,clz:"col-sm-5"}))}else f.register(b,IX.inherit(a,{id:b+"_"+IX.id(),name:b,labelClz:d,clz:"col-sm-5"}))});var g=Stapes.subclass({constructor:function(a){this.$trigger=$XP(a,"trigger",null),this.mode=$XP(a,"mode","edit"),this.model=$XP(a,"model",null)||new Hualala.Account.BaseAccountModel,this.parentView=$XP(a,"parentView",null),this.modal=null,this.formKeys="settleUnitName,receiverType,receiverName,bankAccount,bankCode,bankName,remark,defaultAccount,receiverLinkman,receiverMobile,receiverEmail".split(","),this.loadTemplates(),this.initModal(),this.renderForm(),this.bindEvent(),this.resetBankCode(),this.emit("show")}});g.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_account_edit")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns"));Handlebars.registerHelper("checkFormElementType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),Handlebars.registerHelper("isInputGroup",function(a,b,c){return a||b?c.fn(this):c.inverse(this)}),this.set({layoutTpl:a,btnTpl:b})},getModalTitle:function(){return("edit"==this.mode?"修改":"增加")+"结算账户"},initModal:function(){var a=this;a.modal=new Hualala.UI.ModalDialog({id:"account_edit",clz:"account-modal",title:a.getModalTitle(),afterRemove:function(){}})},mapFormElsData:function(){var a=this,b=a.formKeys,c=_.map(b,function(b){var c=f.get(b),d=$XP(c,"type");if("combo"==d){var e=a.model.get(b)||$XP(c,"defaultVal"),g=_.map($XP(c,"options"),function(a){return IX.inherit(a,{selected:$XP(a,"value")==e?"selected":""})});return IX.inherit(c,{value:e,options:g})}if("radiogrp"==d){var e=a.model.get(b)||$XP(c,"defaultVal"),g=_.map($XP(c,"options"),function(a){return IX.inherit(a,{checked:$XP(a,"value")==e?"checked":""})});return IX.inherit(c,{value:e,options:g})}return"switcher"==d?IX.inherit(c,{checked:a.model.get(b)==$XP(c,"defaultVal")?"checked":""}):IX.inherit(c,{value:a.model.get(b)||$XP(c,"defaultVal")})});return c},renderForm:function(){var a=this,b=a.mapFormElsData(),c=a.get("layoutTpl"),d=a.get("btnTpl"),e=c({formClz:"account-form",items:b});a.modal._.body.html(e),a.modal._.footer.html(d({btns:[{clz:"btn-default",name:"cancel",label:"取消"},{clz:"btn-warning",name:"submit",label:"edit"==a.mode?"保存":"添加"}]})),a.initSwitcher(":checkbox[data-type=switcher]")},initValidFieldOpts:function(){var a=this,b=a.formKeys,c={};return _.each(b,function(a){var b=f.get(a),d=$XP(b,"type");if("section"==d){var e=a+"_min",g=a+"_max";c[e]=$XP(b,"min.validCfg",{}),c[g]=$XP(b,"max.validCfg",{})}else c[a]=$XP(b,"validCfg",{})}),c},bindEvent:function(){var b=this,c=b.initValidFieldOpts();this.on({show:function(){this.modal.show()},hide:function(){this.modal.hide()}}),b.modal._.dialog.find(".btn").on("click",function(){var c=a(this),d=c.attr("name");if("cancel"==d)b.emit("hide");else{var e=b.modal._.body.find("form").data("bootstrapValidator");c.button("提交中..."),e.validate()}}),b.modal._.body.find("form [name=bankCode]").on("change",function(){var c=a(this),d=b.modal._.body.find("form .bank-name-icon"),e=c.val();d.trigger("change",e)}),b.modal._.body.find("form .bank-name-icon").on("change",function(b,c){var d=a(this),e=Hualala.Common.mapBankInfo(c);IX.Debug.info("DEBUG: Account Bank Info : "),IX.Debug.info(e),d.removeClass().addClass("bank-name-icon "+$XP(e,"icon_16",""))}),b.modal._.body.find("form").bootstrapValidator({trigger:"blur",fields:c}).on("error.field.bv",function(b){{var c=a(b.target);c.data("bootstrapValidator")}}).on("success.form.bv",function(c){c.preventDefault();var d=a(c.target),e=(d.data("bootstrapValidator"),b.serializeForm());IX.Debug.info("DEBUG: Account Edit View Form Params : "),IX.Debug.info(e),b.model.emit(b.mode,{params:e,failFn:function(){b.modal._.footer.find(".btn[name=submit]").button("reset")},successFn:function(){b.modal._.footer.find(".btn[name=submit]").button("reset"),b.parentView&&IX.isFn(b.parentView.refresh)&&b.parentView.refresh(),b.emit("hide")}})})},resetBankCode:function(){var a=this,b=a.modal._.body.find("form [name=bankCode]").val();a.modal._.body.find("form .bank-name-icon").trigger("change",b)},initSwitcher:function(b){var c=this;c.modal._.body.find(b).each(function(){var b=a(this),c=b.attr("data-onLabel"),d=b.attr("data-offLabel");b.bootstrapSwitch({size:"normal",onColor:"primary",offColor:"default",onText:c,offText:d})})},serializeForm:function(){{var b=this,c=b.formKeys,d={};_.map(c,function(b){var c=f.get(b),e=$XP(c,"type");d[b]="switcher"==e?a("[name="+b+"]").data("bootstrapSwitch").options.state?1:0:a("[name="+b+"]").val()})}return d}}),Hualala.Account.AccountEditView=g;var h=Stapes.subclass({constructor:function(a){this.$trigger=$XP(a,"trigger",null),this.model=$XP(a,"model",null),this.parentView=$XP(a,"parentView",null),this.modal=null,this.$queryBox=null,this.$resultBox=null,this.queryCtrl=null,this.set({settleUnitID:this.model.get("settleUnitID"),settleName:this.model.get("settleUnitName"),shopCount:this.model.get("shopCount")}),this.loadTemplates(),this.initModal(),this.render(),this.bindEvent(),this.initQueryBox(),this.emit("show")}});h.proto({loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_account_query_shop")),b=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns"));this.set({layoutTpl:a,btnTpl:b})},initModal:function(){var a=this;a.modal=new Hualala.UI.ModalDialog({id:"account_query_shop",clz:"account-modal",title:"结算账户关联店铺",afterRemove:function(){}})},render:function(){var a=this,b=a.get("layoutTpl"),c=a.get("btnTpl"),d=a.model.get("settleUnitName")||"",e=[{clz:"btn-default",name:"cancel",label:"关闭"}],f=b({clz:"",title:d,label:"结算账户名称"});a.modal._.body.html(f),a.modal._.footer.html(c({btns:e})),a.$queryBox=a.modal._.body.find(".query-box"),a.$resultBox=a.modal._.body.find(".result-box")},bindEvent:function(){var b=this;this.on({show:function(){b.modal.show()},hide:function(){b.modal.hide()}}),b.modal._.dialog.find(".btn").on("click",function(){var c=a(this),d=c.attr("name");"cancel"==d&&b.emit("hide")})},initQueryBox:function(){var a=this;a.queryCtrl=new Hualala.Account.AccountQueryShopController({container:a.$queryBox,resultContainer:a.$resultBox,settleUnitID:a.get("settleUnitID"),settleName:a.get("settleName"),shopCount:a.get("shopCount")})}}),Hualala.Account.AccountQueryShopModal=h;var i=Hualala.Constants.PersonUnit,j=Hualala.Constants.CashUnit,k=function(a){if(IX.isEmpty(a))return"";var b=Hualala.TypeDef.ShopBusiness,c=_.find(b,function(b){var c=$XP(b,"id");return c==a});return c?$XP(c,"label",""):""},l=function(a){if(IX.isEmpty(a))return"";var b=Hualala.TypeDef.GENDER,c=_.find(b,function(b){var c=$XP(b,"value");return c==a});return c?$XP(c,"label",""):""},m=function(a,b){var c=$XP(a,"label",""),d=$XP(a,"fieldType",""),e=$XP(a,"fields",[]),f=$XP(b,"userSex","");f=IX.isEmpty(f)?"":"("+l(f)+")";var g=_.map(e,function(a){var c=q[a],d=$XP(c,"label",""),e=$XP(c,"unit",""),g=$XP(c,"clz",""),h=$XP(b,a,"");return h+="userName"==a?f:"",h+=e,{key:a,clz:g,label:d,value:h}
});return{label:c,fieldType:d,fields:g}},n=function(a,b){var c=$XP(a,"label",""),d=$XP(a,"fieldType",""),e=$XP(a,"fields",[]),f=$XP(b,"orderSubType",""),g=k(f);g=IX.isEmpty(g)?"":"("+g+")";var h=_.map(e,function(a){var c=q[a],d=$XP(c,"label",""),e=$XP(c,"unit",""),g=$XP(c,"clz",""),h=$XP(b,a,"");switch(a){case"timeName":case"consumptionTypeName":case"promotionDesc":case"orderRemark":g+=IX.isEmpty(h)?" hidden":"";break;case"orderTime":case"orderCreateTime":h=IX.Date.getDateByFormat(Hualala.Common.formatDateTimeValue(h),"yyyy/MM/dd HH:mm");break;case"statusName":var i=$XP(b,"isAlreadyPaid",0),j=$XP(b,"orderStatus",""),k="";k=j>=20&&1==i?"<span>线上付款</span>":j>=20&&0==i?'<span color="red">'+(20==j?"餐到付款":"到店付款")+"</span>":"<span>未付款</span>",k="("+k+")",h+=k;break;case"takeoutAddress":g+=20==f||21==f?"":" hidden"}return h+=e,{key:a,clz:g,label:d,value:h}});return{label:c,orderSubTypeLabel:g,fieldType:d,fields:h}},o=function(a,b){var c=$XP(a,"label",""),d=$XP(a,"fieldType",""),e=$XP(a,"fields",[]),f=$XP(b,"orderSubType",""),g=_.map(e,function(a){var c=q[a],d=$XP(c,"label",""),e=$XP(c,"unit",""),g=$XP(c,"clz",""),h=$XP(b,a,"");switch(a){case"serviceAmount":case"discountAmount":case"freeAmount":case"giftAmount":case"cardDiscountAmount":case"pointBalance":case"moneyBalance":case"orderRefundAmount":g+=0==h?" hidden":"";break;case"presentInfo":g+=IX.isEmpty(h)?" hidden":"";break;case"takeoutPackagingAmount":g+=20==f||21==f?"":" hidden"}return h+=e,{key:a,clz:g,label:d,value:h}});return{label:c,fieldType:d,fields:g}},p=function(a,b){var c=$XP(a,"label",""),d=$XP(a,"fieldType",""),e=$XP(a,"fields",[]),f=$XP(b,"records",[]),g=_.groupBy(f,function(a){return $XP(a,"foodCategoryID")});return g=_.map(g,function(a,b){var c="",d=a.length,f=_.map(a,function(a){var b={};return _.each(e,function(d){var e=$XP(a,d,""),f=IX.isEmpty(q[d])||IX.isEmpty(q[d].unit)?"":q[d].unit;"foodCategoryName"==d&&(c=e),b[d]=e+f}),b});return{foodCategoryName:c,foodCategorySum:"("+d+")",foodCategoryID:b,rows:f}}),{fieldType:d,label:c,categories:g}},q={userName:{label:"姓名",clz:"col-xs-6"},userLoginMobile:{label:"手机",clz:"col-xs-6"},orderID:{label:"订单号",clz:"col-xs-6"},orderCheckPWD:{label:"消费密码",clz:"col-xs-6"},person:{label:"人数",unit:i,clz:"col-xs-6"},timeName:{label:"餐段名称",clz:"col-xs-6"},tableName:{label:"桌台号",clz:"col-xs-6"},shopOrderKey:{label:"餐饮软件凭证号",clz:"col-xs-6"},orderTime:{label:"用餐时间",clz:"col-xs-12"},orderCreateTime:{label:"下单时间",clz:"col-xs-12"},statusName:{label:"订餐状态",clz:"col-xs-12"},takeoutAddress:{label:"外送地址",clz:"col-xs-6"},consumptionTypeName:{label:"用餐类型",clz:"col-xs-12"},promotionDesc:{label:"店家促销描述",clz:"col-xs-12"},orderRemark:{label:"订单备注",clz:"col-xs-12"},foodAmount:{label:"菜品金额",unit:j,clz:"col-xs-6"},serviceAmount:{label:"服务费",unit:j,clz:"col-xs-6"},paidAmount:{label:"买单前已付金额",unit:j,clz:"col-xs-6"},promotionTotalAmount:{label:"餐饮软件优惠金额",unit:j,clz:"col-xs-6"},discountAmount:{label:"商家折免",unit:j,clz:"col-xs-6"},freeAmount:{label:"商家减免",unit:j,clz:"col-xs-6"},giftAmount:{label:"商家代金券金额",unit:j,clz:"col-xs-6"},presentInfo:{label:"赠送",clz:"col-xs-6"},cardDiscountAmount:{label:"会员卡优惠",unit:j,clz:"col-xs-6"},pointBalance:{label:"积分抵扣",unit:j,clz:"col-xs-6"},moneyBalance:{label:"会员卡余额支付",unit:j,clz:"col-xs-6"},takeoutPackagingAmount:{label:"打包费",unit:j,clz:"col-xs-6"},orderTotal:{label:"订单金额",unit:j,clz:"col-xs-6"},orderRefundAmount:{label:"退款金额",unit:j,clz:"col-xs-6"},shopName:{label:"店铺名称",clz:"col-xs-6"},shopTel:{label:"电话",clz:"col-xs-6"},foodPrice:{label:"菜品价格",unit:j}},r={userFields:{label:"个人信息",fieldType:"list",fields:["userName","userLoginMobile"],mapFn:m},orderFields:{label:"订单信息",fieldType:"list",fields:["orderID","orderCheckPWD","person","timeName","tableName","shopOrderKey","orderTime","orderCreateTime","statusName","takeoutAddress","consumptionTypeName","promotionDesc","orderRemark"],mapFn:n},payFields:{label:"支付详情",fieldType:"list",fields:["foodAmount","serviceAmount","paidAmount","promotionTotalAmount","discountAmount","freeAmount","giftAmount","presentInfo","cardDiscountAmount","pointBalance","moneyBalance","takeoutPackagingAmount","orderTotal","orderRefundAmount","shopName","shopTel"],mapFn:o},foodsFields:{label:"菜品信息",fieldType:"table",fields:["foodCategoryName","foodCategoryID","foodName","foodUnit","foodPrice","foodAmount"],mapFn:p}},s=Stapes.subclass({constructor:function(a){if(this.$trigger=$XP(a,"triggerEl"),this.orderKey=$XP(a,"orderKey",""),this.orderID=$XP(a,"orderID",""),this.transType=$XP(a,"transType",""),this.transID=$XP(a,"transID",""),this.transTypes=Hualala.TypeDef.FSMTransType,this.transTypeHT=new IX.IListManager,this.initTransTypeLib(),this.modal=null,this.tplName=$XP(this.transTypeHT.get(this.transType),"tpl",null),this.callServerName=$XP(this.transTypeHT.get(this.transType),"queryCall",null),this.callServer=null,IX.isFn(this.callServerName))this.callServer=this.callServerName;else{if(!IX.isString(this.callServerName))throw"Configuration failed : Invalid Page Initialized for "+this.callServerName;IX.nsExisted(this.callServerName)&&(this.callServer=IX.getNS(this.callServerName))}return this.queryKeys=$XP(this.transTypeHT.get(this.transType),"queryKeys",null),this.tplName&&this.callServer?(this.loadTemplates(),this.initModal(),this.bindEvent(),void this.emit("load",this.mapQueryParams())):null}});s.proto({initTransTypeLib:function(){var a=this;_.each(this.transTypes,function(b){var c=$XP(b,"value","").toString();c.length>0&&a.transTypeHT.register(c,b)})},loadTemplates:function(){var a=this,b=Handlebars.compile(Hualala.TplLib.get(a.tplName)),c=Handlebars.compile(Hualala.TplLib.get("tpl_shop_modal_btns"));Handlebars.registerHelper("chkFieldType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),this.set({layoutTpl:b,btnTpl:c})},initModal:function(){var a=this;a.modal=new Hualala.UI.ModalDialog({id:"account_trans_detail",clz:"account-modal",sizeCls:"modal-lg",title:"结算账户交易详情",afterRemove:function(){}})},bindEvent:function(){var c=this;c.on({load:function(a){c.callServer(a,function(a){"000"==a.resultcode?c.render($XP(a,"data",null)):b({msg:$XP(a,"resultmsg",""),type:"danger"})})},show:function(){c.modal.show()},hide:function(){c.modal.hide()}},this),c.modal._.dialog.on("click",".btn",function(){var b=a(this),d=b.attr("name");"cancel"==d&&c.emit("hide")})},mapOrderPayDetail:function(a){var b="userFields,orderFields,payFields,foodsFields".split(",");b=_.map(b,function(b){var c=r[b],d=$XF(c,"mapFn"),e=_.pick(c,"label","fieldType","fields");return d(e,a)}),IX.Debug.info("DEBUG: Account TransDetail Modal Order Pay Detail Fieldsets : "),IX.Debug.info(b);var c=$XP(a,"data.orderSubType",""),d=k(c);d=IX.isEmpty(d)?"":"("+d+")";var e={label:"订单打印内容",orderSubTypeLabel:d,content:$XP(a,"orderPrnStr","").replace(/\n/g,"<br/>")};return{fieldsets:b,printDetail:e}},mapFsmCustomerDetail:function(a){var b=this,c=$XP(a,"settleUnitDetail",[])[0],d=$XP(a,"customerCard",[])[0],e=$XP(c,"transType"),f=$XP(b.transTypeHT.get(e),"label","");return c=IX.each(c,{},function(a,c,d){var e="transAfterBalance,transAmount,transSalesCommission";return e.indexOf(d)>=0?a[d]=Hualala.Common.Math.prettyNumeric(Hualala.Common.Math.prettyPrice(c)):"transType"==d?a=IX.inherit(a,{transType:c,transTypeLabel:$XP(b.transTypeHT.get(c),"label","")}):a[d]=c,a}),d=IX.each(d,{},function(a,b,c){var d="saveCashTotal,saveMoneyTotal,moneyBalance";return a[c]=d.indexOf(c)>=0?Hualala.Common.Math.prettyNumeric(Hualala.Common.Math.prettyPrice(b)):b,a}),{settleUnitDetail:IX.inherit(c,{transTypeLabel:f}),customerCard:d}},mapRenderData:function(a){var b=this,c=_.last(b.callServerName.split(".")),d=null;switch(c){case"queryAccountOrderPayDetail":d=b.mapOrderPayDetail(a);break;case"queryAccountFsmCustomerDetail":d=b.mapFsmCustomerDetail(a)}return d},render:function(a){var b=this,c=b.mapRenderData(a),d=b.get("layoutTpl"),e=b.get("btnTpl"),f=d(c);b.modal._.body.html(f),b.modal._.footer.html(e({btns:[{clz:"btn-default",name:"cancel",label:"关闭"}]})),b.emit("show")},mapQueryParams:function(){var a=this,b={};return _.each(a.queryKeys.split(","),function(c){var d="SUA_TransItemID"==c?"transID":c;b[c]=a[d]}),IX.Debug.info("DEBUG: Account TransDetail Modal Query Params:"),IX.Debug.info(b),b}}),Hualala.Account.AccountTransDetailModal=s}(jQuery,window),function(a){IX.ns("Hualala.Account");var b=function(){var b=a("#ix_wrapper > .ix-body > .container"),c=new Hualala.Account.AccountListController({container:b,view:new Hualala.Account.AccountListView,model:new Hualala.Account.AccountListModel({callServer:Hualala.Global.queryAccount})});c.emit("load",{pageNo:1,pageSize:15})},c=function(){{var b=Hualala.PageRoute.getPageContextByPath(),c=a("#ix_wrapper > .ix-body > .container");new Hualala.Account.AccountMgrController({container:c,settleUnitID:$XP(b,"params",[])[0],accountModel:new Hualala.Account.BaseAccountModel,mgrView:new Hualala.Account.AccountMgrView,transaDetailCtrl:new Hualala.Account.TransactionDetailController})}};Hualala.Account.AccountMgrInit=c,Hualala.Account.AccountListInit=b}(jQuery,window),function(){IX.ns("Hualala.Order");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip),b=Stapes.subclass({constructor:function(a){if(this.callServer=$XP(a,"callServer",null),!this.callServer)throw"callServer is empty!";this.cities=$XP(a,"cities",[]),this.statisticKeys="count,foodAmount,giftAmountTotal,orderRefundAmount,orderRegAmount,orderTotal,orderAmount,shouldSettlementTotal,total",this.queryKeys=$XP(a,"queryKeys",[]),this.pagerKeys="pageCount,totalSize,pageNo,pageSize".split(","),this.queryParamsKeys=null,this.hasPager=$XP(a,"hasPager",!0),this.recordModel=$XP(a,"recordModel",c);var b=$XF(a,"initQueryParams");b.apply(this)}});b.proto({init:function(a,b){this.cities=b||this.cities,this.set(IX.inherit({ds_record:new IX.IListManager,ds_page:new IX.IListManager,ds_statistic:new IX.IListManager},this.hasPager?{pageCount:0,totalSize:0,pageNo:$XP(a,"pageNo",1),pageSize:$XP(a,"pageSize",15)}:{})),this.queryParamsKeys=this.hasPager?this.queryKeys.concat(this.pagerKeys):this.queryKeys},updatePagerParams:function(a){var b=this,c=b.queryParamsKeys.join(",");_.each(a,function(a,d){c.indexOf(d)>-1&&b.set(d,a)})},getPagerParams:function(){var a=this,b={};return _.each(a.queryParamsKeys,function(c){b[c]=a.get(c)}),b},updateDataStore:function(a,b){var c=this,d=c.get("ds_record"),e=c.get("ds_page");b=c.hasPager?b:1;var f=_.map(a,function(a){var e=b+"_"+IX.id(),f=new c.recordModel(IX.inherit(a,{__id__:e}));return d.register(e,f),e});e.register(b,f)},updateStatisticDataStore:function(a){var b=this,c=b.get("ds_statistic");_.each(b.statisticKeys.split(","),function(b){var d=$XP(a,b,"");c.register(b,d)})},resetDataStore:function(){this.recordHT.clear(),this.pageHT.clear()},load:function(b,c){var d=this;d.updatePagerParams(b),d.callServer(d.getPagerParams(),function(b){"000"==b.resultcode?(d.updateDataStore($XP(b,"data.records",[]),$XP(b,"data.page.pageNo")),d.updatePagerParams($XP(b,"data.page",{})),d.updateStatisticDataStore($XP(b,"data",{}))):a({msg:$XP(b,"resultmsg",""),type:"danger"}),c(d)})},getRecordsByPageNo:function(a){var b=this,c=b.get("ds_record"),d=b.get("ds_page");a=b.hasPager?a:1;var e=_.map(c.getByKeys(d.get(a)),function(a){return a.getAll()});return IX.Debug.info("DEBUG: Order Query Result Model PageData"),IX.Debug.info(e),e},getRecordModelByID:function(a){var b=this,c=b.get("ds_record");return c.get(a)},getCityByCityID:function(a){if(IX.isEmpty(a))return null;var b=this.cities,c=_.find(b,function(b){return $XP(b,"cityID")==a});return c},getStatisticData:function(){var a=this,b=a.get("ds_statistic"),c={};return _.each(a.statisticKeys.split(","),function(a){c[a]=b.get(a)}),c}}),Hualala.Order.OrderQueryResultModel=b;var c=Stapes.subclass({constructor:function(a){this.set(a)}});c.proto({}),Hualala.Order.BaseOrderRecordModel=c}(jQuery,window),function(a){IX.ns("Hualala.Order");var b=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,[{key:"cityID",clz:"",label:"城市"},{key:"shopName",clz:"",label:"店铺名称"},{key:"orderID",clz:"",label:"订单号"},{key:"userName",clz:"",label:"客户姓名"},{key:"orderTime",clz:"",label:"就餐时间"},{key:"orderStatus",clz:"",label:"订单状态"},{key:"orderTotal",clz:"",label:"应付金额"},{key:"moneyBalance",clz:"",label:"会员卡支付"},{key:"pointBalance",clz:"",label:"会员卡积分支付"},{key:"orderRefundAmount",clz:"",label:"退订/退款"},{key:"total",clz:"",label:"应结金额"},{key:"shouldSettlementTotal",clz:"",label:"结算金额"},{key:"rowControl",clz:"",label:"操作"}]),c=[{key:"cityID",clz:"",label:"城市"},{key:"billDate",clz:"",label:"日期"},{key:"count",clz:"",label:"订单数"},{key:"giftAmountTotal",clz:"",label:"代金券总金额"},{key:"orderTotal",clz:"",label:"订单支付金额"},{key:"orderWaitTotal",clz:"",label:"待消费订单金额"},{key:"orderRegAmount",clz:"",label:"退款金额"},{key:"orderRefundAmount",clz:"",label:"退订金额"},{key:"total",clz:"",label:"成交金额"},{key:"orderTotal",clz:"",label:"线下金额"},{key:"rowControl",clz:"",label:"操作"}],d=[{key:"index",clz:"",label:"序号"},{key:"foodName",clz:"",label:"菜品名称"},{key:"foodCategoryName",clz:"",label:"分类名称"},{key:"sumPrice",clz:"",label:"平均价格"},{key:"sumMaster",clz:"",label:"销售份数"}],e=[{key:"userName",clz:"",label:"姓名"},{key:"userSex",clz:"",label:"性别"},{key:"userLoginMobile",clz:"",label:"手机号"},{key:"sumRecord",clz:"",label:"订餐次数"},{key:"foodAmount",clz:"",label:"订餐金额"},{key:"minOrderTime",clz:"",label:"首次订餐时间"},{key:"maxOrderTime",clz:"",label:"最近订餐时间"}],f=function(a,b,c){var d=this,e=Hualala.PageRoute.getPageContextByPath(),f=$XP(e,"name"),g=d.model.getPagerParams(),h=d.model.queryKeys,i={value:"",text:""},j=$XP(a,c,"");switch(c){case"cityID":j=d.getCityByCityID(j),i.value=$XP(j,"cityID",""),i.text=$XP(j,"cityName","");break;case"userName":var k=$XP(a,"userMobile",""),l=Hualala.Common.getGender($XP(a,"userSex",""));l=IX.isEmpty(l)?"":"("+$XP(l,"label","")+")",k=IX.isEmpty(k)?"":"("+k+")",i.value=$XP(a,"userID",""),i.text=j+l+k;break;case"orderTime":case"minOrderTime":case"maxOrderTime":i.value=j,i.text=IX.Date.getDateByFormat(Hualala.Common.formatDateTimeValue(j),"yyyy/MM/dd HH:mm");break;case"orderStatus":j=Hualala.Common.getOrderStatus(j),i.value=$XP(j,"value",""),i.text=$XP(j,"label","");break;case"billDate":i.value=j,i.text=IX.Date.getDateByFormat(Hualala.Common.formatDateTimeValue(j),"yyyy/MM/dd");break;case"index":i.value=b,i.text=b+1;break;case"sumMaster":i.value=j,i.text=j+"&nbsp;"+$XP(a,"foodUnit","");break;case"sumPrice":i.value=j||0,i.text=Hualala.Common.Math.prettyPrice(Hualala.Common.Math.div(i.value,$XP(a,"sumMaster",1)));break;case"userSex":i.value=j,i.text=$XP(Hualala.Common.getGender($XP(a,"userSex","")),"label","");break;case"rowControl":if("orderQuery"==f)i={type:"button",btns:[{label:"查看详情",link:"javascript:void(0);",clz:"query-order-detail",id:$XP(a,"orderID",""),key:$XP(a,"orderKey",""),type:""}]};else if("orderQueryDay"==f||"orderQueryDuring"==f){var m="orderQueryDuring"==f?"orderQueryDay":"orderQuery",n=_.map(h,function(a){return $XP(g,a,"")}),o="";"orderQuery"==m&&(n=n.concat(["","","",""])),o=Hualala.PageRoute.createPath(m,n),i={type:"button",btns:[{label:"查看详情",link:o,clz:"",id:"",type:""}]}}break;default:i.value=i.text=$XP(a,c,"")}return i};Hualala.Order.mapQueryOrderResultRenderData=function(a){var c=this,d="col-md-12",e="table-striped table-hover",g=b,h=c.model.getStatisticData(),i=function(a,b){var d=_.map(g,function(a){return $XP(a,"key","")}),e={clz:"",type:"text"},h=_.map(d,function(d){var g=f.apply(c,[a,b,d]);return IX.inherit(e,g)});return h},j=_.map(a,function(a,b){return{clz:"",cols:i(a,b)}}),k="orderTotal,orderRefundAmount,total,shouldSettlementTotal",l=_.map(k.split(","),function(a){var b=$XP(h,a,0),c=1,d="",e="orderTotal"==a?3:1;return{clz:d,colspan:e,rowspan:c,text:b,value:b}});l.unshift({clz:"title",colspan:"6",rowspan:"1",value:"",text:"共计："});var m=[{clz:"",cols:l}];return{clz:d,tblClz:e,isEmpty:a&&0!=a.length?!1:!0,colCount:g.length,thead:g,rows:j,tfoot:m}},Hualala.Order.mapQueryOrderDuringRenderData=function(a){var b=this,d=Hualala.PageRoute.getPageContextByPath(),e=$XP(d,"name"),g=(b.model.getPagerParams(),b.model.queryKeys,"col-md-12"),h="table-striped table-hover",i=IX.clone(c),j=b.model.getStatisticData();"orderQueryDuring"==e&&(i=_.map(i,function(a){var b=$XP(a,"key","");return"billDate"==b&&(a=IX.inherit(a,{key:"shopName",clz:"",label:"店铺名称"})),a}));var k=function(a,c){var d=_.map(i,function(a){return $XP(a,"key","")}),e={clz:"",type:"text"},g=_.map(d,function(d){var g=f.apply(b,[a,c,d]);return IX.inherit(e,g)});return g},l=_.map(a,function(a,b){return{clz:"",cols:k(a,b)}}),m="count,giftAmountTotal,orderTotal,orderWaitTotal,orderRegAmount,orderRefundAmount,total,orderAmount",n=_.map(m.split(","),function(a){var b=$XP(j,a,0),c=1,d="",e=1;return{clz:d,colspan:e,rowspan:c,text:b,value:b}});n.unshift({clz:"title",colspan:"2",rowspan:"1",value:"",text:"共计："});var o=[{clz:"",cols:n}];return{clz:g,isEmpty:a&&0!=a.length?!1:!0,colCount:i.length,tblClz:h,thead:i,rows:l,tfoot:o}},Hualala.Order.mapQueryDishesHotRenderData=function(a){var b=this,c="col-md-12",e="table-striped table-hover",g=d,h=function(a,c){var d=_.map(g,function(a){return $XP(a,"key","")}),e={clz:"",type:"text"},h=_.map(d,function(d){var g=f.apply(b,[a,c,d]);return IX.inherit(e,g)});return h},i=_.map(a,function(a,b){return{clz:"",cols:h(a,b)}});return{clz:c,tblClz:e,isEmpty:a&&0!=a.length?!1:!0,colCount:g.length,thead:g,rows:i}},Hualala.Order.mapQueryUserRenderData=function(a){var b=this,c="col-md-12",d="table-striped table-hover",g=e,h=function(a,c){var d=_.map(g,function(a){return $XP(a,"key","")}),e={clz:"",type:"text"},h=_.map(d,function(d){var g=f.apply(b,[a,c,d]);return IX.inherit(e,g)});return h},i=_.map(a,function(a,b){return{clz:"",cols:h(a,b)}});return{clz:c,tblClz:d,isEmpty:a&&0!=a.length?!1:!0,colCount:g.length,thead:g,rows:i}},Hualala.Order.renderQueryOrderResult=function(a){var b=this;b.$result.empty(),b.$result.html(b.get("resultTpl")(a))};var g=Stapes.subclass({constructor:function(a){this.$container=null,this.$resultBox=null,this.$result=null,this.$pager=null,this.set("mapResultRenderData",$XF(a,"mapResultRenderData")),this.set("renderResult",$XF(a,"renderResult")),this.loadTemplate()}});g.proto({init:function(a){if(this.$container=$XP(a,"container",null),this.model=$XP(a,"model",null),!this.$container||!this.model)throw"Query Result View Init Faild!";this.initLayout()},loadTemplate:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_shop_list_layout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_base_datagrid"));Handlebars.registerPartial("colBtns",Hualala.TplLib.get("tpl_base_grid_colbtns")),Handlebars.registerHelper("chkColType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),this.set({layoutTpl:a,resultTpl:b})},initLayout:function(){var a=this.get("layoutTpl"),b=a();this.$container.append(b),this.$resultBox=this.$container.find(".shop-list"),this.$result=this.$container.find(".shop-list-body"),this.$pager=this.$container.find(".page-selection"),this.initPager(),this.bindEvent()},initPager:function(a){var b=this;if(b.model.hasPager){var c={total:0,page:1,maxVisible:10,leaps:!0};this.$pager.IXPager(IX.inherit(c,a))}},bindEvent:function(){var b=this;b.model.hasPager&&b.$pager.on("page",function(a,c){var d=b.model.getPagerParams();d.pageNo=c,b.model.emit("load",IX.inherit(d,{pageNo:$XP(d,"pageNo",1),pageSize:$XP(d,"pageSize",15)}))}),b.$resultBox.on("click","a.query-order-detail",function(){{var b=a(this),c=b.attr("data-key"),d=b.attr("data-id"),e="101";new Hualala.Account.AccountTransDetailModal({triggerEl:b,orderKey:c,orderID:d,transType:e,transID:""})}})},mapRenderData:function(){var a=this.get("mapResultRenderData"),b=IX.isFn(a)?a.apply(this,arguments):null;return b},renderRecords:function(){var a=this.get("renderResult");IX.isFn(a)&&a.apply(this,arguments)},render:function(){var a=this,b=a.model,c=b.hasPager,d=b.getPagerParams(),e=$XP(d,"pageNo",1),f=b.getRecordsByPageNo(e),g=a.mapRenderData(f);a.renderRecords(g),c&&a.initPager({total:b.get("pageCount"),page:b.get("pageNo"),href:"javascript:void(0);"})},getCityByCityID:function(a){var b=this,c=b.model.getCityByCityID(a);return c}}),Hualala.Order.OrderQueryResultView=g}(jQuery,window),function(){IX.ns("Hualala.Order");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.UI.LoadingModal),b=Stapes.subclass({constructor:function(a){if(this.set({sessionData:Hualala.getSessionData()}),this.container=$XP(a,"container",null),this.view=$XP(a,"view",null),this.model=$XP(a,"model",null),!this.view||!this.model||!this.container)throw"Query Result init faild!";this.isReady=!1,this.bindEvent()}});b.proto({init:function(b){this.model.init($XP(b,"params",{}),$XP(b,"cities",null)),this.view.init({model:this.model,container:this.container}),this.loadingModal=new a({start:100}),this.isReady=!0},hasReady:function(){return this.isReady},bindEvent:function(){this.on({load:function(a){var b=this;b.hasReady()||b.init(a),b.model.emit("load",$XP(a,"params",{}))}},this),this.model.on({load:function(a){var b=this,c=function(){b.view.emit("render"),b.loadingModal.hide()};b.loadingModal.show(),b.model.load(a,c)}},this),this.view.on({render:function(){var a=this;a.view.render()}},this)}}),Hualala.Order.OrderListController=b}(jQuery,window),function(){IX.ns("Hualala.Order");Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip;Hualala.Order.initQueryParams=function(){var a=Hualala.PageRoute.getPageContextByPath(),b=this,c=$XP(a,"params",[]),d=b.queryKeys,e=_.object(d,c);b.set(e)};var a=Hualala.Shop.QueryModel.subclass({constructor:function(a){this.origCities=[],this.origAreas=[],this.origShops=[],this.queryKeys=$XP(a,"queryKeys",[]),this.isReady=!1,this.callServer=Hualala.Global.getShopQuerySchema;var b=$XF(a,"initQueryParams");b.apply(this)}});a.proto({getQueryParams:function(){var a=this,b=_.map(a.queryKeys,function(b){return a.get(b)}),c=_.object(a.queryKeys,b);return IX.Debug.info("DEBUG: Order Query Model Query Params :"),IX.Debug.info(c),c}}),Hualala.Order.QueryModel=a}(jQuery,window),function(a){IX.ns("Hualala.Order");Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip;Hualala.Order.QueryFormElsCfg={orderTime:{type:"section",label:"日期",min:{type:"datetimepicker",defaultVal:"",validCfg:{group:".min-input",validators:{}}},max:{type:"datetimepicker",defaultVal:"",validCfg:{group:".max-input",validators:{}}}},cityID:{type:"combo",label:"城市",defaultVal:"",options:[],validCfg:{validators:{}}},shopID:{type:"combo",label:"店铺",defaultVal:"",options:[],validCfg:{validators:{}}},orderStatus:{type:"combo",label:"状态",defaultVal:"",options:Hualala.TypeDef.OrderStatus,validCfg:{validators:{}}},orderTotal:{type:"section",label:"金额",min:{type:"text",defaultVal:"",validCfg:{validators:{numeric:{message:"金额必须为数字"},greaterThan:{inclusive:!0,value:0,message:"金额必须大于或等于0"}}}},max:{type:"text",defaultVal:"",validCfg:{validators:{numeric:{message:"金额必须为数字"},greaterThan:{inclusive:!0,value:0,message:"金额必须大于或等于0"}}}}},orderID:{type:"text",label:"订单号",defaultVal:"",validCfg:{validators:{numeric:{message:"订单号必须为数字"}}}},userMobile:{type:"text",label:"手机号",defaultVal:"",validCfg:{validators:{numeric:{message:"手机号码必须为数字"}}}},userLoginMobile:{type:"text",label:"手机号",defaultVal:"",validCfg:{validators:{numeric:{message:"手机号码必须为数字"}}}},foodCategoryName:{type:"text",label:"分类名称",defaultVal:"",validCfg:{validators:{}}},userName:{type:"text",label:"订餐人",defaultVal:"",validCfg:{validators:{}}},button:{type:"button",clz:"btn btn-block btn-warning",label:"查询"}};var b=new IX.IListManager;_.each(Hualala.Order.QueryFormElsCfg,function(a,c){var d=$XP(a,"type"),e="col-xs-2 col-sm-2 col-md-4 control-label";if("section"==d){var f=minID=c+"_min_"+IX.id(),g=c+"_max_"+IX.id(),h="orderTime"==c?"startDate":"s_orderTotal",i="orderTime"==c?"endDate":"e_orderTotal",j=IX.inherit($XP(a,"min",{}),{id:minID,name:h,clz:"col-xs-5 col-sm-5 col-md-5"}),k=IX.inherit($XP(a,"max",{}),{id:g,name:i,clz:"col-xs-5 col-sm-5 col-md-5"});b.register(c,IX.inherit(a,{id:f,labelClz:"col-xs-2 col-sm-2 col-md-2 control-label",min:j,max:k}))}else b.register(c,IX.inherit(a,{id:c+"_"+IX.id(),name:c,labelClz:e},"button"!==$XP(a,"type")?{clz:"col-xs-8 col-sm-8 col-md-8"}:null))}),Hualala.Order.mapOrderQueryFormRenderData=function(){var a=this,c=(a.model.queryKeys,{cols:[{colClz:"col-md-4",items:b.getByKeys(["orderTime","orderTotal"])},{colClz:"col-md-2",items:b.getByKeys(["cityID","shopID"])},{colClz:"col-md-3",items:b.getByKeys(["orderStatus","orderID"])},{colClz:"col-md-3",items:b.getByKeys(["userMobile"])},{colClz:"col-md-offset-1 col-md-2",items:b.getByKeys(["button"])}]});return{query:c}},Hualala.Order.mapOrderQueryBaseFormRenderData=function(){var a=this,c=(a.model.queryKeys,{cols:[{colClz:"col-md-4",items:b.getByKeys(["orderTime"])},{colClz:"col-md-2",items:b.getByKeys(["cityID"])},{colClz:"col-md-2",items:b.getByKeys(["shopID"])},{colClz:"col-md-2",items:b.getByKeys(["orderStatus"])},{colClz:"col-md-2",items:b.getByKeys(["button"])}]});return{query:c}},Hualala.Order.mapDishesHotQueryFormRenderData=function(){var a=this,c=(a.model.queryKeys,{cols:[{colClz:"col-md-2",items:b.getByKeys(["cityID"])},{colClz:"col-md-2",items:b.getByKeys(["shopID"])},{colClz:"col-md-4",items:b.getByKeys(["orderTime"])},{colClz:"col-md-2",items:b.getByKeys(["foodCategoryName"])},{colClz:"col-md-2",items:b.getByKeys(["button"])}]});return{query:c}},Hualala.Order.mapUsersQueryFormRenderData=function(){var a=this,c=(a.model.queryKeys,{cols:[{colClz:"col-md-3",items:b.getByKeys(["cityID"])},{colClz:"col-md-3",items:b.getByKeys(["shopID"])},{colClz:"col-md-4",items:b.getByKeys(["orderTime"])},{colClz:"col-md-3",items:b.getByKeys(["userLoginMobile"])},{colClz:"col-md-3",items:b.getByKeys(["userName"])},{colClz:"col-md-offset-4 col-md-2",items:b.getByKeys(["button"])}]});return{query:c}};var c=Stapes.subclass({constructor:function(a){this.isReady=!1,this.$container=null,this.$queryBox=null,this.loadTemplates(),this.set("mapRenderDataFn",$XF(a,"mapRenderDataFn"))}});c.proto({init:function(a){if(this.model=$XP(a,"model",null),this.$container=$XP(a,"container",null),!this.model||!this.$container||0==this.$container.length)throw"Init Query View Failed!!";this.renderLayout(),this.bindEvent(),this.isReady=!0,this.emit("query",this.getQueryParams())},hasReady:function(){return this.isReady},loadTemplates:function(){var a=Handlebars.compile(Hualala.TplLib.get("tpl_order_queryLayout")),b=Handlebars.compile(Hualala.TplLib.get("tpl_order_comboOpts"));Handlebars.registerPartial("orderQueryForm",Hualala.TplLib.get("tpl_order_queryForm")),Handlebars.registerHelper("checkFormElementType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),Handlebars.registerHelper("isInputGroup",function(a,b,c){return a||b?c.fn(this):c.inverse(this)}),this.set({layoutTpl:a,comboOptsTpl:b})},initQueryFormEls:function(){var a=this,b=a.model.getQueryParams(),c=$XP(b,"cityID",""),d=$XP(b,"shopID","");a.initCityComboOpts(c),a.initShopComboOpts(c,d),_.each(b,function(b,c){("startDate"==c||"endDate"==c)&&(b=IX.isEmpty(b)?"":IX.Date.getDateByFormat(Hualala.Common.formatDateTimeValue(b),"yyyy/MM/dd")),a.$queryBox.find("[name="+c+"]").val(b)})},initCityComboOpts:function(a){var b=this,c=b.model.getCities();if(!IX.isEmpty(c)){c=_.map(c,function(b){var c=$XP(b,"cityID",""),d=$XP(b,"cityName","");return{value:c,label:d,selected:c==a?"selected":""}}),c.unshift({value:"",label:"全部",selected:IX.isEmpty(a)?"selected":""});var d=b.get("comboOptsTpl"),e=d({opts:c}),f=b.$queryBox.find("select[name=cityID]");f.html(e)}},initShopComboOpts:function(a,b){var c=this,d=IX.isEmpty(a)?c.model.getShops():c.model.getShopsByCityID(a);if(!IX.isEmpty(d)){d=_.map(d,function(a){var c=$XP(a,"shopID",""),d=$XP(a,"shopName","");return{value:c,label:d,selected:c==b?"selected":""}}),d.unshift({value:"",label:"全部",selected:IX.isEmpty(b)?"selected":""});var e=c.get("comboOptsTpl"),f=e({opts:d}),g=c.$queryBox.find("select[name=shopID]");g.html(f)}},initQueryEls:function(){var b=this;b.$queryBox.find("[data-type=datetimepicker]").datetimepicker({format:"yyyy/mm/dd",startDate:"2010/01/01",autoclose:!0,minView:"month",todayBtn:!0,todayHighlight:!0,language:"zh-CN"}),b.$queryBox.on("click",".input-group-addon",function(){var b=a(this),c=b.prev(":text[data-type=datetimepicker]");c.length>0&&c.datetimepicker("show")})},mapRenderLayoutData:function(){var a=this.get("mapRenderDataFn");return IX.isFn(a)&&a.apply(this)},renderLayout:function(){var b=this,c=b.get("layoutTpl"),d=(b.model,b.mapRenderLayoutData()),e=c(d);b.$queryBox=a(e),b.$container.html(b.$queryBox),b.initQueryFormEls(),b.initQueryEls()},bindEvent:function(){var b=this;b.$queryBox.on("change","select",function(){var c=a(this),d=c.val();b.initShopComboOpts(d,"")}),b.$queryBox.on("click",".btn.btn-warning",function(){a(this);b.emit("query",b.getQueryParams())})},getQueryParams:function(){var a=this,b=(a.model.queryKeys,a.$queryBox.find("form")),c=b.serializeArray();return c=_.map(c,function(a){var b=$XP(a,"name"),c=$XP(a,"value","");return"startDate"==b||"endDate"==b?(c=IX.isEmpty(c)?"":IX.Date.getDateByFormat(c,"yyyyMMdd"),{name:b,value:c}):a}),c=_.object(_.pluck(c,"name"),_.pluck(c,"value")),a.model.set(c),c}}),Hualala.Order.QueryView=c}(jQuery,window),function(){IX.ns("Hualala.Order");var a=(Hualala.UI.PopoverMsgTip,Hualala.UI.TopTip,Hualala.Shop.QueryController.subclass({constructor:function(a){if(this.set({sessionData:Hualala.getSessionData()}),this.container=$XP(a,"container",null),this.resultController=$XP(a,"resultController",null),this.model=$XP(a,"model",null),this.view=$XP(a,"view",null),!(this.container&&this.model&&this.view&&this.resultController))throw"QueryController init faild!";this.init()}}));a.proto({bindEvent:function(){this.on({reload:function(){var a=this;a.model.distory(),a.view.distory(),a.init()},query:function(a){var b=this,c=b.model.getCities();IX.Debug.info("DEBUG: Order Query Controller Query Params:"),IX.Debug.info(a),b.resultController&&b.resultController.emit("load",{params:IX.inherit(a,{pageNo:1,pageSize:15}),cities:c})}},this),this.model.on({load:function(a){var b=this,c=$XP(b.get("sessionData"),"user",{});b.model.init(c,a)}},this),this.view.on({init:function(){var a=this;a.view.init({model:a.model,needShopCreate:a.needShopCreate,container:a.container})},filter:function(a){var b=this;b.emit("query",a)},query:function(a){var b=this;b.emit("query",a)}},this)}}),Hualala.Order.QueryController=a}(jQuery,window),function(a){IX.ns("Hualala.Order");var b=function(){var b=Hualala.PageRoute.getPageContextByPath(),c=a("#ix_wrapper > .ix-body > .container");c.empty();var d=function(){var a=IX.Date.getDateByFormat(new Hualala.Date((new Date).getTime()/1e3).toText(),"yyyyMMdd"),c=_.map(Hualala.TypeDef.OrderSubNavType,function(c){var d=_.map($XP(c,"pkeys",[]),function(b){return"startDate"==b||"endDate"==b?a:""});return{active:$XP(b,"name")==c.name?"active":"",disabled:"",path:Hualala.PageRoute.createPath(c.name,d)||"#",name:c.name,label:c.label}});return{toggle:{target:"#order_navbar"},items:c}},e=Handlebars.compile(Hualala.TplLib.get("tpl_order_subnav"));Handlebars.registerPartial("toggle",Hualala.TplLib.get("tpl_site_navbarToggle")),c.html('<div class="order-subnav clearfix" /><div class="order-body" ><div class="order-query-box"></div><div class="order-result-box"></div></div>');{var f=c.find(".order-subnav");c.find(".order-body")}f.html(e(d()))},c=function(){Hualala.PageRoute.getPageContextByPath(),a("#ix_wrapper > .ix-body > .container");b();var c=IX.Date.getDateByFormat(new Hualala.Date((new Date).getTime()/1e3).toText(),"yyyyMMdd"),d=_.find(Hualala.TypeDef.OrderSubNavType,function(a){return"orderQuery"==a.name}),e=$XP(d,"pkeys",[]);e=_.map(e,function(a){return"startDate"==a||"endDate"==a?c:""}),document.location.href=Hualala.PageRoute.createPath("orderQuery",e)},d=function(){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container");b();{var e=d.find(".order-body"),f=$XP(_.findWhere(Hualala.TypeDef.OrderSubNavType,{name:$XP(c,"name")}),"pkeys");new Hualala.Order.QueryController({container:e,resultController:new Hualala.Order.OrderListController({container:e,model:new Hualala.Order.OrderQueryResultModel({callServer:Hualala.Global.queryOrderDetail,queryKeys:f,initQueryParams:Hualala.Order.initQueryParams}),view:new Hualala.Order.OrderQueryResultView({mapResultRenderData:Hualala.Order.mapQueryOrderResultRenderData,renderResult:Hualala.Order.renderQueryOrderResult})}),model:new Hualala.Order.QueryModel({queryKeys:f,initQueryParams:Hualala.Order.initQueryParams}),view:new Hualala.Order.QueryView({mapRenderDataFn:Hualala.Order.mapOrderQueryFormRenderData})})
}},e=function(){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container");b();{var e=d.find(".order-body"),f=$XP(_.findWhere(Hualala.TypeDef.OrderSubNavType,{name:$XP(c,"name")}),"pkeys");new Hualala.Order.QueryController({container:e,resultController:new Hualala.Order.OrderListController({container:e,model:new Hualala.Order.OrderQueryResultModel({callServer:Hualala.Global.queryOrderDayDetail,queryKeys:f,initQueryParams:Hualala.Order.initQueryParams}),view:new Hualala.Order.OrderQueryResultView({mapResultRenderData:Hualala.Order.mapQueryOrderDuringRenderData,renderResult:Hualala.Order.renderQueryOrderResult})}),model:new Hualala.Order.QueryModel({queryKeys:f,initQueryParams:Hualala.Order.initQueryParams}),view:new Hualala.Order.QueryView({mapRenderDataFn:Hualala.Order.mapOrderQueryBaseFormRenderData})})}},f=function(){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container");b();{var e=d.find(".order-body"),f=$XP(_.findWhere(Hualala.TypeDef.OrderSubNavType,{name:$XP(c,"name")}),"pkeys");new Hualala.Order.QueryController({container:e,resultController:new Hualala.Order.OrderListController({container:e,model:new Hualala.Order.OrderQueryResultModel({callServer:Hualala.Global.queryOrderDuringDetail,queryKeys:f,initQueryParams:Hualala.Order.initQueryParams}),view:new Hualala.Order.OrderQueryResultView({mapResultRenderData:Hualala.Order.mapQueryOrderDuringRenderData,renderResult:Hualala.Order.renderQueryOrderResult})}),model:new Hualala.Order.QueryModel({queryKeys:f,initQueryParams:Hualala.Order.initQueryParams}),view:new Hualala.Order.QueryView({mapRenderDataFn:Hualala.Order.mapOrderQueryBaseFormRenderData})})}},g=function(){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container");b();{var e=d.find(".order-body"),f=$XP(_.findWhere(Hualala.TypeDef.OrderSubNavType,{name:$XP(c,"name")}),"pkeys");new Hualala.Order.QueryController({container:e,resultController:new Hualala.Order.OrderListController({container:e,model:new Hualala.Order.OrderQueryResultModel({hasPager:!1,callServer:Hualala.Global.queryOrderDishesHot,queryKeys:f,initQueryParams:Hualala.Order.initQueryParams}),view:new Hualala.Order.OrderQueryResultView({mapResultRenderData:Hualala.Order.mapQueryDishesHotRenderData,renderResult:Hualala.Order.renderQueryOrderResult})}),model:new Hualala.Order.QueryModel({queryKeys:f,initQueryParams:Hualala.Order.initQueryParams}),view:new Hualala.Order.QueryView({mapRenderDataFn:Hualala.Order.mapDishesHotQueryFormRenderData})})}},h=function(){var c=Hualala.PageRoute.getPageContextByPath(),d=a("#ix_wrapper > .ix-body > .container");b();{var e=d.find(".order-body"),f=$XP(_.findWhere(Hualala.TypeDef.OrderSubNavType,{name:$XP(c,"name")}),"pkeys");new Hualala.Order.QueryController({container:e,resultController:new Hualala.Order.OrderListController({container:e,model:new Hualala.Order.OrderQueryResultModel({hasPager:!1,callServer:Hualala.Global.queryUserOrderStatistic,queryKeys:f,initQueryParams:Hualala.Order.initQueryParams}),view:new Hualala.Order.OrderQueryResultView({mapResultRenderData:Hualala.Order.mapQueryUserRenderData,renderResult:Hualala.Order.renderQueryOrderResult})}),model:new Hualala.Order.QueryModel({queryKeys:f,initQueryParams:Hualala.Order.initQueryParams}),view:new Hualala.Order.QueryView({mapRenderDataFn:Hualala.Order.mapUsersQueryFormRenderData})})}};Hualala.Order.OrderPageLayoutInit=b,Hualala.Order.OrderChartInit=c,Hualala.Order.QueryOrderInit=d,Hualala.Order.QueryOrderByDayDetailInit=e,Hualala.Order.QueryOrderByDuringDetailInit=f,Hualala.Order.QueryOrderDishesHotInit=g,Hualala.Order.QueryOrderCustomerInit=h}(jQuery,window),function(a){function b(){var b=Hualala.Common.Browser,c=$XP(b,"ie",null)?!0:!1,d=parseInt($XP(b,"ie",0)),e=1==IX.Cookie.get("allowOldVersion")?!0:!1;if(!c||e)return!0;if(d>8)return!0;var f=8==d?"您使用的IE浏览器版本过于陈旧，可能无法获得我们为您提供的良好的用户体验。<br/>我们建议您使用以下的浏览器或插件进行访问！":"您使用的IE浏览器版本过于陈旧，无法使用我们为您提供的管理功能。<br/>请您使用以下提供的浏览器进行访问！",g=[{href:"http://www.microsoft.com/zh-cn/download/internet-explorer-9-details.aspx",icon:"icon-ie9",name:"IE9",desc:"IE9浏览器是微软公司在2009年推出的新一代浏览器，比IE8界面更简洁，采用硬件加速功能，使访问页面更稳定，部分支持HTML5，CSS3特性。"},{href:"http://www.microsoft.com/zh-cn/download/internet-explorer-10-details.aspx",icon:"icon-ie10",name:"IE10",desc:"IE10浏览器是微软公司在2011年推出的IE9的下一代浏览器，在IE9的基础上增强了CSS3解析及硬件加速功能，并支持了HTML5。"},{href:"http://www.google.cn/intl/zh-CN/chrome/",icon:"icon-chrome",name:"Chrome",desc:"Chrome浏览器是由著名的搜索引擎巨头--谷歌(google)公司推出的现代浏览器，访问网页速度更快，稳定性更强，更具安全性，使用界面更加简洁有效，并完全支持HTML5，CSS3标准的特性。"},{href:"http://www.firefox.com.cn/download/",icon:"icon-firefox",name:"Firefox",desc:"FireFox是Mozilla推出的现代浏览器，全面支持HTML5，CSS3标准的特性。访问页面速度更快，更具安全性。"},{href:"http://ie.sogou.com/",icon:"icon-sogou",name:"搜狗浏览器",desc:"搜狗浏览器是搜狐公司推出的双核告诉浏览器--可以切换为全球最快的Webkit内核(Chrome浏览器)同时也可以切换为使用最普遍的IE内核(IE浏览器)，保证良好的兼容性的同时极大的提升网页的浏览速度。"}],h=Handlebars.compile(Hualala.TplLib.get("tpl_site_browserSupport")),i=a(h({msg:f,items:g}));return a("body > #ix_wrapper").remove(),i.appendTo(a("body")),i.find(".btn").click(function(){IX.Cookie.set("allowOldVersion",1),Hualala.Router.check()}),!1}function c(){var c=Hualala.getSessionData(),d=Handlebars.compile(Hualala.TplLib.get("tpl_site_layout")),e=$XP(Hualala.getSessionUser(),"loginName",null)?!0:!1,f=$XP(c,"user.loginName",""),g=$XP(c,"site.groupName",""),h=function(){var a={pcClientPath:Hualala.PageRoute.createPath("pcclient"),hualalaUrl:Hualala.Global.HualalaWebSite,loginName:f,merchantRoot:Hualala.PageRoute.createPath("main"),groupName:g,isLogin:e,logoutPath:Hualala.Global.getLogoutJumpToUrl(),logo:Hualala.Global.getDefaultImage("logo")},b={aboutPath:Hualala.PageRoute.createPath("about")||"#",contactPath:Hualala.PageRoute.createPath("contact")||"#",gozapLogo:Hualala.Global.getDefaultImage("gozap")};return{header:a,footer:b}},i=a(d(h()));a("body > #ix_wrapper").remove(),b()&&i.appendTo(a("body")),a.fn.bootstrapValidator&&(a.fn.bootstrapValidator.DEFAULT_OPTIONS=a.extend({},a.fn.bootstrapValidator.DEFAULT_OPTIONS,{message:"您输入的数据有误，请核对后再次输入",trigger:"blur",feedbackIcons:{valid:"glyphicon glyphicon-ok",invalid:"glyphicon glyphicon-remove",validating:"glyphicon glyphicon-refresh"}}),a.fn.bootstrapValidator.validators.accuracy={validate:function(a,b,c){var d=$XP(c,"accuracy",null),e=$XP(c,"message","");d=isNaN(d)?null:d;var f=b.val(),g=IX.isEmpty(d)||0==d?"^\\d+$":"^\\d+(\\.\\d{1,"+d+"})?$",h=null;return h=new RegExp(g),isNaN(f)?{valid:!1,message:"只能是数字"}:h.test(f)?!0:{valid:!1,message:e}}})}function d(){var b=(Hualala.getSessionData(),Handlebars.compile(Hualala.TplLib.get("tpl_site_navbar"))),c=Handlebars.compile(Hualala.TplLib.get("tpl_site_navbarToggle")),d=function(){var a=_.map(Hualala.TypeDef.SiteNavType,function(a){return{active:Hualala.Global.isCurrentPage(a.name)?"active":"",disabled:"",path:Hualala.PageRoute.createPath(a.name)||"#",name:a.name,label:a.label}});return{items:a}},e=a(b(d())),f=a(c({target:"#site_navbar"})),g=a("#ix_wrapper .ix-header");g.find("> .container .navbar-collapse").remove(),g.find("> .container").append(e),g.find("> .container > .navbar-header .navbar-toggle").remove(),g.find("> .container > .navbar-header").prepend(f)}function e(){var b=(Hualala.getSessionSite(),Hualala.getSessionUser(),Hualala.getSessionRoles(),Hualala.getSessionPCClient(),Hualala.getSessionUserRight()),c=a("#ix_wrapper > .ix-body > .container"),d=function(){var a=new IX.IListManager,c=null;return IX.iterate(b,function(b){a.register(b.name,b)}),c=_.map(j,function(b){var c=$XP(b,"name"),d=a.get(c)?!0:!1;return IX.inherit(b,{itemClz:$XP(b,"itemClz","")+" "+(d?"":"disabled")})})},e=Handlebars.compile(Hualala.TplLib.get("tpl_site_homepage")),f=a(e({bricks:d()}));c.html(f),f.on("mouseenter mouseleave click",".brick-item",function(b){var c=a(this),d=c.attr("data-pagename"),e=b.type;return c.hasClass("disabled")?!1:void("click"==e?document.location.href=Hualala.PageRoute.createPath(d):c.toggleClass("hover"))})}function f(){var b=Handlebars.compile(Hualala.TplLib.get("tpl_site_login")),c=a(b({bannerImg:Hualala.Global.getDefaultImage("loginBanner")})),d=a("#ix_wrapper > .ix-body > .container");d.html(c),Hualala.Entry.initLogin(c)}function g(){var b=a("#ix_wrapper > .ix-body"),c=Handlebars.compile(Hualala.TplLib.get("tpl_site_about")),d=a(c());d.replaceAll(b)}function h(){var b=a("#ix_wrapper > .ix-body"),c=Handlebars.compile(Hualala.TplLib.get("tpl_site_contact")),d=a(c());d.replaceAll(b)}function i(){var b=a("#ix_wrapper > .ix-body"),c=Handlebars.compile(Hualala.TplLib.get("tpl_client_download")),d=Hualala.getSessionData(),e=a(c({href:$XP(d,"pcClient.downloadClientAddress","#"),title:$XP(d,"pcClient.version","")}));e.replaceAll(b)}IX.ns("Hualala.Common");var j=[{name:"account",title:"结算",label:"提现.账户设置.结算报表",brickClz:"home-brick-md-2",itemClz:"brick-item brick-item-2",icon:"icon-pay"},{name:"order",title:"订单",label:"报表.菜品排行",brickClz:"home-brick-md-3",itemClz:"brick-item",icon:"icon-order"},{name:"shop",title:"店铺管理",label:"开店.信息.菜谱",brickClz:"home-brick-md-1",itemClz:"brick-item",icon:"icon-home"},{name:"pcclient",title:"下载哗啦啦",label:"",brickClz:"home-brick-md-1",itemClz:"brick-item",icon:"icon-download"},{name:"user",title:"账号管理",label:"账号.权限",brickClz:"home-brick-md-1 hidden",itemClz:"brick-item",icon:"icon-lock"},{name:"setting",title:"业务设置",label:"开通业务.业务参数",brickClz:"home-brick-md-3",itemClz:"brick-item",icon:"icon-setting"}];Hualala.Common.LoginInit=f,Hualala.Common.initPageLayout=c,Hualala.Common.initSiteNavBar=d,Hualala.Common.HomePageInit=e,Hualala.Common.AboutInit=g,Hualala.Common.ContactInit=h,Hualala.Common.PCClientDownloadInit=i,Hualala.Common.IndexInit=function(){document.location.href=Hualala.PageRoute.createPath("main")}}(jQuery,window),function(a){function b(a,b){if(!$XP(a,"user",null))throw"Permission Deny!!";e=a,b()}function c(a){var c=IX.getTimeInMS();log("Merchant Sys INIT : "+c),Hualala.Global.loadAppData({},function(d){if(log("Load Merchant APP Data in (ms): "+(IX.getTimeInMS()-c)),0!=$XP(d,"resultcode"))throw document.location.href=Hualala.PageRoute.createPath("login"),"Session Data Load Faild!! resultcode = "+$XP(d,"resultcode","")+"; resultMsg = "+$XP(d,"resultmsg","");b($XP(d,"data",{}),function(){log("Merchant Sys INIT DONE in (ms): "+(IX.getTimeInMS()-c)),a()})},function(){document.location.href=Hualala.PageRoute.createPath("login")})}function d(){IX.nsExisted("Hualala.ajaxEngine.init")&&(a.ajaxSetup({beforeSend:function(b){b.setRequestHeader("X-CSRF-Token",a('meta[name="csrf-token"]').attr("content"))}}),Hualala.ajaxEngine.init({ajaxFn:jQuery.ajax,baseUrl:Hualala.Global.HOME,commonUrl:Hualala.Global.CommonSite,imgUrl:Hualala.Global.IMAGE_ROOT}))}IX.ns("Hualala");var e=null;Hualala.getSessionData=function(){return e},Hualala.getSessionSite=function(){return $XP(e,"site",null)},Hualala.getSessionUser=function(){return $XP(e,"user",null)},Hualala.getSessionRoles=function(){return $XP(e,"roles",[])},Hualala.getSessionPCClient=function(){return $XP(e,"pcClient",null)},Hualala.getSessionUserRight=function(){return $XP(e,"userRight",[])},Hualala.isSessionUser=function(a,b){var c=$XP(e,"user.groupLoginName")+$XP(e,"user.loginName");return e&&c==a+b};var f=!1;Hualala.init=function(){f||(d(),Hualala.PageRoute.start(function(a,b,d){var e="main,pcclient,about,contact,login",f=_.filter(e.split(","),function(a){return"main"!=a}).join(",");return f.indexOf(a)>=0?(Hualala.Common.initPageLayout({},a),e.indexOf(a)<0&&Hualala.Common.initSiteNavBar(a),void(d&&d.apply(null,[a,b]))):void c(function(){Hualala.Common.initPageLayout({},a),e.indexOf(a)<0&&Hualala.Common.initSiteNavBar(a),d&&d.apply(null,[a,b])})}),f=!0)}}(jQuery,window),function(){function a(a,b,c){var d=a.match(c);if(d){var e=d.shift(),g=e.split("/");g=_.map(g,function(a){var b=_.indexOf(e,a);return b>-1?"_":a}),g.push(""),g.unshift("");var h=g.join("_");f[h]=b}}function b(a,b){var c=e[a];if(!c)return console.err("Can't find route : "+a);var d=$XP(c,"path"),f=$XP(c,"reg"),g=d.match(f),h=function(a){return Hualala.Global.HOME+a};return!g||g.length<1?console.err("The Path of Route ("+a+") is wrong!!"):1==g.length?h(d):g.length>1&&IX.isArray(b)&&g.length-1==b.length?(g.shift(),_.each(g,function(a,c){d=d.replace(a,b[c])}),h(d)):void 0}IX.ns("Hualala.PageRoute");var c=Hualala.Router,d=(Hualala.Global.Route,!1),e={},f={},g=function(){function a(a){if(!IX.isFn(IX.getNS(a)))return!1;for(var b=f.get(a),c=IX.getNS(a),d=0;d<b.length;d++)e[b[d]].init=c;return f.remove(a),!0}function b(){return g=IX.loop(g,[],function(b,c){return a(c)||b.push(c),b}),0==g.length}function c(){g=IX.Array.toSet(g),IX.checkReady(b,IX.emptyFn,40,{maxAge:15e3,expire:function(){alert("Can't find page inializor : \n"+g.join("\n"))}})}function d(a,b){var c=null;if(IX.isFn(b))c=b;else{if(!IX.isString(b))throw"Configuration failed : Invalid Page Initialized for "+a;IX.nsExisted(b)&&(c=IX.getNS(b))}return IX.isFn(c)?e[a].init=c:(f.put(b,a),void g.push(b))}var f=new IX.I1ToNManager,g=[];return{start:function(){setTimeout(c,1)},detect:d}}(),h=[{name:"login",path:"/#login",reg:/login$/,bodyClz:"",PageInitiator:"Hualala.Common.LoginInit",label:"登录"},{name:"main",path:"/#home",reg:/home$/,bodyClz:"",PageInitiator:"Hualala.Common.HomePageInit",label:"首页"},{name:"shop",path:"/#shop",reg:/shop$/,bodyClz:"",PageInitiator:"Hualala.Shop.HomePageInit",parentName:"main",label:"店铺管理"},{name:"shopCreate",path:"/#shop/create",reg:/shop\/create$/,bodyClz:"",PageInitiator:"Hualala.Shop.CreateShopInit",parentName:"shop",label:"创建店铺"},{name:"shopInfo",path:"/#shop/{id}/info",reg:/shop\/(.*)\/info$/,bodyClz:"",PageInitiator:"Hualala.Shop.BaseInfoMgrInit",parentName:"shop",label:"店铺信息"},{name:"shopMenu",path:"/#shop/{id}/menu",reg:/shop\/(.*)\/menu$/,bodyClz:"",PageInitiator:"Hualala.Shop.FoodMenuMgrInit",parentName:"shop",label:"菜单管理"},{name:"setting",path:"/#setting",reg:/setting$/,bodyClz:"",PageInitiator:"Hualala.Setting.ShopMgrInit",parentName:"main",label:"业务设置"},{name:"account",path:"/#account",reg:/account$/,bodyClz:"",PageInitiator:"Hualala.Account.AccountListInit",parentName:"main",label:"账户结算"},{name:"accountDetail",path:"/#account/{id}/detail",reg:/account\/(.*)\/detail$/,bodyClz:"",PageInitiator:"Hualala.Account.AccountMgrInit",parentName:"account",label:"账户明细"},{name:"order",path:"/#order",reg:/order$/,bodyClz:"",PageInitiator:"Hualala.Order.OrderChartInit",parentName:"main",label:"订单报表"},{name:"orderQuery",path:"/#order/query/b{begin}/e{end}/c{cityID}/n{shopID}/s{status}/m{mobile}/o{orderKey}/i{minAmount}/a{maxAmount}",reg:/order\/query\/b(.*)\/e(.*)\/c(.*)\/n(.*)\/s(.*)\/m(.*)\/o(.*)\/i(.*)\/a(.*)$/,bodyClz:"",PageInitiator:"Hualala.Order.QueryOrderInit",parentName:"main",label:"订单查询"},{name:"orderQueryDay",path:"/#order/query/day/b{begin}/e{end}/c{cityID}/n{shopID}/s{status}",reg:/order\/query\/day\/b(.*)\/e(.*)\/c(.*)\/n(.*)\/s(.*)/,bodyClz:"",PageInitiator:"Hualala.Order.QueryOrderByDayDetailInit",parentName:"main",label:"订单日汇总"},{name:"orderQueryDuring",path:"/#order/query/during/b{begin}/e{end}/c{cityID}/n{shopID}/s{status}",reg:/order\/query\/during\/b(.*)\/e(.*)\/c(.*)\/n(.*)\/s(.*)/,bodyClz:"",PageInitiator:"Hualala.Order.QueryOrderByDuringDetailInit",parentName:"main",label:"订单期间汇总"},{name:"orderDishesHot",path:"/#order/dishes/hot/b{begin}/e{end}/c{cityID}/n{shopID}/s{foodCategoryName}",reg:/order\/dishes\/hot\/b(.*)\/e(.*)\/c(.*)\/n(.*)\/s(.*)/,bodyClz:"",PageInitiator:"Hualala.Order.QueryOrderDishesHotInit",parentName:"main",label:"菜品销量排行"},{name:"orderQueryCustomer",path:"/#order/customer/b{begin}/e{end}/c{cityID}/n{shopID}/m{mobile}/u{customerName}",reg:/order\/customer\/b(.*)\/e(.*)\/c(.*)\/n(.*)\/m(.*)\/u(.*)/,bodyClz:"",PageInitiator:"Hualala.Order.QueryOrderCustomerInit",parentName:"main",label:"顾客统计"},{name:"pcclient",path:"/#download",reg:/download$/,bodyClz:"",PageInitiator:"Hualala.Common.PCClientDownloadInit",parentName:"main",label:"客户端下载"},{name:"about",path:"/#about",reg:/about$/,bodyClz:"",PageInitiator:"Hualala.Common.AboutInit",parentName:"main",label:"关于"},{name:"contact",path:"/#contact",reg:/contact$/,bodyClz:"",PageInitiator:"Hualala.Common.ContactInit",parentName:"main",label:"联系我们"},{name:"index",path:"",reg:/(.*)$/,bodyClz:"",PageInitiator:"Hualala.Common.IndexInit"}];IX.iterate(h,function(b){var c=IX.inherit({bodyClz:"ix-minor",path:""},b),d=$XP(b,"name"),f=$XP(b,"path"),h=$XP(b,"reg");a(f,d,h),e[d]={name:d,bodyClz:$XP(c,"bodyClz",""),path:f,reg:$XP(c,"reg",null),parentName:$XP(b,"parentName",null),label:$XP(b,"label","")};var i="PageInitiator"in c?c.PageInitiator:null;IX.isString(i)||IX.isFn(i)||(i=IX.emptyFn),g.detect(d,i)}),g.start(),Hualala.PageRoute.start=function(a){d=!0,c.flush().config({mode:"history",root:Hualala.Global.HOME}),_.each(e,function(b,d){var e=$XP(b,"reg"),f=$XF(b,"init"),g=null;g=function(b){IX.Debug.info("INFO: Init Page : ["+d+"]"),IX.Debug.info("INFO: Page Arguments : ["+b+"]"),IX.isFn(a)&&a(d,b,f)},c.add(e,g)}),c.listen().check()},Hualala.PageRoute.createPath=b,Hualala.PageRoute.getCurrentPath=function(){return location.hash},Hualala.PageRoute.getPageContextByPath=function(a){var b=a||Hualala.Router.getFragment(),c=_.filter(e,function(a){return!!b.match(a.reg)}),d=null;return 0==c.length?null:1==c.length?(d=b.match(c[0].reg),d.shift(),IX.inherit({params:d},c[0])):(c=_.filter(c,function(a){return"index"!=a.name}),d=b.match(c[c.length-1].reg),d.shift(),IX.inherit({params:d},c[c.length-1]))},Hualala.PageRoute.getParentNamesByPath=function(a){for(var b=Hualala.PageRoute.getPageContextByPath(a),c=$XP(b,"name",null),d=[];!IX.isEmpty(c);){d.unshift({name:c,label:$XP(b,"label",""),path:Hualala.PageRoute.createPath(c,b.params)});var f=$XP(b,"parentName",null);b=IX.isEmpty(f)?null:$XP(e,f,null),c=$XP(b,"name",null)}return d[d.length-1].isLastNode=!0,d},Hualala.PageRoute.getPageLabelByName=function(a){if(!a)return null;var b=e[a];return b?b.label:null}}(jQuery,window);
//# sourceMappingURL=pages.min.map